<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <link rel="stylesheet" href="almightylisp.css" type="text/css" media="screen" />
        <script src="highlight-lisp.js"></script>
    </head>
    <body>

        <h1 id="18ec4607-12bc-4295-9044-6976a88f52ff"><span class="todo TODO">TODO</span> META</h1>
        <h2 id="cfdb96ce-9fb6-44ad-82e9-efd2b0b65608">WHY I WROTE THIS BOOK</h2>
        <p>Common Lisp is an old programming language that hasn't changed since it was standardized. That means that any learning material produced for the language is still useful even today. You can read Touretzky, Norvig, etc. and learn from people far smarter than me.</p>
        <p>However, the methods of teaching material, the culture of the people reading the material, and the problems or projects presented in the material may not be as relevant to modern audiences. Touretzky writes for new programmers and doesn't even teach Lisp's OOP facilities; Norvig teaches first principles of programming geared toward old fashioned AI; SICP is heavy on math and wasn't written in an age of ubiquitous ecosystems like JavaScript or Python; Steele wrote a language reference, not a tutorial; various other authors focus on macros, CLOS, etc. These older teaching materials are still irreplaceable masterpieces (Norvig perhaps the best of them), but a modern audience has modern needs and sensibilities.</p>
        <p>Practical Common Lisp at one time was the book for modern audiences, but even when it was released it fell short of what it should have been. It provides lots of practical projects, but doesn't provide a detailed guide for how to present those projects to the world. It's a book written for experienced programmers who are Lisp-curious and is partially meant to advocate for Lisp, but does little to fix the problem of Lisp's steep learning curve.</p>
        <p>And it does have a steep learning curve. Why? Not really because of any feature of Common Lisp. The parentheses can be a bit challenging at first, but it's more of an emotional challenge than a technical one. Macros are tough to master, but not so hard to get started with. Common Lisp is a big language, but beginning is not particularly hard and searching the HyperSpec can go a long way to deepen your knowledge of the language.</p>
        <p>No, it's not the language that's the source of the learning curve–it's Emacs. Emacs is the defacto-standard text editor for Common Lisp development. It's also 50 years old and doesn't have the mainstream popularity of other editors, creating a considerable mental block to even considering learning it or Common Lisp. On top of that, developers interact with Emacs very differently from how they interact with VSCode or the JetBrains IDEs (let alone OpenCode or Claude Code-like agentic LLM CLIs), hindering new users from transferring knowledge from the development environments they are familiar with.</p>
        <p>Emacs is the elephant in the room that no books on Common Lisp address. PCL made a half-hearted attempt with Lisp in a Box (a distribution of Emacs somewhat analogous to the later Portacle, now deprecated), but it was insufficient to the task.</p>
        <p>With this book I hope to provide you–the experienced Lisp-curious developer–with a source for learning both Common Lisp and Emacs at the same time, help you get oriented to the Lisp ecosystem and current practices, and get you deploying your applications in your preferred medium by the time you're finished reading.</p>
        <h2 id="4b22efc1-1eed-4f8a-b06a-6e491bd85dd9"><span class="todo TODO">TODO</span> ALMIGHTY</h2>
        <p>When you are given the job of choosing the tech stack for a job, how do you choose? If the task is data science, what language would you choose? Would your choice be different if your task was web development? Would it be different if it was embedded development? Or accounting? Or mobile apps?</p>
        <p>Programming is fraught with choices. Probably the most important choice is which language to use for any particular task. If you're doing data analytics, you need to use Python. If you're developing a web application, you need to use JavaScript or Ruby. If you're writing accounting software, you need to use Java. If you're writing real-time software with performance and size limitations, you use C or Rust.</p>
        <p>We take it for granted that such choices are necessary, that we need to choose a language based on a task. No language is adapted to every task; when you need to drill, you don't use a hammer.</p>
        <p>But what if we had a special, universal tool? What if the tool could be <em>adapted</em> to the task, rather than <em>chosen</em> for it?</p>
        <p>Common Lisp is just such a language. It's the highest level language out there thanks to macros and the parentheses, but a surprisingly low level language thanks to the ability to inspect generated assembly output and the ability to specify types (although in a somewhat sloppy way) to optimize for speed and memory efficiency. As a result, Lisp is both highly expressive while sacrificing little performance. The result is a highly adaptable language–perhaps the <em>most</em> adaptable.</p>
        <p>Lisp does sacrifice <em>something</em>, though. Well-optimized C is going to yield smaller executables, lower memory use, and faster performance. Well written Ruby or Python is probably aesthetically more pleasing than well written Lisp–and I believe that aesthetics are important. The Lisp ecosystem can usually get you started, but it's not going to do most of the heavy lifting like in Java or JavaScript's ecosystems.</p>
        <p>With Lisp, you sacrifice choosing the absolute optimal tool for the job in exchange for absolute <em>flexibility</em>. Lisp may not initially be the best tool for any single job, but you can <em>mould</em> it into the best tool for many jobs. It's not the fastest, but it's competitive with the fastest. It's not the prettiest, but you can make it prettier if that's important to you. There may not be a free library available to do exactly what you want, but you usually don't have to start from scratch, either.</p>
        <p>Lisp is not a language specialized to a domain of work; it's a language specialized to being <em>generally adaptable</em>. It's not a master of any domain, but it can be adapted to a wide variety of domains.</p>
        <p>In English, a man who isn't a specialist in any field, but who commands a holistic knowledge and capabilities in many domains, is called a <em>generalist</em>.</p>
        <p>In Japanese, such a man is called オールマイティ–almighty.</p>
        <p>That's what Lisp is. Lisp is almighty, and it summons programmers to become almighty.</p>
        <p>And in the current environment, you have no choice. AI is here. Whether we like it or not, many people will gladly trade their birthright for a bowl of stew; their ability to do things themselves now and in the future for their ability to do a lot of things (badly) <em>now</em>; craftmanship for crude replacements; their fellow humans and society as a whole for the chance at "generational wealth".</p>
        <p>Lines are being drawn. Either you join them on their quest or they will seek to crush you.</p>
        <p>You and I, friend, must become almighty.</p>
        <h1 id="15173579-9e2f-4553-8ae6-e1184d56a215">EMACS SETUP &amp; USE</h1>
        <h2 id="cbdfe115-ea5c-42dd-8d39-7c927c57cd80">PURPOSE</h2>
        <p>Learning Common Lisp is complicated by the fact that Emacs is the defacto standard Common Lisp code editor. Emacs is good, but making use of its capabilities requires adopting a different mental model for code editing, making it difficult and confusing to learn. Finding out that you need to learn an <em>old</em>, <em>weird</em> editor before you can even begin learning Common Lisp in ernest is enough to turn newcomers off.</p>
        <p>This chapter is a quick references for getting started with Emacs and Common Lisp coding. It's intended to help bootstrap an understanding of Emacs concepts, Common Lisp concepts, and an understanding of common actions in both. You should experience a smooth transition to learning Common Lisp after completing this chapter.</p>
        <p>My intention is to make you less confused. If you are confused after reading this chapter, ask me for help on X (<a href="https://x.com/killian_arts">@killian<sub>arts</sub></a>). Consider me your Emacs and Common Lisp tech support.</p>
        <h2 id="89552785-c7c0-4e4a-aef8-8f9292d5342b">DOOM EMACS INSTALL &amp; SETUP</h2>
        <h3 id="404991c7-d6c1-4c03-89c4-62ce87662087">MacOS</h3>
        <ol class="incremental">
            <li><p>00.01.00.00 Install Homebrew</p>
                <p><a href="https://brew.sh/">Homebrew</a> is a package manager for MacOS.</p>
                <pre><code>/bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)&quot;
                </code></pre>
                <p>Run this command in the terminal and follow instructions.</p></li>
            <li><p>00.01.00.01 Install SBCL</p>
                <p><a href="https://sbcl.org">SBCL</a> is the most popular Common Lisp implementation.</p>
                <pre><code>brew install sbcl
                </code></pre>
                <p>Test that it's installed and working.</p>
                <pre><code>$ sbcl --version
                </code></pre></li>
            <li><p>00.01.00.02 Install Emacs</p>
                <p><a href="https://www.gnu.org/software/emacs/">Emacs</a> is the defacto-standard editor for Common Lisp.</p>
                <p>Install dependencies:</p>
                <pre><code>brew install git ripgrep coreutils fd
                </code></pre>
                <p>Install Emacs Plus</p>
                <pre><code>brew tap d12frosted/emacs-plus
brew install emacs-plus
                </code></pre>
                <p>Test that Emacs is installed and working.</p>
                <pre><code>$ emacs
                </code></pre></li>
            <li><p>00.01.00.03 Install Doom</p>
                <p><a href="https://github.com/doomemacs/doomemacs">Doom</a> is an Emacs distribution. It provides everything Emacs-related for integration with Common Lisp, and generally makes Emacs more ergonomic.</p>
                <pre><code>git clone --depth 1 https://github.com/doomemacs/doomemacs =/.config/emacs
=/.config/emacs/bin/doom install
                </code></pre>
                <p>After installing, add <code class="verbatim">=/.config/emacs/bin/</code> to <code class="verbatim">PATH</code>.</p>
                <p>Open either <code class="verbatim">.bash_profile</code> or <code class="verbatim">.zshrc</code>, add this line and save.</p>
                <pre><code>export PATH=&quot;$HOME/.config/emacs/bin:$PATH&quot;
export PATH=&quot;$PATH:/User/yourhomedirectoryhere/.config/emacs/bin&quot;
                </code></pre>
                <p>Restart your terminal for the change to take effect.</p>
                <p>Test that Doom is installed and that the changes to your <code class="verbatim">PATH</code> are working.</p>
                <pre><code>$ doom sync
$ doom emacs
                </code></pre></li>
            <li><p>00.01.00.04 Configure Doom for Common Lisp</p>
                <p>Edit <code class="verbatim">init.el</code> file.</p>
                <div class="sourceCode" id="cb10" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">;;; init.el -*- lexical-binding: t; -*-</span></span>
                    <span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">;; This file controls what Doom modules are enabled and what order they load</span></span>
                    <span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; in. Remember to run &#39;doom sync&#39; after modifying it!</span></span>
                    <span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; </span><span class="al">NOTE</span><span class="co"> Press &#39;SPC h d h&#39; (or &#39;C-h d h&#39; for non-vim users) to access Doom&#39;s</span></span>
                    <span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">;;      documentation. There you&#39;ll find a link to Doom&#39;s Module Index where all</span></span>
                    <span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">;;      of our modules are listed, including what flags they support.</span></span>
                    <span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; </span><span class="al">NOTE</span><span class="co"> Move your cursor over a module&#39;s name (or its flags) and press &#39;K&#39; (or</span></span>
                    <span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">;;      &#39;C-c c k&#39; for non-vim users) to view its documentation. This works on</span></span>
                    <span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">;;      flags as well (those symbols that start with a plus).</span></span>
                    <span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">;;</span></span>
                    <span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">;;      Alternatively, press &#39;gd&#39; (or &#39;C-c c d&#39;) on a module to browse its</span></span>
                    <span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">;;      directory (for easy access to its source code).</span></span>
                    <span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">;; </span><span class="al">NOTE</span><span class="co"> I have abbreviated the full init.el file.</span></span>
                    <span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co">;;      The below settings are the only ones I&#39;ve changed.</span></span>
                    <span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>(doom! <span class="bu">:input</span></span>
                    <span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>       :completion</span>
                    <span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>       company           <span class="co">; the ultimate code completion backend</span></span>
                    <span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>       :ui</span>
                    <span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>       treemacs          <span class="co">; a project drawer, like neotree but cooler</span></span>
                    <span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>       :editor</span>
                    <span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>       lispy             <span class="co">; vim for lisp, for people who don&#39;t like vim</span></span>
                    <span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>       :emacs</span>
                    <span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>       :term</span>
                    <span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>       vterm             <span class="co">; the best terminal emulation in Emacs</span></span>
                    <span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>       :checkers</span>
                    <span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>       :tools</span>
                    <span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>       :os</span>
                    <span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>       :lang</span>
                    <span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>       common-lisp       <span class="co">; if you&#39;ve seen one lisp, you&#39;ve seen them all</span></span>
                    <span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; The rest is unchanged.</span></span></code></pre></div>
                <p>Save the <code class="verbatim">init.el</code> file.</p>
                <p>Reload Doom with <code class="verbatim">SPC h r r</code> (space key then h then r then r). Alternative: Close Emacs. In the terminal, run <code class="verbatim">doom sync</code>. Reopen <code class="verbatim">doom emacs</code>.</p></li>
        </ol>
        <h3 id="788a0632-2a6a-48b9-84f1-d7ee3e228fa0">Remap Capslock to Control</h3>
        <p>Because the Control key is used so heavily in Emacs keybindings, most Emacs users will remap the Caps Lock key to Control. That improves comfort and usability of Emacs keybindings. I can give you instructions for MacOS.</p>
        <ol class="incremental">
            <li><p>MacOS</p>
                <ul class="incremental">
                    <li>Open Settings.</li>
                    <li>Go to Keyboard.</li>
                    <li>Click on Keyboard Shortcuts.</li>
                    <li>Go to Modifier Keys (bottom left).</li>
                    <li>Click on dropdown menu right of where it says Caps Lock Key.</li>
                    <li>Change it to Control.</li>
                    <li>Click Done.</li>
                </ul></li>
        </ol>
        <h2 id="emacs-dictionary">EMACS DICTIONARY</h2>
        <h3 id="a4ac2611-edc7-4677-82c8-b713555663b7">Concepts</h3>
        <ol class="incremental">
            <li><p>Buffer</p>
                <p>An Emacs <code class="verbatim">buffer</code> displays the contents of a file, terminal, repl, message/log, etc.</p></li>
            <li><p>Modeline</p>
                <p>The modeline is the area at the bottom of nearly every buffer that shows information about that buffer–including the file path for file buffers, the current major mode, and the current Evil state.</p>
                <p>You can interact with the modeline. If you hover over the modeline with the mouse, it will tell you what clicking on that area will do.</p>
                <p>The modeline, and the toolbar, are both invaluable sources of information for beginners.</p></li>
            <li><p>Window</p>
                <p>An Emacs <code class="verbatim">window</code> is closer to the modern concept of a <code class="verbatim">pane</code>. A window can only display one buffer at a time.</p></li>
            <li><p>Frame</p>
                <p>An Emacs <code class="verbatim">frame</code> is the equivalent of the modern concept of a <code class="verbatim">window</code>. It's the box that displays the Emacs application. A frame can hold multiple Emacs windows and minibuffers simultaneously.</p></li>
            <li><p>Minibuffer</p>
                <p>A minibuffer is a <code class="verbatim">buffer</code> that is intended to be temporary. Usually they display some information while you are in the middle of a command or other action, and close automatically when you finish or abort the action/command.</p></li>
            <li><p>Mode</p>
                <p>Buffers have both <code class="verbatim">major</code> and <code class="verbatim">minor</code> modes. If you open a <code class="verbatim">.lisp</code> file, the file will automatically open in <code class="verbatim">lisp-mode</code>. <code class="verbatim">lisp-mode</code> is a <code class="verbatim">major-mode</code>. ~auto-save-mode=, <code class="verbatim">evil-mode</code>, <code class="verbatim">company-mode</code>, <code class="verbatim">hl-mode</code>, etc. are <code class="verbatim">minor</code> modes. Only one <code class="verbatim">major</code> mode can be active in one buffer. Multiple <code class="verbatim">minor</code> modes can be active in a buffer.</p>
                <p>Modes provide syntax highlighting, specialized commands, and various features intended to improve the editing experience.</p></li>
            <li><p>Workspaces &amp; Projects</p>
                <p>Doom includes packages that provide workspace and project functionality, allowing you to more effectively separate groups of buffers and give you the ability to quickly search multiple projects. The functionality idiomatic of workspaces and projects aren't native to Emacs, but they are conveniently provided by Doom Emacs through several packages.</p></li>
            <li><p>Packages</p>
                <p>Emacs packages are equivalent of "extensions" or "plugins". Not to be confused with <em>Common Lisp packages</em> which are an entirely separate idiom and functionality.</p></li>
        </ol>
        <h3 id="3aaaf6de-a910-48cc-866b-5d4c51bd6d87">Keybinding Basics</h3>
        <p>Doom Emacs have vanilla Emacs keybindings and vim-style keybindings (see: <code class="verbatim">evil</code> in the <code class="verbatim">init.el</code> file) enabled by default.</p>
        <p><code class="verbatim">C</code> is the control key. <code class="verbatim">M</code> is the meta/option/alt key. <code class="verbatim">s</code> is the super/command/windows key. <code class="verbatim">SPC</code> is the space key <code class="verbatim">ESC</code> is the escape key.</p>
        <p><code class="verbatim">C-x</code> means "Hold control then press x". <code class="verbatim">C-c C-c</code> means "Hold control then press c, then hold control then press c". <code class="verbatim">SPC f f</code> means "Press the space key then f then f".</p>
        <h2 id="8e2c4081-fb3d-49f1-9a38-06b5a9f07247">SURVIVAL EMACS</h2>
        <p>When you first begin with this book, I assume you at least don't know Emacs keybindings. If you know Vim/Neovim style bindings, then you'll know how to do basic text navigation and editing, search and replace, etc.</p>
        <p>To begin with, I'll assume you don't know either Emacs or Vim keybindings. I'll teach you the basics of how to get around and get started following along with the next Lisp chapter. Importantly, you won't need to learn any keybindings at all; you can mostly pretend Emacs is a plain text editor. Thus, in this chapter I'll teach you how to:</p>
        <ul class="incremental">
            <li>Create &amp; Open a file buffer using the menu.</li>
            <li>Read the modeline.</li>
            <li>Insert text.</li>
            <li>Save a file buffer using the menu.</li>
            <li>View a list of open buffers in the menu.</li>
        </ul>
        <p>Additionally, there are some behaviors in Emacs that may be confusing while doing basic text editing. I'll tell you about these behaviors ahead of time so it's less frustrating when you first begin.</p>
        <h3 id="creating-opening-file-buffers">Creating &amp; Opening File Buffers</h3>
        <p>In Emacs, creating a new file buffer and opening an existing file into a buffer are nearly the same action, making it somewhat confusing.</p>
        <p>Let's say you want to create a new file. In the menu, navigate to <code class="verbatim">File-&gt;Visit New File</code>. A new minibuffer will open. In the top left of the minibuffer it will say "Find File" and show the path to the current directory. To make a new file there, type in the name of the file you want to create, like "abc.txt" or "main.lisp", then press <code class="verbatim">Enter</code>. A new, empty buffer with that name will open. <em>The file doesn't exist until you save it.</em></p>
        <p>To navigate to other directories from that minibuffer, you can type the name of a subdirectory, or you can press <code class="verbatim">Backspace</code> to navigate to a parent directory instead.</p>
        <p>Now let's say you want to open an existing file. In the menu, navigate to <code class="verbatim">File-&gt;Open File</code>. The identical minibuffer will open. Navigate to your file, type in its name, and press <code class="verbatim">Enter</code> to open the file.</p>
        <h3 id="reading-the-modeline">Reading The Modeline</h3>
        <p>With a file buffer open, take a look at the bar at the bottom of the buffer. It contains important information. It's contents, from left to right:</p>
        <ul class="incremental">
            <li>An icon showing the current <code class="verbatim">evil-mode</code> state.</li>
            <li>An integer showing the buffer size.</li>
            <li>The path to the current file/buffer.</li>
            <li>Two numbers separated by a colon. These show the current line and column of the cursor. Example: <code class="verbatim">50:20</code> means <code class="verbatim">line 50, column 20</code></li>
        </ul>
        <h3 id="inserting-text">Inserting Text</h3>
        <p>By default, you are in <code class="verbatim">evil-mode</code>'s <code class="verbatim">Normal State</code>. We want to initially avoid learning any complicated systems of text editing. To do that, we can switch to <code class="verbatim">Emacs State</code>. Type <code class="verbatim">C-z</code>. In the modeline in the bottom left, you should see the icon change, probably to <code class="verbatim">E</code>, indicating that you are in <code class="verbatim">Emacs State</code>. In this state:</p>
        <ul class="incremental">
            <li>You have access to all of Emacs' keybindings.</li>
            <li>You can insert, highlight, cut, copy, paste, and delete text as you usually would.</li>
        </ul>
        <p>You will need to switch to <code class="verbatim">Emacs State</code> every time you open a new buffer.</p>
        <p>To switch out of <code class="verbatim">Emacs State</code> and back into <code class="verbatim">Normal State</code>, type <code class="verbatim">C-z</code> again.</p>
        <h3 id="saving-files">Saving Files</h3>
        <p>You can save a file using your standard keybinding <code class="verbatim">s-s</code>, or you can save with the menu. Navigate to <code class="verbatim">File-&gt;Save</code>.</p>
        <h3 id="view-a-list-of-open-buffers">View A List Of Open Buffers</h3>
        <p>You can view a list of open buffers and switch to one in the menu. Navigate to <code class="verbatim">Buffers</code>. Buffers that have names like <code class="verbatim">*Messages*</code> are special Emacs buffers. All others should be file buffers.</p>
        <p>If you click on one of the buffers, the window with the keyboard cursor active will switch to that buffer.</p>
        <h3 id="killclose-a-buffer">Kill/Close A Buffer</h3>
        <p>To close a buffer, navigate to <code class="verbatim">File-&gt;Close</code>.</p>
        <h3 id="strange-behavior">Strange Behavior</h3>
        <p>That'll get you started with the basics. There are few strange behaviors to look out for, though.</p>
        <ol class="incremental">
            <li><p>"I typed something once but it got repeated several times."</p>
                <p>In <code class="verbatim">Emacs State</code>, if you type <code class="verbatim">C-u</code> and then a number <code class="verbatim">n</code>, the next thing you type will be repeated <code class="verbatim">n</code> times. If you type <code class="verbatim">C-u 8 d</code> you will type 8 d's.</p>
                <p>This is useful behavior when you know what's happening, confusing and frustrating when you don't. It's usually more of a problem in Evil <code class="verbatim">Normal State</code> because you don't even have to type <code class="verbatim">C-u</code>, and if you type <code class="verbatim">8</code>, go into <code class="verbatim">Insert State</code> and type in a bunch of code and then type <code class="verbatim">ESC</code> to go back to <code class="verbatim">Normal State</code>, all of the code will be repeated 8 times.</p></li>
            <li><p>"I can't type anything; the window seems locked."</p>
                <p>Look at the beginning of the buffer name. Does it have a Lock icon? You may have accidentally typed <code class="verbatim">C-x C-q</code> or <code class="verbatim">SPC t r</code>, putting the buffer into read-only mode. Type <code class="verbatim">C-x C-q</code> or <code class="verbatim">SPC t r</code> again to make the buffer editable again.</p></li>
            <li><p>"I typed something and the buffer changed."</p>
                <p>You may have accidentally closed or switched the buffer. You can try switching back using the method above, or you can type <code class="verbatim">C-w C-u</code> to undo whatever the heck you did. We'll see later that the <code class="verbatim">C-w C-u</code> (<code class="verbatim">winner-undo</code>) command has some other uses.</p>
                <p>And if you accidentally undid something that you want to <em>redo</em>, you can type <code class="verbatim">C-w C-r</code>.</p></li>
            <li><p>"I typed something and some minibuffer or prompt came up and I want to just get rid of it."</p>
                <p>Typically this happens to me when I accidently type <code class="verbatim">C-x k</code> to kill/close a buffer. Whatever you did, you can cancel whatever action you are in the middle of by typing <code class="verbatim">C-g</code> a few times. <code class="verbatim">C-g</code> is a universal command for canceling some action.</p></li>
            <li><p>"My buffer has a file open but I can only see part of it (or perhaps none of it at all)."</p>
                <p>If you're sure you have a file buffer open to a file that exists and has data in it, then you may be a victim of <em>narrowing</em>. You can confirm by looking at the modeline: At the beginning of the buffer/file path in the modeline, if you see two arrows, one above the other, pointing to each other, then the buffer has been narrowed.</p>
                <p>To unnarrow or <em>widen</em>, switch to <code class="verbatim">Normal State</code> and type <code class="verbatim">SPC b -</code> (<code class="verbatim">doom/toggle-narrow-buffer</code>).</p></li>
            <li><p>"I cut some text, but when I try to paste, some other text appears."</p>
                <p>Did you cut some text, delete a word with <code class="verbatim">C-backspace</code>? Is that word the one being pasted?</p>
                <p>You are experiencing expected behavior of the kill ring. You can undo everything the normal way you undo any text operation using <code class="verbatim">s-z</code>.</p>
                <p>To avoid this behavior, you need to use <code class="verbatim">backspace</code> or <code class="verbatim">delete</code> alone (erasing a character at a time). I'll cover killing later.</p></li>
        </ol>
        <h3 id="speeding-up-wkeybindings">Speeding Up w/Keybindings</h3>
        <p>If during the next chapter you find yourself limited by using the menu for doing things, notice that in the menu there are keybindings printed next to nearly every command available in there. Try using some of the keybindings for your most frequently used commands (like <code class="verbatim">Eval Defun</code> or <code class="verbatim">Compile Defun</code>).</p>
        <h1 id="lisp-setup-use"><span class="todo TODO">TODO</span> LISP SETUP &amp; USE</h1>
        <h2 id="installing-lisp">INSTALLING LISP</h2>
        <h2 id="98f70bfb-8dcf-4f46-a62c-22a7902fc082">SURVIVAL LISP COMMANDS</h2>
        <p>Beyond simple file/buffer operations and text editing are Common Lisp-specific concepts and commands. This chapter will quickly run through the essentials for getting started.</p>
        <h3 id="5eb9bcc7-4b1c-4cb1-8d8e-84ed1c21d33b">Compiling/Evaluating Lisp Code From the Buffer</h3>
        <ol class="incremental">
            <li><p>Form</p>
                <p>To <em>compile</em> a form, place the cursor anywhere in a form then in the menu navigate to <code class="verbatim">Sly-&gt;Compilation-&gt;Compile Defun</code>. This works for other forms, not just <code class="verbatim">defun</code> (which we'll learn about later).</p>
                <p>To <em>evaluate</em> the form place the cursor anywhere in the form then navigate to <code class="verbatim">Sly-&gt;Evaluation-&gt;Eval Defun</code>.</p></li>
            <li><p>Variable</p>
                <p>If a global variable is set, you can get the value of the variable anywhere it is in a Lisp file.</p>
                <p>Set the cursor at the end of the variable then navigate to <code class="verbatim">Sly-&gt;Evaluation-&gt;Eval last expression</code>. This works for individual symbols and other forms, too.</p></li>
            <li><p>File</p>
                <p>To compile a whole file, navigate to <code class="verbatim">Sly-&gt;Compilation-&gt;Compile and Load File</code>.</p></li>
        </ol>
        <h3 id="3efaaf72-dad8-4bce-8bb2-47fda30721f8">Lisp Images</h3>
        <p>An important concept that has deep implications for Lisp development is the Lisp Image.</p>
        <p>When you first open a Common Lisp file in Emacs, a new REPL session and Lisp image is created. Code is then loaded, compiled, and executed in the image. It is sometimes likened to an operating system.</p>
        <p>Some operations that you perform will modify image-level settings. We will see some examples later.</p>
        <p>An image can be saved and restored. We'll learn how to do that at the appropriate time.</p>
        <h3 id="6f07c1b5-ac09-4782-8edb-4eef691e12e6">Using the REPL</h3>
        <p>Since a REPL was opened when you opened a Common Lisp file, you <em>can</em> switch to it using the standard menu navigation for switching buffers. However, the entire window will be taken up with the REPL, which may not be what you want.</p>
        <p>If you would like a REPL opened in a <em>minibuffer</em> under your Lisp buffer, then do the following: With a Lisp file open and the cursor in the buffer, type <code class="verbatim">SPC m '</code>. A Lisp REPL will be opened. The REPL/image is "attached" to the Emacs instance. If you open a different Lisp file and compile the code, it will be loaded into the same image.</p>
        <h3 id="799621d9-3d9a-4357-a73d-28e360e8c666">Structural Editing</h3>
        <p>Editing Lisp code can be tricky at first.</p>
        <p>If you delete a closing-parenthesis, all of the code between and including the opening and closing parentheses will be deleted.</p>
        <p>Deleting an end-quote will do the same.</p>
        <p>This is call "structural editing". It prevents unbalanced parentheses or quotes. However, there are some circumstances where it actually makes it difficult to fix unbalanced parentheses (usually because of copy/pasting code).</p>
        <p>There can be a lot of confusing behavior with structural editing. To turn it off, type <code class="verbatim">M-x lispy-mode</code> to toggle <code class="verbatim">lispy-mode</code> off. With lispy-mode off, you will have more freedom, but less help from the editor. As the spirit moves, you can toggle it on and play around with it. We'll cover some useful features of structural editing later.</p>
        <h3 id="8b7d5226-5cc1-4574-b15b-940fd73738ec">The Lisp Debugger</h3>
        <p>We will take a closer look at the debugger and errors in the chapter on errors and conditions, but before you get to that section you'll probably cause the debugger to open and display a message like this:</p>
        <pre class="example"><code>:AWS fell through ECASE expression.
Wanted one of (:DEVELOPMENT :PRODUCTION).
   [Condition of type SB-KERNEL:CASE-FAILURE]

Restarts:
 0: [RETRY] Retry SLY evaluation request.
 1: [*ABORT] Return to SLY&#39;s top level.
 2: [ABORT] abort thread (#&lt;THREAD tid=11923 &quot;slynk-worker&quot; RUNNING {70071BE463}&gt;)
        </code></pre>
        <p>In this situation, you can do two things:</p>
        <ol class="incremental">
            <li>Navigate the cursor to one of the <code class="verbatim">restarts</code> and press <code class="verbatim">Enter</code>.</li>
            <li>Type the key corresponding to the <code class="verbatim">restart</code> (0 for [RETRY], 1 for [*ABORT], etc.) to select it.</li>
        </ol>
        <p>In the beginning, it's safest to choose whichever restart says <code class="verbatim">[*ABORT]</code>. If your list of restarts is too long, it will be truncated and you might need to highlight and type <code class="verbatim">Enter</code> on a <code class="verbatim">Show More</code> option.</p>
        <p>However, if you want to, you can give Common Lisp's debugger a test drive. If you cause an error, try leaving the debugger open, fixing the bug in your code (make sure to compile it), and then selecting a <code class="verbatim">RETRY</code> restart if one is available. This is one of Common Lisp's most powerful <strong>built-in</strong> features.</p>
        <h1 id="ab3d328c-1cdc-4481-8343-09a75b58be8d">LISP FUNDAMENTALS</h1>
        <h2 id="004660ef-c278-4f86-a9f9-e01ebcf6262f">SYNTAX &amp; GRAMMAR</h2>
        <h3 id="4ea9f9c4-b092-40b9-8a89-60a9af9f8e31">S-expressions</h3>
        <div class="sourceCode" id="cb12" data-org-language="lisp" data-tangle="essentials-basics-code.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(<span class="op">+</span> <span class="dv">3</span> <span class="dv">4</span>)</span></code></pre></div>
        <p>This is a Common Lisp <code class="verbatim">s-expression</code>. S-expressions are made of indivisible units called <code class="verbatim">atoms</code>–such as the <code class="verbatim">symbol</code> <code class="verbatim">+</code> and the number <code class="verbatim">3</code>–and divisible units called <code class="verbatim">lists</code>. They are also called <code class="verbatim">forms</code>.</p>
        <p>Atoms evaluate to themselves.</p>
        <p>The first atom in a list is evaluated as a function name. The rest of the arguments are evaluated before being passed to the function.</p>
        <p>Symbols, other than the first one in a list, are evaluated as variables.</p>
        <p>Some forms have special evaluation rules and are called special forms.</p>
        <h3 id="a27085d1-fb49-40b2-90df-4bfaf7022899">Prefix Notation</h3>
        <p>Math operations in Common Lisp are probably different than what you're used to.</p>
        <p>Common Lisp math operations use <code class="verbatim">prefix notation</code>: the math operator is a function that comes at the beginning of the parenthesis, and all numbers afterward evaluated using that operator, from left to right. In school, we learn math using <code class="verbatim">infix notation</code>, where the operators are placed between each number.</p>
        <div class="sourceCode" id="cb13" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>(<span class="op">+</span> (<span class="op">*</span> <span class="dv">5</span> <span class="dv">5</span> <span class="dv">5</span>) (<span class="op">/</span> <span class="dv">18</span> <span class="dv">2</span>) (<span class="op">-</span> <span class="dv">20</span> <span class="dv">3</span>)) <span class="co">; using infix notation: 5 * 5 * 5 + 18 / 2 + 20 - 3</span></span></code></pre></div>
        <h3 id="b534a372-46e5-4c17-a31f-bc4f17f2ddb2">More complicated s-expression</h3>
        <p>Let's look at a slightly more complicated example of Common Lisp syntax:</p>
        <div class="sourceCode" id="cb14" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> cube </span>(x)</span>
            <span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  (<span class="op">*</span> x x x))</span></code></pre></div>
        <p>After the opening parenthesis comes <code class="verbatim">defun</code>, a built-in <code class="verbatim">special form</code>. Special forms have different evaluation rules compared to regular function calls. <code class="verbatim">defun</code> is used to define a function. The function above is given the name <code class="verbatim">cube</code>. After giving the function a name, we define it's <code class="verbatim">parameters</code>, the data it takes as ~arguments= to run the operations inside the function. The function takes one argument: <code class="verbatim">x</code>.</p>
        <p>Notice that <code class="verbatim">cube</code> isn't evaluated as a variable. The <code class="verbatim">x</code> in <code class="verbatim">(x)</code> isn't initially interpreted as a function to be called.</p>
        <p><code class="verbatim">defun</code> is a special operator where the first argument it receives is a symbol designating the name to give the function, and the second argument is a list of arguments that the function is expected to receive when it's called. The forms that follow afterward are called the <code class="verbatim">body</code> of the function.</p>
        <p>There are several other special forms with their own syntax. We'll cover them later.</p>
        <h3 id="evaluation-rules">Evaluation Rules</h3>
        <h2 id="37b034a2-4ffc-4f51-bc3f-268864072026">SYMBOLS</h2>
        <h3 id="2c9d7af6-8af0-4b0d-8047-f60f26ed61db">Symbol Names</h3>
        <p>Under normal use, symbols in Common Lisp are case-insensitive.</p>
        <div class="sourceCode" id="cb15" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mY-nUm</span>
            <span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>(MY-num)</span></code></pre></div>
        <p>By calling <code class="verbatim">quote</code> or using the reader-macro <code class="verbatim">'</code>, you can return the names of the symbols, rather than evaluating and returning the values of the symbols.</p>
        <div class="sourceCode" id="cb16" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&#39;my-num</span> <span class="co">; =&gt; MY-NUM</span></span></code></pre></div>
        <h3 id="737ed6c2-4292-4a2f-ac8d-2f082cd23eb4">Introducing Global Variables</h3>
        <ol class="incremental">
            <li><p>Variables with no starting value</p>
                <p>If you want to introduce a variable you have a few options.</p>
                <p>Use <code class="verbatim">defvar</code> to introduce a global variable without a value.</p>
                <div class="sourceCode" id="cb17" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defvar</span><span class="fu"> *a-variable-with-no-value*</span>)</span></code></pre></div>
                <p>To change the value of a <code class="verbatim">defvar</code> variable, you need to call <code class="verbatim">setf</code> on the variable.</p></li>
            <li><p>Variables whose value can change</p>
                <p>Use <code class="verbatim">defparameter</code> to introduce a global variable with a starting value that can be modified.</p>
                <div class="sourceCode" id="cb18" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *a-global-var* </span><span class="dt">&#39;hello-world</span>)</span></code></pre></div>
                <p>Global variables defined with <code class="verbatim">defvar</code> and <code class="verbatim">defparameter</code> are surrounded with <code class="verbatim">*</code> by convention.</p></li>
            <li><p>Variables with values that don't change</p>
                <p>Use <code class="verbatim">defconstant</code> to introduce a global variable that has a value that can't be modified.</p>
                <div class="sourceCode" id="cb19" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defconstant</span><span class="fu"> +pi+ </span><span class="fl">3.14</span>)</span></code></pre></div>
                <p>Constant variable names are surrounded with <code class="verbatim">+</code> by convention.</p></li>
            <li><p>Modifying the value of a variable</p>
                <p>You can also use <code class="verbatim">setf</code> to assign values to variables you've already introduced.</p>
                <div class="sourceCode" id="cb20" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> *a-global-var* <span class="dt">&#39;goodnight-world</span>)</span></code></pre></div>
                <p>You have to use <code class="verbatim">setf</code> to modify the value of a <code class="verbatim">defvar</code> variable, but <code class="verbatim">defparameter</code> variable values can be modified with another call to <code class="verbatim">defparameter</code> with a new value for the variable.</p>
                <p>Using <code class="verbatim">setf</code> on a variable that you haven't introduced yet will result in a warning.</p></li>
        </ol>
        <h3 id="39bbde07-13f6-4096-850a-e59044fe55a4">Introducing Local Variables</h3>
        <p>Use <code class="verbatim">let</code> to introduce a local variable. The variable will only exist or contain the set value inside the <code class="verbatim">let</code> form.</p>
        <div class="sourceCode" id="cb21" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((lucky-num <span class="dv">7</span>))</span>
            <span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  lucky-num)</span>
            <span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a> <span class="co">; =&gt; 7 (3 bits, #x7, #o7, #b111)</span></span></code></pre></div>
        <p>You can also reassign a global variable temporarily.</p>
        <div class="sourceCode" id="cb22" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *var* </span><span class="dt">&#39;outside</span>)</span>
            <span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>*var*                   <span class="co">; =&gt; OUTSIDE</span></span>
            <span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((*var* <span class="dt">&#39;inside</span>))   <span class="co">; *var* is reassigned a new value.</span></span>
            <span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  *var*)                <span class="co">; =&gt; INSIDE</span></span>
            <span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>*var*                   <span class="co">; =&gt; OUTSIDE</span></span></code></pre></div>
        <p>When variables have different values depending on their context, it's called <code class="verbatim">lexical scoping</code>. Scoping variables is critical to avoiding bugs.</p>
        <p>There are several other ways to introduce locally-scoped variables. One of them is inside <code class="verbatim">defun</code> definitions.</p>
        <h3 id="36abda06-3041-4b72-82ce-ac28b4d3d603">More than just variables</h3>
        <p>While variables are an important kind of symbol, they aren't the only kind of symbol. Function names, package names, class names, etc. are all symbols. Symbols themselves are a data structure and can hold more than one piece of information.</p>
        <h2 id="b9211b53-cf91-4bee-9b44-1f76a6e4c09f">FUNCTIONS</h2>
        <h3 id="c0f4977c-c531-46a9-bcbd-20184ac3b52c">Defining Named Functions</h3>
        <ol class="incremental">
            <li><p>Globally</p>
                <p>You can define functions with <code class="verbatim">defun</code>:</p>
                <div class="sourceCode" id="cb23" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> sum </span>(x y) <span class="co">; x and y are now locally-scoped variables</span></span>
                    <span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  (<span class="op">+</span> x y))</span></code></pre></div>
                <p>All functions defined with <code class="verbatim">defun</code> are global in scope.</p>
                <div class="sourceCode" id="cb24" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> categorize-food </span>(food)</span>
                    <span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">defun</span><span class="fu"> compile-food-ingredients </span>(food) ...) <span class="co">; This is global, don&#39;t do it!</span></span>
                    <span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  ...)</span></code></pre></div></li>
            <li><p>Locally</p>
                <p>To define locally-scoped named functions, use <code class="verbatim">flet</code> or <code class="verbatim">labels</code>:</p>
                <div class="sourceCode" id="cb25" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> squirt-then-double </span>(x)</span>
                    <span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">flet</span> ((squirt (y)                        <span class="co">; Locally-scoped function named &quot;squirt&quot;.</span></span>
                    <span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>           (<span class="op">*</span> y y)))</span>
                    <span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    (<span class="op">*</span> <span class="dv">2</span> (squirt x))))</span>
                    <span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> squirt-then-double-with-let </span>(x)</span>
                    <span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">flet</span> ((squirt (y)</span>
                    <span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>           (<span class="op">*</span> y y)))</span>
                    <span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> ((squirted (squirt x)))            <span class="co">; Nesting let, flet, etc. is perfectly crumulent.</span></span>
                    <span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>      (<span class="op">*</span> <span class="dv">2</span> squirted))))</span>
                    <span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> squirt-then-double-with-labels </span>(x)</span>
                    <span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">labels</span> ((squirt (y)                      <span class="co">; labels is the equivalent of let* for functions</span></span>
                    <span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>             (<span class="op">*</span> y y))</span>
                    <span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>           (double ()</span>
                    <span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>             (<span class="op">*</span> <span class="dv">2</span> (squirt x))))</span>
                    <span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    (double x)))</span></code></pre></div></li>
        </ol>
        <h3 id="675a3564-992e-4f87-aa26-d80acc9770e8">Lambda List</h3>
        <div class="sourceCode" id="cb26" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> a-fun </span>(a b c))</span></code></pre></div>
        <p>The second parameter to <code class="verbatim">defun</code> is called a <code class="verbatim">lambda list</code>. Parameters for the function being defined are specified inside the lambda list.</p>
        <h3 id="cb8ee017-5343-49f0-8bd2-bf72db92996c">Parameters</h3>
        <ol class="incremental">
            <li><p>required</p>
                <p>Parameters defined without any other options are required.</p>
                <div class="sourceCode" id="cb27" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> my-fun </span>(this-is-required))</span></code></pre></div></li>
            <li><p><code class="verbatim">&amp;optional</code></p>
                <p>You can define different types of parameters with <code class="verbatim">lambda list keywords</code>.</p>
                <p>Define optional parameters with the <code class="verbatim">&amp;optional</code> lambda list keyword.</p>
                <div class="sourceCode" id="cb28" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> fun-with-optional </span>(a &amp;optional b)</span>
                    <span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;The values passed: ~a and ~a.~&amp;&quot;</span> a b))</span>
                    <span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>(fun-with-optional <span class="dv">5</span>) <span class="co">; =&gt; The values passed: 5 and NIL.</span></span></code></pre></div>
                <p>The default value for optional arguments not passed is <code class="verbatim">nil</code>. You can set the default value.</p>
                <div class="sourceCode" id="cb29" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> fun-with-optional </span>(a &amp;optional (b <span class="dv">10</span>))</span>
                    <span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;The values passed: ~a and ~a.~&amp;&quot;</span> a b))</span>
                    <span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>(fun-with-optional <span class="dv">5</span>) <span class="co">; =&gt; The values passed: 5 and 10.</span></span></code></pre></div>
                <p>You can create a predicate that will return whether the value was supplied or the default is being used.</p>
                <div class="sourceCode" id="cb30" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> fun-with-optional </span>(a &amp;optional (b <span class="dv">10</span> b-supplied-p))</span>
                    <span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> b-supplied-p</span>
                    <span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;The values passed: ~a and ~a (passed by user).~&amp;&quot;</span> a b)</span>
                    <span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;The values passed: ~a and ~a (default).~&amp;&quot;</span> a b)))</span>
                    <span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>(fun-with-optional <span class="dv">5</span>) <span class="co">; =&gt; The values passed: 5 and 10 (default).</span></span>
                    <span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>(fun-with-optional <span class="dv">5</span> <span class="dv">10</span>) <span class="co">; =&gt; The values passed: 5 and 10 (passed by user).</span></span></code></pre></div>
                <p>All parameters following the <code class="verbatim">&amp;optional</code> lambda list keyword will be optional. This is true of all lambda list keywords.</p>
                <div class="sourceCode" id="cb31" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> fun-with-lots-of-options </span>(&amp;optional (a <span class="dv">1</span>) (b <span class="dv">2</span>) (c <span class="dv">3</span>))</span>
                    <span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  (<span class="op">+</span> a b c))</span>
                    <span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>(fun-with-lots-of-options)              <span class="co">; =&gt; 6</span></span>
                    <span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>(fun-with-lots-of-options <span class="dv">2</span>)            <span class="co">; =&gt; 7</span></span>
                    <span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>(fun-with-lots-of-options <span class="dv">5</span> <span class="dv">5</span> <span class="dv">5</span>)        <span class="co">; =&gt; 15</span></span></code></pre></div></li>
            <li><p><code class="verbatim">&amp;key</code></p>
                <p>Define named parameters using <code class="verbatim">&amp;key</code>.</p>
                <div class="sourceCode" id="cb32" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> fun-with-keys </span>(&amp;key a b c)</span>
                    <span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  (<span class="op">+</span> a b c))</span>
                    <span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>(fun-with-keys :a <span class="dv">1</span> :b <span class="dv">2</span> :c <span class="dv">3</span>)          <span class="co">; =&gt; 6</span></span></code></pre></div>
                <p>As with <code class="verbatim">&amp;optional</code>, you can specify default values.</p>
                <div class="sourceCode" id="cb33" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> fun-with-keys </span>(&amp;key (a <span class="dv">1</span>) (b <span class="dv">2</span>) (c <span class="dv">3</span>))</span>
                    <span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  (<span class="op">+</span> a b c))</span>
                    <span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>(fun-with-keys)                         <span class="co">; =&gt; 6</span></span>
                    <span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>(fun-with-keys :c <span class="dv">5</span> :b <span class="dv">7</span> :a <span class="dv">3</span>)          <span class="co">; =&gt; 15</span></span></code></pre></div>
                <p><code class="verbatim">-supplied-p</code> predicates can also be specified.</p>
                <div class="sourceCode" id="cb34" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> fun-with-keys </span>(&amp;key (a <span class="dv">1</span> a-supplied-p) (b <span class="dv">2</span> b-supplied-p) (c <span class="dv">3</span> c-supplied-p))</span>
                    <span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a (~a) + ~a (~a) + ~a (~a) = ~a~&amp;&quot;</span> a a-supplied-p b b-supplied-p c c-supplied-p (<span class="op">+</span> a b c)))</span>
                    <span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>(fun-with-keys)</span>
                    <span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; 1 (NIL) + 2 (NIL) + 3 (NIL) = 6</span></span>
                    <span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; NIL</span></span>
                    <span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>(fun-with-keys :c <span class="dv">5</span> :b <span class="dv">7</span> :a <span class="dv">3</span>)</span>
                    <span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; 3 (T) + 7 (T) + 5 (T) = 15</span></span>
                    <span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; NIL</span></span></code></pre></div></li>
            <li><p><code class="verbatim">&amp;rest</code></p>
                <p>Collect arbitrary arguments into a list with <code class="verbatim">&amp;rest</code>.</p>
                <div class="sourceCode" id="cb35" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> fun-with-rest </span>(&amp;<span class="kw">rest</span> args)</span>
                    <span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">loop</span> for arg in args</span>
                    <span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">do</span> (<span class="kw">print</span> arg)))</span>
                    <span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>(fun-with-rest <span class="dt">&#39;a</span>)                      <span class="co">; A  =&gt; NIL</span></span>
                    <span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>(fun-with-rest <span class="dt">&#39;a</span> <span class="dt">&#39;b</span> <span class="dv">5</span> <span class="st">&quot;rest a while&quot;</span>)</span>
                    <span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; A</span></span>
                    <span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; B</span></span>
                    <span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; 5</span></span>
                    <span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; &quot;rest a while&quot;  =&gt; NIL</span></span>
                    <span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> add </span>(&amp;<span class="kw">rest</span> args)</span>
                    <span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">apply</span> <span class="op">#&#39;</span>+ args))</span>
                    <span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>(add <span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>)                         <span class="co">; =&gt; 15</span></span></code></pre></div></li>
            <li><p>Mixing lambda list keywords</p>
                <p>As a general rule, you don't want to mix <code class="verbatim">&amp;optional</code> and <code class="verbatim">&amp;key</code> parameters.</p>
                <div class="sourceCode" id="cb36" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> do-not-mix </span>(&amp;optional (a <span class="dv">1</span>) (b <span class="dv">2</span>) &amp;key (c <span class="dv">3</span>))</span>
                    <span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  (<span class="op">+</span> a b c))</span>
                    <span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>(do-not-mix :c <span class="dv">5</span>)                       <span class="co">; Error: :c is not a number.</span></span>
                    <span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; It&#39;s interpreted as argument a.</span></span></code></pre></div>
                <p>Use one or the other, but not both.</p></li>
        </ol>
        <h3 id="2131bd41-40b7-46e8-80db-07ace0e8c898">Return Values</h3>
        <p>In Common Lisp, the value returned by the last expression called in a form will be the return value.</p>
        <div class="sourceCode" id="cb37" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defvar</span><span class="fu"> *some-var*</span>)</span>
            <span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> do-a-bunch-of-stuff </span>()</span>
            <span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">setf</span> *some-var* <span class="st">&quot;I assigned a value to *some-var*.&quot;</span>)</span>
            <span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((num <span class="dv">5</span>))</span>
            <span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    (squirt-then-double num)</span>
            <span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">random</span> <span class="dv">10</span>)</span>
            <span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;I am the value that this function will return&quot;</span>))</span>
            <span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>(do-a-bunch-of-stuff)</span></code></pre></div>
        <p>There are cases, however, when you might want to do an early return, especially when looping. You can do that with <code class="verbatim">return</code>.</p>
        <h3 id="6dd6ce6d-af28-42a9-ad1b-796c888343a1">Returning Multiple Values</h3>
        <p>It's possible to return multiple values using the <code class="verbatim">values</code> function.</p>
        <div class="sourceCode" id="cb38" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> return-a-bunch-of-stuff </span>()</span>
            <span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">values</span></span>
            <span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>   (<span class="op">+</span> <span class="dv">2</span> <span class="dv">7</span>)</span>
            <span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>   (<span class="op">*</span> <span class="dv">7</span> <span class="dv">7</span>)</span>
            <span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>   (<span class="op">/</span> <span class="dv">100</span> <span class="dv">25</span>)))</span>
            <span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>(return-a-bunch-of-stuff)</span>
            <span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 9, 49, 4</span></span></code></pre></div>
        <h3 id="e208b35a-25c8-46db-bf67-2948c56f2e38">Binding Multiple Values</h3>
        <p>A simple <code class="verbatim">let</code> won't bind all of the values returned by a function that returns multiple values. Instead, only the first value will be bound.</p>
        <div class="sourceCode" id="cb39" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((val (return-a-bunch-of-stuff)))</span>
            <span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  val)</span>
            <span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 9 (4 bits, #x9, #o11, #b1001)</span></span></code></pre></div>
        <p>If you need to bind multiple values, use <code class="verbatim">multiple-value-bind</code>.</p>
        <div class="sourceCode" id="cb40" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">multiple-value-bind</span> (a b c)</span>
            <span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    (return-a-bunch-of-stuff)</span>
            <span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a * ~a * ~a = ~a&quot;</span> a b c (<span class="op">*</span> a b c)))</span>
            <span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; 9 * 49 * 4 = 1764 =&gt; NIL</span></span></code></pre></div>
        <h3 id="breaking-lists-into-multiple-values">Breaking Lists Into Multiple Values</h3>
        <p>Sometimes you might want to take a list and break it into pieces–called destructuring. For that, there's <code class="verbatim">destructuring-bind</code>.</p>
        <div class="sourceCode" id="cb41" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">destructuring-bind</span> (a b c)</span>
            <span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">list</span> <span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>)</span>
            <span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a * ~a * ~a = ~a&quot;</span> a b c (<span class="op">*</span> a b c)))</span>
            <span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; 1 * 2 * 3 = 6 =&gt; NIL</span></span></code></pre></div>
        <p>This destructuring can be done on arbitrarily deep trees of cons cells.</p>
        <div class="sourceCode" id="cb42" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *deep-tree* </span>`(<span class="kw">defun</span><span class="fu"> function-name </span>(a lambda-list)</span>
            <span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">let</span> ((b :some-value))</span>
            <span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                              b)))</span>
            <span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">destructuring-bind</span> (the-defun the-function-name (the-a the-lambda-list)</span>
            <span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                     (the-let ((the-b the-value-bound-to-b))</span>
            <span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                      the-b-at-the-end))</span>
            <span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    *deep-tree*</span>
            <span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  the-value-bound-to-b)</span>
            <span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; :SOME-VALUE</span></span></code></pre></div>
        <h3 id="334ba8ec-bdc6-4342-ad18-e670ef265f98">Pass by Value</h3>
        <p>When a variable is passed to a function, a new, local variable is introduce with the value of the variable passed to the function.</p>
        <div class="sourceCode" id="cb43" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defvar</span><span class="fu"> *some-num* </span><span class="dv">5</span>)</span>
            <span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> add-5 </span>(num) <span class="co">; local variable num is introduced</span></span>
            <span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">setf</span> num (<span class="op">+</span> num <span class="dv">5</span>)))</span>
            <span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">;; num is assigned the value of *some-num*</span></span>
            <span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>(add-5 *some-num*) <span class="co">; =&gt; 10</span></span>
            <span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; add-5 does not modify *some-num*</span></span>
            <span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>*some-num* <span class="co">; =&gt; 5, not 10</span></span></code></pre></div>
        <p>If you want to modify the value of the global variable, you need to use <code class="verbatim">setf</code> on the global variable directly.</p>
        <div class="sourceCode" id="cb44" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> add-5 </span>()</span>
            <span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">setf</span> *some-num* (<span class="op">+</span> *some-num* <span class="dv">5</span>)))</span>
            <span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>(add-5)</span>
            <span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>some-num <span class="co">; =&gt; 10</span></span></code></pre></div>
        <div class="sourceCode" id="cb45" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *names* </span>&#39;(Micah Greg Takae Marcia Ena Mikasa))</span>
            <span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> add-name </span>(name <span class="kw">sequence</span>)</span>
            <span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">setf</span> <span class="kw">sequence</span> (<span class="kw">push</span> name <span class="kw">sequence</span>)))</span>
            <span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>(add-name <span class="dt">&#39;Guy</span> *names*)</span></code></pre></div>
        <h3 id="1ea9a95c-7365-40c8-aa41-a7deb4b2a0af">First-Class Functions</h3>
        <p>Common Lisp functions are first-class. Many of Lisp's functions can take functions as arguments.</p>
        <p>To pass a function as an argument, you have a few options.</p>
        <p>You can use <code class="verbatim">function</code>:</p>
        <div class="sourceCode" id="cb46" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">mapcar</span> (<span class="kw">function</span> squirt-then-double) &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>))</span></code></pre></div>
        <p>Or, more commonly, use the reader macro <code class="verbatim">#'</code>:</p>
        <div class="sourceCode" id="cb47" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">mapcar</span> <span class="op">#&#39;</span>squirt-then-double &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>))</span></code></pre></div>
        <p>Or you can use anonymous functions.</p>
        <h3 id="561d4706-b72b-41c5-851f-497e202f0a80">Anonymous Functions</h3>
        <p>You can use anonymous functions with <code class="verbatim">lambda</code>:</p>
        <div class="sourceCode" id="cb48" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>((<span class="kw">lambda</span> (x) (<span class="op">*</span> x x)) <span class="dv">5</span>) <span class="co">; =&gt; 25</span></span></code></pre></div>
        <p>Lambdas are useful when using functional programming functions like <code class="verbatim">mapcar</code> or <code class="verbatim">remove-if-not</code>.</p>
        <div class="sourceCode" id="cb49" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">mapcar</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (x) (<span class="op">+</span> (<span class="op">*</span> x x) (<span class="op">*</span> x x))) &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>)) <span class="co">; =&gt; (2 8 18 32 50)</span></span></code></pre></div>
        <h2 id="14e3a59e-f2d9-47c7-901f-c94eae40e303">LISTS</h2>
        <h3 id="989dbdc6-7666-43e6-98e9-e3c57531b0c0">In The Beginning Was The Cons</h3>
        <p>Lists are the most flexible and fundamental data structure in Common Lisp.</p>
        <p>The easiest way to make a list is like this:</p>
        <div class="sourceCode" id="cb50" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">list</span> <span class="dt">&#39;this</span> <span class="dt">&#39;is</span> <span class="dt">&#39;a</span> <span class="dt">&#39;list</span>)</span>
            <span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; =&gt; (THIS IS A LIST)</span></span></code></pre></div>
        <p>That list contains four symbols. The more common way to create the above list is to use <code class="verbatim">quote</code>:</p>
        <div class="sourceCode" id="cb51" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">quote</span> (this is a <span class="kw">list</span>))</span>
            <span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; =&gt; (THIS IS A LIST)</span></span></code></pre></div>
        <p>Or, using a reader macro:</p>
        <div class="sourceCode" id="cb52" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>&#39;(this is a <span class="kw">list</span>)</span>
            <span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; =&gt; (THIS IS A LIST)</span></span></code></pre></div>
        <p>If you are experienced in other languages like Python or JavaScript, you might think Lisp's lists are the same as in those languages. However, that isn't the case.</p>
        <p>The more fundamental data structure that lists are built on top of are cons cells. Lisp's lists are <strong>linked lists</strong> of cons cells.</p>
        <div class="sourceCode" id="cb53" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">cons</span> <span class="dt">&#39;this</span> <span class="kw">nil</span>)</span>
            <span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">cons</span> <span class="dt">&#39;this</span> (<span class="kw">cons</span> <span class="dt">&#39;is</span> <span class="kw">nil</span>))</span>
            <span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">cons</span> <span class="dt">&#39;this</span> (<span class="kw">cons</span> <span class="dt">&#39;is</span> (<span class="kw">cons</span> <span class="dt">&#39;a</span> (<span class="kw">cons</span> <span class="dt">&#39;linked</span> (<span class="kw">cons</span> <span class="dt">&#39;list</span> <span class="kw">nil</span>)))))</span></code></pre></div>
        <p>A cons cell has two parts or slots: a <code class="verbatim">car</code> and a <code class="verbatim">cdr</code>. The car contains some data, and the cdr contains either more cons cells or <code class="verbatim">nil</code>. <code class="verbatim">nil</code> terminates the linked list branch.</p>
        <p>More importantly, and maybe confusingly, Common Lisp code is written using these very same cons cells.</p>
        <div class="sourceCode" id="cb54" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parenthesis, then function name &quot;cons&quot;, then data, all establishing a nested linked list.</span></span>
            <span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">cons</span> <span class="dt">&#39;defun</span> (<span class="kw">cons</span> <span class="dt">&#39;sum</span> (<span class="kw">cons</span> (<span class="kw">cons</span> <span class="dt">&#39;x</span> (<span class="kw">cons</span> <span class="dt">&#39;y</span> <span class="kw">nil</span>))</span>
            <span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                              (<span class="kw">cons</span></span>
            <span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                               (<span class="kw">cons</span> <span class="dt">&#39;+</span></span>
            <span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                                (<span class="kw">cons</span> <span class="dt">&#39;x</span> (<span class="kw">cons</span> <span class="dt">&#39;y</span> <span class="kw">nil</span>)))</span>
            <span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                               <span class="kw">nil</span>))))</span>
            <span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parenthesis, then function name &quot;defun&quot;, then data, all establishing a nested linked list.</span></span>
            <span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> sum </span>(x y)</span>
            <span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  (<span class="op">+</span> x y))</span>
            <span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; quoting the &quot;sum&quot; definition returns the same output as the nested cons cells above.</span></span>
            <span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">quote</span></span>
            <span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a> (<span class="kw">defun</span><span class="fu"> sum </span>(x y)</span>
            <span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>   (<span class="op">+</span> x y)))</span>
            <span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="co">;;... which is different from returning a string containing that code.</span></span>
            <span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;(defun sum (x y)</span></span>
            <span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="st">   (+ x y))&quot;</span></span>
            <span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="co">;; How is it different? Because I can evaluate it as code.</span></span>
            <span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eval</span></span>
            <span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a> (<span class="kw">quote</span></span>
            <span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">defun</span><span class="fu"> sum </span>(x y)</span>
            <span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>    (<span class="op">+</span> x y))))</span>
            <span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a><span class="co">;; And I can do the same to the cons cells above</span></span>
            <span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eval</span></span>
            <span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a> (<span class="kw">cons</span> <span class="dt">&#39;defun</span> (<span class="kw">cons</span> <span class="dt">&#39;sum</span> (<span class="kw">cons</span> (<span class="kw">cons</span> <span class="dt">&#39;x</span> (<span class="kw">cons</span> <span class="dt">&#39;y</span> <span class="kw">nil</span>))</span>
            <span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>                               (<span class="kw">cons</span></span>
            <span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>                                (<span class="kw">cons</span> <span class="dt">&#39;+</span></span>
            <span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>                                      (<span class="kw">cons</span> <span class="dt">&#39;x</span> (<span class="kw">cons</span> <span class="dt">&#39;y</span> <span class="kw">nil</span>)))</span>
            <span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>                                <span class="kw">nil</span>)))))</span></code></pre></div>
        <p>The line between "code" and "data" that is clearly drawn in other languages like Python or JavaScript <em>does not exist</em> in Lisp, owing to the fact that code and data both share the same syntax and data structure.</p>
        <h3 id="c093b768-c585-4e68-94e8-c3c34205d533">Basic List Functions</h3>
        <p>Because lists are so fundamental in Lisp, there are many functions for manipulating lists.</p>
        <p>You can determine how many items are in the list:</p>
        <div class="sourceCode" id="cb55" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">length</span> &#39;(Gerald Sussman stole my wife <span class="kw">and</span> kicked my dog that skallywag))</span></code></pre></div>
        <p>You can reverse the order of the elements of the list:</p>
        <div class="sourceCode" id="cb56" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">reverse</span> &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>))</span></code></pre></div>
        <p>You can get items in a list based on their position in the list:</p>
        <div class="sourceCode" id="cb57" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> my-num &#39;(common <span class="kw">lisp</span> is a general purpose multi-paradigm programming language))</span>
            <span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">first</span> my-list)</span>
            <span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">second</span> my-list)</span>
            <span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">ninth</span> my-list)</span>
            <span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">nth</span> <span class="dv">3</span> my-list)</span></code></pre></div>
        <p>You can search for a single item in a list:</p>
        <div class="sourceCode" id="cb58" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">member</span> <span class="dt">&#39;general</span> &#39;(common <span class="kw">lisp</span> is a general purpose multi-paradigm programming language))</span></code></pre></div>
        <p>And you can select individual items by their index:</p>
        <div class="sourceCode" id="cb59" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">nth</span> <span class="dv">4</span> genesis)</span></code></pre></div>
        <p>You can combine two lists:</p>
        <div class="sourceCode" id="cb60" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">append</span> &#39;(this <span class="kw">list</span> is a <span class="kw">list</span>) &#39;(a <span class="kw">list</span>))</span></code></pre></div>
        <h3 id="91685b14-c5af-4382-bd3a-bbb03f7cbeb6">Lists as Trees</h3>
        <p>Lists are a very simple data structure capable of making other data structures. Consider the linked list of cons cells above:</p>
        <div class="sourceCode" id="cb61" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">cons</span> <span class="dt">&#39;defun</span> (<span class="kw">cons</span> <span class="dt">&#39;sum</span> (<span class="kw">cons</span> (<span class="kw">cons</span> <span class="dt">&#39;x</span></span>
            <span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>                                     (<span class="kw">cons</span> <span class="dt">&#39;y</span> <span class="kw">nil</span>))</span>
            <span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>                               (<span class="kw">cons</span></span>
            <span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>                                (<span class="kw">cons</span> <span class="dt">&#39;+</span></span>
            <span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>                                      (<span class="kw">cons</span> <span class="dt">&#39;x</span> (<span class="kw">cons</span> <span class="dt">&#39;y</span> <span class="kw">nil</span>)))</span>
            <span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>                                <span class="kw">nil</span>))))</span></code></pre></div>
        <p>While it is simply a linked list of cons cells, it's useful to think of it another way: a tree. Each cons cell has two parts: a car and a cdr. The car holds a leaf in the tree, whereas the cdr holds either another branch (in the common case) or another leaf. When working with lists as a tree, you can use <code class="verbatim">car</code> and <code class="verbatim">cdr</code> to access those two positions.</p>
        <div class="sourceCode" id="cb62" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setq</span> my-tree (<span class="kw">cons</span> <span class="dt">&#39;defun</span> (<span class="kw">cons</span> <span class="dt">&#39;sum</span> (<span class="kw">cons</span> (<span class="kw">cons</span> <span class="dt">&#39;x</span></span>
            <span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>                                     (<span class="kw">cons</span> <span class="dt">&#39;y</span> <span class="kw">nil</span>))</span>
            <span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>                               (<span class="kw">cons</span></span>
            <span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>                                (<span class="kw">cons</span> <span class="dt">&#39;+</span></span>
            <span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>                                      (<span class="kw">cons</span> <span class="dt">&#39;x</span> (<span class="kw">cons</span> <span class="dt">&#39;y</span> <span class="kw">nil</span>)))</span>
            <span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>                                <span class="kw">nil</span>)))))</span>
            <span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">car</span> my-tree) <span class="co">; =&gt; DEFUN</span></span>
            <span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">cdr</span> my-tree) <span class="co">; =&gt; (SUM (X Y) (+ X Y))</span></span></code></pre></div>
        <p>You can copy a tree:</p>
        <div class="sourceCode" id="cb63" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">copy-tree</span> my-tree)</span></code></pre></div>
        <p>You can substitute leaves in the tree:</p>
        <div class="sourceCode" id="cb64" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Take all instances of y in the tree and replace them with z</span></span>
            <span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">subst</span> <span class="dt">&#39;z</span> <span class="dt">&#39;y</span> my-tree)</span>
            <span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; Substitute multiple leaves in a tree</span></span>
            <span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">sublis</span> &#39;((sum . subtract) (<span class="op">+</span> . <span class="op">-</span>)) my-tree)</span></code></pre></div>
        <h3 id="48045af1-149c-40a5-925a-ce93cd3f9726">Lists as Tables</h3>
        <p><code class="verbatim">sublis</code> takes a special type of list for its first argument: an association list, otherwise known as an alist or table. A table is a list with nested dotted lists–lists that have a non-nil leaf in the cdr position.</p>
        <div class="sourceCode" id="cb65" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> en-to-ja-table &#39;((one . ichi)</span>
            <span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>                       (two . ni)</span>
            <span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>                       (three . san)</span>
            <span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>                       (four . yon)</span>
            <span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>                       (five . <span class="kw">go</span>)))</span></code></pre></div>
        <p>With tables, the car is a key and the cdr is a value. You can search a table by either key or value.</p>
        <div class="sourceCode" id="cb66" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">assoc</span> <span class="dt">&#39;two</span> en-to-ja-table)</span>
            <span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">rassoc</span> <span class="dt">&#39;yon</span> en-to-ja-table)</span></code></pre></div>
        <h3 id="2d0e5228-d70a-4285-a813-e59c1642754e">Lists as Sets</h3>
        <p>Lists can also be treated like sets–an unordered sequence of unique elements.</p>
        <div class="sourceCode" id="cb67" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Append will combine two lists regardless of the contents.</span></span>
            <span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">append</span> &#39;(three two) &#39;(one two three))</span>
            <span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; Adjoin will add a single element to a set, but only if that element doesn&#39;t exist in the set.</span></span>
            <span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">adjoin</span> <span class="dt">&#39;three</span> &#39;(one two three))</span>
            <span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">adjoin</span> <span class="dt">&#39;four</span> &#39;(one two three))</span></code></pre></div>
        <p>Contents of two sets can be compared to form new sets:</p>
        <div class="sourceCode" id="cb68" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *pizza* </span>&#39;(salty sweet cheese sauce <span class="kw">round</span> carbs))</span>
            <span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *cake* </span>&#39;(sweet chocolate brown carbs <span class="kw">round</span>))</span>
            <span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; Return a set of unique elements that are present in both pizza and cake</span></span>
            <span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">intersection</span> *pizza* *cake*)</span>
            <span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (CARBS ROUND SWEET)</span></span>
            <span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Return a set that combines all unique elements of both *pizza* and *cake*</span></span>
            <span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">union</span> *cake* *pizza*)</span>
            <span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (SAUCE CHEESE SALTY SWEET CHOCOLATE BROWN CARBS ROUND)</span></span>
            <span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Return a set that includes all of the elements in *cake* that are not present in *pizza*</span></span>
            <span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">set-difference</span> *cake* *pizza*)</span>
            <span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (BROWN CHOCOLATE)</span></span>
            <span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a><span class="co">;; ... or vise versa</span></span>
            <span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>(<span class="kw">set-difference</span> *pizza* *cake*)</span>
            <span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (SAUCE CHEESE SALTY)</span></span></code></pre></div>
        <p>We can check if a set is a subset of some other set:</p>
        <div class="sourceCode" id="cb69" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *cheese-pizza* </span>&#39;(salty cheese sauce <span class="kw">round</span> carbs))</span>
            <span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">subsetp</span> *cheese-pizza* *pizza*)</span>
            <span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; T</span></span></code></pre></div>
        <h2 id="ad0193d3-d338-410a-910d-2308e750e5df">CONTROL FLOW</h2>
        <h3 id="5089e8d9-a2db-463d-9595-6d31dd1f92a2">True and False</h3>
        <p><code class="verbatim">t</code> is true and <code class="verbatim">nil</code> is false. In the type hierarchy, all data types except for <code class="verbatim">nil</code>–which is the empty list–extend <code class="verbatim">t</code>. That means that every value except for <code class="verbatim">nil</code> or the empty list are true.</p>
        <h3 id="c0f09a81-b221-48cb-b29b-02c97fe6dd3d">Equality &amp; Comparison</h3>
        <p>Common Lisp has a wide array of equality and comparison operators.</p>
        <ol class="incremental">
            <li><p>Math</p>
                <div class="sourceCode" id="cb70" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>(<span class="op">=</span> <span class="dv">1</span> <span class="dv">1</span>)</span>
                    <span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>(<span class="op">/=</span> <span class="dv">1</span> <span class="dv">1</span>)</span>
                    <span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>(<span class="op">&gt;</span> <span class="dv">199</span> <span class="dv">180</span>)</span>
                    <span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>(<span class="op">&gt;=</span> <span class="dv">155</span> <span class="dv">155</span>)</span>
                    <span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>(<span class="op">&lt;</span> <span class="dv">7</span> <span class="dv">19</span>)</span>
                    <span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>(<span class="op">&lt;=</span> <span class="dv">77</span> <span class="dv">77</span>)</span></code></pre></div></li>
            <li><p>General Use</p>
                <p>For symbols, variables, lists, and other objects, you need to use one of <code class="verbatim">eq</code>, <code class="verbatim">eql</code>, <code class="verbatim">equal</code>, or <code class="verbatim">equalp</code>. Each of them tests equality of different degrees. If you come from Python or JavaScript you'll usually expect functionality similar to <code class="verbatim">equal</code> or <code class="verbatim">equalp</code>.</p>
                <p><code class="verbatim">eq</code> will test equality of identity. Do these two objects share the same place in memory?</p>
                <div class="sourceCode" id="cb71" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *deez-nums* </span>&#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>))</span>
                    <span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *your-nums* </span>&#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>))</span>
                    <span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *gods-nums* </span>&#39;(one two three four five))</span>
                    <span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eq</span> *deez-nums* *your-nums*)                <span class="co">; NIL, two different lists.</span></span>
                    <span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eq</span> *deez-nums* *deez-nums*)                <span class="co">; T, same list.</span></span>
                    <span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eq</span> *gods-nums* &#39;(one two three four five)) <span class="co">; NIL</span></span>
                    <span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eq</span> <span class="dt">&#39;one</span> <span class="dt">&#39;one</span>)                              <span class="co">; T, symbols are reused when they are from the same package.</span></span>
                    <span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eq</span> &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>) &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>))              <span class="co">; NIL, two lists are constructed separately.</span></span>
                    <span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eq</span> <span class="ch">#\a</span> <span class="ch">#\a</span>)                                <span class="co">; T</span></span>
                    <span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eq</span> <span class="ch">#\a</span> <span class="ch">#\A</span>)                                <span class="co">; NIL</span></span>
                    <span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eq</span> <span class="st">&quot;hello&quot;</span> <span class="st">&quot;hello&quot;</span>)                        <span class="co">; NIL, strings are arrays of characters and are constructed separately.</span></span>
                    <span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *greeting* </span><span class="st">&quot;Hello, world!&quot;</span>)</span>
                    <span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eq</span> *greeting* *greeting*)                  <span class="co">; T, same array of characters.</span></span></code></pre></div>
                <p><code class="verbatim">eql</code> is the same as <code class="verbatim">eq</code>, except that if the arguments are characters or numbers of the same type then their values are compared.</p>
                <p><code class="verbatim">equal</code> tests structural similarity.</p>
                <div class="sourceCode" id="cb72" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">equal</span> &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>) &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>))               <span class="co">; T</span></span>
                    <span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">equal</span> &#39;(<span class="dv">1</span> <span class="dv">3</span> <span class="dv">2</span>) &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>))               <span class="co">; NIL</span></span>
                    <span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">equal</span> <span class="st">&quot;hello&quot;</span> <span class="st">&quot;hello&quot;</span>)                 <span class="co">; T</span></span>
                    <span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">equal</span> <span class="st">&quot;HELLO&quot;</span> <span class="st">&quot;hello&quot;</span>)                 <span class="co">; NIL</span></span>
                    <span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">equal</span> <span class="dv">1</span> <span class="fl">1.0</span>)                           <span class="co">; NIL, different types</span></span></code></pre></div>
                <p><code class="verbatim">equalp</code> is further lenient:</p>
                <div class="sourceCode" id="cb73" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">equalp</span> <span class="ch">#\a</span> <span class="ch">#\A</span>)                        <span class="co">; T</span></span>
                    <span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">equalp</span> <span class="st">&quot;hello&quot;</span> <span class="st">&quot;HELLO&quot;</span>)                <span class="co">; T, good for case-insensitive testing of characters or strings</span></span>
                    <span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">equalp</span> <span class="dv">1</span> <span class="fl">1.0</span>)                          <span class="co">; T, good for testing numbers across number types</span></span>
                    <span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">equalp</span> &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>) &#39;(<span class="dv">1</span> <span class="dv">3</span> <span class="dv">2</span>))              <span class="co">; NIL</span></span></code></pre></div></li>
            <li><p>Characters &amp; Strings</p>
                <p>Characters and strings have their own equality operators: <code class="verbatim">char-equal</code> and <code class="verbatim">string-equal</code>.</p>
                <div class="sourceCode" id="cb74" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">char-equal</span> <span class="ch">#\a</span> <span class="ch">#\A</span>)                    <span class="co">; T, same as (equalp #\a #\A)</span></span>
                    <span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">string-equal</span> <span class="st">&quot;hello&quot;</span> <span class="st">&quot;HELLO&quot;</span>)          <span class="co">; T, same as (equalp &quot;hello&quot; &quot;HELLO&quot;)</span></span></code></pre></div>
                <p>Additionally, there are tests like <code class="verbatim">char-greaterp</code>, <code class="verbatim">string=</code>, <code class="verbatim">char&lt;</code>, etc.</p>
                <p>For more detail you should look at <a href="https://novaspec.org/cl/f_equal">the Hyperspec</a>.</p></li>
        </ol>
        <h3 id="0d933968-26e8-474a-88c3-773a36b8c285">Logical Operators</h3>
        <ol class="incremental">
            <li><p>~and</p>
                <p><code class="verbatim">and</code> tests if more than two forms are true. The <code class="verbatim">and</code> form returns the value returned by the last form inside it if all forms in it evaluate to <code class="verbatim">t</code>. Otherwise, it returns <code class="verbatim">nil</code>.</p>
                <div class="sourceCode" id="cb75" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">and</span> <span class="dt">&#39;t</span> <span class="dv">5</span>)</span>
                    <span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 5</span></span>
                    <span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">and</span> <span class="dt">&#39;t</span> <span class="dv">5</span> <span class="dt">&#39;hello</span>)</span>
                    <span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; HELLO</span></span>
                    <span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">and</span> <span class="dt">&#39;nil</span> <span class="dv">5</span> <span class="dt">&#39;hello</span>)</span>
                    <span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span></code></pre></div>
                <p><code class="verbatim">and</code> will evaluate all forms inside it.</p></li>
            <li><p><code class="verbatim">or</code></p>
                <p><code class="verbatim">or</code> returns the value of the first form that evaluates to true. If no form passed to it returns a true value, it returns <code class="verbatim">nil</code>.</p>
                <div class="sourceCode" id="cb76" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">or</span> <span class="dv">5</span> <span class="dt">&#39;t</span> <span class="dt">&#39;nil</span> <span class="dt">&#39;hello</span>)</span>
                    <span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 5</span></span>
                    <span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">or</span> <span class="dt">&#39;nil</span> (<span class="op">&gt;</span> <span class="dv">1</span> <span class="dv">5</span>) (<span class="kw">eq</span> <span class="st">&quot;hello&quot;</span> <span class="st">&quot;hello&quot;</span>))</span>
                    <span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span></code></pre></div>
                <p><code class="verbatim">or</code> will stop evaluating forms on the first form that evaluates to true.</p>
                <div class="sourceCode" id="cb77" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">or</span> <span class="dt">&#39;nil</span> (<span class="op">&gt;</span> <span class="dv">5</span> <span class="dv">10</span>) (<span class="kw">eq</span> <span class="st">&quot;hello&quot;</span> <span class="st">&quot;hello&quot;</span>)  <span class="co">; all evaluate to nil</span></span>
                    <span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">print</span> <span class="st">&quot;Evaluated, returns true.&quot;</span>)</span>
                    <span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">print</span> <span class="st">&quot;Not evaluated.&quot;</span>))</span>
                    <span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="co">; &quot;Evaluated, returns true.&quot;  =&gt; &quot;Evaluated, returns true.&quot;</span></span></code></pre></div></li>
            <li><p><code class="verbatim">not</code></p>
                <p><code class="verbatim">not</code> will return <code class="verbatim">t</code> if the inner form returns <code class="verbatim">nil</code>, and <code class="verbatim">nil</code> if that form returns <code class="verbatim">t</code>.</p>
                <div class="sourceCode" id="cb78" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">not</span> (<span class="op">=</span> <span class="dv">1</span> <span class="dv">1</span>))</span>
                    <span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span>
                    <span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">not</span> (<span class="kw">oddp</span> <span class="dv">2</span>))</span>
                    <span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; T</span></span></code></pre></div></li>
        </ol>
        <h3 id="8cd517eb-daab-41c4-997b-9d266a767a7d">Conditional Forms</h3>
        <ol class="incremental">
            <li><p><code class="verbatim">if</code></p>
                <p><code class="verbatim">if</code> is a special operator. It takes a test argument. If the test returns true, the next form is evaluated. If the test returns false, then the form after that is evaluated.</p>
                <div class="sourceCode" id="cb79" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">if</span> (<span class="op">&gt;</span> <span class="dv">10</span> <span class="dv">1</span>)                            <span class="co">; if</span></span>
                    <span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&#39;10-is-greater-than-1</span>               <span class="co">; then branch</span></span>
                    <span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&#39;10-is-not-greater-than-1</span>)          <span class="co">; (optional) else branch</span></span></code></pre></div></li>
            <li><p><code class="verbatim">when</code> &amp; <code class="verbatim">unless</code></p>
                <p>If you don't need a second (else) branch, you can use <code class="verbatim">when</code> or <code class="verbatim">unless</code>:</p>
                <div class="sourceCode" id="cb80" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((num <span class="dv">0</span>))</span>
                    <span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">when</span> (<span class="op">&lt;=</span> <span class="dv">1</span> num <span class="dv">10</span>)</span>
                    <span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;FROM WHEN EXPRESSION: ~a is between 1 and 10&quot;</span> num)</span>
                    <span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">print</span> num)                         <span class="co">; when and unless don&#39;t have an else branch.</span></span>
                    <span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">print</span> (<span class="op">+</span> num num)))                <span class="co">; You can run multiple expressions after the test.</span></span>
                    <span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (<span class="op">&lt;=</span> <span class="dv">1</span> num <span class="dv">10</span>)</span>
                    <span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;FROM UNLESS EXPRESSION: ~a is not between 1 and 10&quot;</span> num)</span>
                    <span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">print</span> num)</span>
                    <span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">print</span> (<span class="op">+</span> num num))))</span></code></pre></div>
                <p><code class="verbatim">(unless test ...)</code> is equivalent to <code class="verbatim">(when (not test) ...)</code>.</p></li>
            <li><p><code class="verbatim">cond</code></p>
                <p><code class="verbatim">cond</code> takes lists of tests and forms to evaluate if the test returns <code class="verbatim">t</code>.</p>
                <div class="sourceCode" id="cb81" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *monster-happiness-meter* </span><span class="dv">39</span>)</span>
                    <span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((mhm *monster-happiness-meter*))</span>
                    <span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
                    <span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    (    <span class="co">; a list to hold a test and forms to evaluate if the test returns true.</span></span>
                    <span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>     (<span class="op">=</span> <span class="dv">0</span> mhm)                                                        <span class="co">; test</span></span>
                    <span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Get this monster lifting weights at the gym, now!&quot;</span>) <span class="co">; More than one form</span></span>
                    <span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>     <span class="dt">&#39;take-monster-to-gym</span>                                            <span class="co">; can be evaluated.</span></span>
                    <span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>     )</span>
                    <span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    ((<span class="op">&lt;</span> <span class="dv">70</span> mhm <span class="dv">89</span>) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;This monster is pretty happy.&quot;</span>) <span class="dt">&#39;hang-out-with-monster</span>)</span>
                    <span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    ((<span class="op">&lt;</span> <span class="dv">50</span> mhm <span class="dv">69</span>) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;This monster is feeling a little down.&quot;</span>) <span class="dt">&#39;invite-monster-to-lunch</span>)</span>
                    <span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>    ((<span class="op">&lt;</span> <span class="dv">30</span> mhm <span class="dv">49</span>) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Get this monster&#39;s mommy on the phone.&quot;</span>) <span class="dt">&#39;call-monsters-mommy</span>)</span>
                    <span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>    ((<span class="op">&lt;</span> <span class="dv">1</span> mhm <span class="dv">29</span>) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Did this monster&#39;s grandma die or something?&quot;</span>) <span class="dt">&#39;console-monster</span>)</span>
                    <span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">t</span> (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;This is the catchall fallback expression.&quot;</span>))))</span>
                    <span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="co">; Get this monster&#39;s mommy on the phone. =&gt; CALL-MONSTERS-MOMMY</span></span></code></pre></div>
                <p><code class="verbatim">cond</code> is a little tricky because of the parentheses.</p>
                <div class="sourceCode" id="cb82" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">cond</span></span>
                    <span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  ((test) (code to run <span class="kw">if</span> test returns true) (more code <span class="kw">if</span> you want))</span>
                    <span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  ((test) (code to run <span class="kw">if</span> test returns true) (more code <span class="kw">if</span> you want))</span>
                    <span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  ((test) (code to run <span class="kw">if</span> test returns true) (more code <span class="kw">if</span> you want))</span>
                    <span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  ((test) (code to run <span class="kw">if</span> test returns true) (more code <span class="kw">if</span> you want)))</span></code></pre></div>
                <p><code class="verbatim">cond</code> will stop evaluating on the first form that returns <code class="verbatim">t</code>.</p></li>
            <li><p><code class="verbatim">case</code></p>
                <p><code class="verbatim">case</code> takes a key expression and then some clauses. It evaluates the clauses in order. If the value of the first item of a clause is <code class="verbatim">eql</code> to the value returned by the key expression, the rest of the items in the clause are evaluated.</p>
                <p><code class="verbatim">case</code> is part of the family of case forms: <code class="verbatim">case</code>, <code class="verbatim">ccase</code>, <code class="verbatim">ecase</code>, <code class="verbatim">typecase</code>, <code class="verbatim">ctypecase</code>, and <code class="verbatim">etypecase</code>. If you know case statements from other languages, you understand the basic idea.</p>
                <p><code class="verbatim">case</code> and <code class="verbatim">typecase</code> do nothing if no match is found. If you want to trigger errors when no match is found (rather than providing an fallback clause), use <code class="verbatim">ecase</code> and <code class="verbatim">etypecase</code>. If you want the option to provide a value for the key expression and continue the program, use <code class="verbatim">ccase</code> and <code class="verbatim">ctypecase</code>.</p>
                <div class="sourceCode" id="cb83" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *env* </span>:DEVELOPMENT)</span>
                    <span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> check-environment </span>()</span>
                    <span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">case</span> *env*</span>
                    <span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    (:DEVELOPMENT <span class="st">&quot;logging all errors&quot;</span>)</span>
                    <span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    (:PRODUCTION <span class="st">&quot;locking in and locking down&quot;</span>)))</span>
                    <span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>(check-environment)</span>
                    <span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;logging all errors&quot;</span></span>
                    <span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((*env* :PRODUCTION))</span>
                    <span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>  (check-environment))</span>
                    <span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;locking in and locking down&quot;</span></span>
                    <span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((*env* :AWS))</span>
                    <span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>  (check-environment))</span>
                    <span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span></code></pre></div>
                <p><code class="verbatim">case</code> will return <code class="verbatim">nil</code> when none of the other cases match. You can set the fallback case using <code class="verbatim">t</code> or <code class="verbatim">otherwise</code>.</p>
                <div class="sourceCode" id="cb84" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> check-environment </span>()</span>
                    <span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">case</span> *env*</span>
                    <span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    (:DEVELOPMENT <span class="st">&quot;logging all errors&quot;</span>)</span>
                    <span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    (:PRODUCTION <span class="st">&quot;locking in and locking down&quot;</span>)</span>
                    <span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">otherwise</span> <span class="st">&quot;you gotta set your *env* to :DEVELOPMENT or :PRODUCTION&quot;</span>)))</span>
                    <span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((*env* :AWS))</span>
                    <span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>  (check-environment))</span>
                    <span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;you gotta set your *env* to :DEVELOPMENT or :PRODUCTION&quot;</span></span></code></pre></div>
                <p>If you want to return an error if the argument falls through all the checks, use <code class="verbatim">ecase</code>.</p>
                <div class="sourceCode" id="cb85" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> check-environment </span>()</span>
                    <span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">ecase</span> *env*</span>
                    <span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    (:DEVELOPMENT <span class="st">&quot;logging all errors&quot;</span>)</span>
                    <span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    (:PRODUCTION <span class="st">&quot;locking in and locking down&quot;</span>)))</span>
                    <span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((*env* :AWS))</span>
                    <span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>  (check-environment))</span>
                    <span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; :AWS fell through ECASE expression.</span></span>
                    <span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Wanted one of (:DEVELOPMENT :PRODUCTION).</span></span>
                    <span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="co">;;    [Condition of type SB-KERNEL:CASE-FAILURE]</span></span>
                    <span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Restarts:</span></span>
                    <span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="co">;;  0: [RETRY] Retry SLY evaluation request.</span></span>
                    <span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a><span class="co">;;  1: [*ABORT] Return to SLY&#39;s top level.</span></span>
                    <span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a><span class="co">;;  2: [ABORT] abort thread (#&lt;THREAD tid=11923 &quot;slynk-worker&quot; RUNNING {70071BE463}&gt;)</span></span></code></pre></div>
                <p>If you want a <em>continuable</em> error, use <code class="verbatim">ccase</code>.</p>
                <div class="sourceCode" id="cb86" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> check-environment </span>()</span>
                    <span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">ccase</span> *env*</span>
                    <span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    (:DEVELOPMENT <span class="st">&quot;logging all errors&quot;</span>)</span>
                    <span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    (:PRODUCTION <span class="st">&quot;locking in and locking down&quot;</span>)))</span>
                    <span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((*env* :AWS))</span>
                    <span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>  (check-environment))</span>
                    <span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; :AWS fell through CCASE expression.</span></span>
                    <span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Wanted one of (:DEVELOPMENT :PRODUCTION).</span></span>
                    <span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="co">;;    [Condition of type SB-KERNEL:CASE-FAILURE]</span></span>
                    <span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Restarts:</span></span>
                    <span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="co">;;  0: [STORE-VALUE] Supply a new value for *ENV*.</span></span>
                    <span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="co">;;  1: [RETRY] Retry SLY evaluation request.</span></span>
                    <span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a><span class="co">;;  2: [*ABORT] Return to SLY&#39;s top level.</span></span>
                    <span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="co">;;  3: [ABORT] abort thread (#&lt;THREAD tid=11955 &quot;slynk-worker&quot; RUNNING {7007B83833}&gt;)</span></span></code></pre></div>
                <p>Notice that now you can store a value in <code class="verbatim">*env*</code>. If you do, it will retry the case check with that value.</p>
                <p>The <code class="verbatim">typecase</code> family works the same, but will check the type of value returned by the key expression.</p>
                <div class="sourceCode" id="cb87" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((x <span class="dv">5</span>))</span>
                    <span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">typecase</span> x</span>
                    <span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">list</span> <span class="dt">&#39;this-is-a-list</span>)</span>
                    <span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">number</span> <span class="dt">&#39;this-is-a-number</span>)</span>
                    <span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">function</span> <span class="dt">&#39;this-is-a-function</span>)</span>
                    <span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">otherwise</span> <span class="dt">&#39;i-dont-know-what-this-is</span>)))</span>
                    <span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; THIS-IS-A-NUMBER</span></span></code></pre></div>
                <p><code class="verbatim">handler-case</code> is another member of the <code class="verbatim">case</code> family that works on conditions and errors.</p></li>
        </ol>
        <h2 id="46c6cbb1-3653-4f4c-9747-30ca59722d14">ITERATION</h2>
        <h3 id="c6c7051f-ae63-4988-90c9-73986b7e78ac">Iterating by Looping</h3>
        <p>Common Lisp has several different ways of iterating. The most popular is the <code class="verbatim">loop</code> macro:</p>
        <div class="sourceCode" id="cb88" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">loop</span> :for item :in &#39;(one two three)</span>
            <span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>      :do (<span class="kw">print</span> item))</span>
            <span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; ONE</span></span>
            <span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; TWO</span></span>
            <span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; THREE  =&gt; NIL</span></span></code></pre></div>
        <p><code class="verbatim">loop</code> is a macro that uses its own syntax. If you come from Python or JavaScript, it doesn't look so strange, but it looks different from typical Lisp code.</p>
        <div class="sourceCode" id="cb89" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">loop</span> :for n :in &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>)</span>
            <span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>      :collect (<span class="op">*</span> <span class="dv">2</span> (<span class="kw">sqrt</span> n)))</span>
            <span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (2.0 2.828427 3.4641016 4.0 4.472136)</span></span></code></pre></div>
        <h3 id="e1e5032b-3489-48d7-bad0-e6172ec5ceaa">Iterating by Mapping</h3>
        <p>You can iterate by using a functional programming style mapping. You've seen it in action already:</p>
        <div class="sourceCode" id="cb90" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">mapcar</span> <span class="op">#&#39;</span>squirt-then-double &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>))</span>
            <span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">mapcar</span> <span class="op">#&#39;</span>first &#39;((<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>) (one two three four five) (what is going on here) (once upon a <span class="kw">time</span>)))</span></code></pre></div>
        <p><a href="https://novaspec.org/cl/f_mapc">There are several varieties of mapping functions</a>. <code class="verbatim">mapcar</code> is the most common. The most general mapping function is <code class="verbatim">map</code>.</p>
        <div class="sourceCode" id="cb91" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Go through each character in the string and upper case it. Return a string</span></span>
            <span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">map</span> <span class="dt">&#39;string</span> <span class="op">#&#39;</span>char-upcase <span class="st">&quot;hello&quot;</span>)</span>
            <span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="co">;; Take an item from each of the lists and multiply them, returning a list. Finishes at the end of the shortest list.</span></span>
            <span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">map</span> <span class="dt">&#39;list</span> <span class="op">#&#39;</span>* &#39;(<span class="dv">2</span> <span class="dv">4</span> <span class="dv">6</span> <span class="dv">8</span>) &#39;(<span class="dv">3</span> <span class="dv">5</span> <span class="dv">7</span> <span class="dv">9</span> <span class="dv">11</span> <span class="dv">13</span> <span class="dv">15</span>) &#39;(<span class="dv">10</span> <span class="dv">10</span> <span class="dv">10</span>))</span></code></pre></div>
        <h3 id="98c2d481-fd9b-41df-8d89-a25daf38b2f0">Iterating by Reducing</h3>
        <p>You can reduce multiple values down to one value by applying some function to successive items in the sequence with <code class="verbatim">reduce</code>.</p>
        <div class="sourceCode" id="cb92" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">reduce</span> <span class="op">#&#39;</span>+ &#39;(<span class="dv">2</span> <span class="dv">2</span> <span class="dv">2</span>))</span>
            <span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">reduce</span> <span class="op">#&#39;</span>* &#39;(<span class="dv">2</span> <span class="dv">2</span> <span class="dv">2</span>))</span>
            <span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">reduce</span> <span class="op">#&#39;</span>append &#39;((<span class="dv">2</span> <span class="dv">2</span> <span class="dv">2</span>) (<span class="dv">3</span> <span class="dv">3</span> <span class="dv">3</span>) (<span class="dv">4</span> <span class="dv">4</span>)))</span>
            <span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
        <p>If you define a function to use for reducing, it needs to take two arguments:</p>
        <div class="sourceCode" id="cb93" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> sum </span>(x y) (<span class="op">+</span> x y))</span>
            <span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">reduce</span> <span class="op">#&#39;</span>sum &#39;(<span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span> <span class="dv">6</span> <span class="dv">7</span>))</span></code></pre></div>
        <h3 id="aba120f5-8cc9-4846-a66a-a95b8837ae2d">Iterating by Filtering</h3>
        <p>You can filter the contents of a sequence with <code class="verbatim">remove-if-not</code>:</p>
        <div class="sourceCode" id="cb94" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">remove-if-not</span> <span class="op">#&#39;</span>oddp &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span> <span class="dv">6</span> <span class="dv">7</span> <span class="dv">8</span> <span class="dv">9</span> <span class="dv">10</span>))</span>
            <span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (1 3 5 7 9)</span></span>
            <span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *dangerous-animals* </span>&#39;(lion tiger bear snake shark))</span>
            <span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> safe-animal-p </span>(animal)</span>
            <span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">not</span> (<span class="kw">member</span> animal *dangerous-animals*)))</span>
            <span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">remove-if-not</span> <span class="op">#&#39;</span>safe-animal-p &#39;(dog cat monkey lion hamster shark snake bear koala frog))</span>
            <span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (DOG CAT MONKEY HAMSTER KOALA FROG)</span></span>
            <span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> greater-than-50-p </span>(num)</span>
            <span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>  (<span class="op">&gt;</span> num <span class="dv">50</span>))</span>
            <span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>(<span class="kw">remove-if-not</span> <span class="op">#&#39;</span>greater-than-50-p &#39;(<span class="dv">40</span> <span class="dv">50</span> <span class="dv">30</span> <span class="dv">90</span> <span class="dv">80</span> <span class="dv">10</span> <span class="dv">70</span> <span class="dv">100</span> <span class="dv">25</span> <span class="dv">60</span> <span class="dv">55</span> <span class="dv">2</span>))</span>
            <span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (90 80 70 100 60 55)</span></span></code></pre></div>
        <p>You can also use <code class="verbatim">remove-if</code>:</p>
        <div class="sourceCode" id="cb95" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> dangerous-animal-p </span>(animal)</span>
            <span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">member</span> animal *dangerous-animals*))</span>
            <span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">remove-if</span> <span class="op">#&#39;</span>dangerous-animal-p &#39;(dog cat monkey lion hamster shark snake bear koala frog))</span>
            <span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (DOG CAT MONKEY HAMSTER KOALA FROG)</span></span></code></pre></div>
        <h3 id="2c10d93c-3447-474f-850a-757e5c149b43">Iterating by Doing</h3>
        <ol class="incremental">
            <li><p><code class="verbatim">dotimes</code></p>
                <div class="sourceCode" id="cb96" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">dotimes</span> (index-var n [result-form])</span>
                    <span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  body)</span></code></pre></div>
                <p><code class="verbatim">dotimes</code> is for doing something a set number of times. Simple enough. It should feel familiar if you've ever done this in JavaScript:</p>
                <div class="sourceCode" id="cb97"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>let i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
                    <span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a> <span class="op">...}</span></span></code></pre></div>
                <p>or this in Python:</p>
                <div class="sourceCode" id="cb98"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
                    <span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    ...</span></code></pre></div>
                <div class="sourceCode" id="cb99" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">dotimes</span> (i <span class="dv">5</span>)</span>
                    <span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (<span class="op">=</span> i <span class="dv">4</span>)</span>
                    <span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">print</span> <span class="st">&quot;I&#39;M NOT CRAZY!!!&quot;</span>)</span>
                    <span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">print</span> <span class="st">&quot;I&#39;m not crazy!&quot;</span>)))</span>
                    <span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let*</span> ((num-list &#39;(<span class="dv">99</span> <span class="dv">98</span> <span class="dv">97</span> <span class="dv">96</span> <span class="dv">95</span>))</span>
                    <span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>       (times (<span class="kw">length</span> num-list)))</span>
                    <span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">dotimes</span> (i times)</span>
                    <span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> ((bottles-of-milk (<span class="kw">nth</span> i num-list)))</span>
                    <span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;~a of bottles of milk on the wall, ~a bottles of milk.&quot;</span> bottles-of-milk bottles-of-milk))))</span></code></pre></div></li>
            <li><p><code class="verbatim">dolist</code></p>
                <div class="sourceCode" id="cb100" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">dolist</span> (index-var <span class="kw">list</span> [result-form])</span>
                    <span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  body)</span></code></pre></div>
                <p><code class="verbatim">dolist</code> is similar. If you're doing simple stuff with lists, this is probably what you want.</p>
                <div class="sourceCode" id="cb101" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">dolist</span> (i &#39;(yet another beautiful short <span class="kw">list</span>))</span>
                    <span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;~a&quot;</span> i))</span>
                    <span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> my-reverse </span>(<span class="kw">list</span>)</span>
                    <span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((reversed <span class="kw">nil</span>))</span>
                    <span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">dolist</span> (i cat reversed)</span>
                    <span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">push</span> (<span class="kw">pop</span> cat) reversed))))</span>
                    <span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> check-all-even </span>(nums)</span>
                    <span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">dolist</span> (i nums <span class="kw">t</span>)</span>
                    <span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Looking at ~a...&quot;</span> i)</span>
                    <span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">when</span> (<span class="kw">oddp</span> i)</span>
                    <span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Ooops, this is odd!&quot;</span>)</span>
                    <span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">return</span> <span class="kw">nil</span>))))</span></code></pre></div>
                <p>The [result-form] is in square brackets because it's optional. If you don't set it, then you need to return the result-form manually.</p>
                <div class="sourceCode" id="cb102" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> my-reverse-manual-return </span>(<span class="kw">list</span>)</span>
                    <span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((reversed <span class="kw">nil</span>))</span>
                    <span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">dolist</span> (i cat)                     <span class="co">; reversed not set as result-form</span></span>
                    <span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">push</span> (<span class="kw">pop</span> cat) reversed))</span>
                    <span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    reversed))                          <span class="co">; reversed manually called at the end of the let block</span></span></code></pre></div>
                <p>Notice the use of <code class="verbatim">push</code> and <code class="verbatim">pop</code> here. They are both destructive functions that modify lists, either by adding or removing items. <code class="verbatim">push</code> puts items at the front of the list, returning the modified list. <code class="verbatim">pop</code> removes the first item and returns that item.</p></li>
            <li><p><code class="verbatim">do</code></p>
                <div class="sourceCode" id="cb103" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">do</span> ((var1 init1 [update1])</span>
                    <span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>     (var2 init2 [update2])</span>
                    <span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>     ...)</span>
                    <span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    (test action-1... action-n) <span class="co">; base case</span></span>
                    <span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a> body)</span></code></pre></div>
                <p><code class="verbatim">do</code> is the most general and powerful of the <code class="verbatim">do</code> family. It is also a bit complicated and difficult to read/understand.</p>
                <div class="sourceCode" id="cb104" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> check-all-even-do </span>(nums)</span>
                    <span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">do</span> ((n nums (<span class="kw">cdr</span> n)))</span>
                    <span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>      ((<span class="kw">null</span> n) (<span class="kw">return</span> <span class="kw">t</span>))</span>
                    <span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Looking at ~a...&quot;</span> (<span class="kw">first</span> n))</span>
                    <span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">when</span> (<span class="kw">oddp</span> (<span class="kw">first</span> n))</span>
                    <span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;~a is odd.&quot;</span> (<span class="kw">first</span> n))</span>
                    <span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">return</span> <span class="kw">nil</span>))))</span>
                    <span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>(check-all-even-do &#39;(<span class="dv">2</span> <span class="dv">4</span> <span class="dv">6</span> <span class="dv">7</span> <span class="dv">8</span> <span class="dv">10</span>))</span></code></pre></div>
                <p>Unlike <code class="verbatim">dotimes</code> and <code class="verbatim">dolist</code>, which take care of incrementing the counter or stepping through the list, <code class="verbatim">do</code> requires you to specify the step/update at the end of each iteration. It also requires you to take care of specifying the base case–the conditions for ending the loop.</p>
                <p><code class="verbatim">do</code> is useful especially for people who are comfortable with iterating recursively because recursion also requires the programmer to specify the stepping function and base case.</p>
                <div class="sourceCode" id="cb105" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> check-all-even-recursive </span>(nums)</span>
                    <span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span> ((<span class="kw">null</span> nums) <span class="kw">t</span>)</span>
                    <span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>        ((<span class="kw">oddp</span> (<span class="kw">car</span> nums)) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;~a is odd!&quot;</span> (<span class="kw">first</span> nums)) <span class="kw">nil</span>)</span>
                    <span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">t</span> (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;~a is even.&quot;</span> (<span class="kw">car</span> nums))</span>
                    <span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>           (check-all-even-recursive (<span class="kw">cdr</span> nums)))))</span>
                    <span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>(check-all-even-recursive &#39;(<span class="dv">2</span> <span class="dv">4</span> <span class="dv">6</span> <span class="dv">7</span> <span class="dv">8</span> <span class="dv">10</span>))</span></code></pre></div>
                <p>The step function is <code class="verbatim">(cdr nums)</code>. Using <code class="verbatim">cdr</code> to step through a list is called "cdring down" the list. The similarities between the recursive method and the <code class="verbatim">do</code> method make it both powerful and often unergonomic. As a reader of code, when you see either a recursive or <code class="verbatim">do</code> iteration, you have to check the step function and base case–something you don't have to do with <code class="verbatim">dotimes</code>, <code class="verbatim">dolist</code>, <code class="verbatim">mapcar</code>, <code class="verbatim">remove-if-not</code>, etc.</p>
                <p>To reiterate, the <code class="verbatim">loop</code> iterator is much more widely used than the <code class="verbatim">do</code> iterators, so if you wish for most other Lispers to understand your code and collaborate with others, you should generally prefer <code class="verbatim">loop</code>.</p>
                <p>If you prefer a more applicative/functional style, then map/filter/reduce is the way to go.</p></li>
        </ol>
        <h3 id="2e3f6dc1-3d81-4a12-b7a5-cef145057982">Early Returns</h3>
        <p>There are times when it's necessary to do an early return. We saw an example with <code class="verbatim">check-all-even</code>:</p>
        <div class="sourceCode" id="cb106" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> check-all-even </span>(nums)</span>
            <span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">dolist</span> (i nums <span class="kw">t</span>)</span>
            <span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Looking at ~a...&quot;</span> i)</span>
            <span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">when</span> (<span class="kw">oddp</span> i)</span>
            <span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Ooops, this is odd!&quot;</span>)</span>
            <span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">return</span> <span class="kw">nil</span>))))</span></code></pre></div>
        <p>The result-form set for <code class="verbatim">dolist</code> is <code class="verbatim">t</code>, meaning that when we get to the end of the list we should return <code class="verbatim">t</code>.</p>
        <p>However, when we spot an odd number, we need to return from the <code class="verbatim">dolist</code> loop early using <code class="verbatim">(return nil)</code>.</p>
        <h3 id="ed4b4a00-b8a6-4c71-9657-7127c213a30a"><code class="verbatim">every</code>, <code class="verbatim">some</code>, <code class="verbatim">notevery</code>, <code class="verbatim">notany</code></h3>
        <p>If you only need to test the sequence, <code class="verbatim">check-all-even</code> could be rewritten using <code class="verbatim">every</code>.</p>
        <div class="sourceCode" id="cb107" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">every</span> <span class="op">#&#39;</span>evenp &#39;(<span class="dv">2</span> <span class="dv">4</span> <span class="dv">6</span> <span class="dv">8</span> <span class="dv">10</span>))</span>
            <span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; T</span></span>
            <span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">every</span> <span class="op">#&#39;</span>evenp &#39;(<span class="dv">1</span> <span class="dv">4</span> <span class="dv">6</span> <span class="dv">8</span> <span class="dv">10</span>))</span>
            <span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span></code></pre></div>
        <p><code class="verbatim">every</code> runs a test on all items of a sequence and returns <code class="verbatim">t</code> if the test returns <code class="verbatim">t</code> for every item.</p>
        <p>Similarly, <code class="verbatim">some</code> tests all items of a sequence, but will return <code class="verbatim">t</code> as soon as the test returns <code class="verbatim">t</code> for an item.</p>
        <div class="sourceCode" id="cb108" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">some</span> <span class="op">#&#39;</span>oddp &#39;(<span class="dv">2</span> <span class="dv">4</span> <span class="dv">6</span> <span class="dv">8</span>))</span>
            <span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span>
            <span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">some</span> <span class="op">#&#39;</span>oddp &#39;(<span class="dv">1</span> <span class="dv">4</span> <span class="dv">6</span> <span class="dv">8</span>))</span>
            <span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; T</span></span></code></pre></div>
        <p><code class="verbatim">notevery</code> runs a test on all items of a sequence and returns <code class="verbatim">t</code> if the test returns <code class="verbatim">nil</code> for every item.</p>
        <div class="sourceCode" id="cb109" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">notevery</span> <span class="op">#&#39;</span>oddp &#39;(<span class="dv">1</span> <span class="dv">3</span> <span class="dv">5</span>))</span>
            <span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span>
            <span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">notevery</span> <span class="op">#&#39;</span>oddp &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">5</span>))</span>
            <span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; T</span></span></code></pre></div>
        <p><code class="verbatim">notany</code> runs a test on all items of a sequence and returns <code class="verbatim">t</code> if the test returns <code class="verbatim">nil</code> for one item.</p>
        <div class="sourceCode" id="cb110" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">notany</span> <span class="op">#&#39;</span>oddp &#39;(<span class="dv">2</span> <span class="dv">4</span> <span class="dv">6</span>))</span>
            <span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; T</span></span>
            <span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">notany</span> <span class="op">#&#39;</span>oddp &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">4</span> <span class="dv">6</span>))</span>
            <span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span></code></pre></div>
        <h2 id="a7c69a9c-1a2f-413d-a171-3faff3f7442a">STRINGS &amp; I/O</h2>
        <h3 id="45101a89-1b09-4069-b8d0-ddaedf98ab10">What are strings?</h3>
        <p>Strings in Common Lisp are ~arrays= of characters. As a result, all operations that can be used on <code class="verbatim">sequences</code> can be used on arrays.</p>
        <h3 id="4c95298f-49a2-4d99-863c-35344fe5370b">Printing Information to REPL</h3>
        <ol class="incremental">
            <li><p><code class="verbatim">print</code></p>
                <p>You can print information in the REPL using <code class="verbatim">print</code>.</p>
                <div class="sourceCode" id="cb111" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">print</span> <span class="st">&quot;hello world&quot;</span>)</span></code></pre></div>
                <p><code class="verbatim">print</code> both sends data to the REPL, but also returns the data as a value. That means you can place <code class="verbatim">print</code> over many different kinds of code, making if useful for simple debugging.</p>
                <div class="sourceCode" id="cb112" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> factorial </span>(x)</span>
                    <span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">labels</span> ((_factorial (n)</span>
                    <span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">cond</span> ((<span class="op">=</span> n <span class="dv">0</span>) <span class="dv">1</span>)</span>
                    <span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>                   (<span class="kw">t</span> (<span class="kw">print</span> (<span class="op">*</span> n (_factorial (<span class="op">-</span> n <span class="dv">1</span>))))))))</span>
                    <span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    (_factorial x)))</span>
                    <span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>(factorial <span class="dv">5</span>)</span>
                    <span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a><span class="co">; 1</span></span>
                    <span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a><span class="co">; 2</span></span>
                    <span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a><span class="co">; 6</span></span>
                    <span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a><span class="co">; 24</span></span>
                    <span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a><span class="co">; 120  =&gt; 120 (7 bits, #x78, #o170, #b1111000)</span></span></code></pre></div></li>
        </ol>
        <h3 id="47ad10e1-cfe4-433a-be58-40580a436691">Using Sequence Operations on Strings</h3>
        <ol class="incremental">
            <li><p><code class="verbatim">concatenate</code></p>
                <p><code class="verbatim">concatenate</code> combines two or more sequences–meaning it can combine lists, vectors, or strings. The first argument specifies the output type.</p>
                <div class="sourceCode" id="cb113" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">concatenate</span> <span class="dt">&#39;list</span> &#39;(<span class="ch">#\h</span> <span class="ch">#\e</span> <span class="ch">#\l</span> <span class="ch">#\l</span> <span class="ch">#\o</span> <span class="ch">#\s</span>pace) &#39;(<span class="ch">#\w</span> <span class="ch">#\o</span> <span class="ch">#\r</span> <span class="ch">#\l</span> <span class="ch">#\d</span>))</span>
                    <span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (#\h #\e #\l #\l #\o #\  #\w #\o #\r #\l #\d)</span></span>
                    <span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">concatenate</span> <span class="dt">&#39;vector</span> &#39;(<span class="ch">#\h</span> <span class="ch">#\e</span> <span class="ch">#\l</span> <span class="ch">#\l</span> <span class="ch">#\o</span> <span class="ch">#\s</span>pace) &#39;(<span class="ch">#\w</span> <span class="ch">#\o</span> <span class="ch">#\r</span> <span class="ch">#\l</span> <span class="ch">#\d</span>))</span>
                    <span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #(#\h #\e #\l #\l #\o #\  #\w #\o #\r #\l #\d)</span></span>
                    <span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">concatenate</span> <span class="dt">&#39;string</span> &#39;(<span class="ch">#\h</span> <span class="ch">#\e</span> <span class="ch">#\l</span> <span class="ch">#\l</span> <span class="ch">#\o</span> <span class="ch">#\s</span>pace) &#39;(<span class="ch">#\w</span> <span class="ch">#\o</span> <span class="ch">#\r</span> <span class="ch">#\l</span> <span class="ch">#\d</span>))</span>
                    <span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;hello world&quot;</span></span>
                    <span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">concatenate</span> <span class="dt">&#39;string</span> <span class="st">&quot;hello &quot;</span> <span class="st">&quot;world&quot;</span>)</span>
                    <span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;hello world&quot;</span></span></code></pre></div></li>
            <li><p><code class="verbatim">length</code></p>
                <p><code class="verbatim">length</code> can tell you the number of characters in a string.</p>
                <div class="sourceCode" id="cb114" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">length</span> <span class="st">&quot;hello world&quot;</span>)</span>
                    <span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 11</span></span></code></pre></div></li>
            <li><p><code class="verbatim">reverse</code></p>
                <p>Just as with lists, <code class="verbatim">reverse</code> can place characters in a string in reverse order.</p>
                <div class="sourceCode" id="cb115" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">reverse</span> <span class="st">&quot;YOU WILL REWRITE THAT THING IN COMMON LISP IMMEDIATELY&quot;</span>)</span>
                    <span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;YLETAIDEMMI PSIL NOMMOC NI GNIHT TAHT ETIRWER LLIW UOY&quot;</span></span></code></pre></div></li>
            <li><p><code class="verbatim">map</code></p>
                <p><code class="verbatim">map</code> is the most general of the mapping functions. If you pass <code class="verbatim">string</code> as the result type, you can run character operations on the string and get back a new string.</p>
                <div class="sourceCode" id="cb116" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">map</span> <span class="dt">&#39;string</span> <span class="op">#&#39;</span>char-upcase <span class="st">&quot;hello&quot;</span>)</span>
                    <span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;HELLO&quot;</span></span></code></pre></div></li>
        </ol>
        <h3 id="46a5d065-3f04-4114-abd0-f4040ef2b286">String Specific Operations</h3>
        <ol class="incremental">
            <li><p>String Modification</p>
                <p>There are also string-specific functions.</p>
                <p>The previous <code class="verbatim">map</code> call can be simplified using <code class="verbatim">string-upcase</code>.</p>
                <div class="sourceCode" id="cb117" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">string-upcase</span> <span class="st">&quot;almighty&quot;</span>)</span>
                    <span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;ALMIGHTY&quot;</span></span></code></pre></div>
                <p>You can probably guess what <code class="verbatim">string-downcase</code> does.</p></li>
            <li><p>String Comparison Operators</p>
                <p><code class="verbatim">string=</code> and <code class="verbatim">string-equal</code> can be used to test if two strings are the same. <code class="verbatim">string=</code> is case-sensitive, <code class="verbatim">string-equal</code> is case-insensitive.</p>
                <div class="sourceCode" id="cb118" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">string=</span> <span class="st">&quot;almighty&quot;</span> <span class="st">&quot;almighty&quot;</span>)</span>
                    <span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; T</span></span>
                    <span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">string=</span> <span class="st">&quot;almighty&quot;</span> <span class="st">&quot;Almighty&quot;</span>)         <span class="co">; case-sensitive</span></span>
                    <span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span>
                    <span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">string-equal</span> <span class="st">&quot;almighty&quot;</span> <span class="st">&quot;ALMIGHTY&quot;</span>)    <span class="co">; case-insensitive</span></span>
                    <span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; T</span></span></code></pre></div>
                <p>There are other string comparison operators: <code class="verbatim">string&gt;</code>, <code class="verbatim">string/=</code>, <code class="verbatim">string-not-greaterp</code>, etc.</p></li>
        </ol>
        <h3 id="ab30e0bf-6abc-42f8-a0d1-cc6cdc96b69d">Streams</h3>
        <p>Streams are either a source or destination for some data. Common Lisp uses streams for reading and writing files, etc.</p>
        <h3 id="e38d3532-76ba-48b2-9424-f8fcce3325ec">Writing Files</h3>
        <p>Use <code class="verbatim">with-open-file</code> to create a block where a streaming connection with some file is active.</p>
        <div class="sourceCode" id="cb119" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">with-open-file</span> (<span class="kw">stream</span> #P<span class="st">&quot;io-test.txt&quot;</span> <span class="bu">:direction</span> <span class="bu">:output</span> :if-exists <span class="bu">:supersede</span> :if-does-not-exist <span class="bu">:create</span>)</span>
            <span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~&amp;Put this in the test file.~&amp;This will be on a new line.~&amp;&quot;</span>))</span></code></pre></div>
        <p><code class="verbatim">with-open-file</code> is a macro providing a shortcut to using the lower-level functions <code class="verbatim">open</code> and <code class="verbatim">close</code> combined with <code class="verbatim">unwind-protect</code>. It ensures that the connection to the file is closed before leaving the block.</p>
        <p>An exhaustive explanation of all the options <code class="verbatim">open</code> and <code class="verbatim">with-open-file</code> can take are in <a href="https://cl-community-spec.github.io/pages/open.html">the Hyperspec</a>. We'll cover the basics here.</p>
        <h3 id="a326ebe6-d1cb-47f0-9b3a-dee2cbce2639">Reading Files</h3>
        <p>If you want to read a file, set <code class="verbatim">:direction</code> to <code class="verbatim">:input</code> and use one of <code class="verbatim">read</code>, <code class="verbatim">read-line</code>, or <code class="verbatim">read-char</code>.</p>
        <div class="sourceCode" id="cb120" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">with-open-file</span> (<span class="kw">stream</span> #P<span class="st">&quot;io-test.txt&quot;</span> <span class="bu">:direction</span> <span class="bu">:input</span> :if-exists <span class="bu">:supersede</span> :if-does-not-exist <span class="bu">:create</span>)</span>
            <span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">loop</span> for line <span class="op">=</span> (<span class="kw">read-line</span> <span class="kw">stream</span> <span class="kw">nil</span> <span class="kw">nil</span>)</span>
            <span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>        while line</span>
            <span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">do</span> (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a~&amp;&quot;</span> line)))</span></code></pre></div>
        <h3 id="4bc8c923-574e-4701-ac44-e5cde1dbdc91">Beyond the Basics w/Files</h3>
        <p>Common Lisp functions for working with file systems, paths, etc. are generally not portable between Lisp implementations. The package <code class="verbatim">UIOP</code> is the defacto-standard source of portable path and filesystem utilities.</p>
        <h3 id="17d4ce69-dae6-496a-8934-17c76be133d2"><code class="verbatim">format</code></h3>
        <ol class="incremental">
            <li><p>Stream Output</p>
                <p><code class="verbatim">format</code> is used to write strings to output streams. The first argument is the stream. If set to <code class="verbatim">t</code>, then it will send the input to <code class="verbatim">*standard-output*</code>, which is output to the REPL.</p>
                <div class="sourceCode" id="cb121" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Almighty Lisp~%&quot;</span>)</span></code></pre></div>
                <p>However, as in the <code class="verbatim">with-open-file</code> examples, you can also use <code class="verbatim">format</code> to write to files, etc.</p></li>
            <li><p>The Almighty Tilde</p>
                <p><code class="verbatim">format</code> has an extensive set of <code class="verbatim">control-string directives</code> used for customizing how text is formatted. All of the directives begin with <code class="verbatim">tilde</code>, such as <code class="verbatim">~a</code>, <code class="verbatim">~&amp;</code>, etc. They also have an extensive set of modifiers. Complex format strings are vaguely similar to regular expressions and tend to get just as hairy.</p>
                <p>I will cover the bare minimum here. Refer to the <a href="https://cl-community-spec.github.io/pages/Formatted-Output.html">Hyperspec</a> to learn all of the directives. I will explain any other directives as necessary.</p>
                <ol class="incremental">
                    <li><p><code class="verbatim">Tilda a</code></p>
                        <p><code class="verbatim">Tilda a</code> will output the data in human readable, "aesthetic" format.</p>
                        <div class="sourceCode" id="cb122" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a&quot;</span> (<span class="kw">aref</span> <span class="st">&quot;hello&quot;</span> <span class="dv">0</span>))</span>
                            <span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; h =&gt; NIL</span></span>
                            <span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; </span><span class="al">NOTE</span><span class="co">: not #\h</span></span></code></pre></div>
                        <p><code class="verbatim">format</code> takes an arbitrary number of arguments after the format string. For each argument, you need to supply another <code class="verbatim">Tilda a</code>.</p>
                        <div class="sourceCode" id="cb123" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *alist* </span>&#39;((:micah <span class="dt">&#39;male</span> <span class="dt">&#39;39</span> <span class="dt">&#39;married</span> <span class="dt">&#39;japan</span>)</span>
                            <span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>                        (:takae <span class="dt">&#39;female</span> <span class="dt">&#39;34</span> <span class="dt">&#39;married</span> <span class="dt">&#39;japan</span>)</span>
                            <span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>                        (:mom <span class="dt">&#39;female</span> <span class="dt">&#39;70</span> <span class="dt">&#39;married</span> <span class="dt">&#39;america</span>)</span>
                            <span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>                        (:papa <span class="dt">&#39;male</span> <span class="dt">&#39;74</span> <span class="dt">&#39;married</span> <span class="dt">&#39;america</span>)))</span>
                            <span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">loop</span> for row in *alist*</span>
                            <span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">do</span> (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;~a: ~a~%&quot;</span> (<span class="kw">first</span> row) (<span class="kw">rest</span> row)))</span>
                            <span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; MICAH: (&#39;MALE &#39;39 &#39;MARRIED &#39;JAPAN)</span></span>
                            <span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; TAKAE: (&#39;FEMALE &#39;34 &#39;MARRIED &#39;JAPAN)</span></span>
                            <span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; MOM:   (&#39;FEMALE &#39;70 &#39;MARRIED &#39;AMERICA)</span></span>
                            <span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; PAPA:  (&#39;MALE &#39;74 &#39;MARRIED &#39;AMERICA)</span></span>
                            <span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; NIL</span></span>
                            <span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">loop</span> for row in *alist*</span>
                            <span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">do</span> (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;=?~%&quot;</span> <span class="st">&quot;~a: ~a ~a ~a ~a&quot;</span> row))</span></code></pre></div></li>
                    <li><p><code class="verbatim">Tilda &amp;</code> and <code class="verbatim">Tilda %</code></p>
                        <p>These directives output newlines. <code class="verbatim">Tilda %</code> will always output a newline. <code class="verbatim">Tilda &amp;</code> will only output a newline if the output stream is not on a newline already.</p></li>
                </ol></li>
            <li><p><span class="todo TODO">TODO</span> Format Directive Cheat Sheet</p>
                <table>
                    <thead>
                        <tr>
                            <th>Directive</th>
                            <th>Description</th>
                            <th>Parameters</th>
                            <th>Colon</th>
                            <th>At-sign</th>
                            <th>Examples</th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>A                            | Prints an argument without escape characters (like princ). Supports mincol for minimum width, full form for padding control. | mincol=0, colinc=1, minpad=0, padchar=space                       | Prints nil as ()                                                                              | Left-justify (pad left)                    | (format nil "~5A" "hi") =&gt; "   hi"; (format nil "~5:@A" "hi") =&gt; "hi   "                                                                                    |                |                     | | ~S                            | Prints an argument with escape characters (like prin1). Same params/modifiers as ~A.                                         | Same as ~A                                                        | Same as ~A                                                                                    | Same as ~A, upcases                        | (format nil "~S" '(1 2)) =&gt; "(1 2)"; (format nil "</code>:@S" '(1 2)) <code class="verbatim">&gt; "(1 2)" (upcased if applicable)                                                          |                |                     | | ~D                            | Prints integer in decimal (base 10). Supports width, padding, commas.                                                        | mincol=0, padchar=0/space, comma</code>,, interval=3</td>
                            <td>No commas</td>
                            <td>Always print sign (+/-)</td>
                            <td>(format nil "<code>:D" 1234) =&gt; "1,234"; (format nil "~@D" -1234) =&gt; "-1234"; (format nil "~12,'0D" 42) =&gt; "0000000042"                                          |                |                     | | ~B                            | Prints integer in binary (base 2). Same as ~D.                                                                               | Same as ~D                                                        | No commas                                                                                     | Always print sign                          | (format nil "~B" 5) =&gt; "101"; (format nil "</code>:B" 5) =&gt; "101"</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>~O</td>
                            <td>Prints integer in octal (base 8). Same as ~D.</td>
                            <td>Same as ~D</td>
                            <td>No commas</td>
                            <td>Always print sign</td>
                            <td>(format nil "~O" 8) =&gt; "10"</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><code>X                            | Prints integer in hex (base 16). Same as ~D; letters A-F.                                                                    | Same as ~D                                                        | No commas                                                                                     | Always print sign, upcase letters          | (format nil "~X" 255) =&gt; "FF"; (format nil "~@X" 255) =&gt; "+FF"                                                                                              |                |                     | | ~R                            | Prints number in words (English cardinal) or radix. No params: words; with radix: like ~D.                                   | radix=10, mincol=0, padchar=0/space, comma=,, interval=3          | Ordinal (e.g., "fourth")                                                                      | Roman numerals (e.g., IV)                  | (format nil "~R" 14) =&gt; "fourteen"; (format nil "</code>:R" 4) =&gt; "fourth"; (format nil "<code>@R" 4) =&gt; "IV"; (format nil "</code>:@R" 1234) =&gt; "MCCXXXIIII"</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><code>P                            | Pluralization: no output, but affects following ~S/~A by backing up arg and adding 's' if arg !=1 (or 0).                    | None                                                              | Back up one arg (for ~R etc.)                                                                 | Use 'ies' instead of 's'                   | (format nil "~D ~P item~P" 1) =&gt; "1 item"; (format nil "~D ~:@P" 2) =&gt; "2 tries"; (format nil "~R file</code>:P" 10) =&gt; "ten files"</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><code>C                            | Prints a character.                                                                                                          | None                                                              | Spell out name (e.g., "Space")                                                                | Reader syntax (#\X)                        | (format nil "~C" #\a) =&gt; "a"; (format nil "</code>:C" #) =&gt; "Space"; (format nil "<code>@C" #\a) =&gt; "#\\a"; (format nil "</code>:@C" (code-char 0)) =&gt; "Control-@"</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><code>F                            | Fixed-point float.                                                                                                           | w=0 (width), d=0 (dec places), k=0 (scale), overflow=#, pad=space | N/A                                                                                           | Always sign (+/-)                          | (format nil "~6,2F" 3.14) =&gt; "  3.14"; (format nil "</code>,4F" 3.14159) =&gt; "3.1416"; (format nil "<code>@F" 3.14) =&gt; "+3.14"                                          |                |                     | | ~E                            | Exponential float (scientific).                                                                                              | w=0, d=0, e=0 (exp digits), k=1, overflow=#, pad=space, expchar=E | N/A                                                                                           | Always sign (+/-)                          | (format nil "~9,2E" 3141.59) =&gt; "  3.14E+03"; (format nil "</code>,4E" 3.14159) =&gt; "3.1416E+00"</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>~G</td>
                            <td>General float: chooses ~F or ~E.</td>
                            <td>w=0, d=0, e=3, k=1, overflow=#, pad=space, expchar=G</td>
                            <td>N/A</td>
                            <td>Always sign</td>
                            <td>(format nil "~G" 0.031) =&gt; "0.031"; (format nil "~4G" 314159) =&gt; "3.142e5"</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>~$</td>
                            <td>Monetary format (like ~F but with $ and 2 decimals).</td>
                            <td>d=2 (dec), n=1 (min whole digits), w=0 (width), pad=space</td>
                            <td>Sign before padding</td>
                            <td>Always sign</td>
                            <td>(format nil "~$" 1234.56) =&gt; "<span class="math inline">$1234.56"; (format nil "~2,4$</span>" 12.34) =&gt; "0012.34"; (format nil "~@$" 1234.56) =&gt; "+$1234.56"</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>~%</td>
                            <td>Unconditional newline(s).</td>
                            <td>reps=1 (newlines)</td>
                            <td>N/A</td>
                            <td>N/A</td>
                            <td>(format nil "~%") =&gt; ""; (format nil "~2%") =&gt; ""</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><code>&amp;                            | Fresh line: newline if not at start of line.                                                                                 | reps=1                                                            | N/A                                                                                           | N/A                                        | (format t "~&amp;Hello") ensures newline before "Hello"                                                                                                         |                |                     | | ~                             |                                                                                                                              | Page separator (formfeed).                                        | reps=1                                                                                        | N/A                                        | N/A                                                                                                                                                         | (format nil "</code></td>
                            <td>") =&gt; formfeed char</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>~~</td>
                            <td>Literal tilde.</td>
                            <td>reps=1</td>
                            <td>N/A</td>
                            <td>N/A</td>
                            <td>(format nil "~~") =&gt; "<code>"; (format nil "~2</code>") =&gt; "~~"</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>~&lt;newline&gt;</td>
                            <td>Ignore newline and following whitespace in format string.</td>
                            <td>None</td>
                            <td>Preserve following whitespace</td>
                            <td>Ignore following whitespace</td>
                            <td>Used for multi-line: ~ text =&gt; "text" (ignores indent)</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>~T</td>
                            <td>Tabulate to column or relative.</td>
                            <td>colnum=0 (absolute col), colinc=1</td>
                            <td>Relative to current position? Wait, CLtL: colon for absolute from left margin in pretty print</td>
                            <td>N/A</td>
                            <td>(format nil "~10Tfoo") =&gt; spaces to col 10 + "foo"; (format nil "~5,2T") =&gt; tab 5, inc 2</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><code>*                            | Argument navigation: skip args.                                                                                              | n=1 (args to skip)                                                | Back up n args                                                                                | Goto nth arg (1-based)                     | (format nil "~*~A" "x" "y") =&gt; "y" (skips x); (format nil "~3:*~A" a b c d) =&gt; "d" (goto 3rd back? Wait, : backs up)                                        |                |                     | | ~?                            | Indirection: insert format string and args.                                                                                  | Takes string arg, then list arg                                   | N/A                                                                                           | Replace with the sub-format                | (format nil "</code>? ~D" "~A is ~D" '("hi" 5) 10) =&gt; "hi is 5 10"</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>~_</td>
                            <td>Pretty-print newline (pprint-newline).</td>
                            <td>None</td>
                            <td>:fill or :mandatory style</td>
                            <td>:miser style</td>
                            <td>Used in ~&lt;…~&gt; for logical blocks</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>~W</td>
                            <td>Write object, respecting print vars (<strong>print-escape</strong> etc.).</td>
                            <td>None</td>
                            <td>Ignore <strong>print-level</strong>, <strong>print-length</strong></td>
                            <td>Pretty-print (with indentation)</td>
                            <td>(format nil "~W" '(1 2 3)) =&gt; "(1 2 3)" (escaped if *print-escape*=t)</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><code>I                            | Indent in pretty printing.                                                                                                   | n=0 (spaces)                                                      | Relative to block start                                                                       | N/A                                        | (format nil "~2I~A~I" "text") indents "text" by 2                                                                                                           |                |                     | | ~(~str</code>)</td>
                            <td>Case conversion on enclosed output.</td>
                            <td>None</td>
                            <td>Capitalize each word</td>
                            <td>Capitalize first word</td>
                            <td>(format nil "<code>(~A</code>)" "hello WORLD") <code class="verbatim">&gt; "hello world"; (format nil "~:(~A~)" "hello") =&gt; "Hello"; (format nil "~@(~A~)" "hello") =&gt; "HELLO"                  |                |                     | | ~[str0~;str1~;...~:;default~] | Conditional: select clause by arg (0=true first, etc.).                                                                      | None (clauses separated by ;)                                     | Use ~:; for default if arg &gt;</code> #clauses</td>
                            <td>If arg non-nil, do body; else skip</td>
                            <td>(format nil "<code>[zero</code>;one~;~:;many~]" 0) =&gt; "zero"; (format nil "<code>[FAIL</code>;PASS~]" nil) =&gt; "FAIL"; (format nil "<code>@[~A~]" t "ok") =&gt; "ok"                       |                |                     | | ~{str</code>}</td>
                        </tr>
                        <tr>
                            <td>~&lt;str~&gt;</td>
                            <td>Justification/block.</td>
                            <td>~/fun/</td>
                            <td>User-defined dispatch to function.</td>
                            <td>params passed to fun</td>
                            <td>Passed as :colon</td>
                            <td>Passed as :at-sign</td>
                            <td>Define (defun my-fun (stream colon at &amp;rest args) …); (format nil "~/my-fun/ ~D" 42) calls it</td>
                        </tr>
                        <tr>
                            <td>~^</td>
                            <td>Termination condition: exit loop if no args or test fails.</td>
                            <td>n=1 (args left), n1=0,n2=1,n3=2 (for ~[)</td>
                            <td>N/A</td>
                            <td>N/A</td>
                            <td>(format nil "~{~A~^, ~}" '(1 2 3)) =&gt; "1, 2, 3" (stops on no args); Used in ~{ to avoid trailing comma</td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
                <ol class="incremental">
                    <li><p><code class="verbatim">TILDE D</code></p>
                        <div class="sourceCode" id="cb124" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> format-money </span>(<span class="kw">stream</span> (this us-dollar))</span>
                            <span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((total-cents (amount this)))</span>
                            <span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span> ((<span class="op">&lt;</span> total-cents <span class="dv">0</span>)</span>
                            <span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">let*</span> ((total-cents (<span class="op">-</span> total-cents))</span>
                            <span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>                  (dollars (<span class="kw">floor</span> total-cents <span class="dv">100</span>))</span>
                            <span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>                  (cents (<span class="kw">mod</span> total-cents <span class="dv">100</span>)))</span>
                            <span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;-~a~:D.~2,&#39;0D&quot;</span> (currency-sign this) dollars cents)))</span>
                            <span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">t</span></span>
                            <span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">let</span> ((dollars (<span class="kw">floor</span> total-cents <span class="dv">100</span>))</span>
                            <span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>                 (cents (<span class="kw">mod</span> total-cents <span class="dv">100</span>)))</span>
                            <span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a~:D.~2,&#39;0D&quot;</span> (currency-sign this) dollars cents))))))</span></code></pre></div>
                        <p>For small, negative values of <code class="verbatim">total-cents</code>, <code class="verbatim">floor</code> will be inaccurate (<code class="verbatim">(floor -5 100)</code> will return <code class="verbatim">-1</code> rather than <code class="verbatim">0</code>), so we make all negative integers positive before formatting them, adding the minus-sign back at the beginning of the format string.</p>
                        <p><code class="verbatim">~2,'0D</code> looks crazy, I know. Format directives can be modified by optional parameters–separated by commas–and by modifiers <code class="verbatim">COLON</code> or <code class="verbatim">AT-SIGN</code>. For <code class="verbatim">TILDE D</code>, we have four possible parameters:</p>
                        <ol class="incremental">
                            <li>mincol</li>
                            <li>padchar</li>
                            <li>comma</li>
                            <li>interval</li>
                        </ol>
                        <p>Let's take a look at them in action:</p>
                        <div class="sourceCode" id="cb125" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((small-num <span class="dv">7</span>)</span>
                            <span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>      (big-num <span class="dv">987654321</span>))</span>
                            <span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~d | ~d&quot;</span>                          <span class="st">&quot;no modifications&quot;</span>                  small-num big-num)</span>
                            <span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4d | ~4d&quot;</span>                        <span class="st">&quot;mincol of 4&quot;</span>                       small-num big-num)</span>
                            <span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4,&#39;xd | ~4,&#39;xd&quot;</span>                  <span class="st">&quot;mincol padding using character x&quot;</span>  small-num big-num)</span>
                            <span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4,&#39;x:d | ~4,&#39;x:d&quot;</span>                <span class="st">&quot;colon added&quot;</span>                       small-num big-num)</span>
                            <span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4,&#39;x,&#39;x:d | ~4,&#39;x,&#39;x:d&quot;</span>          <span class="st">&quot;commas replaced with x&quot;</span>            small-num big-num)</span>
                            <span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4,&#39;x,&#39;x,1:d | ~4,&#39;x,&#39;x,1:d&quot;</span>      <span class="st">&quot;comma interval set to 1&quot;</span>           small-num big-num)</span>
                            <span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4,&#39;x@d | ~4,&#39;x,&#39;x,1@d&quot;</span>           <span class="st">&quot;colon replaced with at-sign&quot;</span>       small-num big-num)</span>
                            <span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4,&#39;x@:d | ~4,&#39;x,&#39;x,1@:d&quot;</span>         <span class="st">&quot;at-sign and colon combined&quot;</span>        small-num big-num))</span></code></pre></div>
                        <p>Returns:</p>
                        <pre class="example"><code>no modifications                         | 7 | 987654321
mincol of 4                              |    7 | 987654321
mincol padding using character x         | xxx7 | 987654321
colon added                              | xxx7 | 987,654,321
commas replaced with x                   | xxx7 | 987x654x321
comma interval set to 1                  | xxx7 | 9x8x7x6x5x4x3x2x1
colon replaced with at-sign              | xx+7 | +987654321
at-sign and colon combined               | xx+7 | +9x8x7x6x5x4x3x2x1 =&gt; NIL
                        </code></pre>
                        <p>It should be a bit easier now to understand the format string for <code class="verbatim">format-money</code>: <code class="verbatim">~a</code>, just display the <code class="verbatim">currency-sign</code>. <code class="verbatim">~:D</code>, add commas to dollars side where appropriate. <code class="verbatim">.</code>, we add the dot. <code class="verbatim">~2,'0D</code>, set the <code class="verbatim">mincol</code> to 2 and pad empty space with 0s. This ensures that <code class="verbatim">(usd 5)</code> returns <code class="verbatim">$0.05</code> and not <code class="verbatim">$0.5</code>.</p></li>
                </ol></li>
        </ol>
        <h2 id="95fcc2cf-6a48-4974-816a-f16253b18852"><span class="todo TODO">TODO</span> <code class="verbatim">CRAPS</code></h2>
        <p>This how-to guide comes from <a href="https://www.cs.cmu.edu/afs/cs.cmu.edu/user/dst/www/LispBook/index.html">Common Lisp: A Gentle Introduction to Symbolic Computation</a>.</p>
        <p>In this how-to guide I will show you how to build a casino game called craps. Here are the rules:</p>
        <ul class="incremental">
            <li>The game is played by throwing two dice.</li>
            <li>When the player throws the dice, the player wins instantly if he rolls a 7 or 11.</li>
            <li>He loses instantly if he rolls 2, 3, or 12.</li>
            <li>If the player rolls any other number, it becomes his "point".</li>
            <li>He wins the game if he rolls the "point" again.</li>
            <li>He loses if he rolls a 7.</li>
        </ul>
        <h3 id="f9c6e89f-bb0c-4ae6-8438-22acfb51346c">Step 1: Make Dice</h3>
        <p>Let's start by defining a dice roll.</p>
        <div class="sourceCode" id="cb127" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> roll-die </span>()</span>
            <span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  (<span class="op">+</span> <span class="dv">1</span> (<span class="kw">random</span> <span class="dv">6</span>)))</span></code></pre></div>
        <p>Random numbers are generated with the function <code class="verbatim">random</code>. The argument <code class="verbatim">5</code> here is the upper limit. The lower limit is 0 and it can't be set with <code class="verbatim">random</code>, so <code class="verbatim">(random 6)</code> generates a number between 0 and 5. We add 1 to the result of <code class="verbatim">(random 6)</code> to get a random number between 1 and 6.</p>
        <p>To play craps, we need to roll two dice at a time. That's easy:</p>
        <div class="sourceCode" id="cb128" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> roll-dice </span>()</span>
            <span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">list</span> (roll-die) (roll-die)))</span></code></pre></div>
        <p>This list with two numbers is a <code class="verbatim">dice</code>, our data structure that we can pass around and work with.</p>
        <h3 id="45b393d8-617b-4baf-a416-d69624c10b54">Step 2: Defining Win and Lose Conditions</h3>
        <p>Now we need to determine of the value of a dice roll is one of the instant win or instant loss values. To reiterate, an instant win occurs when the player rolls a 7 or 11. In other words, the combined value of the two dice must be either 7 or 11. For an instant loss, the combined value must be either 2, 3, or 12.</p>
        <div class="sourceCode" id="cb129" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> instant-win-p </span>(dice)</span>
            <span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">or</span> (<span class="op">=</span> <span class="dv">7</span> (<span class="kw">reduce</span> <span class="op">#&#39;</span>+ dice))</span>
            <span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>      (<span class="op">=</span> <span class="dv">11</span> (<span class="kw">reduce</span> <span class="op">#&#39;</span>+ dice))))</span>
            <span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> instant-loss-p </span>(dice)</span>
            <span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">or</span> (<span class="op">=</span> <span class="dv">2</span> (<span class="kw">reduce</span> <span class="op">#&#39;</span>+ dice))</span>
            <span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>      (<span class="op">=</span> <span class="dv">3</span> (<span class="kw">reduce</span> <span class="op">#&#39;</span>+ dice))</span>
            <span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>      (<span class="op">=</span> <span class="dv">12</span> (<span class="kw">reduce</span> <span class="op">#&#39;</span>+ dice))))</span></code></pre></div>
        <p>Functions that return <code class="verbatim">t</code> or <code class="verbatim">nil</code> (or some data that matches the check) are ended with "p" by convention.</p>
        <p>These two functions take a <code class="verbatim">dice</code>, add up their values, and then check if they equal the instant win or instant lose numbers.</p>
        <p>Since we know that a <code class="verbatim">dice</code> only has two values, we could have used <code class="verbatim">first</code> and <code class="verbatim">last</code>, or <code class="verbatim">nth</code>, but <code class="verbatim">reduce</code> is pretty convenient here.</p>
        <p>There's a lot of repetition, though. Let's fix that with <code class="verbatim">let</code>.</p>
        <div class="sourceCode" id="cb130" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> instant-win-p </span>(dice)</span>
            <span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((result (<span class="kw">reduce</span> <span class="op">#&#39;</span>+ dice)))</span>
            <span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">or</span> (<span class="op">=</span> <span class="dv">7</span> result)</span>
            <span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>        (<span class="op">=</span> <span class="dv">11</span> result))))</span>
            <span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> instant-loss-p </span>(dice)</span>
            <span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((result (<span class="kw">reduce</span> <span class="op">#&#39;</span>+ dice)))</span>
            <span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">or</span> (<span class="op">=</span> <span class="dv">2</span> result)</span>
            <span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>        (<span class="op">=</span> <span class="dv">3</span> result)</span>
            <span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>        (<span class="op">=</span> <span class="dv">12</span> result))))</span></code></pre></div>
        <h3 id="1c804b94-6e96-4653-87db-11ed718bd007">Step 3: Play</h3>
        <p>We can "roll" the dice, and we can determine an instant win or loss. Now, let's test them out together.</p>
        <div class="sourceCode" id="cb131" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> play-craps </span>()</span>
            <span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((dice (roll-dice)))</span>
            <span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You rolled ~a and ~a&quot;</span> (<span class="kw">first</span> dice) (<span class="kw">second</span> dice))</span>
            <span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span> ((instant-win-p dice) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You win!&quot;</span>))</span>
            <span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>          ((instant-loss-p dice) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You lose...&quot;</span>)))))</span></code></pre></div>
        <p>This is simple enough. In <code class="verbatim">play-craps</code>, we <code class="verbatim">roll-dice</code>, saving the value to a variable called <code class="verbatim">dice</code>.</p>
        <p><code class="verbatim">format</code> is for printing text to the REPL or other streams. The string between quotes is called a format string. It has a complex grammar for printing and interpolating values. We will cover <code class="verbatim">format</code> in more detail later, but we'll start with the basics here.</p>
        <p><code class="verbatim">&amp;</code> will add a new line if one doesn't already exist. <code class="verbatim">~a</code> will interpolate a value passed to format after the format string. The first call to <code class="verbatim">format</code> has two values after the format string. The first one will be interpolated into the place where the first <code class="verbatim">~a</code> exists. The second value will be interpolated into the next <code class="verbatim">~a</code>.</p>
        <p><code class="verbatim">cond</code> is special operator for executing code based on different conditions. <code class="verbatim">cond</code> is typically used when there are more than two condition checks. The <code class="verbatim">cond</code> block will do each check from top to bottom. It returns the value of the first condition that returns <code class="verbatim">t</code>.</p>
        <p>If the player doesn't instantly win or lose, they need to know what their "point" is. Obviously, they can do the math by looking at the values of the first and second die, but let's just make it convenient for the player.</p>
        <div class="sourceCode" id="cb132" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> play-craps </span>()</span>
            <span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((dice (roll-dice)))</span>
            <span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You rolled ~a and ~a&quot;</span> (<span class="kw">first</span> dice) (<span class="kw">second</span> dice))</span>
            <span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span> ((instant-win-p dice) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You win!&quot;</span>))</span>
            <span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>          ((instant-loss-p dice) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You lose...&quot;</span>))</span>
            <span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">t</span> (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Your point is: ~a&quot;</span> (<span class="kw">reduce</span> <span class="op">#&#39;</span>+ dice))))))</span></code></pre></div>
        <h3 id="45322222-932b-4eea-8473-a19abefde934">Step 4: Continue Rolling for Point</h3>
        <p>We can throw dice and determine an instant win or loss. Now we need to give the player the ability to continue playing and roll for a point.</p>
        <p>To keep things extra simple, we're going to ask the player to do more than just run <code class="verbatim">play-craps</code>. They will need to run one other function, <code class="verbatim">try-for-point</code>, manually inputing their "point" as an argument.</p>
        <div class="sourceCode" id="cb133" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> try-for-point </span>(point)</span>
            <span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((dice (roll-dice))</span>
            <span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>         (roll-point (<span class="kw">reduce</span> <span class="op">#&#39;</span>+ dice)))</span>
            <span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You rolled: ~a&quot;</span> roll-point)</span>
            <span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span> ((<span class="op">=</span> roll-point point) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You win!&quot;</span>))</span>
            <span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>          ((<span class="op">=</span> roll-point <span class="dv">7</span>) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You lose!&quot;</span>))</span>
            <span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">t</span> (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Roll again.&quot;</span>)))))</span></code></pre></div>
        <p>Again, we roll, but since we are going to be using the value of the dice a few times, we can save the points in <code class="verbatim">roll-point</code>. Notice that we use <code class="verbatim">let*</code> because otherwise <code class="verbatim">(reduce #'+ dice)</code> will return an error saying that a variable of <code class="verbatim">dice</code> hasn't been set. In order to use variables defined earlier in the let block, we need to use <code class="verbatim">let*</code>.</p>
        <p>In this version of the game, the player will need to repeatedly run <code class="verbatim">try-for-point</code> manually. We'll take a look at making a bit more ergonomic later.</p>
        <h3 id="900934ac-6f0d-47ee-b522-d3109996c8d7">FULL CODE</h3>
        <div class="sourceCode" id="cb134" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> roll-die </span>()</span>
            <span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  (<span class="op">+</span> <span class="dv">1</span> (<span class="kw">random</span> <span class="dv">6</span>)))</span>
            <span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> roll-dice </span>()</span>
            <span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">list</span> (roll-die) (roll-die)))</span>
            <span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> instant-win-p </span>(dice)</span>
            <span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((result (<span class="kw">reduce</span> <span class="op">#&#39;</span>+ dice)))</span>
            <span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">or</span> (<span class="op">=</span> <span class="dv">7</span> result)</span>
            <span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>        (<span class="op">=</span> <span class="dv">11</span> result))))</span>
            <span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> instant-loss-p </span>(dice)</span>
            <span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((result (<span class="kw">reduce</span> <span class="op">#&#39;</span>+ dice)))</span>
            <span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">or</span> (<span class="op">=</span> <span class="dv">2</span> result)</span>
            <span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>        (<span class="op">=</span> <span class="dv">3</span> result)</span>
            <span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a>        (<span class="op">=</span> <span class="dv">12</span> result))))</span>
            <span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> play-craps </span>()</span>
            <span id="cb134-19"><a href="#cb134-19" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((dice (roll-dice)))</span>
            <span id="cb134-20"><a href="#cb134-20" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You rolled ~a and ~a&quot;</span> (<span class="kw">first</span> dice) (<span class="kw">second</span> dice))</span>
            <span id="cb134-21"><a href="#cb134-21" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span> ((instant-win-p dice) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You win!&quot;</span>))</span>
            <span id="cb134-22"><a href="#cb134-22" aria-hidden="true" tabindex="-1"></a>          ((instant-loss-p dice) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You lose...&quot;</span>))</span>
            <span id="cb134-23"><a href="#cb134-23" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">t</span> (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Your point is: ~a&quot;</span> (<span class="kw">reduce</span> <span class="op">#&#39;</span>+ dice))))))</span>
            <span id="cb134-24"><a href="#cb134-24" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb134-25"><a href="#cb134-25" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> try-for-point </span>(point)</span>
            <span id="cb134-26"><a href="#cb134-26" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((dice (roll-dice))</span>
            <span id="cb134-27"><a href="#cb134-27" aria-hidden="true" tabindex="-1"></a>         (roll-point (<span class="kw">reduce</span> <span class="op">#&#39;</span>+ dice)))</span>
            <span id="cb134-28"><a href="#cb134-28" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You rolled: ~a&quot;</span> roll-point)</span>
            <span id="cb134-29"><a href="#cb134-29" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span> ((<span class="op">=</span> roll-point point) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You win!&quot;</span>))</span>
            <span id="cb134-30"><a href="#cb134-30" aria-hidden="true" tabindex="-1"></a>          ((<span class="op">=</span> roll-point <span class="dv">7</span>) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You lose!&quot;</span>))</span>
            <span id="cb134-31"><a href="#cb134-31" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">t</span> (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Roll again.&quot;</span>)))))</span></code></pre></div>
        <h2 id="2a661e75-a68a-4775-a0a0-010f245e45b5"><span class="todo TODO">TODO</span> <code class="verbatim">TIC-TAC-TOE</code></h2>
        <h3 id="af7b3291-b62d-40c0-beb6-dbd6a1cf3769">Introduction</h3>
        <p>For this project we'll be making a game of tic-tac-toe complete with a computer opponent. Tic-tac-toe is a relatively common coding project. The version we'll be making is by David Touretzky.</p>
        <p>The purpose of this project is to help you get a feel for what editing code is like in Emacs. You'll have a chance to try out structural editing (if you want), and you'll get some practice with tricky forms like <code class="verbatim">let</code> and <code class="verbatim">cond</code> that use an abundance of parentheses.</p>
        <p>Common Lisp code tends to be wider than other languages. This is partially because of the culture of using unabbreviated names, but also because of Lisp's functional programming roots. As a result, Lisp programmers often make smaller abstractions to make code more readable and fit into the line-width limits of the editor. This project will give you some exposure to both the "problem" of wider code and the solutions for it.</p>
        <p>In order to get the most out of this project, you should follow along and actually type out the code in Emacs, rather than copying and pasting.</p>
        <h3 id="42e6535f-522a-4bfa-a8ad-3fb2fc0df951">Tutorial</h3>
        <ol class="incremental">
            <li><p>Choose data representation</p>
                <ol class="incremental">
                    <li><p>code</p>
                        <div class="sourceCode" id="cb135" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp" data-mkdirp="t"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defvar</span><span class="fu"> *board*</span>)</span>
                            <span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> reset-board </span>()</span>
                            <span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">setf</span> *board* (<span class="kw">list</span> <span class="dt">&#39;board</span></span>
                            <span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>                      <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span></span>
                            <span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>                      <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span></span>
                            <span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>                      <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span>)))</span>
                            <span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *player-one* </span><span class="dv">1</span>)</span>
                            <span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *player-two* </span><span class="dv">10</span>)</span></code></pre></div></li>
                    <li><p>explanation</p>
                        <p>The first step in solving a problem–like how to make a tic-tac-toe game–is to decide how we will represent data. The simpler the data representation, the simpler the rest of the code will be; thus, we want to choose the simplest data representation that can solve the problem.</p>
                        <p>Tic-tac-toe works like this:</p>
                        <ul class="incremental">
                            <li>There are two players.</li>
                            <li>Each take turns putting their "piece" on the board–either an X or an O.</li>
                            <li>If either player gets three of their pieces in a row vertically, horizontally, or diagonally, they win.</li>
                            <li>If all spaces are filled without any player winning, it's a draw.</li>
                        </ul>
                        <p>The game is simple, so the data representation can be simple.</p>
                        <p>The board is a flat list of 0's representing empty spaces. <code class="verbatim">board</code> is a filler symbol to make later code more intuitive to understand. We use <code class="verbatim">setf</code> to assign the globally scoped <code class="verbatim">*board*</code> variable to the value <code class="verbatim">'(board 0 0 0 0 0 0 0 0)</code>.</p>
                        <p>We represent player "pieces" as 1 and 10.</p>
                        <p>There are numerous advantages to representing the board as a "flat" list and the players as abstract numbers, rather than directly as the strings "X" and "O".</p>
                        <ul class="incremental">
                            <li>Data access is trivial.</li>
                            <li>Detecting player piece positions is easy.</li>
                            <li>Adding an AI opponent is simple.</li>
                        </ul></li>
                    <li><p>instructions</p>
                        <ul class="incremental">
                            <li>Type the above code into a buffer named <code class="verbatim">tic-tac-toe.lisp</code>.</li>
                            <li>Compile each form individually with <code class="verbatim">Sly-&gt;Compilation-&gt;Compile Defun</code></li>
                            <li>Without typing anything more, practice evaluating the symbols <code class="verbatim">*player-one*</code> and <code class="verbatim">*player-two*</code> with <code class="verbatim">Sly-&gt;Evaluation-&gt;Eval Defun</code>.</li>
                            <li>Type <code class="verbatim">(reset-board)</code> in the buffer and then evaluate that form. What is the value of <code class="verbatim">*board*</code>?</li>
                        </ul></li>
                </ol></li>
            <li><p>Write functions for manipulating data</p>
                <p>Now that we have our data representations settled, we need a way to manipulate it.</p>
                <div class="sourceCode" id="cb136" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> place-piece </span>(board piece <span class="kw">position</span>)</span>
                    <span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">setf</span> (<span class="kw">nth</span> <span class="kw">position</span> board) piece)</span>
                    <span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  board)</span></code></pre></div>
                <p>Using <code class="verbatim">setf</code> with <code class="verbatim">nth</code> here is similar to doing something like <code class="verbatim">var[n] = my-value</code> in other languages. You <code class="verbatim">setf</code> to a <code class="verbatim">place</code>, such as a variable, a hashtable key, list position, array index, etc.</p>
                <p>Here we assign the <code class="verbatim">place</code> in our <code class="verbatim">*board*</code> to the value of <code class="verbatim">piece</code>. The last value returned by the last form evaluated in a function becomes that function's return value. We return the <code class="verbatim">board</code> to be able to show the updated board to the players.</p>
                <p>We also need a way to map positions on the board to all possible winning positions–Touretzky calls them triplets.</p>
                <div class="sourceCode" id="cb137" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *triplets* </span>&#39;((<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>) (<span class="dv">4</span> <span class="dv">5</span> <span class="dv">6</span>) (<span class="dv">7</span> <span class="dv">8</span> <span class="dv">9</span>) <span class="co">; horizontal winning positions</span></span>
                    <span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>                           (<span class="dv">1</span> <span class="dv">4</span> <span class="dv">7</span>) (<span class="dv">2</span> <span class="dv">5</span> <span class="dv">8</span>) (<span class="dv">3</span> <span class="dv">6</span> <span class="dv">9</span>) <span class="co">; vertical winning positions</span></span>
                    <span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>                           (<span class="dv">1</span> <span class="dv">5</span> <span class="dv">9</span>) (<span class="dv">3</span> <span class="dv">5</span> <span class="dv">7</span>)))       <span class="co">; diagonal winning positions</span></span></code></pre></div></li>
            <li><p>Write game logic</p>
                <p>Next, we need a way to calculate the state of those triplets.</p>
                <div class="sourceCode" id="cb138" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> sum-triplet </span>(board triplet)</span>
                    <span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  (<span class="op">+</span> (<span class="kw">nth</span> (<span class="kw">first</span> triplet) board)</span>
                    <span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">nth</span> (<span class="kw">second</span> triplet) board)</span>
                    <span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">nth</span> (<span class="kw">third</span> triplet) board)))</span>
                    <span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> compute-sums </span>(board)</span>
                    <span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">mapcar</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet) (sum-triplet board triplet)) *triplets*))</span></code></pre></div>
                <p><code class="verbatim">mapcar</code> is one of the many functions that takes a function as an argument. <code class="verbatim">mapcar</code> will apply the function to each item in the sequence and collect them into a list, returning the list.</p>
                <p>Let's test it out by placing some pieces manually.</p>
                <div class="sourceCode" id="cb139" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>(place-piece *board* *player-one* <span class="dv">1</span>)</span>
                    <span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (BOARD 1 0 0 0 0 0 0 0 0)</span></span>
                    <span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>(place-piece *board* *player-two* <span class="dv">2</span>)</span>
                    <span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (BOARD 1 10 0 0 0 0 0 0 0)</span></span>
                    <span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>(place-piece *board* *player-one* <span class="dv">5</span>)</span>
                    <span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (BOARD 1 10 0 0 1 0 0 0 0)</span></span>
                    <span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>(place-piece *board* *player-two* <span class="dv">9</span>)</span>
                    <span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (BOARD 1 10 0 0 1 0 0 0 10)</span></span>
                    <span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>(place-piece *board* *player-one* <span class="dv">7</span>)</span>
                    <span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (BOARD 1 10 0 0 1 0 1 0 10)</span></span>
                    <span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>(place-piece *board* *player-two* <span class="dv">3</span>)</span>
                    <span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (BOARD 1 10 10 0 1 0 1 0 10)</span></span>
                    <span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>(place-piece *board* *player-one* <span class="dv">4</span>)</span>
                    <span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (BOARD 1 10 10 1 1 0 1 0 10)</span></span></code></pre></div>
                <p>Now let's test <code class="verbatim">compute-triplet</code>.</p>
                <div class="sourceCode" id="cb140" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>(compute-sums *board*)</span>
                    <span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (21 2 11 3 11 20 12 12)</span></span></code></pre></div>
                <p>We can see now that player one, represented as 1s on the board, occupies all three spaces in a triplet. We have a winner, but our program doesn't know that yet. Let's add win and tie detection.</p>
                <div class="sourceCode" id="cb141" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> winner-p </span>(board)</span>
                    <span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((sums (compute-sums board)))</span>
                    <span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">or</span> (<span class="kw">member</span> (<span class="op">*</span> <span class="dv">3</span> *player-one*) sums)</span>
                    <span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">member</span> (<span class="op">*</span> <span class="dv">3</span> *player-two*) sums))))</span>
                    <span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> tie-p </span>(board)</span>
                    <span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">not</span> (<span class="kw">member</span> <span class="dv">0</span> board)))</span>
                    <span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>(winner-p *board*)</span>
                    <span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (3 11 20 12 12)</span></span>
                    <span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>(tie-p *board*)</span>
                    <span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span></code></pre></div>
                <p><code class="verbatim">member</code> is called a <code class="verbatim">semi-predicate</code>: it searches a sequence like <code class="verbatim">sums</code> for an item like <code class="verbatim">(* 3 *player-one*)</code>. If none is found, it returns <code class="verbatim">nil</code>. If one is found, however, it doesn't return <code class="verbatim">t</code>; it returns a list of the item plus the <code class="verbatim">rest</code> of the list after the item.</p>
                <p>We can add pieces to the board, calculate the state of the board, and detect a winner. If we make an interface for two human players, we can have a game.</p></li>
            <li><p>Representing data to the player</p>
                <p>We need a way to show the board to players using <code class="verbatim">format</code>. Instead of trying to do everything at once, we'll break it down into pieces, starting with converting player pieces from numbers to letters</p>
                <div class="sourceCode" id="cb142" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> convert-to-letter </span>(piece)</span>
                    <span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">ecase</span> piece</span>
                    <span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0</span>  <span class="st">&quot; &quot;</span>)</span>
                    <span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>  <span class="st">&quot;X&quot;</span>)</span>
                    <span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">10</span> <span class="st">&quot;O&quot;</span>)))</span>
                    <span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>(convert-to-letter <span class="dv">1</span>)</span>
                    <span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; X</span></span>
                    <span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>(convert-to-letter <span class="dv">10</span>)</span>
                    <span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; O</span></span>
                    <span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> opponent </span>(piece)</span>
                    <span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (<span class="op">=</span> piece <span class="dv">1</span>)</span>
                    <span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>      <span class="dv">10</span></span>
                    <span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span>))</span></code></pre></div>
                <p>Now let's print a row from the board.</p>
                <div class="sourceCode" id="cb143" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> print-row </span>(x y z)</span>
                    <span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp; ~a | ~a | ~a ~%&quot;</span> (convert-to-letter x) (convert-to-letter y) (convert-to-letter z)))</span></code></pre></div>
                <p>Now let's print the board.</p>
                <div class="sourceCode" id="cb144" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> print-board </span>(board)</span>
                    <span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;&quot;</span>)</span>
                    <span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>  (print-row (<span class="kw">nth</span> <span class="dv">1</span> board) (<span class="kw">nth</span> <span class="dv">2</span> board) (<span class="kw">nth</span> <span class="dv">3</span> board))</span>
                    <span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;-----------&quot;</span>)</span>
                    <span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>  (print-row (<span class="kw">nth</span> <span class="dv">4</span> board) (<span class="kw">nth</span> <span class="dv">5</span> board) (<span class="kw">nth</span> <span class="dv">6</span> board))</span>
                    <span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;-----------&quot;</span>)</span>
                    <span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>  (print-row (<span class="kw">nth</span> <span class="dv">7</span> board) (<span class="kw">nth</span> <span class="dv">8</span> board) (<span class="kw">nth</span> <span class="dv">9</span> board))</span>
                    <span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;=&amp;&quot;</span>))</span>
                    <span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>(print-board *board*)</span>
                    <span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a><span class="co">;  X | O | O</span></span>
                    <span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a><span class="co">; -----------</span></span>
                    <span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a><span class="co">;  X | X |</span></span>
                    <span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a><span class="co">; -----------</span></span>
                    <span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a><span class="co">;  X |   | O</span></span>
                    <span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a><span class="co">;  =&gt; NIL</span></span></code></pre></div>
                <p>Here's where having <code class="verbatim">board</code> as a filler item in the <code class="verbatim">*board*</code> list is useful: the calls to <code class="verbatim">nth</code> here are intuitive to understand.</p></li>
            <li><p>Getting user input</p>
                <p>Now we need to get player input. We need to ensure that our input is well-formed and that the move from the player is legal.</p>
                <div class="sourceCode" id="cb145" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> read-legal-move </span>(piece board)</span>
                    <span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((move (<span class="kw">read</span>)))</span>
                    <span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span> ((<span class="kw">not</span> (<span class="kw">integerp</span> move))                                                    <span class="co">; Condition</span></span>
                    <span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Moves must be a number between 1-9. Your move: ~a~%&quot;</span> move)  <span class="co">; Code to run if condition is true.</span></span>
                    <span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>           (print-board board)                                                      <span class="co">; Multiple forms can be evaluated</span></span>
                    <span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>           (read-legal-move piece board))                                           <span class="co">; after the condition.</span></span>
                    <span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>          ((<span class="kw">not</span> (<span class="kw">and</span> (<span class="op">&gt;=</span> move <span class="dv">1</span>) (<span class="op">&gt;=</span> <span class="dv">9</span> move)))</span>
                    <span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Choose a space between 1 and 9.&quot;</span>)</span>
                    <span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>           (print-board board)</span>
                    <span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>           (read-legal-move piece board))</span>
                    <span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>          ((<span class="op">/=</span> (<span class="kw">nth</span> move board) <span class="dv">0</span>)</span>
                    <span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;You must place a piece on an empty space.&quot;</span>)</span>
                    <span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a>           (print-board board)</span>
                    <span id="cb145-14"><a href="#cb145-14" aria-hidden="true" tabindex="-1"></a>           (read-legal-move piece board))</span>
                    <span id="cb145-15"><a href="#cb145-15" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">t</span> move))))</span></code></pre></div>
                <p>The function <code class="verbatim">read</code> is how we request user input from the REPL. In the <code class="verbatim">cond</code> form–which can look pretty hairy to our new Lisp brothers–we run a few checks. <code class="verbatim">integerp</code> is a <code class="verbatim">predicate</code> function (with names typically ending with <code class="verbatim">p</code> <code class="verbatim">-p</code>) that checks if the user input is an integer. If the player input isn't a number, we tell them we need a number, print the board, and let the player try again.</p>
                <p>The next check makes sure that the number the user inputted was a number between 1 and 9.</p>
                <p>Finally, we need to check that the space chosen by the player is empty.</p>
                <p>If the <code class="verbatim">move</code> passes all the checks, then the <code class="verbatim">cond</code> will evaluate the final form <code class="verbatim">(t move)</code>. This is the conventional way of providing a default branch in the <code class="verbatim">cond</code> if all other conditions return <code class="verbatim">nil</code>. In this instance, we just return <code class="verbatim">move</code>.</p>
                <p>Now we can make a move.</p>
                <div class="sourceCode" id="cb146" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> move </span>(piece board)</span>
                    <span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;It&#39;s ~a&#39;s turn.~%&quot;</span> (convert-to-letter piece))</span>
                    <span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>  (print-board board)</span>
                    <span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((move (read-legal-move piece board))</span>
                    <span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>         (updated-board (place-piece board piece move))</span>
                    <span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>         (winner (winner-p updated-board)))</span>
                    <span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span> (winner</span>
                    <span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a wins!&quot;</span> (convert-to-letter (<span class="op">/</span> (<span class="kw">first</span> winner) <span class="dv">3</span>))))</span>
                    <span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>          ((tie-p updated-board)</span>
                    <span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;It&#39;s a tie!&quot;</span>))</span>
                    <span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">t</span> (move (opponent piece) board)))))</span>
                    <span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> play-game </span>()</span>
                    <span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a>  (reset-board)</span>
                    <span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print</span> <span class="st">&quot;X goes first&quot;</span>)</span>
                    <span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>  (move *player-one* *board*))</span></code></pre></div>
                <p><code class="verbatim">let*</code> is how we bound locally-scoped variables. <code class="verbatim">let*</code>, unlike the regular <code class="verbatim">let</code>, can bind variables to values that were computed earlier in the form. We pass <code class="verbatim">move</code> to <code class="verbatim">place-piece</code> and bind <code class="verbatim">updated-board</code> to the value returned. If we used <code class="verbatim">let</code> instead, we would get an error.</p></li>
            <li><p>Write computer moving logic</p>
                <p>At this point, the human-vs-human version of the game is feature-complete. What we want now is to add a computer opponent.</p>
                <p>At minimum, the computer needs to do the following:</p>
                <ul class="incremental">
                    <li>Choose a strategy
                        <ul class="incremental">
                            <li>If there is a winning move, choose it.</li>
                            <li>If there is a blocking move, choose it.</li>
                            <li>Otherwise, take a random position.</li>
                        </ul></li>
                </ul>
                <ol class="incremental">
                    <li><p>Choose a strategy</p>
                        <div class="sourceCode" id="cb147" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> choose-move </span>(board)</span>
                            <span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">or</span> (make-three-in-a-row board)       <span class="co">; Take the winning move.</span></span>
                            <span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>      (block-opponent-win board)        <span class="co">; Block the opponent.</span></span>
                            <span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>      (take-random-position board)))    <span class="co">; Take a random position.</span></span></code></pre></div>
                        <p><code class="verbatim">or</code> will evaluate its arguments in order. It will stop evaluation on the first argument that returns a non-nil value.</p></li>
                    <li><p>Finding a winning move</p>
                        <p>The computer needs to know if there it has a potential win. There is a potential win if any of the triplets sum to 20.</p>
                        <p>First, let's make a test board.</p>
                        <div class="sourceCode" id="cb148" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *test-board* </span>&#39;(board</span>
                            <span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>                             <span class="dv">10</span> <span class="dv">1</span> <span class="dv">0</span></span>
                            <span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>                             <span class="dv">10</span> <span class="dv">1</span> <span class="dv">0</span></span>
                            <span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>                             <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span>))</span></code></pre></div>
                        <p>What we want to is to find a triplet that sums to 20.</p>
                        <div class="sourceCode" id="cb149" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet) (<span class="op">=</span> <span class="dv">20</span> (sum-triplet *test-board* triplet))) *triplets*)</span>
                            <span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (1 4 7)</span></span></code></pre></div>
                        <p><code class="verbatim">find-if</code> takes a predicate function and returns the first value in a sequence that evaluates to <code class="verbatim">t</code> when the predicate is applied to it. It iterates over <code class="verbatim">*triplets*</code>, and tests if any of the triplets on the board sum up to 20.</p>
                        <p>If we find a triplet with a winning move, we want to return the position on the board to take. That means we need to find the element in the winning triplet that is 0.</p>
                        <div class="sourceCode" id="cb150" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (element) (<span class="op">=</span> <span class="dv">0</span> (<span class="kw">nth</span> element *test-board*)))</span>
                            <span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet) (<span class="op">=</span> <span class="dv">20</span> (sum-triplet *test-board* triplet))) *triplets*))</span>
                            <span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 7 (3 bits, #x7, #o7, #b111)</span></span></code></pre></div>
                        <p>Since we need to do the same thing to check if we need to block…</p>
                        <div class="sourceCode" id="cb151" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (element) (<span class="op">=</span> <span class="dv">0</span> (<span class="kw">nth</span> element *test-board*)))</span>
                            <span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Notice (= 2 ...), not (= 20 ...)</span></span>
                            <span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet) (<span class="op">=</span> <span class="dv">2</span> (sum-triplet *test-board* triplet))) *triplets*))</span>
                            <span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 8 (4 bits, #x8, #o10, #b1000)</span></span></code></pre></div>
                        <p>…we can make this one function.</p>
                        <div class="sourceCode" id="cb152" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> win-or-block </span>(board target-sum)</span>
                            <span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((target-triplet (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet)</span>
                            <span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="co">;; </span><span class="al">NOTE</span><span class="co">: bug left purposefully for teaching purposes</span></span>
                            <span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>                                    (<span class="op">=</span> target-sum (sum-triplet *test-board* triplet)))</span>
                            <span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>                                *triplets*)))</span>
                            <span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> target-triplet</span>
                            <span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (element) (<span class="op">=</span> (<span class="kw">nth</span> element board) <span class="dv">0</span>)) target-triplet))))</span>
                            <span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>(win-or-block *test-board* <span class="dv">2</span>)</span>
                            <span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 8 (4 bits, #x8, #o10, #b1000)</span></span>
                            <span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; This is the space to take if we want to block.</span></span>
                            <span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>(win-or-block *test-board* <span class="dv">20</span>)</span>
                            <span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 7 (3 bits, #x7, #o7, #b111)</span></span>
                            <span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; This is the space to take if we want to win.</span></span></code></pre></div>
                        <div class="aside" title="Reading Lisp Code">
                            <p>Lisp code often needs to be read "inside-out". The nested <code class="verbatim">find-if</code> forms above demonstrate that. The inner <code class="verbatim">find-if</code> returned a triplet from the list of <code class="verbatim">*triplets*</code>, then the outer <code class="verbatim">find-if</code> returned an item from the triplet. This can be confusing if you're not used reading code this way.</p>
                            <p>By first assigning <code class="verbatim">target-triplet</code> to the triplet that sums to <code class="verbatim">target-sum</code>, we reverse the order of the code we read first, making it clearer. It also allows us to check if a <code class="verbatim">target-triplet</code> even exists.</p>
                        </div></li>
                    <li><p>Adding strategies</p>
                        <p>Now that we have a function that can find spaces to either win or block a win, we can call it with the appropriate target-sum in our win and block strategies.</p>
                        <div class="sourceCode" id="cb153" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> make-three-in-a-row </span>(board)</span>
                            <span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((move (win-or-block board (<span class="op">*</span> <span class="dv">2</span> *player-two*))))</span>
                            <span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">when</span> move</span>
                            <span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">list</span> move (<span class="kw">format</span> <span class="kw">nil</span> <span class="st">&quot;~&amp;I see a winning move at ~a.~%&quot;</span> move)))))</span>
                            <span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> block-opponent-win </span>(board)</span>
                            <span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((move (win-or-block board (<span class="op">*</span> <span class="dv">2</span> *player-one*))))</span>
                            <span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">when</span> move</span>
                            <span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">list</span> move (<span class="kw">format</span> <span class="kw">nil</span> <span class="st">&quot;~&amp;Danger! Loss imminent! Moving to block at ~a.~%&quot;</span> move)))))</span>
                            <span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>(print-board *test-board*)</span>
                            <span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  O | X |</span></span>
                            <span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; -----------</span></span>
                            <span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  O | X |</span></span>
                            <span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; -----------</span></span>
                            <span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;    |   |</span></span>
                            <span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; NIL</span></span>
                            <span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>(make-three-in-a-row *test-board*)</span>
                            <span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; (7 &quot;I see a winning move at 7.</span></span>
                            <span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; &quot;)</span></span>
                            <span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a>(block-opponent-win *test-board*)</span>
                            <span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; (8 &quot;Danger! Loss imminent! Moving to block at 8.</span></span>
                            <span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; &quot;)</span></span></code></pre></div>
                        <p>We will return a list with the move and also the strategy employed.</p>
                        <div class="aside">
                            <p>Notice that we use <code class="verbatim">when</code>. We could use <code class="verbatim">if</code> instead, but <code class="verbatim">when</code> communicates more precisely what we mean. If we don't need the optional "else" branch of the <code class="verbatim">if</code> form, then it's better style to use <code class="verbatim">when</code> or <code class="verbatim">unless</code>.</p>
                        </div>
                        <p>If the computer is going first, it should just take a random position.</p>
                        <div class="sourceCode" id="cb154" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> take-random-position </span>(board)</span>
                            <span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((move (<span class="op">+</span> <span class="dv">1</span> (<span class="kw">random</span> <span class="dv">9</span>))))</span>
                            <span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span> ((<span class="op">=</span> <span class="dv">0</span> (<span class="kw">nth</span> move board))</span>
                            <span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>           (place-piece board *player-two* move)</span>
                            <span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">list</span> move <span class="st">&quot;Picking random position.&quot;</span>))</span>
                            <span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">t</span></span>
                            <span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>           (take-random-position board)))))</span></code></pre></div>
                        <p><code class="verbatim">random</code> will choose a semi-random value <strong>between</strong> 0 and the argument passed. Unfortunately, there is no way to specify the beginning of the "range" nor is the number random enough to be used for security purposes. Since we need to pick a number between 1 (remember the filler <code class="verbatim">BOARD</code> symbol) and 9 inclusive, we add 1 to the result.</p>
                        <p>Since the random position chosen may be occupied, the catchall branch simply makes a recursive call to <code class="verbatim">take-random-position</code> to try again.</p>
                        <p>Right now, <code class="verbatim">move</code> calls itself with the opponent player. We'll need a <code class="verbatim">human-move</code> and <code class="verbatim">computer-move</code> to give us the ability to let the computer choose.</p>
                        <div class="sourceCode" id="cb155" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> human-move </span>(board)</span>
                            <span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;It&#39;s ~a&#39;s turn.~%&quot;</span> (convert-to-letter *player-one*))</span>
                            <span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  (print-board board)</span>
                            <span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((move (read-legal-move *player-one* board))</span>
                            <span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>         (updated-board (place-piece board *player-one* move))</span>
                            <span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>         (winner (winner-p updated-board)))</span>
                            <span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span> (winner</span>
                            <span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>           (print-board updated-board)</span>
                            <span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a wins!&quot;</span> (convert-to-letter (<span class="op">/</span> (<span class="kw">first</span> winner) <span class="dv">3</span>))))</span>
                            <span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>          ((tie-p updated-board)</span>
                            <span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>           (print-board updated-board)</span>
                            <span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;It&#39;s a tie!&quot;</span>))</span>
                            <span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">t</span> (computer-move board)))))</span>
                            <span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> computer-move </span>(board)</span>
                            <span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;It&#39;s ~a&#39;s turn.~%&quot;</span> (convert-to-letter *player-two*))</span>
                            <span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a>  (print-board board)</span>
                            <span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((move-and-strategy (choose-move board))</span>
                            <span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a>         (move (<span class="kw">first</span> move-and-strategy))</span>
                            <span id="cb155-20"><a href="#cb155-20" aria-hidden="true" tabindex="-1"></a>         (strategy (<span class="kw">second</span> move-and-strategy))</span>
                            <span id="cb155-21"><a href="#cb155-21" aria-hidden="true" tabindex="-1"></a>         (updated-board (place-piece board *player-two* move))</span>
                            <span id="cb155-22"><a href="#cb155-22" aria-hidden="true" tabindex="-1"></a>         (winner (winner-p updated-board)))</span>
                            <span id="cb155-23"><a href="#cb155-23" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;My move: ~a~%&quot;</span> move)</span>
                            <span id="cb155-24"><a href="#cb155-24" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;My strategy: ~a~%&quot;</span> strategy)</span>
                            <span id="cb155-25"><a href="#cb155-25" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span> (winner</span>
                            <span id="cb155-26"><a href="#cb155-26" aria-hidden="true" tabindex="-1"></a>           (print-board updated-board)</span>
                            <span id="cb155-27"><a href="#cb155-27" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a wins!&quot;</span> (convert-to-letter (<span class="op">/</span> (<span class="kw">first</span> winner) <span class="dv">3</span>))))</span>
                            <span id="cb155-28"><a href="#cb155-28" aria-hidden="true" tabindex="-1"></a>          ((tie-p updated-board)</span>
                            <span id="cb155-29"><a href="#cb155-29" aria-hidden="true" tabindex="-1"></a>           (print-board updated-board)</span>
                            <span id="cb155-30"><a href="#cb155-30" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;It&#39;s a tie!&quot;</span>))</span>
                            <span id="cb155-31"><a href="#cb155-31" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">t</span> (human-move board)))))</span>
                            <span id="cb155-32"><a href="#cb155-32" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb155-33"><a href="#cb155-33" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> play-game-with-computer </span>()</span>
                            <span id="cb155-34"><a href="#cb155-34" aria-hidden="true" tabindex="-1"></a>  (reset-board)</span>
                            <span id="cb155-35"><a href="#cb155-35" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (<span class="kw">y-or-n-p</span> <span class="st">&quot;Do you want to go first, human?&quot;</span>)</span>
                            <span id="cb155-36"><a href="#cb155-36" aria-hidden="true" tabindex="-1"></a>      (human-move *board*)</span>
                            <span id="cb155-37"><a href="#cb155-37" aria-hidden="true" tabindex="-1"></a>      (computer-move *board*)))</span></code></pre></div>
                        <p>The <code class="verbatim">y-or-n-p</code> function takes user input like <code class="verbatim">read</code> does, but it only accepts two possible inputs: <code class="verbatim">y</code> or <code class="verbatim">n</code>, meaning yes or no. It evaluates to <code class="verbatim">t</code> for yes and <code class="verbatim">nil</code> for no.</p></li>
                    <li><p>Fixing a bug</p>
                        <p>Try playing with the computer. You'll notice that the computer is always going with the <code class="verbatim">make-three-in-a-row</code> strategy, even if you let it go first.</p>
                        <p>In the <code class="verbatim">win-or-block</code> function, there is a bug: we forgot to remove <code class="verbatim">*test-board*</code> from the first <code class="verbatim">find-if</code>.</p>
                        <p>Try this: Start a game, let the computer go first. It should tell you <code class="verbatim">"My strategy: I see a winning move at"</code>. We expect it to simply pick a random space.</p>
                        <p><strong>While the game is still running</strong>, update and compile the <code class="verbatim">win-or-block</code> function.</p>
                        <div class="sourceCode" id="cb156" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> win-or-block </span>(board target-sum)</span>
                            <span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((target-triplet (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet)</span>
                            <span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="co">;; </span><span class="al">NOTE</span><span class="co">:  *test-board* -&gt; board</span></span>
                            <span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>                                    (<span class="op">=</span> target-sum (sum-triplet board triplet)))</span>
                            <span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>                                *triplets*)))</span>
                            <span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> target-triplet</span>
                            <span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (element) (<span class="op">=</span> (<span class="kw">nth</span> element board) <span class="dv">0</span>)) target-triplet))))</span></code></pre></div>
                        <p>After compiling, <em>continue the game</em>. Make your move. You should now see the computer choose a random space.</p>
                        <p>This small interaction demonstrates a big feature of Lisp: <strong>We can update code as it is running, without restarting it.</strong> Whether we are updating a small tic-tac-toe game, <a href="https://www.youtube.com/watch?v=gdjkSkRFcr4">a program for music and visualization generation</a>, or a running web app, we can update it while it's running.</p></li>
                </ol></li>
            <li><p>Add computer strategies</p>
                <p>The simple data representation we chose at the beginning has made it fairly easy to get a simple human-vs-computer tic-tac-toe game made. However, the computer is very dumb. It doesn't think ahead and doesn't recognize different human strategies. Let's change that.</p>
                <p>Tic-tac-toe has a rather unfun characteristic: if played well by both players, every game will end in a draw.</p>
                <p>For our computer strategies, then, we are going to be mostly reacting to the human player, recognizing different strategies and countering them perfectly. By the end, we'll totally drain what little fun can be had from the game. But the coding will be fun, so let's go.</p>
                <ol class="incremental">
                    <li><p>Beyond triplets</p>
                        <p>There are two strategies you can employ that can guarantee a victory if the opponent doesn't react correctly: the <em>squeeze play</em> and a <em>two-on-one play</em>.</p>
                        <div class="sourceCode" id="cb157" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *squeeze* </span>(<span class="kw">list</span> <span class="dt">&#39;board</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">10</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">1</span>))</span>
                            <span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *two-on-one* </span>(<span class="kw">list</span> <span class="dt">&#39;board</span> <span class="dv">10</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">1</span>))</span>
                            <span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>(print-board *squeeze*)</span>
                            <span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a><span class="co">;  X |   |</span></span>
                            <span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a><span class="co">; -----------</span></span>
                            <span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a><span class="co">;    | O |</span></span>
                            <span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a><span class="co">; -----------</span></span>
                            <span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a><span class="co">;    |   | X</span></span>
                            <span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a><span class="co">;  =&gt; NIL</span></span>
                            <span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>(print-board *two-on-one*)</span>
                            <span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a><span class="co">;  O |   |</span></span>
                            <span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a><span class="co">; -----------</span></span>
                            <span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a><span class="co">;    | X |</span></span>
                            <span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a><span class="co">; -----------</span></span>
                            <span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a><span class="co">;    |   | X</span></span>
                            <span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a><span class="co">;  =&gt; NIL</span></span></code></pre></div>
                        <p>The squeeze happens when one player takes two corners and one player takes the middle. The two-on-one happens when one player takes the corner and the middle, and the other player takes a corner as well. In both scenarios, O is guaranteed to lose if X plays properly.</p>
                        <p>To avoid these two scenarios, the computer must recognize possible strategies being deployed against it and react correctly.</p>
                        <ul class="incremental">
                            <li>If the computer is in the middle between two human pieces, it's a possible squeeze.
                                <ul class="incremental">
                                    <li>To counter, take a side: don't take a corner.</li>
                                </ul></li>
                            <li>If the computer is in a corner and the human has the middle and the corner lining up his pieces against the computer, it's a possible two-on-one.
                                <ul class="incremental">
                                    <li>To counter, take a corner: don't take a side.</li>
                                </ul></li>
                        </ul>
                        <p>Right now, the computer reads the board as a list of triplets and identifies possible wins and danger. But to ensure both players end the game disappointed, the computer needs to recognize some other characteristics of the board: corners and sides.</p>
                        <div class="sourceCode" id="cb158" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *corners* </span>&#39;(<span class="dv">1</span> <span class="dv">3</span> <span class="dv">7</span> <span class="dv">9</span>))</span>
                            <span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *sides* </span>&#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">6</span> <span class="dv">7</span> <span class="dv">8</span> <span class="dv">9</span>))</span></code></pre></div></li>
                    <li><p>Detecting a squeeze</p>
                        <p>Let's start by detecting a squeeze.</p>
                        <p>First, we need to search the board and cross-reference the triplets, looking for any triplet with values that reduce to 12</p>
                        <div class="sourceCode" id="cb159" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> detect-squeeze </span>(board)</span>
                            <span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet)</span>
                            <span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>               (<span class="op">=</span> <span class="dv">12</span> (sum-triplet board triplet)))</span>
                            <span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>           *triplets*))</span>
                            <span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>(detect-squeeze *squeeze*)</span>
                            <span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (1 5 9)</span></span>
                            <span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>(detect-squeeze *two-on-one*)</span>
                            <span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (1 5 9)</span></span></code></pre></div>
                        <p>We need to know for sure this is a diagonal triplet, though.</p>
                        <div class="sourceCode" id="cb160" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> diagonal-p </span>(triplet)</span>
                            <span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">every</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (item)</span>
                            <span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>             <span class="co">;; Every item is either a corner or the middle.</span></span>
                            <span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">or</span> (<span class="kw">member</span> item *corners*)</span>
                            <span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>                 (<span class="op">=</span> <span class="dv">5</span> item)))</span>
                            <span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>         triplet))</span>
                            <span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> detect-squeeze </span>(board)</span>
                            <span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet)</span>
                            <span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>               <span class="co">;; Add AND and DIAGONAL-P</span></span>
                            <span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a>               (<span class="kw">and</span> (<span class="op">=</span> <span class="dv">12</span> (sum-triplet board triplet))</span>
                            <span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a>                    (diagonal-p triplet)))</span>
                            <span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a>           *triplets*))</span>
                            <span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>(detect-squeeze *squeeze*)</span>
                            <span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (1 5 9)</span></span>
                            <span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>(detect-squeeze *two-on-one*)</span>
                            <span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (1 5 9)</span></span></code></pre></div>
                        <p><code class="verbatim">every</code> runs a predicate function on a sequence and returns <code class="verbatim">t</code> if the predicate evaluated to <code class="verbatim">t</code> for every element of the sequence. In <code class="verbatim">diagonal-p</code>, it checks if every element of the triplet is either a corner or the middle space.</p>
                        <p>We also need to know who is in the middle.</p>
                        <div class="sourceCode" id="cb161" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> human-in-middle-p </span>(board)</span>
                            <span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>  (<span class="op">=</span> (<span class="kw">nth</span> <span class="dv">5</span> board) *player-one*))</span>
                            <span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> detect-squeeze </span>(board target-sum)</span>
                            <span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet)</span>
                            <span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>               (<span class="kw">and</span> (<span class="op">=</span> (sum-triplet board triplet) target-sum)</span>
                            <span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>                    (diagonal-p triplet)</span>
                            <span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>                    (<span class="kw">not</span> (human-in-middle-p board))))</span>
                            <span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a>           *triplets*))</span>
                            <span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>(detect-squeeze *squeeze*)</span>
                            <span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (1 5 9)</span></span>
                            <span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a>(detect-squeeze *two-on-one*)</span>
                            <span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span></code></pre></div>
                        <p>Finally, we just need to be sure that we're at the beginning of the game. The player may have already blocked the squeeze or two-on-one, or the game may have otherwise progressed beyond the first diagonals.</p>
                        <div class="sourceCode" id="cb162" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> side-empty-p </span>(board)</span>
                            <span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>  (find-empty-position board *sides*))</span>
                            <span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> find-empty-position </span>(board search-area)</span>
                            <span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (x) (<span class="op">=</span> <span class="dv">0</span> (<span class="kw">nth</span> x board))) search-area))</span>
                            <span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> detect-squeeze </span>(board target-sum)</span>
                            <span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((squeeze-p</span>
                            <span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet)</span>
                            <span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>                       (<span class="kw">and</span> (<span class="op">=</span> (sum-triplet board triplet) target-sum)     <span class="co">; Is the triplet the target-sum?</span></span>
                            <span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a>                            (diagonal-p triplet)                           <span class="co">; Is the triplet a diagonal?</span></span>
                            <span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">not</span> (human-in-middle-p board))                <span class="co">; Is the human not in the middle?</span></span>
                            <span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>                            (side-empty-p board)))                         <span class="co">; Are all the sides empty?</span></span>
                            <span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a>                   *triplets*)))</span>
                            <span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> squeeze-p</span>
                            <span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a>        (find-empty-position board *sides*))))</span></code></pre></div>
                        <p>If we see a squeeze, we need to counter. To counter a squeeze, we need to take a side (not a corner). So we look for an empty position in one of the <code class="verbatim">*sides*</code>.</p>
                        <p>If we test <code class="verbatim">detect-squeeze</code>, we should get an empty space on one of the sides:</p>
                        <div class="sourceCode" id="cb163" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>(detect-squeeze *squeeze* <span class="dv">12</span>)</span>
                            <span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 2 (2 bits, #x2, #o2, #b10)</span></span></code></pre></div>
                        <p>2 is the space between corner 1 and 3, so it's given an expected return value.</p></li>
                    <li><p>Detecting a two-on-one</p>
                        <p><code class="verbatim">detect-two-on-one</code> is nearly identical to <code class="verbatim">detect-squeeze</code>:</p>
                        <div class="sourceCode" id="cb164" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> detect-two-on-one </span>(board target-sum)</span>
                            <span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((two-on-one-p</span>
                            <span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet)</span>
                            <span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>                       (<span class="kw">and</span> (<span class="op">=</span> (sum-triplet board triplet) target-sum)</span>
                            <span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>                            (diagonal-p triplet)</span>
                            <span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>                            (human-in-middle-p board)  <span class="co">; Human in the middle?</span></span>
                            <span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>                            (side-empty-p board)))</span>
                            <span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>                   *triplets*)))</span>
                            <span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">when</span> two-on-one-p</span>
                            <span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>      (find-empty-position board *corners*)))) <span class="co">; Look for an empty space in the corners.</span></span>
                            <span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a>(detect-squeeze *two-on-one* <span class="dv">12</span>)</span>
                            <span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span>
                            <span id="cb164-14"><a href="#cb164-14" aria-hidden="true" tabindex="-1"></a>(detect-squeeze *squeeze* <span class="dv">12</span>)</span>
                            <span id="cb164-15"><a href="#cb164-15" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 2 (2 bits, #x2, #o2, #b10)</span></span>
                            <span id="cb164-16"><a href="#cb164-16" aria-hidden="true" tabindex="-1"></a>(detect-two-on-one *two-on-one* <span class="dv">12</span>)</span>
                            <span id="cb164-17"><a href="#cb164-17" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 3 (2 bits, #x3, #o3, #b11)</span></span>
                            <span id="cb164-18"><a href="#cb164-18" aria-hidden="true" tabindex="-1"></a>(detect-two-on-one *squeeze* <span class="dv">12</span>)</span>
                            <span id="cb164-19"><a href="#cb164-19" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span></code></pre></div>
                        <p>With that, we just need a couple of small wrappers to encapsulate our strategies.</p>
                        <div class="sourceCode" id="cb165" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> block-squeeze-play </span>(board)</span>
                            <span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((move (detect-squeeze board (<span class="op">+</span> (<span class="op">*</span> *player-one* <span class="dv">2</span>) *player-two*))))</span>
                            <span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">when</span> move</span>
                            <span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">list</span> move <span class="st">&quot;I&#39;m being squeezed! Taking side space.&quot;</span>))))</span>
                            <span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> block-two-on-one-play </span>(board)</span>
                            <span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((move (detect-two-on-one board (<span class="op">+</span> (<span class="op">*</span> *player-one* <span class="dv">2</span>) *player-two*))))</span>
                            <span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">when</span> move</span>
                            <span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">list</span> move <span class="st">&quot;It&#39;s two-on-one! Taking corner space.&quot;</span>))))</span></code></pre></div></li>
                    <li><p>Updating <code class="verbatim">choose-move</code></p>
                        <p>Finally, we update <code class="verbatim">choose-move</code> by adding our two new strategies.</p>
                        <div class="sourceCode" id="cb166" data-org-language="lisp" data-tangle="src/basics/tic-tac-toe.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> choose-move </span>(board)</span>
                            <span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">or</span> (make-three-in-a-row board)</span>
                            <span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>      (block-squeeze-play board)         <span class="co">; Added</span></span>
                            <span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>      (block-two-on-one-play board)      <span class="co">; Added</span></span>
                            <span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>      (block-opponent-win board)</span>
                            <span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>      (take-random-position board)))</span></code></pre></div></li>
                </ol></li>
            <li><p>Summary</p>
                <p>Now you have a finished AI that will force a draw every game. Try playing it and enjoy infinite draws.</p>
                <p>With this, you have gotten your first experience writing a program in Almighty Common Lisp. It may have been painful: if you aren't using structural editing modes like <code class="verbatim">lispy-mode</code> or <code class="verbatim">paredit-mode</code>, you had to make sure to keep your parentheses balanced and moving code around may have been harder than you expected. However, with practice, you'll be stacking parens like an expert.</p></li>
        </ol>
        <h3 id="98e05c1c-a80b-445e-a6f2-304a66abdcb3">Discussion</h3>
        <ol class="incremental">
            <li><p>Reading Lisp Code</p>
                <p>"inside-out", using <code class="verbatim">let</code> to change order of code.</p>
                <div class="aside">
                    <p>Lisp code often needs to be read "inside-out". The nested <code class="verbatim">find-if</code> forms above demonstrate that. The inner <code class="verbatim">find-if</code> returned a triplet from the list of <code class="verbatim">*triplets*</code>, then the outer <code class="verbatim">find-if</code> returned an item from the triplet. This can be confusing if you're not used reading code this way.</p>
                    <p>By first assigning <code class="verbatim">target-triplet</code> to the triplet that sums to <code class="verbatim">target-sum</code>, we reverse the order of the code we read first, making it clearer. It also allows us to check if a <code class="verbatim">target-triplet</code> even exists.</p>
                </div></li>
            <li><p>Good Code Communication</p>
                <p>be specific with <code class="verbatim">if/when/unless/cond</code>. <code class="verbatim">*global-variables*</code></p></li>
        </ol>
        <h1 id="c59f393b-dd4e-4480-bc90-f245ee577b08">EMACS FUNDAMENTALS</h1>
        <h2 id="18d08c10-e549-4c91-bba4-57f9060f2477">BEYOND SURVIVAL MODE</h2>
        <p>In order to do any Lisp coding at all, you need to be able to edit text (duh). With Doom Emacs, you have three options: Use Emacs keybindings, use Evil keybindings, or use Emacs as much as possible like VSCode or other editors you're likely familiar with. We'll call the last one Survival Mode. So far, you've been in Survival Mode.</p>
        <ol class="incremental">
            <li>You've typed <code class="verbatim">C-z</code> to enable Evil <code class="verbatim">Emacs State</code>, which enables editing using standard Emacs keybindings.</li>
            <li>You probably turned off <code class="verbatim">lispy-mode</code> to avoid confusing behavior.</li>
            <li>You edited text as usual: type, mouse click around, scroll wheel up and down, click and drag to highlight text, copy/paste with the keybindings you already know, etc.</li>
            <li>You've used the top menu bar or mode line to browse commands you can use while editing Lisp files.</li>
        </ol>
        <p>If you're still on the fence about this whole Emacs/Lisp thing, there is no shame in staying in Survival Mode. However, you probably ended up using some keybindings already for frequently used commands that you learned in the menu. This is the perfect start to learning Emacs–gradually incorporating more and more keybindings/functionality into your workflow as your power grows.</p>
        <p>This chapter will help you increase your mastery of Emacs by introducing you to keybindings for many of the most common and useful functions in Doom Emacs, starting with text and Lisp editing, then moving on to buffers, windows, and projects.</p>
        <h2 id="support-level-disclaimer">SUPPORT LEVEL DISCLAIMER</h2>
        <p>None of the functionality here is necessary to continue this book. Instead, you should consider this chapter a reference to return to whenever you are ready to add a little more Emacs functionality into your workflow.</p>
        <p>However, I won't be including any more references to the menu or using the mode line to navigate to and execute commands. For the rest of this book, I will refer to keybindings and give the names of the commands as well so that you can become familiar with the different packages and commands that are associated with different parts of Doom Emacs' functionality.</p>
        <p>I will also assume that you are using Evil <code class="verbatim">Normal State</code> at least partially. If you are in <code class="verbatim">Emacs State</code> and the keybindings aren't working, type <code class="verbatim">M-x</code> and type in the name of the command I am referencing. Some commands may not have keybindings in <code class="verbatim">Emacs State</code>, or they may be confusing.</p>
        <p>Example: <code class="verbatim">evil-delete-line</code> will not have a keybinding in <code class="verbatim">Emacs State</code> and <code class="verbatim">org-kill-line</code> in <code class="verbatim">Normal State</code> is bound to <code class="verbatim">&lt;deleteline&gt;</code>.</p>
        <p>I won't be testing any of the keybindings in <code class="verbatim">Emacs State</code>. If you want to use <code class="verbatim">Emacs State</code> exclusively you <em>might</em> be able to run some keybindings using <code class="verbatim">M-SPC</code> instead of <code class="verbatim">SPC</code>, but not all commands have such alternative bindings.</p>
        <p>I will only test keybindings in <code class="verbatim">lisp-mode</code>; other modes may have different bindings, or commands that do similar but subtly different things may share bindings in different major modes.</p>
        <h2 id="setting-expectations">SETTING EXPECTATIONS</h2>
        <p>Learning Evil bindings + Doom Emacs exclusive bindings will take time. Expect to stumble around for two weeks, feel somewhat productive in two months, and proficient in about 6-12 months. As always, focus on the keybindings and features that seem most useful to the task at hand–learning Common Lisp–and learn more Emacs as you learn more Common Lisp.</p>
        <h2 id="e444362e-bf3a-44ad-a87e-4c0eda5044ea">TEXT EDITING</h2>
        <h3 id="5b1c2d65-5ab0-4b8b-8ac8-da422881e625">Evil Bindings</h3>
        <p>By default, <code class="verbatim">evil-mode</code> is available and active in Doom Emacs. This means that you have access to both Emac's default bindings as well as bindings typical of Vim/Neovim.</p>
        <p>If you don't already know how to use the Neovim keybindings, you can check out <a href="https://openvim.com">https://openvim.com</a> or <a href="https://vim-adventures.com/">https://vim-adventures.com/</a>. Both provide an interactive experience for learning the VIM text navigation keybindings.</p>
        <p><code class="verbatim">evil</code> uses several different editing states. The three most common are Normal, Insert, and Visual. In <code class="verbatim">Normal State</code>, you navigate and run commands, often starting with <code class="verbatim">SPC</code>. In <code class="verbatim">Insert State</code>, you can edit text. In <code class="verbatim">Visual State</code>, you can select and act upon regions of text.</p>
        <p>These states are set on a per-buffer basis. The state of the current buffer is displayed on the left side of the mode line.</p>
        <p>Whenever a keybinding in this book mentions a keybinding starting with <code class="verbatim">SPC</code>, I assume you are in Evil <code class="verbatim">Normal State</code>.</p>
        <h3 id="5fea9882-9d7b-4051-9b0e-2d849f80ccda">Inserting</h3>
        <p>Type <code class="verbatim">i</code> to enter Evil <code class="verbatim">Insert State</code> and type as usual.</p>
        <h3 id="933e2ee0-9697-4848-af6e-092b7c80a5d8">Cutting/Copying/Pasting</h3>
        <ol class="incremental">
            <li><p><code class="verbatim">kill</code></p>
                <p>To cut some text, you must <code class="verbatim">kill</code> it.</p>
                <p>The simplest way to kill some text is to kill the entire contents right of the cursor with <code class="verbatim">D</code> (<code class="verbatim">lispyville-delete-line</code>) while in <code class="verbatim">Normal State</code>.</p>
                <p>To kill a whole line, type <code class="verbatim">d d</code> in <code class="verbatim">Normal State</code>.</p>
                <p>You can kill single characters with <code class="verbatim">x</code>, single words with <code class="verbatim">k i w</code> or <code class="verbatim">M-backspace</code>. You can kill the contents within some textual boundaries like () or "" with <code class="verbatim">k i (</code> or <code class="verbatim">k i quotemark</code>. You can include the boundaries with <code class="verbatim">k o</code> instead of <code class="verbatim">k i</code>.</p></li>
            <li><p><code class="verbatim">yank</code></p>
                <p>To copy something, you must <code class="verbatim">yank</code> it.</p>
                <p>Use <code class="verbatim">y y</code> in Evil <code class="verbatim">Normal State</code> to yank a line. You can yank a word with <code class="verbatim">y i w</code> or a symbol with <code class="verbatim">y i o</code>.</p></li>
            <li><p><code class="verbatim">paste</code></p>
                <p>To paste some text, type <code class="verbatim">p</code> in Evil <code class="verbatim">Normal State</code>, or <code class="verbatim">s-v</code> (or whatever keyboard shortcut you're accustomed to using to paste text).</p></li>
        </ol>
        <h3 id="marking-text">Marking Text</h3>
        <p>You can mark regions of text to work on using <code class="verbatim">Visual State</code>. Type <code class="verbatim">v</code> and then navigate text to select it from where you first entered.</p>
        <p>Marked text can be killed or yanked. There are plenty of other operations that you can do on marked text, but we'll save that for another time.</p>
        <h3 id="simple-searching">Simple Searching</h3>
        <p>You can search for some text in a buffer with <code class="verbatim">SPC s s</code> (<code class="verbatim">+default/search-buffer</code>).</p>
        <h3 id="e5fb1aca-99dd-4f22-8a54-78fb75b401a4">Aborting A command</h3>
        <p>Let's say you pressed <code class="verbatim">SPC f</code>, but you decided you don't want to continue. To abort the command, press <code class="verbatim">C-g</code> (<code class="verbatim">doom/escape</code>).</p>
        <p>It's common to accidently hit a key or combination of keys you didn't mean to. If you are "stuck" inside <em>some</em> command, or in the middle of a keybinding, the quickest solution is to press <code class="verbatim">C-g</code> a few times.</p>
        <h3 id="4852c424-81a9-4c0f-9bc7-9cf43ccdd0f0">Undoing An Action</h3>
        <p><code class="verbatim">C-/</code> (<code class="verbatim">undo-fu-only-undo</code>) will undo the previous action. Doom also includes the <code class="verbatim">s-z</code> keybinding, which is the same as undo in the browser, MS Word, etc.</p>
        <h3 id="66ef24d2-1b8c-47cf-9689-6ae0057f8296">Doing An Action Multiple Times</h3>
        <p>In Doom Emacs, if you press a number while in <code class="verbatim">Normal State</code> before running a command, entering Evil <code class="verbatim">Insert State</code>, etc. Emacs will run the action the same number of times as the number you typed.</p>
        <p>If you don't know VIM/evil keybindings, you probably won't <em>want</em> to do this, but you may accidently do so. For example, you may be in Evil <code class="verbatim">Normal State</code>, press 9, enter <code class="verbatim">Insert State</code> and type something, then return to <code class="verbatim">Normal State</code> with <code class="verbatim">ESC</code>, at which point you now have inserted the same text 9 times. It might look something like this:</p>
        <div class="sourceCode" id="cb167" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>(<span class="op">+</span> <span class="dv">1</span> <span class="dv">1</span>(<span class="op">+</span> <span class="dv">1</span> <span class="dv">1</span>(<span class="op">+</span> <span class="dv">1</span> <span class="dv">1</span>(<span class="op">+</span> <span class="dv">1</span> <span class="dv">1</span>(<span class="op">+</span> <span class="dv">1</span> <span class="dv">1</span>(<span class="op">+</span> <span class="dv">1</span> <span class="dv">1</span>(<span class="op">+</span> <span class="dv">1</span> <span class="dv">1</span>(<span class="op">+</span> <span class="dv">1</span> <span class="dv">1</span>(<span class="op">+</span> <span class="dv">1</span> <span class="dv">1</span>)))))))))</span></code></pre></div>
        <p>The best thing to do in this situation is just undo and retype.</p>
        <p>This functionality can be quite useful. For example, if you want to navigate down 10 lines, you can type <code class="verbatim">10 j</code> in <code class="verbatim">Normal State</code> to navigate down ten lines. It also makes it easy to type decorative dividers in comments like this:</p>
        <div class="sourceCode" id="cb168" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; ==============================</span></span></code></pre></div>
        <h3 id="multiple-cursors">Multiple Cursors</h3>
        <p>Type <code class="verbatim">g z z</code> (<code class="verbatim">+multiple-cursors/evil-mc-toggle-cursor-here</code>) to create a cursor. Move your cursor and the one you created stays in place. You can create arbitrary numbers of cursors. Once you've made all the cursors you need, you can begin editing them by entering Evil <code class="verbatim">Insert State</code>.</p>
        <p>If you need to pause the cursors, type <code class="verbatim">g z t</code> (<code class="verbatim">+multiple-cursors/evil-mc-toggle-cursors</code>). If you need to undo the creation of the last cursor, type <code class="verbatim">g z u</code> (<code class="verbatim">+multiple-cursors/evil-mc-undo-cursor</code>).</p>
        <h3 id="multiediting">Multiediting</h3>
        <p>If you like multicursor editing in other editors, you're going to love multiediting in Doom Emacs. With multiple cursors, you can place cursors in arbitrary locations. The downside is that you need to move the cursor to each location you want to place the cursor. With multiediting, you can search and highlight text and edit all highlighted areas simultaneously. You can leave the highlighted regions and edit other text, then return to the highlighted region an</p>
        <ol class="incremental">
            <li><p>Next Match</p>
                <p>Place the cursor or mark a region. Type <code class="verbatim">M-d</code> (<code class="verbatim">evil-multiedit-match-symbol-and-next</code>) to begin multiediting. If you type <code class="verbatim">M-d</code> again, you will mark the next symbol or region that matches the first one. You can continue that as many times as you want.</p></li>
            <li><p>Previous Match</p>
                <p>You can also match backwards with <code class="verbatim">M-D</code> (<code class="verbatim">evil-multiedit-match-symbol-and-prev</code>).</p></li>
            <li><p>Toggling Matches</p>
                <p>While multiediting, if you press <code class="verbatim">Enter</code>, you will remove a match from being edited. <code class="verbatim">C-g</code> to quit multiediting. Typing <code class="verbatim">Enter</code> again will toggle the match back on.</p></li>
            <li><p>Navigating Matches</p>
                <p>After marking several matches, you can navigate directly between them with <code class="verbatim">C-n</code> (<code class="verbatim">evil-multiedit-next</code>) and <code class="verbatim">C-p</code> (<code class="verbatim">evil-multiedit-prev</code>).</p></li>
            <li><p>Quitting Multiediting</p>
                <p>To unmark all matches and quit multiediting, type <code class="verbatim">C-g</code> (maybe a few times).</p></li>
        </ol>
        <h3 id="searching-replacing">Searching &amp; Replacing</h3>
        <p>When you want to rename a few instances of a symbol in a <code class="verbatim">defun</code>, multiediting is the right tool for the job. If you want to rename a function throughout a file, there is a better tool for the job: VIM search and replace.</p>
        <p>To begin using it, just type <code class="verbatim">:</code> (<code class="verbatim">evil-ex</code>). How you proceed from there depends on how sophisticated your search and replace operation needs to be. The simplest case is replacing all instances of some text throughout the buffer:</p>
        <pre class="example"><code>:%s/TEXT TO REPLACE/TEXT TO REPLACE IT WITH/g
        </code></pre>
        <p>This search and replace tool is very powerful, but a full treatment is out of the scope of this book. A good place to learn more is <a href="https://vim.fandom.com/wiki/Search_and_replace">the Vim tips wiki</a> (<a href="https://vim.fandom.com/wiki/Search_and_replace">https://vim.fandom.com/wiki/Search_and_replace</a>).</p>
        <h3 id="5d9f13e9-4b36-40f8-a3b0-4eddf505f5a5">Running Commands/Functions With No Keybindings</h3>
        <p>There are many commands that don't have keybindings. There are also many commands you don't know the keybindings for.</p>
        <p>To find and run those commands, type <code class="verbatim">M-x</code>. A minibuffer will open with a list of commands and a short description. If they have a keybinding, it will be displayed in parentheses next to the command itself.</p>
        <p><code class="verbatim">C-n</code> will move the cursor down a line inside that minibuffer. <code class="verbatim">C-p</code> will move the cursor up a line.</p>
        <h3 id="quick-reference-table">Quick Reference Table</h3>
        <table>
            <thead>
                <tr>
                    <th>Action</th>
                    <th>Emacs Binding</th>
                    <th>Evil Binding (Normal State)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>enter Insert State</td>
                    <td></td>
                    <td>i</td>
                </tr>
                <tr>
                    <td>delete character</td>
                    <td></td>
                    <td>x</td>
                </tr>
                <tr>
                    <td>delete to end of line</td>
                    <td></td>
                    <td>D</td>
                </tr>
                <tr>
                    <td>delete whole line</td>
                    <td></td>
                    <td>dd</td>
                </tr>
                <tr>
                    <td>delete inner word</td>
                    <td></td>
                    <td>diw</td>
                </tr>
                <tr>
                    <td>delete a word</td>
                    <td></td>
                    <td>daw</td>
                </tr>
                <tr>
                    <td>delete inner parentheses</td>
                    <td></td>
                    <td>di(</td>
                </tr>
                <tr>
                    <td>delete inner quotes</td>
                    <td></td>
                    <td>di"</td>
                </tr>
                <tr>
                    <td>delete around parentheses</td>
                    <td></td>
                    <td>da(</td>
                </tr>
                <tr>
                    <td>delete around quotes</td>
                    <td></td>
                    <td>da"</td>
                </tr>
                <tr>
                    <td>delete with alt-backspace</td>
                    <td>M-Backspace</td>
                    <td>M-Backspace</td>
                </tr>
                <tr>
                    <td>yank (copy) line</td>
                    <td></td>
                    <td>yy</td>
                </tr>
                <tr>
                    <td>yank (copy) inner word</td>
                    <td></td>
                    <td>yiw</td>
                </tr>
                <tr>
                    <td>yank (copy) inner symbol</td>
                    <td></td>
                    <td>yis</td>
                </tr>
                <tr>
                    <td>paste after cursor</td>
                    <td></td>
                    <td>p</td>
                </tr>
                <tr>
                    <td>paste from system clipboard</td>
                    <td>C-v</td>
                    <td>s-v</td>
                </tr>
                <tr>
                    <td>enter Visual State</td>
                    <td></td>
                    <td>v</td>
                </tr>
                <tr>
                    <td>search in buffer</td>
                    <td></td>
                    <td>SPC s s</td>
                </tr>
                <tr>
                    <td>abort command</td>
                    <td>C-g</td>
                    <td>C-g</td>
                </tr>
                <tr>
                    <td>undo</td>
                    <td>C-/</td>
                    <td>s-z or C-/</td>
                </tr>
                <tr>
                    <td>repeat action N times</td>
                    <td></td>
                    <td>&lt;number&gt; then command</td>
                </tr>
                <tr>
                    <td>multiedit: match symbol and next</td>
                    <td>M-d</td>
                    <td>M-d</td>
                </tr>
                <tr>
                    <td>multiedit: match symbol and prev</td>
                    <td>M-D</td>
                    <td>M-D</td>
                </tr>
                <tr>
                    <td>multiedit: toggle match</td>
                    <td>Enter</td>
                    <td>Enter</td>
                </tr>
                <tr>
                    <td>multiedit: next match</td>
                    <td>C-n</td>
                    <td>C-n</td>
                </tr>
                <tr>
                    <td>multiedit: previous match</td>
                    <td>C-p</td>
                    <td>C-p</td>
                </tr>
                <tr>
                    <td>quit multiediting</td>
                    <td>C-g</td>
                    <td>C-g</td>
                </tr>
                <tr>
                    <td>start ex command (search &amp; replace)</td>
                    <td></td>
                    <td>:</td>
                </tr>
                <tr>
                    <td>execute command (M-x)</td>
                    <td>M-x</td>
                    <td>M-x</td>
                </tr>
                <tr>
                    <td>navigate down in minibuffer</td>
                    <td>C-n</td>
                    <td>C-n</td>
                </tr>
                <tr>
                    <td>navigate up in minibuffer</td>
                    <td>C-p</td>
                    <td>C-p</td>
                </tr>
            </tbody>
        </table>
        <h2 id="fbda6d60-50ff-4285-badb-7a73d7bec26a">BUFFER NAVIGATION &amp; MANAGEMENT</h2>
        <h3 id="8bc74fc5-ba2a-43e5-8e59-35652958e581">It All Begins With A Buffer</h3>
        <p>Buffers are the most fundamental abstraction in Emacs. A buffer is a named place that displays some data. Usually buffers display the contents of text files, but they can also point to Emacs-specific functionality like the <code class="verbatim">*scratch*</code>, <code class="verbatim">*Messages*</code>, or <code class="verbatim">*Org-Agenda*</code> buffers. Some buffers may be called <code class="verbatim">minibuffers</code>. Minibuffers are typically designed to be ephemeral, like the buffer that appears when you type <code class="verbatim">M-x</code> to run some command.</p>
        <p>Once you're done learning the essentials of buffer navigation and management, you'll be able to:</p>
        <ul class="incremental">
            <li>Open &amp; Close buffers.</li>
            <li>Open a "scratch" buffer.</li>
            <li>Switch between buffers.</li>
            <li>View lists of buffers.</li>
            <li>Save Files.</li>
            <li>Get more information about buffers.</li>
        </ul>
        <h3 id="f77642a9-a9e1-48e8-ba49-fc825e26864c">Opening Buffers</h3>
        <p>To open a file buffer, type <code class="verbatim">C-x C-f</code> or <code class="verbatim">SPC f f</code> to run <code class="verbatim">find-file</code>. You can open a file that already exists, or you can navigate to a directory and/or file that doesn't exist, type <code class="verbatim">Enter</code>, and create a buffer for that location. The file/directory doesn't exist until you save the buffer.</p>
        <p>Besides file buffers, there are many other kinds of buffers. The most important buffer to know as a beginner is the <code class="verbatim">M-x</code> command minibuffer. There you can get a list of function you can (possibly) run. There are many commands that aren't bound to keybindings that you may want to use on occasion (or perhaps you would like bind them to a custom key command).</p>
        <h3 id="be353a3a-cf1d-41a2-bdfe-97b21f6c4553">Scratch Buffer</h3>
        <p>The scratch buffer is a buffer that can be opened to use the same way "scratch" paper is use–to do a little work that you'll quickly save somewhere else or discard after a short time. You can open it with <code class="verbatim">SPC x</code>. Once in the buffer, you can change the mode using <code class="verbatim">M-x</code> and typing in the mode.</p>
        <h3 id="8d0ad60b-eb3f-48fa-ac08-07461dbb5b46">Switching Buffers</h3>
        <p>You can switch buffers by typing <code class="verbatim">C-x b</code> or <code class="verbatim">SPC b B</code> (<code class="verbatim">consult-buffer</code>). You will be presented with a minibuffer listing all buffers that are open. Unlike <code class="verbatim">list-buffers</code>, you can navigate the list of buffers using <code class="verbatim">C-n/C-p</code> and peak at the buffer before switching to it. The minibuffer is smaller and disappears after you select a buffer to switch to.</p>
        <p>You can't mouse click buffers in the list to switch to them. You have to either type the name (often the ideal way to switch to a buffer anyway) or use Emacs keybindings to move the cursor up and down the list with <code class="verbatim">C-n</code> an <code class="verbatim">C-p</code> and select with <code class="verbatim">Enter</code>.</p>
        <h3 id="22e1fcd8-c585-439d-8b35-fbc9b022353f">Closing Buffers</h3>
        <p>To close the active buffer, type <code class="verbatim">s-k</code> or <code class="verbatim">SPC b k</code>. If you want to close multiple buffers, you can type <code class="verbatim">C-x C-b</code> to run <code class="verbatim">list-buffers</code>. Inside the <code class="verbatim">*Buffer List*</code> buffer, you can mark a buffer to close with <code class="verbatim">d</code>. After marking all of the buffers you want to close, you can "execute" the closing with <code class="verbatim">x</code>.</p>
        <p>Different minibuffers often can be closed with simpler keybindings like <code class="verbatim">ESC</code> or <code class="verbatim">q</code>.</p>
        <h3 id="f57a1113-c88c-4213-9b13-55947ebe313b">Saving File Buffers</h3>
        <p>You can save the current file buffer with <code class="verbatim">C-x C-s</code> or <code class="verbatim">s-s</code>.</p>
        <h3 id="5b4c6313-8ac1-4e4b-85c9-29710b360fca">Getting More Information About A Buffer</h3>
        <p>As you get more experience with Emacs, you may want to know how something works. Many functions–especially in a distribution like Doom–are not native functions. They are often available because of a major or minor mode created by a certain package that's installed. Thus, learning more about the environment can help you come to grips with what package does what and what other functionality is available but "hidden".</p>
        <ol class="incremental">
            <li><p>Getting Information About Major &amp; Minor Modes</p>
                <p>You can get more information about the major and minor modes of the active buffer using <code class="verbatim">C-h m</code> or <code class="verbatim">SPC h m</code> (<code class="verbatim">describe-mode</code>). A minibuffer listing all the modes–including all of the functions/keybindings those modes provide–will appear.</p></li>
            <li><p>Getting Information About A Function</p>
                <p>You can go deeper and find information about a function with <code class="verbatim">C-h o</code> or <code class="verbatim">SPC h o</code> (<code class="verbatim">describe-symbol</code>) and then typing in an Emacs Lisp symbol or function name. Documentation and the actual code of the function will be made available in a minibuffer.</p>
                <p>The documentation that <code class="verbatim">describe-symbol</code> shows includes keybindings for the function. Unlike the <code class="verbatim">M-x</code> minibuffer, you can see all of the bindings for a single function (many functions have multiple bindings, as you've probably noticed already). The <code class="verbatim">M-x</code> minibuffer will only show one binding.</p></li>
            <li><p>Getting Information About A Keybinding</p>
                <p>Maybe you know a keybinding but don't know or remember the function that the keybinding calls? Maybe you hit a key that did something surprising and want to know what the heck it was?</p>
                <p>In that case, you can use <code class="verbatim">C-h k</code> or <code class="verbatim">SPC h k</code> (<code class="verbatim">describe-key</code>). You will be prompted to type the keybinding you want to know more about.</p>
                <p>To browse keybindings and functions, you can either type <code class="verbatim">M-x</code> to open a list of all commands, or you can open <code class="verbatim">embark-bindings</code> with <code class="verbatim">C-h b b</code> or <code class="verbatim">SPC h b b</code>. embark-bindings is especially useful because it only shows the keybindings available in the current buffer. <code class="verbatim">describe-mode</code> also shows all of the functions a mode provides, but only shows a maximum of one binding per function. Embark bindings shows you all of them. Additionally, <code class="verbatim">embark-bindings</code> lets you search <em>keybindings</em>. For example, you can search for "C-c" and find all keybindings that include <code class="verbatim">C-c</code> in any of them. This will be especially useful for cases where you might not know the <em>exact</em> keybinding you are looking for, or if you're looking for an open keybinding in a buffer you want to make a custom shortcut for.</p></li>
        </ol>
        <h3 id="84df23d2-8e02-4e2b-94e7-4ad8a0cf8d67">Quick Reference Table</h3>
        <table>
            <thead>
                <tr>
                    <th>Action</th>
                    <th>Emacs Binding</th>
                    <th>Evil Binding</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>find file / open buffer</td>
                    <td>C-x C-f</td>
                    <td>SPC f f</td>
                </tr>
                <tr>
                    <td>open scratch buffer</td>
                    <td></td>
                    <td>SPC x</td>
                </tr>
                <tr>
                    <td>switch buffers</td>
                    <td>C-x b</td>
                    <td>SPC b B</td>
                </tr>
                <tr>
                    <td>close active buffer</td>
                    <td></td>
                    <td>s-k or SPC b k</td>
                </tr>
                <tr>
                    <td>list buffers</td>
                    <td>C-x C-b</td>
                    <td></td>
                </tr>
                <tr>
                    <td>mark buffer to close (in list)</td>
                    <td>d</td>
                    <td>d</td>
                </tr>
                <tr>
                    <td>execute closing (in list)</td>
                    <td>x</td>
                    <td>x</td>
                </tr>
                <tr>
                    <td>save current file buffer</td>
                    <td>C-x C-s</td>
                    <td>s-s</td>
                </tr>
                <tr>
                    <td>describe mode</td>
                    <td>C-h m</td>
                    <td>SPC h m</td>
                </tr>
                <tr>
                    <td>describe symbol</td>
                    <td>C-h o</td>
                    <td>SPC h o</td>
                </tr>
                <tr>
                    <td>describe key</td>
                    <td>C-h k</td>
                    <td>SPC h k</td>
                </tr>
                <tr>
                    <td>embark bindings</td>
                    <td>C-h b b</td>
                    <td>SPC h b b</td>
                </tr>
                <tr>
                    <td>close minibuffer</td>
                    <td>ESC or q</td>
                    <td>ESC or q</td>
                </tr>
            </tbody>
        </table>
        <h2 id="2eb8d430-fa13-4675-bfbe-d690152c9682">WINDOW NAVIGATION &amp; MANAGEMENT</h2>
        <h3 id="dc1c2899-1298-44d8-a48e-cd948c57db96">Getting Familiar With Windows</h3>
        <p>In Emacs, a "frame" is what most people would call a window: an operating system-level defined space to display the contents of an application.</p>
        <p>Emacs uses the word "window" differently from how operating systems do. Emacs windows are separate places where buffers can be displayed. Buffers, of course, show either file contents or things like the Lisp REPL. A frame can be subdivided into many windows, each displaying a single buffer at a time.</p>
        <p>Opening, closing, and navigating between windows are essential skills for using Emacs. Now that you know the basics of Lisp, it's time to become more familiar with windows.</p>
        <h3 id="f7f9c5c3-3219-425c-afa5-794d91dd75a3">Splitting &amp; Closing Windows</h3>
        <p>You can split a window vertically or horizontally (creating another window).</p>
        <p>To split vertically, type <code class="verbatim">C-x 2</code> or <code class="verbatim">SPC w s</code>. To split horizontally, type <code class="verbatim">C-x 3</code> or <code class="verbatim">SPC w v</code>.</p>
        <p>You can delete a window with <code class="verbatim">C-x 0</code> or <code class="verbatim">SPC w d</code>, or you can close all <em>except</em> the currently selected window with <code class="verbatim">C-x 1</code> or <code class="verbatim">C-w C-o</code>.</p>
        <h3 id="8d85dbe7-847c-43d0-b659-9056d93e7c0c">Moving Between Windows</h3>
        <p>While you can use the mouse to move the cursor around, eventually you'll want to learn to use keybindings instead. Trust me, it's nice.</p>
        <ol class="incremental">
            <li><p>Ace window</p>
                <p>You can use the <code class="verbatim">ace-window</code> packages' functionality to switch windows. Type <code class="verbatim">C-x o</code> or <code class="verbatim">C-w C-w</code> to run <code class="verbatim">ace-window</code>. If there are only two windows open, then it will move the cursor to the one that isn't currently active. If however, you have three or more windows open, <code class="verbatim">ace-window</code> will display letters at the top left of each buffer. Typing the letter displayed in a window will move the cursor to that window.</p>
                <p>This method is my preferred method of switching windows because it works regardless of what Evil state or Emacs major mode I'm in. It's also more direct. However, it does require some getting used to. As a beginner, you can't predict what letter you can use to switch to a window. Thus, in the beginning this method will often be slower then the next method I'll introduce to you.</p></li>
            <li><p>Evil window</p>
                <p>The next method uses <code class="verbatim">evil-window</code> keybindings. With <code class="verbatim">evil</code> navigation, in Normal State, you navigate the cursor one line up and down with <code class="verbatim">j</code> and <code class="verbatim">k</code>, and one character left and right with <code class="verbatim">h</code> and <code class="verbatim">l</code>.</p>
                <p>Using this familiar navigation method, you switch windows like this:</p>
                <ul class="incremental">
                    <li><code class="verbatim">SPC w l</code> or <code class="verbatim">C-w l</code> (<code class="verbatim">evil-window-right</code>), move the cursor one window to the right.</li>
                    <li><code class="verbatim">SPC w h</code> or <code class="verbatim">C-w h</code> (<code class="verbatim">evil-window-left</code>), move the cursor one window to the left.</li>
                    <li><code class="verbatim">SPC w j</code> or <code class="verbatim">C-w j</code> (<code class="verbatim">evil-window-down</code>), move the cursor one window down.</li>
                    <li><code class="verbatim">SPC w k</code> or <code class="verbatim">C-w k</code> (<code class="verbatim">evil-window-down</code>), move the cursor one window up.</li>
                </ul>
                <p>It's simple and effective. Even with experience, you may prefer it over using <code class="verbatim">ace-window</code>. However, as I said above, all of these shortcuts require you to be in Evil Normal State (<code class="verbatim">C-w</code> in Insert State is mapped to <code class="verbatim">evil-delete-backward-word</code>).</p></li>
        </ol>
        <h3 id="16be3f0f-0050-41cf-bc89-6cb7ae52d4b3">Moving Window Positions</h3>
        <p>The above commands move the <em>cursor</em> from one window to another. It's also possible to move a window from one position to another.</p>
        <ul class="incremental">
            <li><code class="verbatim">SPC w L</code> or <code class="verbatim">C-w L</code> (<code class="verbatim">+evil/window-move-right</code>)</li>
            <li><code class="verbatim">SPC w H</code> or <code class="verbatim">C-w H</code> (<code class="verbatim">+evil/window-move-left</code>)</li>
            <li><code class="verbatim">SPC w J</code> or <code class="verbatim">C-w J</code> (<code class="verbatim">+evil/window-move-down</code>)</li>
            <li><code class="verbatim">SPC w K</code> or <code class="verbatim">C-w K</code> (<code class="verbatim">+evil/window-move-up</code>)</li>
        </ul>
        <p>Technically, it's more like you are switching <em>buffers</em> between windows. What this means is that all windows maintain their current size; if you have one large window and one small window, if you run one of the above commands while the cursor is in the large window, the buffer in that window will appear in the smaller window</p>
        <h3 id="9d5b08b5-1c1f-48e0-89a4-fcadba71a3a1">Resizing Windows</h3>
        <p>You probably won't find yourself resizing windows very often. Sometimes Emacs will do some weird resizing of windows for certain actions (keep an eye out when using <code class="verbatim">sly-sticker-replay</code>, introduced in a later chapter) that you need to fix, you might want to dedicate a window to a certain buffer (such as the <code class="verbatim">org-agenda</code> buffer, introduced in a later chapter) and keep it open, and thus want to make the window smaller. Or maybe you really need to micro-adjust everything.</p>
        <p>You can use the mouse to resize windows (click and drag the border between windows). It's honestly not such a bad idea since it will likely be an infrequent activity. However, it's also possible to resize windows with keybindings.</p>
        <ul class="incremental">
            <li><code class="verbatim">C-x {</code> (<code class="verbatim">shrink-window-horizontally</code>) or <code class="verbatim">SPC w &gt;</code> or <code class="verbatim">C-w &gt;</code> (<code class="verbatim">evil-window-increase-width</code>).</li>
            <li><code class="verbatim">C-x }</code> (<code class="verbatim">enlarge-window-horizontally</code>) or <code class="verbatim">SPC w &lt;</code> or <code class="verbatim">C-w &lt;</code> (<code class="verbatim">evil-window-decrease-width</code>).</li>
            <li><code class="verbatim">SPC w +</code> or <code class="verbatim">C-w +</code> (<code class="verbatim">evil-window-increase-height</code>)</li>
            <li><code class="verbatim">SPC w -</code> or <code class="verbatim">C-w -</code> (<code class="verbatim">evil-window-decrease-height</code>)</li>
        </ul>
        <p>Each of the above commands will resize by one line or character. If you are in <code class="verbatim">evil</code> Normal State, you can type a number <code class="verbatim">n</code> and then run the command <code class="verbatim">n</code> times. In Normal State, typing <code class="verbatim">50 SPC w &gt;</code> will increase the window width by 50 characters.</p>
        <p>You can also make one window larger than all your other windows using <code class="verbatim">C-w o</code> or <code class="verbatim">SPC w o</code> (<code class="verbatim">doom/window-enlargen</code>).</p>
        <p>You can make all windows equal in size with <code class="verbatim">SPC w =</code> or <code class="verbatim">C-w =</code> (<code class="verbatim">balance-windows</code>).</p>
        <h3 id="5b7a2f05-ed8c-4406-a689-d9b79796e615">Undoing Changes</h3>
        <p>Undoing any change is simple: <code class="verbatim">C-w u</code> or <code class="verbatim">SPC w u</code> (<code class="verbatim">winner-undo</code>).</p>
        <p>This is useful not only for typos (for example, maybe you accidentally typed <code class="verbatim">C-x C-x a</code> and accidently closed all but one window) or for strange changes made by Emacs (sometimes closing a minibuffer drastically resizes other windows for no known reason), but also for intentional changes. For example, the above <code class="verbatim">doom/window-enlargen</code> command drastically resizes all windows. You can undo that change with <code class="verbatim">winner-undo</code>.</p>
        <p><code class="verbatim">winner-undo</code> no only undoes window resizes, but any changes to windows. If you accidentally closed a window, you can undo with <code class="verbatim">winner-undo</code>. If you move a window, you can undo the move. It's perhaps one of the most essential commands for beginners who are most likely to make mistakes or be faced with strange changes in window arrangements they weren't expecting.</p>
        <p>Of course, you can also run <code class="verbatim">winner-redo</code> with <code class="verbatim">C-w C-r</code> or <code class="verbatim">SPC w C-r</code></p>
        <h3 id="a53c1bbb-0e1c-432d-a612-56db3905b292">More About Windows</h3>
        <p>If you want to learn more about what's possible with windows, just type <code class="verbatim">C-w</code> and look at the list of commands available in the minibuffer.</p>
        <h3 id="57dab982-8c06-4831-94cc-74a3d7cef44a">Quick Reference Table</h3>
        <table>
            <thead>
                <tr>
                    <th>Action</th>
                    <th>Emacs Binding</th>
                    <th>Evil Binding</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>split window vertically</td>
                    <td>C-x 3</td>
                    <td>C-w C-v</td>
                </tr>
                <tr>
                    <td>split window horizontally</td>
                    <td>C-x 2</td>
                    <td>C-w C-s</td>
                </tr>
                <tr>
                    <td>kill window</td>
                    <td>C-x 0</td>
                    <td>C-w d</td>
                </tr>
                <tr>
                    <td>split window vertically</td>
                    <td>C-x 2</td>
                    <td>SPC w s</td>
                </tr>
                <tr>
                    <td>split window horizontally</td>
                    <td>C-x 3</td>
                    <td>SPC w v</td>
                </tr>
                <tr>
                    <td>delete window</td>
                    <td>C-x 0</td>
                    <td>SPC w d</td>
                </tr>
                <tr>
                    <td>close all except the currently selected window</td>
                    <td>C-x 1</td>
                    <td>C-w C-o</td>
                </tr>
                <tr>
                    <td>run ace-window</td>
                    <td>C-x o</td>
                    <td>C-w C-w</td>
                </tr>
                <tr>
                    <td>move the cursor one window to the right</td>
                    <td>C-w l</td>
                    <td>SPC w l</td>
                </tr>
                <tr>
                    <td>move the cursor one window to the left</td>
                    <td>C-w h</td>
                    <td>SPC w h</td>
                </tr>
                <tr>
                    <td>move the cursor one window down</td>
                    <td>C-w j</td>
                    <td>SPC w j</td>
                </tr>
                <tr>
                    <td>move the cursor one window up</td>
                    <td>C-w k</td>
                    <td>SPC w k</td>
                </tr>
                <tr>
                    <td>move window right</td>
                    <td>C-w L</td>
                    <td>SPC w L</td>
                </tr>
                <tr>
                    <td>move window left</td>
                    <td>C-w H</td>
                    <td>SPC w H</td>
                </tr>
                <tr>
                    <td>move window down</td>
                    <td>C-w J</td>
                    <td>SPC w J</td>
                </tr>
                <tr>
                    <td>move window up</td>
                    <td>C-w K</td>
                    <td>SPC w K</td>
                </tr>
                <tr>
                    <td>shrink window horizontally</td>
                    <td>C-x {</td>
                    <td>SPC w &gt; or C-w &gt;</td>
                </tr>
                <tr>
                    <td>enlarge window horizontally</td>
                    <td>C-x }</td>
                    <td>SPC w &lt; or C-w &lt;</td>
                </tr>
                <tr>
                    <td>increase window height</td>
                    <td></td>
                    <td>SPC w + or C-w +</td>
                </tr>
                <tr>
                    <td>decrease window height</td>
                    <td></td>
                    <td>SPC w - or C-w -</td>
                </tr>
                <tr>
                    <td>make one window larger than all your other windows</td>
                    <td>C-w o</td>
                    <td>SPC w o</td>
                </tr>
                <tr>
                    <td>make all windows equal in size</td>
                    <td>C-w =</td>
                    <td>SPC w =</td>
                </tr>
                <tr>
                    <td>undoing any change</td>
                    <td>C-w u</td>
                    <td>SPC w u</td>
                </tr>
                <tr>
                    <td>redoing any change</td>
                    <td>C-w C-r</td>
                    <td>SPC w C-r</td>
                </tr>
            </tbody>
        </table>
        <h2 id="6fffb271-e52e-4c02-83fc-6f17fa6418ca">PROJECT NAVIGATION &amp; MANAGEMENT</h2>
        <h3 id="cf8ea5db-7f08-40be-bca6-bf49142b8876">Buffer &amp; Window Management w/Projects</h3>
        <p>Beyond buffers and windows are projects–groups of buffers and windows related to a project. Using projects will provide the following benefits:</p>
        <ul class="incremental">
            <li>Project-focused <code class="verbatim">find-file</code> searches.</li>
            <li>Project-focused buffer switching/listing.</li>
            <li>Project-focused text searches.</li>
            <li>Project buffer saving.</li>
            <li>Project state saving/loading.</li>
            <li>Project switching.</li>
            <li>Project file tree view.</li>
        </ul>
        <p>And probably more I'm not aware of.</p>
        <h3 id="98c38620-411f-42a3-bbf8-5cf630fff3d9">Project-Related Packages</h3>
        <p>Project-level functionality is not the result of just a single package. Instead, it is the result of the coordination between several packages.</p>
        <ul class="incremental">
            <li><code class="verbatim">projectile</code> provides many of the functions like project-level file searching, project-wide file saving, project switching, etc.</li>
            <li><code class="verbatim">helm/ido/ivy/vertico</code> provide the project-level text search functionality.</li>
            <li><code class="verbatim">persp-mode</code> provides "workspaces" that can be saved and loaded.</li>
            <li><code class="verbatim">embark</code> enables project-wide text search-replace operations.</li>
        </ul>
        <p>Doom Emacs provides some abstractions over some of these modes, so some names could become confusing later.</p>
        <h3 id="824d150c-62ad-4ab3-8e84-23a6f3254473">Creating &amp; Removing Emacs Projects</h3>
        <p>To create a project:</p>
        <ul class="incremental">
            <li>Create an empty <code class="verbatim">.project</code> file in the project root directory.</li>
            <li>Type <code class="verbatim">SPC p a</code> (<code class="verbatim">project-add-known-project</code>), navigate to the project root directory and then type <code class="verbatim">Enter</code>.</li>
        </ul>
        <p>Now if you type <code class="verbatim">SPC p p</code> (<code class="verbatim">projectile-switch-project</code>) you will find your project in a list of projects you can open or switch to.</p>
        <h3 id="1772d2c8-8bd8-4fe1-8571-5afba76bbd34">Switching Between Projects</h3>
        <p>After creating and switching to a project, a small label at the bottom will appear with the name of the project (the name of the project root directory). That label is a <code class="verbatim">workspace</code>.</p>
        <p>If you have multiple projects open, you can switch between them via several means.</p>
        <ul class="incremental">
            <li><code class="verbatim">SPC TAB [</code> (<code class="verbatim">+workspace/switch-left</code>) to switch to the workspace to the right in the list of workspaces.</li>
            <li><code class="verbatim">SPC TAB ]</code> (<code class="verbatim">+workspace/switch-right</code>)</li>
            <li><code class="verbatim">SPC TAB .</code> (<code class="verbatim">+workspace/switch-to</code>) to choose from a list of open workspaces.</li>
            <li><code class="verbatim">SPC TAB &lt;number&gt;</code> Switch to the <code class="verbatim">nth</code> workspace.</li>
        </ul>
        <h3 id="e94a382b-65cf-415b-ac05-e8252307b91e">Saving &amp; Loading Project Workspaces</h3>
        <p>Workspaces are not strictly speaking exclusive to projects. A workspace can be created independent of projects using <code class="verbatim">SPC TAB n</code> (<code class="verbatim">+workspace/new</code>). If open some buffers, windows, etc. and then save the workspace with <code class="verbatim">SPC TAB s</code>, you can close the workspace and reopen it with <code class="verbatim">SPC TAB l</code>.</p>
        <p>If you have a complex setup that you want to save, the ability to save the state of your workspace is a useful feature.</p>
        <h3 id="29efc61f-9f08-43a8-85d2-c95c9b40d6ed">Saving Project Files</h3>
        <p>Once you have a project/workspace open and start editing, you may find several files in your project haven't been saved. This is especially true in Common Lisp projects where you update them by compiling files or individual functions–with no need to save the application files in order to update them in memory.</p>
        <p>To save all the files in your project, type <code class="verbatim">SPC p s</code> (<code class="verbatim">projectile-save-project-buffers</code>).</p>
        <h3 id="06dee006-aa37-4937-809e-c1c4bd8695ea">Switching Project Buffers</h3>
        <p>Using <code class="verbatim">C-x b</code> or <code class="verbatim">SPC b B</code> you can switch between <em>all</em> buffers. However, if you want switch between <em>project</em> buffers, you can use <code class="verbatim">C-c p b</code> or <code class="verbatim">SPC b b</code>. The exact function is called depends on the <code class="verbatim">:completion</code> library you chose in the <code class="verbatim">init.el</code> file when we first installed Doom Emacs.</p>
        <div class="sourceCode" id="cb170" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>:completion</span>
            <span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>company           <span class="co">; the ultimate code completion backend</span></span>
            <span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="co">;;helm              ; the *other* search engine for love and life</span></span>
            <span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a><span class="co">;;ido               ; the other *other* search engine...</span></span>
            <span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a><span class="co">;; ivy               ; a search engine for love and life</span></span>
            <span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>vertico           <span class="co">; the search engine of the future</span></span></code></pre></div>
        <p>I recommended vertico, but <code class="verbatim">helm</code>, <code class="verbatim">ido</code>, and <code class="verbatim">ivy</code> will all have similar functionality.</p>
        <p>The vertico command called is <code class="verbatim">+vertico/switch-workspace-buffer</code>.</p>
        <h3 id="eea4133d-ae84-4dae-896c-1306b71f3e43">Searching In Projects</h3>
        <p>There are two kinds of searches: filename searches and text searches.</p>
        <ol class="incremental">
            <li><p>Filename searches</p>
                <p>You can search for a file within your project using <code class="verbatim">SPC SPC</code> (<code class="verbatim">projectile-find-file</code>). Searching with the normal <code class="verbatim">find-file</code> begins with a view of files within a directory, then you need to navigate to the directory and file you want. With <code class="verbatim">projectile-find-file</code>, all files in your project root directory–including subdirectories–will be available to search.</p>
                <p>This is a very powerful feature allowing quick searching. If you know you have a file in <code class="verbatim">src/system/components/ui/button.lisp</code>, you can type <code class="verbatim">SPC SPC ui but Enter</code> and open the file without doing any scrolling or navigation of your filesystem.</p></li>
            <li><p>Project text search &amp; replace</p>
                <p>You can search for some text within the files of your project using <code class="verbatim">SPC /</code> (<code class="verbatim">+default/search-project</code>).</p>
                <p>While searching, you can type <code class="verbatim">C-c C-e</code> (<code class="verbatim">embark-export</code>) to export all the search matches to an <em>editable buffer</em>. Inside the buffer, you can type <code class="verbatim">Enter</code> on individual matches to go to the file to see context. In the Embark buffer, after editing the buffer, you can save changes to all of the files with <code class="verbatim">C-c C-c</code>, or discard changes with <code class="verbatim">C-c C-k</code>.</p></li>
        </ol>
        <h3 id="cfea9c32-468a-4d8a-9f8a-bb145c1392d8">Project Tree View</h3>
        <p><code class="verbatim">treemacs</code> provides a tree view of your project. Open it with <code class="verbatim">SPC o p</code> (<code class="verbatim">+treemacs/toggle</code>).</p>
        <ol class="incremental">
            <li><p>Switching to treemacs buffer</p>
                <p>If you have a treemacs buffer open and move away from it into another buffer, if you use <code class="verbatim">ace-window</code>, ace-window won't give you the option of switching to the treemacs buffer. You either need to use one of the <code class="verbatim">evil-window-</code> commands from the previous chapter, or toggle the treemacs buffer closed and reopen it.</p></li>
            <li><p>Opening Files</p>
                <p>In addition to using treemacs to browse your project, you can open files by typing <code class="verbatim">Enter</code> while highlighting a file.</p></li>
            <li><p>Renaming Files</p>
                <p>While highlighting a file, type <code class="verbatim">R</code> to rename it.</p>
                <p>The advantage of using treemacs to rename files is this: if the file is open in a buffer, treemacs will automatically (or in some cases, provide you the option to) rename <em>the open buffer for the file</em>, too. The other usual means of renaming files (<code class="verbatim">rename-file</code>) doesn't automatically rename the buffer.</p>
                <p>If you rename a directory, and you have files in the directory open in buffers, <em>those buffers will also be renamed</em>.</p></li>
            <li><p>Moving Files</p>
                <p>While highlighting a file, type <code class="verbatim">m</code> to move it. You will be asked where to move it.</p>
                <p>When you move a file that is currently open in a buffer, treemacs will ask if you want to delete the open buffer. If you don't delete it and save the buffer, you will recreate the file in the old location.</p>
                <p>Unfortunately, if you move a directory with files from that directory open in buffers, those buffers won't be renamed and you won't be prompted to kill them, so you will need to do that yourself.</p></li>
            <li><p>Deleting Files</p>
                <p>While highlighting a file or directory, type <code class="verbatim">d</code> to delete it. You'll be prompted to confirm you want to delete the file.</p>
                <p>Similarly for moving directories, if you have files open from a directory you delete, treemacs will not delete the buffers for you.</p></li>
            <li><p>Bulk Actions</p>
                <p>If you need to delete, copy, or move multiple files, you can type <code class="verbatim">M-m</code> to be given options for the currently highlighted file.</p></li>
        </ol>
        <h3 id="454a61f3-2d53-4db4-9d6a-422b31863a02">Quick Reference Table</h3>
        <table>
            <thead>
                <tr>
                    <th>Action</th>
                    <th>Emacs Binding</th>
                    <th>Evil Binding</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>add known project</td>
                    <td></td>
                    <td>SPC p a</td>
                </tr>
                <tr>
                    <td>switch project</td>
                    <td></td>
                    <td>SPC p p</td>
                </tr>
                <tr>
                    <td>switch workspace left</td>
                    <td></td>
                    <td>SPC TAB [</td>
                </tr>
                <tr>
                    <td>switch workspace right</td>
                    <td></td>
                    <td>SPC TAB ]</td>
                </tr>
                <tr>
                    <td>switch to workspace</td>
                    <td></td>
                    <td>SPC TAB .</td>
                </tr>
                <tr>
                    <td>switch to nth workspace</td>
                    <td></td>
                    <td>SPC TAB &lt;number&gt;</td>
                </tr>
                <tr>
                    <td>create new workspace</td>
                    <td></td>
                    <td>SPC TAB n</td>
                </tr>
                <tr>
                    <td>save workspace</td>
                    <td></td>
                    <td>SPC TAB s</td>
                </tr>
                <tr>
                    <td>load workspace</td>
                    <td></td>
                    <td>SPC TAB l</td>
                </tr>
                <tr>
                    <td>save all project buffers</td>
                    <td></td>
                    <td>SPC p s</td>
                </tr>
                <tr>
                    <td>switch between all buffers</td>
                    <td>C-x b</td>
                    <td>SPC b B</td>
                </tr>
                <tr>
                    <td>switch between project buffers</td>
                    <td>C-c p b</td>
                    <td>SPC b b</td>
                </tr>
                <tr>
                    <td>find file in project</td>
                    <td></td>
                    <td>SPC SPC</td>
                </tr>
                <tr>
                    <td>search text in project</td>
                    <td></td>
                    <td>SPC /</td>
                </tr>
                <tr>
                    <td>embark export</td>
                    <td>C-c C-e</td>
                    <td></td>
                </tr>
                <tr>
                    <td>save changes in embark buffer</td>
                    <td>C-c C-c</td>
                    <td></td>
                </tr>
                <tr>
                    <td>discard changes in embark buffer</td>
                    <td>C-c C-k</td>
                    <td></td>
                </tr>
                <tr>
                    <td>toggle treemacs</td>
                    <td></td>
                    <td>SPC o p</td>
                </tr>
                <tr>
                    <td>open file in treemacs</td>
                    <td>Enter</td>
                    <td>Enter</td>
                </tr>
                <tr>
                    <td>rename file in treemacs</td>
                    <td>R</td>
                    <td>R</td>
                </tr>
                <tr>
                    <td>move file in treemacs</td>
                    <td>m</td>
                    <td>m</td>
                </tr>
                <tr>
                    <td>delete file in treemacs</td>
                    <td>d</td>
                    <td>d</td>
                </tr>
                <tr>
                    <td>bulk actions in treemacs</td>
                    <td>M-m</td>
                    <td>M-m</td>
                </tr>
            </tbody>
        </table>
        <h2 id="learning-more">LEARNING MORE</h2>
        <p>Type <code class="verbatim">M-x</code> to open that minibuffer. Type <code class="verbatim">describe</code>. "Describing" is how you get more information about something in Emacs. This feature makes it "self-documenting".</p>
        <h3 id="9e43e4ee-44e4-406d-a75b-7d39aea43184"><code class="verbatim">describe-key</code></h3>
        <p><code class="verbatim">C-h k</code> will run the command <code class="verbatim">describe-key</code>. You will be prompted to enter a keybinding to describe.</p>
        <p>Type <code class="verbatim">SPC f f</code> in that prompt. It will tell you that the keybinding is for the <code class="verbatim">find-file</code> function and lots of other information. It will tell you if there are other keybindings, for example. You may prefer an <code class="verbatim">evil</code> binding or a Emacs binding.</p>
        <h3 id="4a29359e-36ae-4995-9056-f792b1e55085"><code class="verbatim">describe-mode</code></h3>
        <p><code class="verbatim">C-h m</code> will run the command <code class="verbatim">describe-mode</code>. This will provide detailed information about all of the modes that are active in a given buffer.</p>
        <h3 id="70718866-927c-4b9a-8516-10930d529f3f"><code class="verbatim">embark-bindings</code></h3>
        <p><code class="verbatim">C-h b b</code> will run the command <code class="verbatim">embark-bindings</code>. This will show all of the bindings available in the current buffer. Useful especially for discovering Evil keybindings that may only be one character long.</p>
        <h3 id="info"><code class="verbatim">info</code></h3>
        <p>Type <code class="verbatim">C-h i</code> or <code class="verbatim">SPC h i</code> (<code class="verbatim">info</code>) to open the Emacs manual.</p>
        <h1 id="ad0da37a-1b67-48b8-bee3-d27e59d67e0c">THE LISP IDE</h1>
        <h2 id="86fd9a38-f8f5-40d3-9419-ac517a1fed24">THE LISP CODING ENVIRONMENT</h2>
        <p>I've already introduced some essential functions and keybindings for coding Lisp in Emacs. Now that you have a basic knowledge of both Lisp and Emacs commands for coding in Lisp, it will be useful to gain a deeper knowledge of the Lisp IDE in Emacs.</p>
        <p>Common Lisp includes debugging functions like <code class="verbatim">trace</code>, <code class="verbatim">break</code>, etc. that allow you to do debugging directly in the REPL.</p>
        <p>However, there are Common Lisp IDEs that help improve the ergonomics of using the debugger. One of those IDEs is Sly, which was installed when we configured the <code class="verbatim">init.el</code> file to include <code class="verbatim">common-lisp</code> language support.</p>
        <h2 id="1fd93a4c-79a7-4670-a5ec-93da5f9b2f57">SLY BACKTRACE NAVIGATION</h2>
        <p>There are some functions within the Sly debugger that we can use for simple navigation. They all are prefixed with <code class="verbatim">sly-db-</code> and are discoverable if you run <code class="verbatim">embark-bindings</code> with <code class="verbatim">SPC h b b</code> or <code class="verbatim">C-h b b</code>. We'll look at a few of them here.</p>
        <h3 id="43ddafb1-34bc-463b-94bc-2d46a1c3e218"><code class="verbatim">sly-db-up</code> &amp; <code class="verbatim">sly-db-down</code></h3>
        <p>Move the cursor up or down the stack in the backtrace with <code class="verbatim">C-k</code> and <code class="verbatim">C-j</code>. If the cursor is not highlighting any frames in the stack, the cursor will first move to the top frame if you run <code class="verbatim">sly-db-down</code>.</p>
        <h3 id="3a364e73-6819-45cc-b651-39c5a996bda8"><code class="verbatim">sly-db-toggle-details</code></h3>
        <p>With the cursor over a stack frame in the backtrace, type <code class="verbatim">t</code> to show any local variables and bindings, arguments passed, etc.</p>
        <h3 id="f42bf219-52d3-4403-bd0f-d82af8da697d"><code class="verbatim">sly-db-show-frame-source</code></h3>
        <p>If you bring the cursor over a stack frame in the backtrace and press the <code class="verbatim">v</code> key, Sly will open the source code file for that line in the backtrace and briefly highlight the exact form that executed in that frame. Useful for navigating straight to possible sources of error.</p>
        <h3 id="550361e5-a2aa-4a49-8aed-97c1c7bc6c80"><code class="verbatim">sly-db-details-up</code> &amp; <code class="verbatim">sly-db-details-down</code></h3>
        <p>These will do all three functions above: move the cursor to a stack from in the backtrace, toggle open/close the details for that frame, open the source for the frame in a different window, and highlight the form in that source. The bindings are <code class="verbatim">M-p</code> and <code class="verbatim">M-n</code> (or <code class="verbatim">M-k</code> and <code class="verbatim">M-j</code> if you prefer more Evilly bindings consistent with the ones above for the normal up and down commands).</p>
        <h2 id="d40f124b-fb62-4f7d-af29-7f2951f442f1">TRACING</h2>
        <p>Beyond simple navigation within the debugger is actual debugging methods and tools.</p>
        <p>Tracing is a debugging method that shows a form as it is called and then what it returns. Tracing is typically used for recursive functions.</p>
        <h3 id="e4941ddf-01d3-4e98-8a98-353a966aa360"><code class="verbatim">sly-fancy-trace</code></h3>
        <p>Let's say you have this function:</p>
        <div class="sourceCode" id="cb171" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> factorial </span>(n)</span>
            <span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Compute factorial using linear recursion.&quot;</span></span>
            <span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (<span class="op">=</span> n <span class="dv">1</span>)</span>
            <span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span></span>
            <span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>      (<span class="op">*</span> n (factorial (<span class="op">-</span> n <span class="dv">1</span>)))))</span></code></pre></div>
        <p>You can run <code class="verbatim">trace</code> on a function in Emacs like this:</p>
        <div class="sourceCode" id="cb172" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">trace</span> factorial)</span></code></pre></div>
        <p>…or by highlighting a function name symbol and typing <code class="verbatim">C-c M-t</code> for <code class="verbatim">sly-fancy-trace</code>.</p>
        <p>If you use fancy tracing on <code class="verbatim">factorial</code> above, you will get output like this in the REPL:</p>
        <pre class="example"><code>0: (FACTORIAL 5)
  1: (FACTORIAL 4)
    2: (FACTORIAL 3)
      3: (FACTORIAL 2)
        4: (FACTORIAL 1)
        4: FACTORIAL returned 1
      3: FACTORIAL returned 2
    2: FACTORIAL returned 6
  1: FACTORIAL returned 24
0: FACTORIAL returned 120
        </code></pre>
        <h3 id="437fdf94-bd91-43eb-8fb6-f6334993dc64"><code class="verbatim">sly-trace-dialog-toggle-trace</code></h3>
        <p>Alternatively, you can trace using <code class="verbatim">sly-trace-dialog-toggle-trace</code> via <code class="verbatim">C-c C-t</code> or <code class="verbatim">SPC m T T</code>. The difference is that fancy trace will show the trace in the REPL, whereas the trace dialog toggle requires you to open the trace dialog with <code class="verbatim">C-c T</code>.</p>
        <p>If you use the trace dialog, you get output like this:</p>
        <pre class="example"><code>0 - factorial
  | &gt; 5 (3 bits, #x5, #o5, #b101)
  | &lt; 120 (7 bits, #x78, #o170, #b1111000)
1 `--- factorial
     | &gt; 4 (3 bits, #x4, #o4, #b100)
     | &lt; 24 (5 bits, #x18, #o30, #b11000)
2    `--- factorial
        | &gt; 3 (2 bits, #x3, #o3, #b11)
        | &lt; 6 (3 bits, #x6, #o6, #b110)
3       `--- factorial
           | &gt; 2 (2 bits, #x2, #o2, #b10)
           | &lt; 2 (2 bits, #x2, #o2, #b10)
4          `--- factorial
                &gt; 1 (1 bit, #x1, #o1, #b1)
                &lt; 1 (1 bit, #x1, #o1, #b1)
        </code></pre>
        <p>You can <code class="verbatim">untrace</code> the function when you're done either with the Lisp function or by using the same commands above in Emacs.</p>
        <h2 id="f6a4fdc2-7295-4bfa-8551-f5cf4e242ee7">STICKERS</h2>
        <p>Where Sly's debugging capabilities really shine is with <code class="verbatim">stickers</code>. Stickers are basically a replacement for <code class="verbatim">print</code> and <code class="verbatim">break</code> functions</p>
        <h3 id="385f8620-64de-4a9c-ae47-f754dda5be3d"><code class="verbatim">sly-stickers-dwim</code></h3>
        <p>Let's say we have the following code:</p>
        <div class="sourceCode" id="cb175" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> do-some-math </span>(num)</span>
            <span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>  (<span class="op">/</span> (<span class="op">+</span> num (<span class="op">*</span> num num num) (<span class="op">-</span> num <span class="dv">10</span> num)) <span class="dv">7</span>))</span>
            <span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>(do-some-math <span class="dv">9</span>)</span>
            <span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
        <p>And you're thinking, "Hmm, I wonder what the result of that addition was?"</p>
        <p>You could wrap it in <code class="verbatim">print</code>. Or you could use a sticker. Highlight the opening parenthesis of the addition form then use <code class="verbatim">sly-stickers-dwim</code> via <code class="verbatim">C-c C-s C-s</code> or <code class="verbatim">SPC m s s</code> to place a sticker on it. After placing the sticker, you need to recompile the function (<code class="verbatim">C-c C-c</code>) to "arm" the sticker.</p>
        <h3 id="6eeb5339-e061-41ce-a86a-b66fd9f9139a"><code class="verbatim">sly-stickers-replay</code></h3>
        <p>With the sticker armed, when you run the function, the return value of the form you placed the sticker on will be recorded. You can view the recording with <code class="verbatim">sly-stickers-replay</code> using <code class="verbatim">C-c C-s C-r</code> or <code class="verbatim">SPC m s r</code>.</p>
        <h3 id="fb4e4631-358c-4610-8eb3-16ee4d6bacef"><code class="verbatim">sly-stickers-toggle-break-on-stickers</code> &amp; <code class="verbatim">sly-db-step</code></h3>
        <p>You can also configure Sly to break when computation reaches the sticker using <code class="verbatim">sly-stickers-toggle-break-on-stickers</code> via <code class="verbatim">SPC m s b</code>. During computation, when a sticker is reached, the debugger will open with a message like this:</p>
        <pre class="example"><code>#&lt;JUST BEFORE #&lt;STICKER id=145 hit-count=1&gt;&gt;
   [Condition of type SLYNK-STICKERS::JUST-BEFORE-STICKER]
        </code></pre>
        <p>The sticker will also flash in the source code file window. Useful for when you have multiple stickers and need to know which one you're looking at.</p>
        <p>If you choose the <code class="verbatim">CONTINUE</code> restart (either via <code class="verbatim">c</code> or <code class="verbatim">0</code> or navigating to <code class="verbatim">[CONTINUE]</code> and typing <code class="verbatim">Enter</code>) or you use <code class="verbatim">sly-db-step</code> via <code class="verbatim">s</code> in the debugger window, you will see a message like this:</p>
        <pre class="example"><code>#&lt;RIGHT-AFTER #&lt;STICKER id=255 hit-count=2&gt; (recorded #&lt;RECORDING 1 values&gt;)&gt;
   [Condition of type SLYNK-STICKERS::RIGHT-AFTER-STICKER]
        </code></pre>
        <p>…and the return value of the form where the sticker is placed.</p>
        <h3 id="24226382-b316-47bf-a357-f6000b321394"><code class="verbatim">sly-stepper</code></h3>
        <p>If you are having trouble tracking down the exact location of your error, you can perform a comprehensive sweep using <code class="verbatim">sly-stepper</code> with <code class="verbatim">C-c C-s P</code>. That will apply stickers to every form inside a function. After running <code class="verbatim">sly-stepper</code>, compile the function to arm the stickers.</p>
        <p><code class="verbatim">sly-stickers-replay</code> is especially useful because, like with the breaking option, it will open the source code file and flash the exact sticker whose value it's displaying. You can also navigate to the next sticker with <code class="verbatim">n</code>, <em>or the previous one</em> with <code class="verbatim">p</code>. Every time you move forward or backward in the replay, the stickers will flash. This makes a bit easier to follow the control flow of the code.</p>
        <h1 id="f1e80a27-77cc-4993-b7a7-25bd811cafd8">STRUCTURED EDITING</h1>
        <h2 id="ae9518a5-72f1-4949-a44b-881017d25877">RESTRUCTURING CODE WITH EASE</h2>
        <p>Writing Lisp code often involves moving forms around or wrapping forms in new forms. If you're using <code class="verbatim">lispy-mode</code> or <code class="verbatim">lispyville-mode</code>–both turned on with Doom's <code class="verbatim">lispy</code> config in the <code class="verbatim">init.el</code> file–you can more easily build out and modify Lisp code.</p>
        <h3 id="04fd67d1-8148-4f04-8d6a-797210424efe">Slurping and barfing</h3>
        <p>Slurping and barfing are terms for describing moving parentheses to either include or exclude forms from other forms. Let me show you what I mean.</p>
        <p>In the tic-tac-toe project, we wrote code to find positions on the board to win or block the opponent's win. To begin, we wrote this:</p>
        <div class="sourceCode" id="cb178" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet) (<span class="op">=</span> <span class="dv">20</span> (sum-triplet *test-board* triplet))) *triplets*)</span></code></pre></div>
        <p>This finds any triplet that sums to 20 on the board. But we then wanted to search the result of that <code class="verbatim">find-if</code> form to search for the empty space in the triplet.</p>
        <div class="sourceCode" id="cb179" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (element) (<span class="op">=</span> (<span class="kw">nth</span> element board) <span class="dv">0</span>))</span>
            <span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet) (<span class="op">=</span> <span class="dv">20</span> (sum-triplet *test-board* triplet))) *triplets*))</span></code></pre></div>
        <p>If you use structural editing, this can actually be difficult at first. You might naturally try to write the code like this:</p>
        <div class="sourceCode" id="cb180" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (element) (<span class="op">=</span> (<span class="kw">nth</span> element board) <span class="dv">0</span>)))</span>
            <span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet) (<span class="op">=</span> <span class="dv">20</span> (sum-triplet *test-board* triplet))) *triplets*)</span></code></pre></div>
        <p>And then, in order to wrap the bottom <code class="verbatim">find-if</code> form with the top <code class="verbatim">find-if</code> form, you might try to delete the final parenthesis of the top <code class="verbatim">find-if</code> and then move it to the end of the bottom <code class="verbatim">find-if</code> form:</p>
        <div class="sourceCode" id="cb181" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (element) (<span class="op">=</span> (<span class="kw">nth</span> element board) <span class="dv">0</span>)) <span class="co">; deleted paren</span></span>
            <span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet) (<span class="op">=</span> <span class="dv">20</span> (sum-triplet *test-board* triplet))) *triplets*)) <span class="co">; added paren</span></span></code></pre></div>
        <p>What actually happens, however, is that the entire top <code class="verbatim">find-if</code> form is deleted when you try to delete just the last parenthesis! This very confusing behavior is from <code class="verbatim">lispy-mode</code>. It is designed to keep parentheses balanced at all times.</p>
        <p>If you want to move only one parenthesis, then, what do you do?</p>
        <p>One option would be to <code class="verbatim">kill</code> the <code class="verbatim">find-if</code> form intended to become the inner form…</p>
        <div class="sourceCode" id="cb182" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (element) (<span class="op">=</span> (<span class="kw">nth</span> element board) <span class="dv">0</span>)) <span class="co">; bottom form killed</span></span></code></pre></div>
        <p>and then paste it at the end of the outer <code class="verbatim">find-if</code>…</p>
        <div class="sourceCode" id="cb183" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (element) (<span class="op">=</span> (<span class="kw">nth</span> element board) <span class="dv">0</span>)) (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet) (<span class="op">=</span> <span class="dv">20</span> (sum-triplet *test-board* triplet))) *triplets*))</span></code></pre></div>
        <p>and then move the cursor to the beginning parenthesis of the inner <code class="verbatim">find-if</code> and press <code class="verbatim">ENTER</code> to place it on a new line.</p>
        <div class="sourceCode" id="cb184" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (element) (<span class="op">=</span> (<span class="kw">nth</span> element board) <span class="dv">0</span>))</span>
            <span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet) (<span class="op">=</span> <span class="dv">20</span> (sum-triplet *test-board* triplet))) *triplets*))</span></code></pre></div>
        <p>This is okay, but there is an even easier method called <code class="verbatim">slurping</code>.</p>
        <p>Start with this code:</p>
        <div class="sourceCode" id="cb185" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (element) (<span class="op">=</span> (<span class="kw">nth</span> element board) <span class="dv">0</span>)))</span>
            <span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triplet) (<span class="op">=</span> <span class="dv">20</span> (sum-triplet *test-board* triplet))) *triplets*)</span></code></pre></div>
        <p>Place the cursor on the last parenthesis of the top form. While still in Evil Normal mode (not Insert mode), press <code class="verbatim">&gt;</code> (the <code class="verbatim">lispyville-mode</code> keybinding for <code class="verbatim">lispyville-slurp</code>). The parenthesis will move to the <strong>end</strong> of the bottom <code class="verbatim">find-if</code> form, making it an inner nested form.</p>
        <p>Slurping is especially useful for any time you need to "build out" from some code. Consider this:</p>
        <div class="sourceCode" id="cb186" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triple)</span>
            <span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>             (<span class="op">=</span> (sum-triple *test-board* triple) target-sum))</span>
            <span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>         *triples*)</span></code></pre></div>
        <p>This is how we started building out the code for detecting squeezes. But then we realized that we needed to add more conditions. For a strategy to be a squeeze, the triplet need to sum to the target, <strong>and</strong> it needs to be diagonal as well as some other conditions. That means that we needed to wrap several predicate functions in an <code class="verbatim">and</code> form.</p>
        <div class="sourceCode" id="cb187" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; These need to be wrapped in an (and ...) form</span></span>
            <span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>(<span class="op">=</span> (sum-triple board triple) target-sum)</span>
            <span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>(diagonal-p triple)</span></code></pre></div>
        <p>We can do that by first writing the <code class="verbatim">and</code> form before the other two forms:</p>
        <div class="sourceCode" id="cb188" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">and</span>) (<span class="op">=</span> (sum-triple board triple) target-sum)</span>
            <span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>(diagonal-p triple)</span></code></pre></div>
        <p>Put the Evil Normal-mode cursor on the end paren of the <code class="verbatim">and</code> form, and then <code class="verbatim">slurp</code> up the other two forms.</p>
        <div class="sourceCode" id="cb189" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">and</span> (<span class="op">=</span> (sum-triple board triple) target-sum)</span>
            <span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>     (diagonal-p triple))</span></code></pre></div>
        <p>Once we added the rest of the conditions, we wanted to then bind the return value of the <code class="verbatim">find-if</code> form to a local variable using <code class="verbatim">let</code>. The process looks like this:</p>
        <div class="sourceCode" id="cb190" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Write the LET and variable we want in the LET.</span></span>
            <span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; let               Finished find-if</span></span>
            <span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((squeeze-p))) (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triple)</span>
            <span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">and</span> (<span class="op">=</span> (sum-triple board triple) target-sum)</span>
            <span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>                  (diagonal-p triple)</span>
            <span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>                  (<span class="kw">not</span> (human-in-middle-p board))</span>
            <span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>                  (side-empty-p board)))</span>
            <span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>         *triples*)</span></code></pre></div>
        <p>Then use <code class="verbatim">lispyville-slurp</code> on the three ending parentheses of the <code class="verbatim">let</code> form to complete the new form.</p>
        <p>After adding an <code class="verbatim">if</code> form, we need to make this a function, so we can write the function definition above the entire <code class="verbatim">let</code> form:</p>
        <div class="sourceCode" id="cb191" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> detect-squeeze </span>(board target-sum))</span>
            <span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((squeeze-p</span>
            <span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (triple)</span>
            <span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>                     (<span class="kw">and</span> (<span class="op">=</span> (sum-triple board triple) target-sum)</span>
            <span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>                          (diagonal-p triple)</span>
            <span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>                          (<span class="kw">not</span> (human-in-middle-p board))</span>
            <span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>                          (side-empty-p board)))</span>
            <span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>                 *triples*)))</span>
            <span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> squeeze-p</span>
            <span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>      (find-empty-position board *sides*)))</span></code></pre></div>
        <p>And then just slurp up the entire <code class="verbatim">let</code> into the <code class="verbatim">defun</code> form.</p>
        <p>Again, you <em>could</em> just <code class="verbatim">kill</code> and <code class="verbatim">paste</code> the forms around, but killing can sometimes be dangerous (if you kill a word using <code class="verbatim">M-backspace</code>, you've just replaced your function in the kill-ring). It's nicer to simply keep the code on the screen and using slurp to do what you want.</p>
        <p>The reverse of <code class="verbatim">slurp</code> is <code class="verbatim">barf</code>, bound to <code class="verbatim">&lt;</code> in Doom Emacs <code class="verbatim">lispyville-mode</code>. I don't find it nearly as useful as slurping, but maybe you can find a use for it.</p>
        <h3 id="14823514-1e02-448d-8e85-5dc11a3ee23b">Dragging forms forward/backward</h3>
        <p>Another operation you'll probably want to do a lot is move forms around. For example, maybe you wrote this:</p>
        <div class="sourceCode" id="cb192" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> choose-move </span>(board)</span>
            <span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">or</span> (make-three-in-a-row board)</span>
            <span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>      (block-opponent-win board)</span>
            <span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>      (take-random-position board)</span>
            <span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>      (block-two-on-one-play board)</span>
            <span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>      (block-squeeze-play board)))</span></code></pre></div>
        <p>Then you realized that the <code class="verbatim">block-two-on-one</code> and <code class="verbatim">block-squeeze-play</code> strategies need to take higher priority over all but the <code class="verbatim">make-three-in-a-row</code> strategy. You could, of course, kill/paste them into the proper position. But if you want, you can also use <code class="verbatim">lispyville-drag-backward</code>–bound to <code class="verbatim">M-k</code>–while the cursor is on the opening parentheses of the <code class="verbatim">block-</code> forms to move them. <code class="verbatim">lispyville-drag-forward</code>–bound to <code class="verbatim">M-j</code>–goes in the opposite direction.</p>
        <p>They also work on individual symbols. For example, let's say you have a call to <code class="verbatim">nth</code>:</p>
        <div class="sourceCode" id="cb193" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">nth</span> <span class="dv">4</span> my-list)</span></code></pre></div>
        <p>But then you decide you want to use <code class="verbatim">member</code> instead.</p>
        <div class="sourceCode" id="cb194" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">member</span> <span class="dv">4</span> my-list)</span></code></pre></div>
        <p>Unfortunately, you now need to switch the location of 4 and <code class="verbatim">my-list</code> in the arguments to <code class="verbatim">member</code>. Fortunately, you can use <code class="verbatim">lispyville-drag-</code> functions for that, too. Place the cursor over the 4 and use <code class="verbatim">lispyville-drag-forward</code> (<code class="verbatim">M-j</code>) to switch the 4 and <code class="verbatim">my-list</code>.</p>
        <h2 id="9eeb06ce-babb-4ccc-8bae-55fde79b93fb">NAVIGATING THE SEA OF PARENTHESES</h2>
        <p>Navigation is an important topic in Emacs. When programming Lisp in Doom Emacs, you have additional navigation options that can dramatically speed up your development flow.</p>
        <h3 id="e2d08305-4237-499d-86e4-2c600dc85636">Generic searching</h3>
        <p>Doom Emacs comes with a function called <code class="verbatim">+default/search-buffer</code>, bound to <code class="verbatim">SPC s s</code>, that you can use in any mode to search for some text. This is an essential tool for navigation.</p>
        <h3 id="64be7f00-c69f-4582-92cf-a603f2cabd20">Tab navigation</h3>
        <p>When your Normal mode cursor is on a parenthesis, if you press <code class="verbatim">TAB</code> the cursor will move to the matching parenthesis on the other side. This is actually a more general function called <code class="verbatim">evil-jump-item</code>.</p>
        <p><code class="verbatim">+default/search-buffer</code> will only move the cursor to the <em>first</em> instance of some text on a line. It's often quicker to tab to the "cattail" at the end of a Lisp form, move the cursor to another parenthesis, and then tab to the matching parenthesis on the other side to get closer to the text you're navigating to.</p>
        <h2 id="a71177a4-13a1-4fa1-8d53-1f94655bbf51">MORE RESTRUCTURING &amp; NAVIGATING TOOLS</h2>
        <p>Remember that you can get more information about the keybindings available in the buffer using either <code class="verbatim">M-x describe-key</code> (<code class="verbatim">SPC h k</code>), <code class="verbatim">M-x describe-mode</code> (<code class="verbatim">SPC h m</code>), and <code class="verbatim">M-x embark-bindings</code> (<code class="verbatim">SPC h b b</code>). Look into the <code class="verbatim">lispy-</code>, <code class="verbatim">lispyville-</code>, and <code class="verbatim">special-lispy-</code> commands and their keybindings.</p>
        <h1 id="66b10de4-0a51-40b9-a1ad-9409ee091aba">BEYOND LISTS</h1>
        <h2 id="cd623563-5cd0-49a0-aa09-e6e400bd7453">OOP</h2>
        <h3 id="0de43b4b-5995-42c7-aa9f-3dbe6bb0e1a8">What are Common Lisp classes?</h3>
        <p><code class="verbatim">Classes</code> are user-defined data types that group related data. Unlike the OOP systems found elsewhere, Common Lisp classes don't package data and an API for acting on that data together in the same module. Instead, classes define types of data that can be targeted or specialized for by <code class="verbatim">typecase</code> forms and generic functions/methods.</p>
        <h3 id="1c8c2edf-97df-42f2-b991-6899bc920585">Class Basics</h3>
        <div class="sourceCode" id="cb195" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> creature </span>()</span>
            <span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>  ((name :initarg <span class="bu">:name</span></span>
            <span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>         :initform <span class="kw">nil</span></span>
            <span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>         :accessor creature-name)</span>
            <span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>   (territory :initarg :territory</span>
            <span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>              :initform <span class="st">&quot;Earth&quot;</span></span>
            <span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>              :accessor creature-territory)))</span></code></pre></div>
        <p>This is the basic structure of a class definition. <code class="verbatim">defclass</code> takes at least three arguments: a name, a list of classes to inherit from, and <code class="verbatim">slot</code> definitions.</p>
        <p>Use <code class="verbatim">make-instance</code> to make an instance of the class.</p>
        <div class="sourceCode" id="cb196" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-instance</span> <span class="dt">&#39;creature</span> <span class="bu">:name</span> <span class="st">&quot;Cat&quot;</span>)</span></code></pre></div>
        <p>Slot definitions can take a number of options. The essentials are:</p>
        <ol class="incremental">
            <li><p><code class="verbatim">:initargs</code></p>
                <p>Defines the keyword argument used for setting the slot's value when creating an instance of the class.</p>
                <div class="sourceCode" id="cb197" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *cat* </span>(<span class="kw">make-instance</span> <span class="dt">&#39;creature</span> <span class="bu">:name</span> <span class="st">&quot;Cat&quot;</span>))</span></code></pre></div></li>
            <li><p><code class="verbatim">:initform</code></p>
                <p>Defines the default value of the slot if none is provided at the time of instantiation.</p>
                <div class="sourceCode" id="cb198" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>(creature-territory *cat*)</span>
                    <span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Earth&quot;</span></span></code></pre></div>
                <p>When a class <code class="verbatim">inherits</code> from another class, its definition includes everything in the superclass plus the additional slots it's own definition includes. You can also overwrite the definition of a superclass's slot.</p>
                <div class="sourceCode" id="cb199" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> person </span>(creature)</span>
                    <span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>  ((name :initarg :creature-name</span>
                    <span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>         :initform <span class="st">&quot;John Doe&quot;</span></span>
                    <span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>         :accessor person-name)</span>
                    <span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>   (marrital-status :initarg :marrital-status</span>
                    <span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a>                    :initform :single</span>
                    <span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a>                    :accessor marrital-status)))</span>
                    <span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *john-doe* </span>(<span class="kw">make-instance</span> <span class="dt">&#39;person</span> :marrital-status :married))</span>
                    <span id="cb199-10"><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb199-11"><a href="#cb199-11" aria-hidden="true" tabindex="-1"></a>(person-name *john-doe*)</span>
                    <span id="cb199-12"><a href="#cb199-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;John Doe&quot;</span></span></code></pre></div></li>
            <li><p><code class="verbatim">:accessor</code></p>
                <p>Defines the <em>generic method</em> that can be used to both access and modify the slot's value.</p>
                <div class="sourceCode" id="cb200" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>(creature-name *cat*)</span>
                    <span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Cat&quot;</span></span>
                    <span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (creature-name *cat*) <span class="st">&quot;Tiger&quot;</span>)</span>
                    <span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>(creature-name *cat*)</span>
                    <span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Tiger&quot;</span></span></code></pre></div>
                <p>Because accessors are generic methods specialized on instances of the class that defines them, two classes can define accessors with the same name without any conflicts.</p>
                <p>In practice, you'll often see accessors that follow a <code class="verbatim">&lt;class-name&gt;-&lt;slot-name&gt;</code> convention for clarity.</p></li>
            <li><p><code class="verbatim">:reader</code> &amp; <code class="verbatim">:writer</code></p>
                <p>Usually you want an accessor–a method that allows you to both read and write to a slot. In some cases, as in condition definitions, you may want to only allow the program to read from a slot. In that case, you can replace <code class="verbatim">:accessor</code> with <code class="verbatim">:reader</code>.</p></li>
        </ol>
        <h3 id="537c8eca-8d5b-4817-9f68-1721e6ee57ca">Custom Constructors</h3>
        <p>While you can manually called <code class="verbatim">make-instance</code> all the time, it's common to define a custom constructor for objects.</p>
        <div class="sourceCode" id="cb201" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> make-creature </span>(name territory)</span>
            <span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">make-instance</span> <span class="dt">&#39;creature</span> <span class="bu">:name</span> name :territory territory))</span></code></pre></div>
        <p>In addition to reducing typing in the simple case, custom constructors are also where you can filter input, add type-checking with <code class="verbatim">etypecase</code>, modify data before making an instance, etc.</p>
        <h3 id="704e9a08-cb81-44ea-9bb9-b9d4e1eccb44">Generic Functions &amp; Methods</h3>
        <p>Classes describe what an object <em>has</em>, but they don't say anything about what an object <em>does</em>. That's because in Common Lisp, <em>classes</em> don't have <code class="verbatim">methods</code>; <em>generic functions</em> have methods.</p>
        <div class="sourceCode" id="cb202" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> person </span>()</span>
            <span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>  ((name :initarg <span class="bu">:name</span> :initform <span class="kw">nil</span> :accessor person-name)))</span>
            <span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defgeneric</span><span class="fu"> greet </span>(instance))</span>
            <span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> greet </span>((this person))</span>
            <span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Hello, ~a~%&quot;</span> (person-name this)))</span>
            <span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *john-doe* </span>(<span class="kw">make-instance</span> <span class="dt">&#39;person</span> <span class="bu">:name</span> <span class="st">&quot;John Doe&quot;</span>))</span>
            <span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a>(greet *john-doe*)</span>
            <span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Hello, John Doe</span></span>
            <span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; NIL</span></span></code></pre></div>
        <p><code class="verbatim">defgeneric</code> defines a generic function. Generic functions define an interface for, and then dispatch to, <code class="verbatim">generic methods</code>. <code class="verbatim">greet</code> defines an interface: it only requires an instance of a class. When a call to <code class="verbatim">greet</code> is made, it looks at the object instance passed and dispatches to the method specialized on that generic function.</p>
        <h3 id="bf26599a-976b-4224-81b5-124ec86b7dbe">Extending OOP Systems</h3>
        <p>Every generic method can be wrapped in code that will modify its behavior before it's called, after it's called, or both ("around"). Methods can be specialized on more than one type. A method call is sent to the method that is most "specific"–the method that specializes on types that are closest to the ones passed to the method as argument. A more specific method can call the next less specific method in a chain of methods.</p>
        <p>Method combination is a technique that involves chaining together some mixture of the above techniques. Extending an OOP system in Common Lisp will involve some degree of method combination.</p>
        <h3 id="6287d8b9-7440-4dbb-a530-0fe71e4d806e">Before, After, &amp; Around Methods</h3>
        <p>Before, after, and around methods are methods that modify the behavior of a method–called the primary method–at certain points in the method call.</p>
        <div class="sourceCode" id="cb203" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> greet </span>:before ((this person))</span>
            <span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Oh, what a nice looking young man. Let me go talk to him...~%&quot;</span>))</span>
            <span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>(greet *john-doe*)</span>
            <span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Oh, what a nice looking young man. Let me go talk to him...</span></span>
            <span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Hello, John Doe</span></span>
            <span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; NIL</span></span>
            <span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb203-8"><a href="#cb203-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> greet </span>:after ((this person))</span>
            <span id="cb203-9"><a href="#cb203-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;(Strong handshake, good man.)~%&quot;</span>))</span>
            <span id="cb203-10"><a href="#cb203-10" aria-hidden="true" tabindex="-1"></a>(greet *john-doe*)</span>
            <span id="cb203-11"><a href="#cb203-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Oh, what a nice looking young man. Let me go talk to him...</span></span>
            <span id="cb203-12"><a href="#cb203-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Hello, John Doe</span></span>
            <span id="cb203-13"><a href="#cb203-13" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; (Strong handshake, good man.)</span></span>
            <span id="cb203-14"><a href="#cb203-14" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; NIL</span></span></code></pre></div>
        <p>Before and after methods are fairly self explanatory. Primary methods are the core of the onion; before and after methods are two layers around the core.</p>
        <p>After methods are a layer outside of before and after methods.</p>
        <div class="sourceCode" id="cb204" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> greet </span>:around ((this person))</span>
            <span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;I should get off the couch and go talk to people.&quot;</span>))</span>
            <span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>(greet *john-doe*)</span>
            <span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a><span class="co">; I should get off the couch and go talk to people. =&gt; NIL</span></span></code></pre></div>
        <p>However, they require extra work to use.</p>
        <div class="sourceCode" id="cb205" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> greet </span>:around ((this person))</span>
            <span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;I should get off the couch and go talk to people.&quot;</span>)</span>
            <span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call-next-method</span>)</span>
            <span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;Here&#39;s my card, ~a. Let me know if you need help learning Lisp.&quot;</span> (person-name this)))</span>
            <span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>(greet *john-doe*)</span>
            <span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a><span class="co">; I should get off the couch and go talk to people.</span></span>
            <span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a><span class="co">; Oh, what a nice looking young man. Let me go talk to him...</span></span>
            <span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a><span class="co">; Hello, John Doe</span></span>
            <span id="cb205-9"><a href="#cb205-9" aria-hidden="true" tabindex="-1"></a><span class="co">; (Strong handshake, good man.)</span></span>
            <span id="cb205-10"><a href="#cb205-10" aria-hidden="true" tabindex="-1"></a><span class="co">; Here&#39;s my card, John Doe. Let me know if you need help learning Lisp. =&gt; NIL</span></span></code></pre></div>
        <p><code class="verbatim">call-next-method</code> calls the next most specific version of <code class="verbatim">greet</code> for the <code class="verbatim">*john-doe*</code> object, which is the before method. The before method automatically calls the next method–the primary method–so we don't have to call <code class="verbatim">call-next-method</code> in it. Same goes for the around method.</p>
        <p>Since <code class="verbatim">call-next-method</code> works by calling the next most specific method, it can be used to chain together methods in other ways.</p>
        <div class="sourceCode" id="cb206" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> smart-person </span>(person) ())</span>
            <span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> rich-person </span>(person) ())</span>
            <span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> dumb-person </span>(person) ())</span>
            <span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> poor-person </span>(person) ())</span>
            <span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *musk* </span>(<span class="kw">make-instance</span> <span class="dt">&#39;smart-person</span> <span class="bu">:name</span> <span class="st">&quot;Mr. Musk&quot;</span>))</span>
            <span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> greet </span>((this smart-person))</span>
            <span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;(Wow, it&#39;s ~a! I can&#39;t believe he&#39;s here!)~%&quot;</span> (person-name this)))</span>
            <span id="cb206-10"><a href="#cb206-10" aria-hidden="true" tabindex="-1"></a>(greet *musk*)</span>
            <span id="cb206-11"><a href="#cb206-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; I should get off the couch and go talk to people.</span></span>
            <span id="cb206-12"><a href="#cb206-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Oh, what a nice looking young man. Let me go talk to him...</span></span>
            <span id="cb206-13"><a href="#cb206-13" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; (Wow, it&#39;s Mr. Musk! I can&#39;t believe he&#39;s here!) &lt;- Primary method response.</span></span>
            <span id="cb206-14"><a href="#cb206-14" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; (Strong handshake, good man.)</span></span>
            <span id="cb206-15"><a href="#cb206-15" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Here&#39;s my card, Mr. Musk. Let me know if you need help learning Lisp. =&gt; NIL</span></span>
            <span id="cb206-16"><a href="#cb206-16" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> greet </span>((this smart-person))</span>
            <span id="cb206-17"><a href="#cb206-17" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;(Wow, it&#39;s ~a! I can&#39;t believe he&#39;s here!)~%&quot;</span> (person-name this))</span>
            <span id="cb206-18"><a href="#cb206-18" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call-next-method</span>))</span>
            <span id="cb206-19"><a href="#cb206-19" aria-hidden="true" tabindex="-1"></a>(greet *musk*)</span>
            <span id="cb206-20"><a href="#cb206-20" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; I should get off the couch and go talk to people.</span></span>
            <span id="cb206-21"><a href="#cb206-21" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Oh, what a nice looking young man. Let me go talk to him...</span></span>
            <span id="cb206-22"><a href="#cb206-22" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; (Wow, it&#39;s Mr. Musk! I can&#39;t believe he&#39;s here!) &lt;- Primary method response.</span></span>
            <span id="cb206-23"><a href="#cb206-23" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Hello, Mr. Musk                                  &lt;- Next most specific method response.</span></span>
            <span id="cb206-24"><a href="#cb206-24" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; (Strong handshake, good man.)</span></span>
            <span id="cb206-25"><a href="#cb206-25" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Here&#39;s my card, Mr. Musk. Let me know if you need help learning Lisp. =&gt; NIL</span></span></code></pre></div>
        <p>All this indirection can be confusing. If you are extending some OOP system and your method isn't being called for some reason, you can use <code class="verbatim">compute-applicable-methods</code> to find out which methods a particular combination of arguments to a certain function name apply to those arguments.</p>
        <div class="sourceCode" id="cb207" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">compute-applicable-methods</span> <span class="op">#&#39;</span>greet (<span class="kw">list</span> (<span class="kw">make-instance</span> <span class="dt">&#39;person</span> <span class="bu">:name</span> <span class="st">&quot;Micah&quot;</span>)))</span>
            <span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (#&lt;STANDARD-METHOD COMMON-LISP-USER::GREET :AROUND (PERSON) {7009D091C3}&gt;</span></span>
            <span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; #&lt;STANDARD-METHOD COMMON-LISP-USER::GREET :AFTER (PERSON) {7009D091E3}&gt;</span></span>
            <span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; #&lt;STANDARD-METHOD COMMON-LISP-USER::GREET :BEFORE (PERSON) {7009D09203}&gt;</span></span>
            <span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; #&lt;STANDARD-METHOD COMMON-LISP-USER::GREET (PERSON) {7009D09223}&gt;)</span></span>
            <span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">compute-applicable-methods</span> <span class="op">#&#39;</span>greet (<span class="kw">list</span> (<span class="kw">make-instance</span> <span class="dt">&#39;smart-person</span> <span class="bu">:name</span> <span class="st">&quot;Mr. Musk&quot;</span>)))</span>
            <span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (#&lt;STANDARD-METHOD COMMON-LISP-USER::GREET (SMART-PERSON) {700792E213}&gt;</span></span>
            <span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; #&lt;STANDARD-METHOD COMMON-LISP-USER::GREET :AROUND (PERSON) {7009D091C3}&gt;</span></span>
            <span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; #&lt;STANDARD-METHOD COMMON-LISP-USER::GREET :AFTER (PERSON) {7009D091E3}&gt;</span></span>
            <span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; #&lt;STANDARD-METHOD COMMON-LISP-USER::GREET :BEFORE (PERSON) {7009D09203}&gt;</span></span>
            <span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; #&lt;STANDARD-METHOD COMMON-LISP-USER::GREET (PERSON) {7009D09223}&gt;)</span></span></code></pre></div>
        <h3 id="e71f5967-a164-4f62-ac80-fe5c478be619">Pretty Printing Objects</h3>
        <p>There are several generic functions worth knowing about when you first start using Lisp. One of them is <code class="verbatim">print-object</code>–used for pretty printing objects.</p>
        <div class="sourceCode" id="cb208" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> print-object </span>((this creature) <span class="kw">stream</span>)</span>
            <span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">with-slots</span> (name territory) this</span>
            <span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a ~a&quot;</span> name territory)))</span>
            <span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-instance</span> <span class="dt">&#39;creature</span> <span class="bu">:name</span> <span class="st">&quot;Cat&quot;</span> :territory <span class="st">&quot;House&quot;</span>)</span>
            <span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; Cat House</span></span></code></pre></div>
        <p><code class="verbatim">with-slots</code> is a useful macro for dealing with object data. You could use <code class="verbatim">let</code> instead…</p>
        <div class="sourceCode" id="cb209" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((name (<span class="kw">slot-value</span> this <span class="dt">&#39;name</span>))</span>
            <span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>      (territory (<span class="kw">slot-value</span> this <span class="dt">&#39;territory</span>)))</span>
            <span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>  ...)</span></code></pre></div>
        <p>But <code class="verbatim">with-slots</code> is nicer for this purpose. There is also <code class="verbatim">with-accessors</code>, which is equivalent to using <code class="verbatim">creature-name</code> and <code class="verbatim">creature-territory</code> instead of <code class="verbatim">slot-value</code>.</p>
        <p>In the case of <code class="verbatim">print-object</code>, it's safest to stick with <code class="verbatim">with-slots</code> or <code class="verbatim">slot-value</code>. If you change the accessor, you might end up with difficult to debug errors when printing objects.</p>
        <p>Another common error would be to try to print slot values that aren't bound. That's why you should probably have <code class="verbatim">:initform</code> set to <code class="verbatim">nil</code> if you have no other desired default value; you won't have trouble with <code class="verbatim">UNBOUND SLOT</code> errors.</p>
        <div class="sourceCode" id="cb210" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> beverage </span>()</span>
            <span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>  ((name :initarg <span class="bu">:name</span> :accessor name)</span>
            <span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>   (amount :initarg :amount :accessor amount)))</span>
            <span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-instance</span> <span class="dt">&#39;beverage</span>)</span>
            <span id="cb210-6"><a href="#cb210-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;BEVERAGE {700B0D0343}&gt;</span></span>
            <span id="cb210-7"><a href="#cb210-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb210-8"><a href="#cb210-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> print-object </span>((this beverage) <span class="kw">stream</span>)</span>
            <span id="cb210-9"><a href="#cb210-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">with-slots</span> (name amount) this</span>
            <span id="cb210-10"><a href="#cb210-10" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a ~a&quot;</span> name amount)))</span>
            <span id="cb210-11"><a href="#cb210-11" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb210-12"><a href="#cb210-12" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-instance</span> <span class="dt">&#39;beverage</span>)</span>
            <span id="cb210-13"><a href="#cb210-13" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;BEVERAGE &lt;&lt;error printing object&gt;&gt; {7008470343}&gt;</span></span></code></pre></div>
        <p>Since we didn't bind any of the slots–neither in the call to <code class="verbatim">make-instance</code> nor in the class definition with <code class="verbatim">:initform</code>–we get the <code class="verbatim">&lt;&lt;error printing object&gt;&gt;</code> message. We have two choices to fix the problem: check for unbound slots in the <code class="verbatim">print-object</code> method using <code class="verbatim">slot-boundp</code>, or prevent slots from being unbound when the object is initialized.</p>
        <div class="sourceCode" id="cb211" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Check for unbound slots.</span></span>
            <span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> print-object </span>((this beverage) <span class="kw">stream</span>)</span>
            <span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((name (<span class="kw">when</span> (<span class="kw">slot-boundp</span> this <span class="dt">&#39;name</span>) (<span class="kw">slot-value</span> this <span class="dt">&#39;name</span>)))</span>
            <span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>        (amount (<span class="kw">when</span> (<span class="kw">slot-boundp</span> this <span class="dt">&#39;amount</span>) (<span class="kw">slot-value</span> this <span class="dt">&#39;amount</span>))))</span>
            <span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a ~a&quot;</span> name amount)))</span>
            <span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb211-7"><a href="#cb211-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-instance</span> <span class="dt">&#39;beverage</span>)</span>
            <span id="cb211-8"><a href="#cb211-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL NIL</span></span>
            <span id="cb211-9"><a href="#cb211-9" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb211-10"><a href="#cb211-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; Prevent slots from being unbound by specifying a default value of nil.</span></span>
            <span id="cb211-11"><a href="#cb211-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> beverage </span>()</span>
            <span id="cb211-12"><a href="#cb211-12" aria-hidden="true" tabindex="-1"></a>  ((name :initarg <span class="bu">:name</span> :initform <span class="kw">nil</span> :accessor name)</span>
            <span id="cb211-13"><a href="#cb211-13" aria-hidden="true" tabindex="-1"></a>   (amount :initarg :amount :initform <span class="kw">nil</span> :accessor amount)))</span>
            <span id="cb211-14"><a href="#cb211-14" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb211-15"><a href="#cb211-15" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> print-object </span>((this beverage) <span class="kw">stream</span>)</span>
            <span id="cb211-16"><a href="#cb211-16" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">with-slots</span> (name amount) this</span>
            <span id="cb211-17"><a href="#cb211-17" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a ~a&quot;</span> name amount)))</span>
            <span id="cb211-18"><a href="#cb211-18" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb211-19"><a href="#cb211-19" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-instance</span> <span class="dt">&#39;beverage</span>)</span>
            <span id="cb211-20"><a href="#cb211-20" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL NIL</span></span></code></pre></div>
        <ol class="incremental">
            <li><p><code class="verbatim">print-unreadable-object</code></p>
                <p>By default, Lisp will provide a printed representation of an object that looks like this:</p>
                <pre class="example"><code>#&lt;BEVERAGE {700B0D0343}&gt;
                </code></pre>
                <p>This representation contains two important piece of information:</p>
                <ol class="incremental">
                    <li><code class="verbatim">#&lt;BEVERAGE ...&gt;</code>: This is a <code class="verbatim">BEVERAGE</code> object.</li>
                    <li><code class="verbatim">{700B0D0343}</code>: This is where the object is in memory.</li>
                </ol>
                <p>Consider this:</p>
                <div class="sourceCode" id="cb213" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> warm-beverage </span>(beverage) ())</span>
                    <span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> cold-beverage </span>(beverage) ())</span>
                    <span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">values</span> (<span class="kw">make-instance</span> <span class="dt">&#39;warm-beverage</span> <span class="bu">:name</span> <span class="st">&quot;Coffee&quot;</span> :amount <span class="dv">1000</span>)</span>
                    <span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">make-instance</span> <span class="dt">&#39;cold-beverage</span> <span class="bu">:name</span> <span class="st">&quot;Coffee&quot;</span> :amount <span class="dv">1000</span>))</span>
                    <span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; Coffee 1000, Coffee 1000</span></span></code></pre></div>
                <p>There's no indication that there is a difference between these two objects. If they weren't shown side-by-side, we wouldn't even know they were two different objects.</p>
                <p>To add this information back into your custom pretty printers, you can use the <code class="verbatim">print-unreadable-object</code> macro.</p>
                <div class="sourceCode" id="cb214" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> print-object </span>((this beverage) <span class="kw">stream</span>)</span>
                    <span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print-unreadable-object</span> (this <span class="kw">stream</span> <span class="bu">:type</span> <span class="kw">t</span> :identity <span class="kw">t</span>)</span>
                    <span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">with-slots</span> (name amount) this</span>
                    <span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a ~a&quot;</span> name amount))))</span>
                    <span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-instance</span> <span class="dt">&#39;cold-beverage</span> <span class="bu">:name</span> <span class="st">&quot;Coffee&quot;</span> :amount <span class="dv">1000</span>)</span>
                    <span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;COLD-BEVERAGE Coffee 1000 {7008A403A3}&gt;</span></span></code></pre></div></li>
        </ol>
        <h3 id="2f0f4ef5-af40-473b-8b85-8095604ab05a">Modifying Object Initialization</h3>
        <p>Let's say we have the following <code class="verbatim">defclass</code>:</p>
        <div class="sourceCode" id="cb215" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> user </span>()</span>
            <span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a>  ((name :initarg <span class="bu">:name</span></span>
            <span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a>         :initform <span class="kw">nil</span></span>
            <span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a>         :accessor user-name)</span>
            <span id="cb215-5"><a href="#cb215-5" aria-hidden="true" tabindex="-1"></a>   (email :initarg :email</span>
            <span id="cb215-6"><a href="#cb215-6" aria-hidden="true" tabindex="-1"></a>          :initform <span class="kw">nil</span></span>
            <span id="cb215-7"><a href="#cb215-7" aria-hidden="true" tabindex="-1"></a>          :accessor user-email)))</span></code></pre></div>
        <p>We've specified the type of data the slots will hold: strings.</p>
        <p>Let's run <code class="verbatim">make-instance</code>:</p>
        <div class="sourceCode" id="cb216" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-instance</span> <span class="dt">&#39;user</span>)</span>
            <span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;USER {7007C40343}&gt;</span></span></code></pre></div>
        <p>It works, but what we really want is:</p>
        <ol class="incremental">
            <li>Both slots to be required.</li>
            <li>To validate that the value assigned in <code class="verbatim">email</code> is actually an email.</li>
        </ol>
        <p>We can do that using two important features of Common Lisp's object system: custom initializer methods and method modifiers.</p>
        <p>To validate that the email is a valid email, we would like to be able to use regular expressions. Lisp doesn't have regular expression support built in, so we'll use the <code class="verbatim">ppcre</code> package to give us regular expressions:</p>
        <div class="sourceCode" id="cb217" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>(ql:quickload <span class="st">&quot;cl-ppcre&quot;</span>)</span></code></pre></div>
        <p>Then we'll make a function for validating that the string passed to <code class="verbatim">make-instance</code> is a valid email.</p>
        <div class="sourceCode" id="cb218" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> valid-email-address-p </span>(<span class="kw">string</span>)</span>
            <span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">not</span> (<span class="kw">null</span></span>
            <span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>        (ppcre:scan <span class="st">&quot;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+</span><span class="sc">\\</span><span class="st">.[a-zA-Z]{2,}$&quot;</span> <span class="kw">string</span>))))</span>
            <span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>(valid-email-address-p <span class="st">&quot;micah@almightylisp.com&quot;</span>)</span>
            <span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; T</span></span>
            <span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>(valid-email-address-p <span class="st">&quot;dude*@*man.com&quot;</span>)</span>
            <span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span></code></pre></div>
        <p>Now we just need some way to run this function when we run <code class="verbatim">make-instance</code>. To do that, we can use custom initialization with the <code class="verbatim">initialize-instance</code> method.</p>
        <div class="sourceCode" id="cb219" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> initialize-instance </span>:before ((this <span class="kw">user</span>) &amp;key name email)</span>
            <span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> name</span>
            <span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="st">&quot;Name is required.&quot;</span>))</span>
            <span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> email</span>
            <span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="st">&quot;Email is required.&quot;</span>))</span>
            <span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (valid-email-address-p email)</span>
            <span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="st">&quot;~a is not a valid email.&quot;</span> email)))</span></code></pre></div>
        <p><code class="verbatim">initialize-instance</code> is a generic method run whenever an object is created. Using the <code class="verbatim">:before</code> method modifier, we can run some code before the main <code class="verbatim">initialize-instance</code> method. Here, we ensure that the name and email slots are bound and that the email is valid. Importantly, if the data doesn't pass the checks, the developer is thrown into the debugger, and the object is never created.</p>
        <h3 id="40847bb4-e348-470c-9763-24fd65364ee0">Specializing Methods On Other Values</h3>
        <p>It's possible to specialize methods on other values besides just classes/types.</p>
        <div class="sourceCode" id="cb220" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> greet </span>((this (<span class="kw">eql</span> :robot)))</span>
            <span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;Woah, this is a realistic robot.&quot;</span>))</span>
            <span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>(greet :robot)</span>
            <span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Woah, this is a realistic robot. =&gt; NIL</span></span>
            <span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> greet </span>((this (<span class="kw">eql</span> (<span class="op">+</span> <span class="dv">2</span> <span class="dv">2</span>))))</span>
            <span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;Hey, Micah.&quot;</span>))</span>
            <span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>(greet <span class="dv">4</span>)</span>
            <span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Hey, Micah. =&gt; NIL</span></span>
            <span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> greet </span>((this (<span class="kw">eql</span> <span class="op">#&#39;</span>+)))</span>
            <span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">funcall</span> this <span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>))</span>
            <span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a>(greet <span class="op">#&#39;</span>+)</span>
            <span id="cb220-12"><a href="#cb220-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 15 (4 bits, #xF, #o17, #b1111)</span></span></code></pre></div>
        <p>In the section later about structures, I'll show you that methods can even be specialized on structures and don't require you to use classes/types for your data structure.</p>
        <p>Unfortunately, you can't specialize a method on things like the type <code class="verbatim">string</code> or <em>the shape of</em> some data structure. For that, there's Coalton.</p>
        <div class="sourceCode" id="cb221" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> greet </span>((this (<span class="kw">eql</span> <span class="dt">&#39;string</span>)))</span>
            <span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;What&#39;s up, ~a?~%&quot;</span> this))</span>
            <span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb221-4"><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a>(greet <span class="st">&quot;Dude&quot;</span>)</span>
            <span id="cb221-5"><a href="#cb221-5" aria-hidden="true" tabindex="-1"></a><span class="co">;; =&gt; Error</span></span>
            <span id="cb221-6"><a href="#cb221-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; There is no applicable method for the generic function</span></span>
            <span id="cb221-7"><a href="#cb221-7" aria-hidden="true" tabindex="-1"></a><span class="co">;;   #&lt;STANDARD-GENERIC-FUNCTION COMMON-LISP-USER::GREET (12)&gt;</span></span>
            <span id="cb221-8"><a href="#cb221-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; when called with arguments</span></span>
            <span id="cb221-9"><a href="#cb221-9" aria-hidden="true" tabindex="-1"></a><span class="co">;;   (&quot;Dude&quot;).</span></span>
            <span id="cb221-10"><a href="#cb221-10" aria-hidden="true" tabindex="-1"></a><span class="co">;;    [Condition of type SB-PCL::NO-APPLICABLE-METHOD-ERROR]</span></span></code></pre></div>
        <h2 id="hash-tables">HASH-TABLES</h2>
        <h3 id="f4d83efa-9a7f-4247-ba6e-e02372d21137">What is a hash-table?</h3>
        <p>A hash-table is a group of key/value pairs. ~associated-lists= are the list-based equivalent.</p>
        <h3 id="d9fc374c-8e06-453f-a433-3e22b88e37dc">Making hash-tables</h3>
        <p>To make a hash table, use <code class="verbatim">make-hash-table</code>.</p>
        <div class="sourceCode" id="cb222" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-hash-table</span>)</span>
            <span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;HASH-TABLE :</span><span class="al">TEST</span><span class="co"> EQL :COUNT 0 {7008090473}&gt;</span></span></code></pre></div>
        <h3 id="0a384a03-5b54-40e7-b364-bff49a35c006">Adding/Accessing/Modifying items to a hash-table</h3>
        <div class="sourceCode" id="cb223" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *h* </span>(<span class="kw">make-hash-table</span>))</span>
            <span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; *H*</span></span>
            <span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a><span class="co">;; Add an item</span></span>
            <span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (<span class="kw">gethash</span> <span class="bu">:name</span> *h*) <span class="st">&quot;Micah&quot;</span>)</span>
            <span id="cb223-5"><a href="#cb223-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Micah&quot;</span></span>
            <span id="cb223-6"><a href="#cb223-6" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb223-7"><a href="#cb223-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Access it</span></span>
            <span id="cb223-8"><a href="#cb223-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">gethash</span> <span class="bu">:name</span> *h*)</span>
            <span id="cb223-9"><a href="#cb223-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Micah&quot;, T</span></span>
            <span id="cb223-10"><a href="#cb223-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">gethash</span> :age *h*)</span>
            <span id="cb223-11"><a href="#cb223-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL, NIL</span></span>
            <span id="cb223-12"><a href="#cb223-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Modify it</span></span>
            <span id="cb223-13"><a href="#cb223-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (<span class="kw">gethash</span> <span class="bu">:name</span> *h*) <span class="st">&quot;Bob&quot;</span>)</span>
            <span id="cb223-14"><a href="#cb223-14" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Bob&quot;</span></span></code></pre></div>
        <p>Compare this to ~alists=:</p>
        <div class="sourceCode" id="cb224" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *a* </span>&#39;())</span>
            <span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> *a* (<span class="kw">append</span> *a* &#39;((<span class="bu">:name</span> <span class="st">&quot;Micah&quot;</span>))))</span>
            <span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; ((:NAME &quot;Micah&quot;))</span></span>
            <span id="cb224-4"><a href="#cb224-4" aria-hidden="true" tabindex="-1"></a>*a*</span>
            <span id="cb224-5"><a href="#cb224-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; ((:NAME &quot;Micah&quot;))</span></span>
            <span id="cb224-6"><a href="#cb224-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">cadr</span> (<span class="kw">assoc</span> <span class="bu">:name</span> *a*))</span>
            <span id="cb224-7"><a href="#cb224-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Micah&quot;</span></span>
            <span id="cb224-8"><a href="#cb224-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">cadr</span> (<span class="kw">assoc</span> :age *a*))</span>
            <span id="cb224-9"><a href="#cb224-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span>
            <span id="cb224-10"><a href="#cb224-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (<span class="kw">cadr</span> (<span class="kw">assoc</span> <span class="bu">:name</span> *a*)) <span class="st">&quot;Bob&quot;</span>)</span>
            <span id="cb224-11"><a href="#cb224-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Bob&quot;</span></span>
            <span id="cb224-12"><a href="#cb224-12" aria-hidden="true" tabindex="-1"></a>*a*</span>
            <span id="cb224-13"><a href="#cb224-13" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; ((:NAME &quot;Bob&quot;))</span></span></code></pre></div>
        <h3 id="4b5951c1-4be3-491b-8f3c-ede0e2dcc0a2">Printing a hash-table</h3>
        <p>Hash-tables don't get printed nicely like lists do.</p>
        <div class="sourceCode" id="cb225" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>*h*</span>
            <span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;HASH-TABLE :</span><span class="al">TEST</span><span class="co"> EQL :COUNT 1 {70075F0503}&gt;</span></span>
            <span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a>*a*</span>
            <span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; ((:NAME &quot;Bob&quot;))</span></span></code></pre></div>
        <p>Use <code class="verbatim">maphash</code> to print key/value pairs or other mapping operations.</p>
        <div class="sourceCode" id="cb226" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> print-hash </span>(<span class="kw">hash-table</span>)</span>
            <span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">maphash</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (key value) (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;~a -&gt; ~a~%&quot;</span> key value)) <span class="kw">hash-table</span>))</span>
            <span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a>(print-hash *h*)</span>
            <span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; NAME -&gt; Bob</span></span>
            <span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; NIL</span></span>
            <span id="cb226-7"><a href="#cb226-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (<span class="kw">gethash</span> :age *h*) <span class="dv">39</span>)</span>
            <span id="cb226-8"><a href="#cb226-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 39 (6 bits, #x27, #o47, #b100111)</span></span>
            <span id="cb226-9"><a href="#cb226-9" aria-hidden="true" tabindex="-1"></a>(print-hash *h*)</span>
            <span id="cb226-10"><a href="#cb226-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; NAME -&gt; Bob</span></span>
            <span id="cb226-11"><a href="#cb226-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; AGE -&gt; 39</span></span>
            <span id="cb226-12"><a href="#cb226-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; NIL</span></span></code></pre></div>
        <h3 id="bc676328-a795-468d-bbf5-553d9fd853e9">Using strings as keys</h3>
        <p>The <code class="verbatim">keys</code> of a hash-table can be keywords, strings, or symbols. But, there's a catch:</p>
        <div class="sourceCode" id="cb227" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (<span class="kw">gethash</span> <span class="dt">&#39;favorite-language</span> *h*) <span class="st">&quot;Common Lisp&quot;</span>)</span>
            <span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Common Lisp&quot;</span></span>
            <span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a>(print-hash *h*)</span>
            <span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; NAME -&gt; Bob</span></span>
            <span id="cb227-5"><a href="#cb227-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; AGE -&gt; 39</span></span>
            <span id="cb227-6"><a href="#cb227-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; FAVORITE-LANGUAGE -&gt; Common Lisp</span></span>
            <span id="cb227-7"><a href="#cb227-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; NIL</span></span>
            <span id="cb227-8"><a href="#cb227-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">gethash</span> <span class="dt">&#39;favorite-language</span> *h*)</span>
            <span id="cb227-9"><a href="#cb227-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Common Lisp&quot;, T</span></span>
            <span id="cb227-10"><a href="#cb227-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (<span class="kw">gethash</span> <span class="st">&quot;location&quot;</span> *h*) <span class="st">&quot;Japan&quot;</span>)</span>
            <span id="cb227-11"><a href="#cb227-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Japan&quot;</span></span>
            <span id="cb227-12"><a href="#cb227-12" aria-hidden="true" tabindex="-1"></a>(print-hash *h*)</span>
            <span id="cb227-13"><a href="#cb227-13" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; NAME -&gt; Bob</span></span>
            <span id="cb227-14"><a href="#cb227-14" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; AGE -&gt; 39</span></span>
            <span id="cb227-15"><a href="#cb227-15" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; FAVORITE-LANGUAGE -&gt; Common Lisp</span></span>
            <span id="cb227-16"><a href="#cb227-16" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; location -&gt; Japan</span></span>
            <span id="cb227-17"><a href="#cb227-17" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; NIL</span></span>
            <span id="cb227-18"><a href="#cb227-18" aria-hidden="true" tabindex="-1"></a>(<span class="kw">gethash</span> <span class="st">&quot;location&quot;</span> *h*)</span>
            <span id="cb227-19"><a href="#cb227-19" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL, NIL</span></span>
            <span id="cb227-20"><a href="#cb227-20" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Huh?</span></span></code></pre></div>
        <p><code class="verbatim">make-hash-table</code>, when searching for <code class="verbatim">"location"</code> or any other key, defaults to testing keys using <code class="verbatim">eql</code>.</p>
        <div class="sourceCode" id="cb228" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eql</span> <span class="dt">&#39;favorite-language</span> <span class="dt">&#39;favorite-language</span>)</span>
            <span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; T</span></span>
            <span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eql</span> <span class="st">&quot;location&quot;</span> <span class="st">&quot;location&quot;</span>)</span>
            <span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span></code></pre></div>
        <p>You can change the test to <code class="verbatim">equal</code>, <code class="verbatim">equalp</code>, or <code class="verbatim">eq</code>.</p>
        <div class="sourceCode" id="cb229" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *h* </span>(<span class="kw">make-hash-table</span> <span class="bu">:test</span> <span class="op">#&#39;</span>equal))</span>
            <span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; *H*</span></span>
            <span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (<span class="kw">gethash</span> <span class="st">&quot;location&quot;</span> *h*) <span class="st">&quot;Japan&quot;</span>)</span>
            <span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Japan&quot;</span></span>
            <span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">gethash</span> <span class="st">&quot;location&quot;</span> *h*)</span>
            <span id="cb229-6"><a href="#cb229-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Japan&quot;, T</span></span>
            <span id="cb229-7"><a href="#cb229-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">gethash</span> <span class="st">&quot;LOCATION&quot;</span> *h*)</span>
            <span id="cb229-8"><a href="#cb229-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL, NIL</span></span>
            <span id="cb229-9"><a href="#cb229-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> *h* (<span class="kw">make-hash-table</span> <span class="bu">:test</span> <span class="op">#&#39;</span>equalp))</span>
            <span id="cb229-10"><a href="#cb229-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;HASH-TABLE :</span><span class="al">TEST</span><span class="co"> EQUALP :COUNT 0 {7008AF0503}&gt;</span></span>
            <span id="cb229-11"><a href="#cb229-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (<span class="kw">gethash</span> <span class="st">&quot;location&quot;</span> *h*) <span class="st">&quot;Japan&quot;</span>)</span>
            <span id="cb229-12"><a href="#cb229-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Japan&quot;</span></span>
            <span id="cb229-13"><a href="#cb229-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">gethash</span> <span class="st">&quot;location&quot;</span> *h*)</span>
            <span id="cb229-14"><a href="#cb229-14" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Japan&quot;, T</span></span>
            <span id="cb229-15"><a href="#cb229-15" aria-hidden="true" tabindex="-1"></a>(<span class="kw">gethash</span> <span class="st">&quot;LOCatiON&quot;</span> *h*)</span>
            <span id="cb229-16"><a href="#cb229-16" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Japan&quot;, T</span></span></code></pre></div>
        <h2 id="arrays">ARRAYS</h2>
        <h3 id="b09f8c3f-9f85-4930-990e-141242a04c23">Differences between arrays and lists</h3>
        <p>One of the most fun things about Common Lisp is that it is the highest-level language to exist (thanks to macros), but it is also surprisingly low level as well.</p>
        <p>In Lisp, a list is a linked-list. Arrays, on the other hand, are surprisingly similar to the arrays in C. You need to manually set their size at creation time. Resizing them involves either assigning them a special property or simply recreating the array with the new size.</p>
        <h3 id="9c075c78-dce3-4968-b0ad-3ef0d8bb9aac">When to use arrays</h3>
        <p>Arrays are useful when you have a prototype using lists and need to optimize for speed and memory efficiency.</p>
        <h3 id="511eab18-e9fc-4ac6-b6e5-31ec97855952">Kinds of arrays</h3>
        <p>There are several different kinds of arrays. They include:</p>
        <ul class="incremental">
            <li>Vectors (one-dimensional arrays)</li>
            <li>Multi-dimensional arrays</li>
            <li>Specialized arrays</li>
            <li>Adjustable arrays</li>
            <li>Strings</li>
        </ul>
        <p>Because my goal is to cover the essentials for getting started with Common Lisp and arrays are largely for optimization, we won't go into great detail about arrays.</p>
        <h3 id="b854e7b2-33e5-428a-95c6-54e18ef26c6a">Vectors</h3>
        <ol class="incremental">
            <li><p>Making a vector</p>
                <p><code class="verbatim">make-array</code> is the primary function for making arrays of all types.</p>
                <div class="sourceCode" id="cb230" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-array</span> <span class="dv">5</span>)</span>
                    <span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #(0 0 0 0 0)</span></span></code></pre></div>
                <p>The first argument to <code class="verbatim">make-array</code> is the <code class="verbatim">dimensions</code> of the array: how many columns in how many rows. A single number makes a one-dimension array with the same number of elements as the number.</p>
                <p>You can set the initial element(s) in the array:</p>
                <div class="sourceCode" id="cb231" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-array</span> <span class="dv">5</span> <span class="bu">:initial-element</span> <span class="st">&quot;ALMIGHTY&quot;</span>)</span>
                    <span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a> <span class="co">; =&gt; #(&quot;ALMIGHTY&quot; &quot;ALMIGHTY&quot; &quot;ALMIGHTY&quot; &quot;ALMIGHTY&quot; &quot;ALMIGHTY&quot;)</span></span>
                    <span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-array</span> <span class="dv">5</span> <span class="bu">:initial-contents</span> &#39;(this is almighty common <span class="kw">lisp</span>))</span>
                    <span id="cb231-4"><a href="#cb231-4" aria-hidden="true" tabindex="-1"></a> <span class="co">; =&gt; #(THIS IS ALMIGHTY COMMON LISP)</span></span></code></pre></div>
                <p>You can also use the <code class="verbatim">#</code> reader macro.</p>
                <div class="sourceCode" id="cb232" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *almighty* </span>#(this is almighty common <span class="kw">lisp</span>))</span>
                    <span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #(THIS IS ALMIGHTY COMMON LISP)</span></span></code></pre></div></li>
            <li><p>Accessing data in a vector</p>
                <p>Use ~aref= to access the data by index.</p>
                <div class="sourceCode" id="cb233" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">aref</span> *almighty* <span class="dv">0</span>)</span>
                    <span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; THIS</span></span>
                    <span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">aref</span> *almighty* <span class="dv">4</span>)</span>
                    <span id="cb233-4"><a href="#cb233-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; LISP</span></span>
                    <span id="cb233-5"><a href="#cb233-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">aref</span> *almighty* <span class="dv">5</span>)</span>
                    <span id="cb233-6"><a href="#cb233-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; Error: Invalid index</span></span></code></pre></div>
                <p>This shows one of the first important differences between a list and an array in practical use. Using <code class="verbatim">nth</code> to get an element in a list by its place in the list, if you go beyond the last element, <code class="verbatim">nth</code> only returns <code class="verbatim">NIL</code> without an error.</p>
                <div class="sourceCode" id="cb234" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *almighty-list* </span>&#39;(this is almighty common <span class="kw">lisp</span>))</span>
                    <span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">nth</span> <span class="dv">4</span> *almighty-list*)</span>
                    <span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; LISP</span></span>
                    <span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">nth</span> <span class="dv">5</span> *almighty-list*)</span>
                    <span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span>
                    <span id="cb234-6"><a href="#cb234-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">nth</span> <span class="dv">99</span> *almighty-list*)</span>
                    <span id="cb234-7"><a href="#cb234-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span></code></pre></div></li>
            <li><p>Modifying data in a vector</p>
                <p>Use <code class="verbatim">setf</code> to modify the data at a place in a vector</p>
                <div class="sourceCode" id="cb235" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">aref</span> *almighty* <span class="dv">3</span>)</span>
                    <span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; COMMON</span></span>
                    <span id="cb235-3"><a href="#cb235-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (<span class="kw">aref</span> *almighty* <span class="dv">3</span>) <span class="dt">&#39;powerful</span>)</span>
                    <span id="cb235-4"><a href="#cb235-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; POWERFUL</span></span>
                    <span id="cb235-5"><a href="#cb235-5" aria-hidden="true" tabindex="-1"></a>*almighty*</span>
                    <span id="cb235-6"><a href="#cb235-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #(THIS IS ALMIGHTY POWERFUL LISP)</span></span></code></pre></div></li>
            <li><p>Adding/Deleting an element of a vector</p>
                <ol class="incremental">
                    <li><p>Starting with an adjustable vector</p>
                        <p>Deleting items from an array requires more manual work than with lists.</p>
                        <p>One method involves changing the size of the vector with ~adjust-array=, leaving no "empty" cells. This method relies on the array being created with the <code class="verbatim">:adjustable</code> option set to <code class="verbatim">t</code>, making it an ~adjustable array=.</p>
                        <div class="sourceCode" id="cb236" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *adjustably-almighty* </span>(<span class="kw">make-array</span> <span class="dv">5</span> <span class="bu">:initial-contents</span> &#39;(THIS IS ALMIGHTY COMMON LISP) <span class="bu">:adjustable</span> <span class="kw">t</span>))</span>
                            <span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> inefficiently-delete-vector-element </span>(<span class="kw">vector</span> index)</span>
                            <span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">when</span> (<span class="op">&lt;</span> index (<span class="kw">length</span> <span class="kw">vector</span>))</span>
                            <span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">loop</span> for i from index below (<span class="op">1-</span> (<span class="kw">length</span> <span class="kw">vector</span>))</span>
                            <span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Move all elements above the target index down one cell,</span></span>
                            <span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a>          <span class="kw">do</span> (<span class="kw">setf</span> (<span class="kw">aref</span> <span class="kw">vector</span> i) (<span class="kw">aref</span> <span class="kw">vector</span> (<span class="op">1+</span> i))))</span>
                            <span id="cb236-7"><a href="#cb236-7" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">adjust-array</span> <span class="kw">vector</span> (<span class="op">1-</span> (<span class="kw">length</span> <span class="kw">vector</span>))))  <span class="co">; Resize the array.</span></span>
                            <span id="cb236-8"><a href="#cb236-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">vector</span>)</span>
                            <span id="cb236-9"><a href="#cb236-9" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb236-10"><a href="#cb236-10" aria-hidden="true" tabindex="-1"></a>(inefficiently-delete-vector-element *adjustably-almighty* <span class="dv">3</span>)</span>
                            <span id="cb236-11"><a href="#cb236-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #(THIS IS ALMIGHTY LISP)</span></span></code></pre></div></li>
                    <li><p>Starting with an adjustable vector with a fill pointer</p>
                        <p>Use <code class="verbatim">vector-pop</code> to remove the last element of a vector that has a <code class="verbatim">:fill-pointer</code> set. Use <code class="verbatim">vector-push</code> to add an element to the end of the vector. It will not change the size/dimensions of the array.</p>
                        <div class="sourceCode" id="cb237" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *fill-pointer-almighty* </span>(<span class="kw">make-array</span> <span class="dv">5</span> <span class="bu">:initial-contents</span> &#39;(this is almighty common <span class="kw">lisp</span>) :fill-pointer <span class="dv">5</span>))</span>
                            <span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">vector-pop</span> *fill-pointer-almighty*)</span>
                            <span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; LISP</span></span>
                            <span id="cb237-4"><a href="#cb237-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">aref</span> *fill-pointer-almighty* <span class="dv">4</span>)</span>
                            <span id="cb237-5"><a href="#cb237-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; LISP</span></span>
                            <span id="cb237-6"><a href="#cb237-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; The data is still there if we look.</span></span>
                            <span id="cb237-7"><a href="#cb237-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">array-dimensions</span> *fill-pointer-almighty*)</span>
                            <span id="cb237-8"><a href="#cb237-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (5)</span></span>
                            <span id="cb237-9"><a href="#cb237-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; The array hasn&#39;t changed physical size; memory is still used.</span></span>
                            <span id="cb237-10"><a href="#cb237-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">print</span> *fill-pointer-almighty*)</span>
                            <span id="cb237-11"><a href="#cb237-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; #(THIS IS ALMIGHTY COMMON)  =&gt; #(THIS IS ALMIGHTY COMMON)</span></span>
                            <span id="cb237-12"><a href="#cb237-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; But the &quot;active&quot; portion--the logical size--of the array has changed.</span></span>
                            <span id="cb237-13"><a href="#cb237-13" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;</span></span>
                            <span id="cb237-14"><a href="#cb237-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">vector-push</span> <span class="dt">&#39;lisp</span> *fill-pointer-almighty*)</span>
                            <span id="cb237-15"><a href="#cb237-15" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 4 (3 bits, #x4, #o4, #b100)</span></span>
                            <span id="cb237-16"><a href="#cb237-16" aria-hidden="true" tabindex="-1"></a>(<span class="kw">print</span> *fill-pointer-almighty*)</span>
                            <span id="cb237-17"><a href="#cb237-17" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb237-18"><a href="#cb237-18" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; #(THIS IS ALMIGHTY COMMON LISP)  =&gt; #(THIS IS ALMIGHTY COMMON LISP)</span></span></code></pre></div>
                        <p><code class="verbatim">vector-push</code> won't resize the array beyond the dimensions defined with <code class="verbatim">make-array</code>. Use <code class="verbatim">vector-push-extend</code> to resize the array when it's necessary.</p>
                        <div class="sourceCode" id="cb238" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">vector-push</span> <span class="dt">&#39;dude</span> *fill-pointer-almighty*)</span>
                            <span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span>
                            <span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">print</span> *fill-pointer-almighty*)</span>
                            <span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; #(THIS IS ALMIGHTY COMMON LISP)  =&gt; #(THIS IS ALMIGHTY COMMON LISP)</span></span>
                            <span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">array-dimensions</span> *fill-pointer-almighty*)</span>
                            <span id="cb238-6"><a href="#cb238-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (5)</span></span>
                            <span id="cb238-7"><a href="#cb238-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">vector-push-extend</span> <span class="dt">&#39;dude</span> *fill-pointer-almighty*)</span>
                            <span id="cb238-8"><a href="#cb238-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 5</span></span>
                            <span id="cb238-9"><a href="#cb238-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">print</span> *fill-pointer-almighty*)</span>
                            <span id="cb238-10"><a href="#cb238-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; #(THIS IS ALMIGHTY COMMON LISP DUDE)  =&gt; #(THIS IS ALMIGHTY COMMON LISP DUDE)</span></span>
                            <span id="cb238-11"><a href="#cb238-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">array-dimensions</span> *fill-pointer-almighty*)</span>
                            <span id="cb238-12"><a href="#cb238-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (10)</span></span></code></pre></div></li>
                    <li><p>Starting with a non-adjustable vector</p>
                        <p>Deleting an element in the middle of a non-adjustable vector requires shifting elements that come after it down one cell and then setting the last element in the array to <code class="verbatim">NIL</code>.</p>
                        <div class="sourceCode" id="cb239" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *almighty* </span>(<span class="kw">make-array</span> <span class="dv">5</span> <span class="bu">:initial-contents</span> &#39;(THIS IS ALMIGHTY COMMON LISP)))</span>
                            <span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> delete-vector-element </span>(<span class="kw">vector</span> index)</span>
                            <span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">when</span> (<span class="op">&lt;</span> index (<span class="kw">length</span> <span class="kw">vector</span>))</span>
                            <span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">loop</span> for i from index below (<span class="op">1-</span> (<span class="kw">length</span> <span class="kw">vector</span>))</span>
                            <span id="cb239-5"><a href="#cb239-5" aria-hidden="true" tabindex="-1"></a>          <span class="kw">do</span> (<span class="kw">setf</span> (<span class="kw">aref</span> <span class="kw">vector</span> i) (<span class="kw">aref</span> <span class="kw">vector</span> (<span class="op">1+</span> i))))</span>
                            <span id="cb239-6"><a href="#cb239-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">setf</span> (<span class="kw">aref</span> <span class="kw">vector</span> (<span class="op">1-</span> (<span class="kw">length</span> <span class="kw">vector</span>))) <span class="kw">nil</span>))  <span class="co">; Clear last element</span></span>
                            <span id="cb239-7"><a href="#cb239-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">vector</span>)</span>
                            <span id="cb239-8"><a href="#cb239-8" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb239-9"><a href="#cb239-9" aria-hidden="true" tabindex="-1"></a>(delete-vector-element *almighty* <span class="dv">3</span>)</span>
                            <span id="cb239-10"><a href="#cb239-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #(THIS IS ALMIGHTY LISP NIL)</span></span>
                            <span id="cb239-11"><a href="#cb239-11" aria-hidden="true" tabindex="-1"></a>(delete-vector-element *almighty* <span class="dv">3</span>)</span>
                            <span id="cb239-12"><a href="#cb239-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #(THIS IS ALMIGHTY NIL NIL)</span></span></code></pre></div>
                        <p>This method leaves the array dimensions untouched, shifts all elements above the given index down one cell in the array, and leaves <code class="verbatim">NIL</code> to fill the empty space.</p></li>
                </ol></li>
        </ol>
        <h2 id="structures">STRUCTURES</h2>
        <h3 id="fe76d15e-6d96-47b3-992e-d9edc4b7f2ca">What is a structure?</h3>
        <p>Structures are user-defined data types that group related data. They are similar to classes, but are faster and more memory efficient than classes under some scenarios.</p>
        <h3 id="3fe35f2e-a7d7-4b6b-b6ef-72ff9012c475">Defining structures and making instances</h3>
        <ol class="incremental">
            <li><p>Slots w/default values</p>
                <p>Use <code class="verbatim">defstruct</code> to define a structure. After giving the structure a name, define the slots. Use <code class="verbatim">make-&lt;structure name&gt;</code> to make an instance of the structure. Assign slot values at instantiation using keywords.</p>
                <div class="sourceCode" id="cb240" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defstruct</span><span class="fu"> s-point</span></span>
                    <span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a>  x</span>
                    <span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a>  y)</span>
                    <span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a>(make-s-point)</span>
                    <span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #S(S-POINT :X NIL :Y NIL)</span></span>
                    <span id="cb240-7"><a href="#cb240-7" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb240-8"><a href="#cb240-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defstruct</span><span class="fu"> http-request</span></span>
                    <span id="cb240-9"><a href="#cb240-9" aria-hidden="true" tabindex="-1"></a>  (status <span class="dv">200</span>)</span>
                    <span id="cb240-10"><a href="#cb240-10" aria-hidden="true" tabindex="-1"></a>  (headers &#39;(()))</span>
                    <span id="cb240-11"><a href="#cb240-11" aria-hidden="true" tabindex="-1"></a>  (body <span class="kw">nil</span>))</span>
                    <span id="cb240-12"><a href="#cb240-12" aria-hidden="true" tabindex="-1"></a>(make-http-request)</span>
                    <span id="cb240-13"><a href="#cb240-13" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #S(HTTP-REQUEST :STATUS 200 :HEADERS (NIL) :BODY NIL)</span></span>
                    <span id="cb240-14"><a href="#cb240-14" aria-hidden="true" tabindex="-1"></a>(make-http-request :status <span class="dv">404</span> :body <span class="st">&quot;This page doesn&#39;t exist.&quot;</span>)</span>
                    <span id="cb240-15"><a href="#cb240-15" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #S(HTTP-REQUEST :STATUS 404 :HEADERS (NIL) :BODY &quot;This page doesn&#39;t exist.&quot;)</span></span></code></pre></div>
                <p>Slots default to <code class="verbatim">NIL</code>, but you can define defaults as in the <code class="verbatim">http-request</code> example. <code class="verbatim">status</code> defaults to <code class="verbatim">200</code>, <code class="verbatim">headers</code> to <code class="verbatim">'(())</code>, etc.</p></li>
            <li><p>Defining required slots</p>
                <p>If you define the <code class="verbatim">:constructor</code> for the structure you can make slots required.</p>
                <div class="sourceCode" id="cb241" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defstruct</span><span class="fu"> </span>(animal (<span class="bu">:constructor</span> raise-animal (name &amp;optional territory)))</span>
                    <span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>  (name <span class="st">&quot;&quot;</span>)</span>
                    <span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>  (territory <span class="st">&quot;World&quot;</span>))</span>
                    <span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a>(raise-animal)                          <span class="co">; Error: invalid number of arguments: 0</span></span>
                    <span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a>(raise-animal <span class="st">&quot;Tiger&quot;</span>)</span>
                    <span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #S(ANIMAL :NAME &quot;Tiger&quot; :TERRITORY &quot;World&quot;)</span></span></code></pre></div></li>
            <li><p>Defining required types</p>
                <p>You can also define types–checked at compile time–for slots.</p>
                <div class="sourceCode" id="cb242" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defstruct</span><span class="fu"> s-point</span></span>
                    <span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>  (x <span class="fl">0.0</span> <span class="bu">:type</span> <span class="kw">float</span>)</span>
                    <span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a>  (y <span class="fl">0.0</span> <span class="bu">:type</span> <span class="kw">float</span>))</span>
                    <span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb242-5"><a href="#cb242-5" aria-hidden="true" tabindex="-1"></a>(make-s-point)</span>
                    <span id="cb242-6"><a href="#cb242-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #S(S-POINT :X 0.0 :Y 0.0)</span></span>
                    <span id="cb242-7"><a href="#cb242-7" aria-hidden="true" tabindex="-1"></a>(make-s-point :x <span class="dv">5</span>)</span>
                    <span id="cb242-8"><a href="#cb242-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; The value</span></span>
                    <span id="cb242-9"><a href="#cb242-9" aria-hidden="true" tabindex="-1"></a><span class="co">;;   5</span></span>
                    <span id="cb242-10"><a href="#cb242-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; is not of type</span></span>
                    <span id="cb242-11"><a href="#cb242-11" aria-hidden="true" tabindex="-1"></a><span class="co">;;   FLOAT</span></span>
                    <span id="cb242-12"><a href="#cb242-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; when setting slot X of structure S-POINT</span></span>
                    <span id="cb242-13"><a href="#cb242-13" aria-hidden="true" tabindex="-1"></a><span class="co">;;    [Condition of type TYPE-ERROR]</span></span></code></pre></div></li>
            <li><p>Inheritance</p>
                <p>Structures support single inheritance.</p>
                <div class="sourceCode" id="cb243" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defstruct</span><span class="fu"> vehicle</span></span>
                    <span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>  make</span>
                    <span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a>  model)</span>
                    <span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb243-5"><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defstruct</span><span class="fu"> </span>(van (:include vehicle))</span>
                    <span id="cb243-6"><a href="#cb243-6" aria-hidden="true" tabindex="-1"></a>  (doors <span class="dv">4</span>))</span>
                    <span id="cb243-7"><a href="#cb243-7" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb243-8"><a href="#cb243-8" aria-hidden="true" tabindex="-1"></a>(make-van)</span>
                    <span id="cb243-9"><a href="#cb243-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #S(VAN :MAKE NIL :MODEL NIL :DOORS 4)</span></span></code></pre></div></li>
        </ol>
        <h3 id="5ad8ae40-1ebd-4f98-a6b0-560f4c5625ec">Accessing/Modifying slots in a structure instance</h3>
        <p>To access slot values, pass the structure to the function called <code class="verbatim">&lt;structure-name&gt;-&lt;slot-name&gt;</code>, created when compiling the structure definition. Use <code class="verbatim">setf</code> to modify the value.</p>
        <div class="sourceCode" id="cb244" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defstruct</span><span class="fu"> s-point</span></span>
            <span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a>  (x <span class="fl">0.0</span> <span class="bu">:type</span> <span class="kw">float</span>)</span>
            <span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>  (y <span class="fl">0.0</span> <span class="bu">:type</span> <span class="kw">float</span>))</span>
            <span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *s-point* </span>(make-s-point :x <span class="fl">5.0</span> :y <span class="fl">10.0</span>))</span>
            <span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a>(s-point-x *s-point*)</span>
            <span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 5.0</span></span>
            <span id="cb244-7"><a href="#cb244-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (s-point-x *s-point*) <span class="fl">10.0</span>)</span>
            <span id="cb244-8"><a href="#cb244-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 10.0</span></span>
            <span id="cb244-9"><a href="#cb244-9" aria-hidden="true" tabindex="-1"></a>(s-point-x *s-point*)</span>
            <span id="cb244-10"><a href="#cb244-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 10.0</span></span></code></pre></div>
        <h3 id="c9876377-22db-4194-a905-43347c12b0a9">Printing structures</h3>
        <p>Structures print in a somewhat human-readable form.</p>
        <div class="sourceCode" id="cb245" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">print</span> *s-point*)</span>
            <span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #S(S-POINT :X 10.0 :Y 10.0)</span></span></code></pre></div>
        <p>Use the <code class="verbatim">:print-structure</code> option to customize how it is printed.</p>
        <div class="sourceCode" id="cb246" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defstruct</span><span class="fu"> </span>(s-point (:print-function</span>
            <span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a>                     (<span class="kw">lambda</span> (this <span class="kw">stream</span> depth)</span>
            <span id="cb246-3"><a href="#cb246-3" aria-hidden="true" tabindex="-1"></a>                       (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~&amp;X: ~a Y: ~a~%&quot;</span> (s-point-x this) (s-point-y this)))))</span>
            <span id="cb246-4"><a href="#cb246-4" aria-hidden="true" tabindex="-1"></a>  (x <span class="fl">0.0</span> <span class="bu">:type</span> <span class="kw">float</span>)</span>
            <span id="cb246-5"><a href="#cb246-5" aria-hidden="true" tabindex="-1"></a>  (y <span class="fl">0.0</span> <span class="bu">:type</span> <span class="kw">float</span>))</span>
            <span id="cb246-6"><a href="#cb246-6" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb246-7"><a href="#cb246-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">print</span> (make-s-point :x <span class="fl">5.0</span> :y <span class="fl">10.0</span>))</span>
            <span id="cb246-8"><a href="#cb246-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;   =&gt; X: 5.0 Y: 10.0</span></span></code></pre></div>
        <p>The <code class="verbatim">depth</code> argument in the lambda list is required. When necessary, it is used to determine how to print nested structures.</p>
        <h3 id="2d2e5ed1-43a9-4b56-ab9b-ff682515a0f2">Structures Vs. Classes</h3>
        <ol class="incremental">
            <li><p>Similarities</p>
                <p>Structures and classes are both user-defined data types, they both let you define groups of related data into slots, and those slots can include default values and other options.</p>
                <p><code class="verbatim">Generic methods</code> can be specialized on both structures and classes.</p>
                <div class="sourceCode" id="cb247" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defgeneric</span><span class="fu"> add </span>(point-a point-b))</span>
                    <span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> add </span>((a s-point) (b s-point))</span>
                    <span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a>  (make-s-point :x (<span class="op">+</span> (s-point-x a) (s-point-x b))</span>
                    <span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a>                :y (<span class="op">+</span> (s-point-y a) (s-point-y b))))</span>
                    <span id="cb247-6"><a href="#cb247-6" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb247-7"><a href="#cb247-7" aria-hidden="true" tabindex="-1"></a>(add *s-point* *s-point*)</span>
                    <span id="cb247-8"><a href="#cb247-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; X: 20.0 Y: 20.0</span></span>
                    <span id="cb247-9"><a href="#cb247-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> add </span>((a c-point) (b c-point))</span>
                    <span id="cb247-10"><a href="#cb247-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">make-instance</span> <span class="dt">&#39;c-point</span></span>
                    <span id="cb247-11"><a href="#cb247-11" aria-hidden="true" tabindex="-1"></a>                 :x (<span class="op">+</span> (c-point-x a) (c-point-x b))</span>
                    <span id="cb247-12"><a href="#cb247-12" aria-hidden="true" tabindex="-1"></a>                 :y (<span class="op">+</span> (c-point-y a) (c-point-y b))))</span>
                    <span id="cb247-13"><a href="#cb247-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> *c-point* (<span class="kw">make-instance</span> <span class="dt">&#39;c-point</span> :x <span class="fl">4.0</span> :y <span class="fl">7.5</span>))</span>
                    <span id="cb247-14"><a href="#cb247-14" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb247-15"><a href="#cb247-15" aria-hidden="true" tabindex="-1"></a>(add *c-point* *c-point*)</span>
                    <span id="cb247-16"><a href="#cb247-16" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; This is your object data: X is 8.0, Y is 15.0</span></span></code></pre></div></li>
            <li><p>Differences</p>
                <ol class="incremental">
                    <li><p>Dynamic redefinition</p>
                        <p>Similarities between structures and classes are superficial–the differences are much more significant.</p>
                        <p>Probably the most important difference between structures and classes in Lisp is that when you modify their definition, currently instantiated structures aren't updated with the new definition, but object instances are. This is called <code class="verbatim">dynamic redefinition</code>.</p>
                        <p>Let's setup a structure and a class:</p>
                        <div class="sourceCode" id="cb248" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defstruct</span><span class="fu"> s-point</span></span>
                            <span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>  x</span>
                            <span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>  y)</span>
                            <span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *s-point* </span>(make-s-point :x <span class="dv">5</span> :y <span class="dv">10</span>))</span>
                            <span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; *S-POINT*</span></span>
                            <span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a>(s-point-x *s-point*)</span>
                            <span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 5 (3 bits, #x5, #o5, #b101)</span></span>
                            <span id="cb248-8"><a href="#cb248-8" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb248-9"><a href="#cb248-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> c-point </span>()</span>
                            <span id="cb248-10"><a href="#cb248-10" aria-hidden="true" tabindex="-1"></a>  ((x :initarg :x</span>
                            <span id="cb248-11"><a href="#cb248-11" aria-hidden="true" tabindex="-1"></a>      :initform <span class="kw">nil</span></span>
                            <span id="cb248-12"><a href="#cb248-12" aria-hidden="true" tabindex="-1"></a>      :accessor c-point-x)</span>
                            <span id="cb248-13"><a href="#cb248-13" aria-hidden="true" tabindex="-1"></a>   (y :initarg :y</span>
                            <span id="cb248-14"><a href="#cb248-14" aria-hidden="true" tabindex="-1"></a>      :initform <span class="kw">nil</span></span>
                            <span id="cb248-15"><a href="#cb248-15" aria-hidden="true" tabindex="-1"></a>      :accessor c-point-y)))</span>
                            <span id="cb248-16"><a href="#cb248-16" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *c-point* </span>(<span class="kw">make-instance</span> <span class="dt">&#39;c-point</span> :x <span class="dv">5</span> :y <span class="dv">10</span>))</span>
                            <span id="cb248-17"><a href="#cb248-17" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb248-18"><a href="#cb248-18" aria-hidden="true" tabindex="-1"></a>(c-point-x *c-point*)</span>
                            <span id="cb248-19"><a href="#cb248-19" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 5 (3 bits, #x5, #o5, #b101)</span></span></code></pre></div>
                        <p>Now, what happens to <em>instances</em> if we change their <em>definitions</em>?</p>
                        <p>With the structure:</p>
                        <div class="sourceCode" id="cb249" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defstruct</span><span class="fu"> s-point</span></span>
                            <span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a>  id</span>
                            <span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a>  x</span>
                            <span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a>  y)</span>
                            <span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; attempt to redefine the STRUCTURE-OBJECT class S-POINT</span></span>
                            <span id="cb249-7"><a href="#cb249-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; incompatibly with the current definition</span></span>
                            <span id="cb249-8"><a href="#cb249-8" aria-hidden="true" tabindex="-1"></a><span class="co">;;    [Condition of type SIMPLE-ERROR]</span></span>
                            <span id="cb249-9"><a href="#cb249-9" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb249-10"><a href="#cb249-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; Restarts:</span></span>
                            <span id="cb249-11"><a href="#cb249-11" aria-hidden="true" tabindex="-1"></a><span class="co">;;  0: [CONTINUE] Use the new definition of S-POINT, invalidating already-loaded code and instances.</span></span>
                            <span id="cb249-12"><a href="#cb249-12" aria-hidden="true" tabindex="-1"></a><span class="co">;;  1: [RECKLESSLY-CONTINUE] Use the new definition of S-POINT as if it were compatible, allowing old accessors to use new instances and allowing new accessors to use old instances.</span></span>
                            <span id="cb249-13"><a href="#cb249-13" aria-hidden="true" tabindex="-1"></a><span class="co">;;  2: [ABORT] Abort compilation.</span></span>
                            <span id="cb249-14"><a href="#cb249-14" aria-hidden="true" tabindex="-1"></a><span class="co">;;  3: [*ABORT] Return to SLY&#39;s top level.</span></span>
                            <span id="cb249-15"><a href="#cb249-15" aria-hidden="true" tabindex="-1"></a><span class="co">;;  4: [ABORT] abort thread (#&lt;THREAD tid=6447 &quot;slynk-worker&quot; RUNNING {70072FDD93}&gt;)</span></span></code></pre></div>
                        <p>We need to overwrite the current definition and invalidate loaded code and <em>instances</em>, or <code class="verbatim">RECKLESSLY-CONTINUE</code>.</p>
                        <p>With the class:</p>
                        <div class="sourceCode" id="cb250" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> c-point </span>()</span>
                            <span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a>  ((id :initarg :id</span>
                            <span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a>       :initform <span class="dv">7</span></span>
                            <span id="cb250-4"><a href="#cb250-4" aria-hidden="true" tabindex="-1"></a>       :accessor id)</span>
                            <span id="cb250-5"><a href="#cb250-5" aria-hidden="true" tabindex="-1"></a>   (x :initarg :x</span>
                            <span id="cb250-6"><a href="#cb250-6" aria-hidden="true" tabindex="-1"></a>      :initform <span class="kw">nil</span></span>
                            <span id="cb250-7"><a href="#cb250-7" aria-hidden="true" tabindex="-1"></a>      :accessor x)</span>
                            <span id="cb250-8"><a href="#cb250-8" aria-hidden="true" tabindex="-1"></a>   (y :initarg :y</span>
                            <span id="cb250-9"><a href="#cb250-9" aria-hidden="true" tabindex="-1"></a>      :initform <span class="kw">nil</span></span>
                            <span id="cb250-10"><a href="#cb250-10" aria-hidden="true" tabindex="-1"></a>      :accessor y)))</span>
                            <span id="cb250-11"><a href="#cb250-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;STANDARD-CLASS COMMON-LISP-USER::C-POINT&gt;</span></span>
                            <span id="cb250-12"><a href="#cb250-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Compiles without trouble.</span></span>
                            <span id="cb250-13"><a href="#cb250-13" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb250-14"><a href="#cb250-14" aria-hidden="true" tabindex="-1"></a>(id *c-point*)</span>
                            <span id="cb250-15"><a href="#cb250-15" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 7 (3 bits, #x7, #o7, #b111)</span></span>
                            <span id="cb250-16"><a href="#cb250-16" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; The instance is given the default initform.</span></span>
                            <span id="cb250-17"><a href="#cb250-17" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb250-18"><a href="#cb250-18" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> c-point </span>()</span>
                            <span id="cb250-19"><a href="#cb250-19" aria-hidden="true" tabindex="-1"></a>  ((x :initarg :x</span>
                            <span id="cb250-20"><a href="#cb250-20" aria-hidden="true" tabindex="-1"></a>      :initform <span class="kw">nil</span></span>
                            <span id="cb250-21"><a href="#cb250-21" aria-hidden="true" tabindex="-1"></a>      :accessor x)</span>
                            <span id="cb250-22"><a href="#cb250-22" aria-hidden="true" tabindex="-1"></a>   (y :initarg :y</span>
                            <span id="cb250-23"><a href="#cb250-23" aria-hidden="true" tabindex="-1"></a>      :initform <span class="kw">nil</span></span>
                            <span id="cb250-24"><a href="#cb250-24" aria-hidden="true" tabindex="-1"></a>      :accessor y)))</span>
                            <span id="cb250-25"><a href="#cb250-25" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb250-26"><a href="#cb250-26" aria-hidden="true" tabindex="-1"></a>(id *c-point*)                          <span class="co">; =&gt; Error, slot no longer exists.</span></span>
                            <span id="cb250-27"><a href="#cb250-27" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb250-28"><a href="#cb250-28" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> c-point </span>()</span>
                            <span id="cb250-29"><a href="#cb250-29" aria-hidden="true" tabindex="-1"></a>  ((id :initarg :id</span>
                            <span id="cb250-30"><a href="#cb250-30" aria-hidden="true" tabindex="-1"></a>       :initform (<span class="kw">random</span> <span class="kw">most-positive-fixnum</span>)</span>
                            <span id="cb250-31"><a href="#cb250-31" aria-hidden="true" tabindex="-1"></a>       :accessor id)</span>
                            <span id="cb250-32"><a href="#cb250-32" aria-hidden="true" tabindex="-1"></a>   (x :initarg :x</span>
                            <span id="cb250-33"><a href="#cb250-33" aria-hidden="true" tabindex="-1"></a>      :initform <span class="kw">nil</span></span>
                            <span id="cb250-34"><a href="#cb250-34" aria-hidden="true" tabindex="-1"></a>      :accessor x)</span>
                            <span id="cb250-35"><a href="#cb250-35" aria-hidden="true" tabindex="-1"></a>   (y :initarg :y</span>
                            <span id="cb250-36"><a href="#cb250-36" aria-hidden="true" tabindex="-1"></a>      :initform <span class="kw">nil</span></span>
                            <span id="cb250-37"><a href="#cb250-37" aria-hidden="true" tabindex="-1"></a>      :accessor y)))</span>
                            <span id="cb250-38"><a href="#cb250-38" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb250-39"><a href="#cb250-39" aria-hidden="true" tabindex="-1"></a>(id (<span class="kw">make-instance</span> <span class="dt">&#39;c-point</span>))</span>
                            <span id="cb250-40"><a href="#cb250-40" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 4069218540621267255 (62 bits, #x3878C4B3FB2A0137)</span></span>
                            <span id="cb250-41"><a href="#cb250-41" aria-hidden="true" tabindex="-1"></a>(id *c-point*)</span>
                            <span id="cb250-42"><a href="#cb250-42" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 3821555703091291730 (62 bits, #x3508E4AA1C1FE652)</span></span></code></pre></div></li>
                    <li><p>Inheritance</p>
                        <p>Both structures and classes support inheritance, but classes support <code class="verbatim">multiple inheritance</code>.</p></li>
                    <li><p>Printing</p>
                        <p>Structures can modify how <code class="verbatim">print</code> will display data using <code class="verbatim">:print-function</code> as above, but classes need to use the <code class="verbatim">print-object</code> generic method.</p>
                        <div class="sourceCode" id="cb251" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> print-object </span>((this c-point) <span class="kw">stream</span>)</span>
                            <span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~&amp;This is your object data: X is ~a, Y is ~a~%&quot;</span> (c-point-x this) (c-point-y this)))</span>
                            <span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">print</span> *c-point*)</span>
                            <span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;   =&gt; This is your object data: X is 5, Y is 10</span></span></code></pre></div></li>
                    <li><p>Typing</p>
                        <p>When you define slot types with structures, Lisp will check the type of value passed to it at compile time. Class slot type definitions aren't enforced–you need to enforce them yourself with <code class="verbatim">initialize-instance :before</code>.</p>
                        <div class="sourceCode" id="cb252" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> c-point </span>()</span>
                            <span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>  ((x :initarg :x</span>
                            <span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a>      :initform <span class="fl">0.0</span></span>
                            <span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a>      :accessor c-point-x</span>
                            <span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a>      <span class="bu">:type</span> <span class="kw">float</span>)                      <span class="co">; added type</span></span>
                            <span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a>   (y :initarg :y</span>
                            <span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a>      :initform <span class="fl">0.0</span></span>
                            <span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a>      :accessor c-point-y</span>
                            <span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a>      <span class="bu">:type</span> <span class="kw">float</span>)))                    <span class="co">; added type</span></span>
                            <span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb252-11"><a href="#cb252-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-instance</span> <span class="dt">&#39;c-point</span>)</span>
                            <span id="cb252-12"><a href="#cb252-12" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; This is your object data: X is 0.0, Y is 0.0</span></span>
                            <span id="cb252-13"><a href="#cb252-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-instance</span> <span class="dt">&#39;c-point</span> :x <span class="fl">5.0</span> :y <span class="fl">12.3</span>)</span>
                            <span id="cb252-14"><a href="#cb252-14" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; This is your object data: X is 5.0, Y is 12.3</span></span>
                            <span id="cb252-15"><a href="#cb252-15" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-instance</span> <span class="dt">&#39;c-point</span> :x <span class="st">&quot;five dot zero&quot;</span>)</span>
                            <span id="cb252-16"><a href="#cb252-16" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; This is your object data: X is five dot zero, Y is 0.0</span></span>
                            <span id="cb252-17"><a href="#cb252-17" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb252-18"><a href="#cb252-18" aria-hidden="true" tabindex="-1"></a><span class="co">;; Check the types before initializing the instance.</span></span>
                            <span id="cb252-19"><a href="#cb252-19" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> initialize-instance </span>:before ((p c-point) &amp;key x y)</span>
                            <span id="cb252-20"><a href="#cb252-20" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (<span class="kw">typep</span> x <span class="dt">&#39;float</span>)</span>
                            <span id="cb252-21"><a href="#cb252-21" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="dt">&#39;type-error</span> :datum x :expected-type <span class="dt">&#39;float</span>))</span>
                            <span id="cb252-22"><a href="#cb252-22" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (<span class="kw">typep</span> y <span class="dt">&#39;float</span>)</span>
                            <span id="cb252-23"><a href="#cb252-23" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="dt">&#39;type-error</span> :datum y :expected-type <span class="dt">&#39;float</span>)))</span>
                            <span id="cb252-24"><a href="#cb252-24" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb252-25"><a href="#cb252-25" aria-hidden="true" tabindex="-1"></a>(<span class="kw">handler-case</span></span>
                            <span id="cb252-26"><a href="#cb252-26" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> ((p2 (<span class="kw">make-instance</span> <span class="dt">&#39;c-point</span> :x <span class="st">&quot;invalid&quot;</span> :y <span class="fl">2.0</span>)))</span>
                            <span id="cb252-27"><a href="#cb252-27" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;This won&#39;t print due to type error~%&quot;</span>))</span>
                            <span id="cb252-28"><a href="#cb252-28" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">type-error</span> (e)</span>
                            <span id="cb252-29"><a href="#cb252-29" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;Type error caught: ~a~%&quot;</span> e)))</span>
                            <span id="cb252-30"><a href="#cb252-30" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; Type error caught: The value</span></span>
                            <span id="cb252-31"><a href="#cb252-31" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;                      &quot;invalid&quot;</span></span>
                            <span id="cb252-32"><a href="#cb252-32" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;                    is not of type</span></span>
                            <span id="cb252-33"><a href="#cb252-33" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;                      FLOAT</span></span>
                            <span id="cb252-34"><a href="#cb252-34" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; NIL</span></span></code></pre></div>
                        <p>Type definitions in class slots should be considered "documentation"–you need to enforce the types yourself. With structure slots, types are enforced by the compiler.</p></li>
                </ol></li>
            <li><p>Which one should you use?</p>
                <p>Generally, structures are going to be most useful for optimizing speed and memory efficiency. Classes are otherwise superior due to their more dynamic, flexible design. Unless you know for certain that you need an optimized data structure, stick with classes.</p></li>
        </ol>
        <h1 id="62af4a9f-2a40-4502-acf3-68db21ecc13d">ERRORS &amp; CONDITIONS</h1>
        <h2 id="49ac2060-d571-4037-b248-3807f63463c4">Signaling Conditions</h2>
        <p>In Lisp, instead of "throwing" or "returning" an error, you "signal a condition". The most common way to signal some <code class="verbatim">condition</code> is to use <code class="verbatim">error</code> or <code class="verbatim">cerror</code>.</p>
        <div class="sourceCode" id="cb253" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> oops </span>(x)</span>
            <span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (<span class="kw">zerop</span> x)</span>
            <span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="st">&quot;What the h?&quot;</span>)))</span>
            <span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a>(oops <span class="dv">0</span>)</span></code></pre></div>
        <p>That opens the debugger:</p>
        <pre class="example"><code>What the h?
   [Condition of type SIMPLE-ERROR]

Restarts:
 0: [*ABORT] Return to SLY&#39;s top level.
 1: [ABORT] abort thread (#&lt;THREAD tid=12411 &quot;slynk-worker&quot; RUNNING {7007185183}&gt;)
        </code></pre>
        <p>Notice that the <code class="verbatim">condition</code> is a <code class="verbatim">SIMPLE-ERROR</code>.</p>
        <p><code class="verbatim">cerror</code> will create a <em>continuable</em> error.</p>
        <div class="sourceCode" id="cb255" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> oops </span>(x)</span>
            <span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (<span class="kw">zerop</span> x)</span>
            <span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">cerror</span> <span class="st">&quot;Want to continue?&quot;</span> <span class="st">&quot;You passed =d&quot;</span> x))</span>
            <span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print</span> <span class="st">&quot;You continued.&quot;</span>))</span>
            <span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a>(oops <span class="dv">0</span>)</span></code></pre></div>
        <p>Returns:</p>
        <pre class="example"><code>You passed 0
   [Condition of type SIMPLE-ERROR]

Restarts:
 0: [CONTINUE] Want to continue?
 1: [*ABORT] Return to SLY&#39;s top level.
 2: [ABORT] abort thread (#&lt;THREAD tid=12483 &quot;slynk-worker&quot; RUNNING {700776ADA3}&gt;)
        </code></pre>
        <p>Continuing will continue after the point of the error.</p>
        <p>If you only want to make a warning, you can use <code class="verbatim">warn</code>.</p>
        <div class="sourceCode" id="cb257" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">progn</span></span>
            <span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">warn</span> <span class="st">&quot;You are about to be Rick Rolled.&quot;</span>)</span>
            <span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;Never Gonna Give You Up&quot;</span>)</span>
            <span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">error</span> <span class="st">&quot;You&#39;ve been deserted.&quot;</span>)</span>
            <span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;I hate meta.&quot;</span>))</span></code></pre></div>
        <p>If you execute this, it will print the warning and the first <code class="verbatim">format</code> in the REPL and then open a debugger with the error message. You won't see the second <code class="verbatim">format</code> message.</p>
        <h2 id="154ee590-039c-4811-91fb-ac20ae500496">Assertions</h2>
        <p>With ~assert=, you can check a condition. If it returns <code class="verbatim">t</code>, the program continues. If the condition returns <code class="verbatim">nil</code>, it will signal a continuable error and then you can assign a value to the selected symbols and retry the assert.</p>
        <div class="sourceCode" id="cb258" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> using-assertion </span>(x)</span>
            <span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print</span> <span class="st">&quot;before assert&quot;</span>)</span>
            <span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">assert</span> (<span class="op">&gt;</span> x <span class="dv">0</span>)</span>
            <span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>          (x)</span>
            <span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;=d Needs to be a positive number.&quot;</span> x)</span>
            <span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print</span> <span class="st">&quot;after assert&quot;</span>)</span>
            <span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print</span> x))</span>
            <span id="cb258-8"><a href="#cb258-8" aria-hidden="true" tabindex="-1"></a>(using-assertion <span class="op">-</span><span class="dv">4</span>)</span></code></pre></div>
        <p>Returns:</p>
        <pre class="example"><code>Needs to be a positive number.
   [Condition of type SIMPLE-ERROR]

Restarts:
 0: [CONTINUE] Retry assertion with new value for X.
 1: [*ABORT] Return to SLY&#39;s top level.
 2: [ABORT] abort thread (#&lt;THREAD tid=12435 &quot;slynk-worker&quot; RUNNING {7007A4FF33}&gt;)
        </code></pre>
        <p>If you continue, in the REPL, this is what you'll see:</p>
        <pre class="example"><code>&quot;before assert&quot;
The old value of X is -4.
Do you want to supply a new value?  (y or n)
        </code></pre>
        <p>If you type <code class="verbatim">y</code> and <code class="verbatim">Enter</code>, then you will be prompted to enter a form to be evaluated.</p>
        <pre class="example"><code>Type a form to be evaluated:
[I type in 1]

&quot;after assert&quot;
1
        </code></pre>
        <h2 id="8c8d438e-de15-49b3-9150-53eed26f93c4">Conditions</h2>
        <p>If you need or want to provide more control over error handling, you can define your own conditions.</p>
        <div class="sourceCode" id="cb262" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">define-condition</span><span class="fu"> naughty-word </span>(<span class="kw">error</span>)</span>
            <span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a>  ()</span>
            <span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a>  (:documentation <span class="st">&quot;A condition for when naughty words are detected.&quot;</span>))</span></code></pre></div>
        <p>Conditions are <code class="verbatim">objects</code> using the CLOS.</p>
        <div class="sourceCode" id="cb263" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-condition</span> <span class="dt">&#39;naughty-word</span>)</span>
            <span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;NAUGHTY-WORD {7009850503}&gt;</span></span></code></pre></div>
        <p>Let's make a list of naughty words to detect and a function to detect them.</p>
        <div class="sourceCode" id="cb264" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *naughty-words* </span>&#39;(rust java haskell cobol crypto bitcoin)</span>
            <span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Words that must never be uttered.&quot;</span>)</span>
            <span id="cb264-3"><a href="#cb264-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb264-4"><a href="#cb264-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> naughty-word-p </span>(word)</span>
            <span id="cb264-5"><a href="#cb264-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Check if a word is in *naughty-words*.&quot;</span></span>
            <span id="cb264-6"><a href="#cb264-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">member</span> word *naughty-words*))</span>
            <span id="cb264-7"><a href="#cb264-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb264-8"><a href="#cb264-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> process-word </span>(word)</span>
            <span id="cb264-9"><a href="#cb264-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Signal a naughty-word condition if a word is naughty.&quot;</span></span>
            <span id="cb264-10"><a href="#cb264-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">when</span> (naughty-word-p word)</span>
            <span id="cb264-11"><a href="#cb264-11" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="dt">&#39;naughty-word</span>))</span>
            <span id="cb264-12"><a href="#cb264-12" aria-hidden="true" tabindex="-1"></a>  word)</span>
            <span id="cb264-13"><a href="#cb264-13" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb264-14"><a href="#cb264-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> process-sentence </span>(sentence)</span>
            <span id="cb264-15"><a href="#cb264-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Look through all the words in a sentence and do something if any of them are</span></span>
            <span id="cb264-16"><a href="#cb264-16" aria-hidden="true" tabindex="-1"></a><span class="st">naughty.&quot;</span></span>
            <span id="cb264-17"><a href="#cb264-17" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">loop</span> :for word :in sentence</span>
            <span id="cb264-18"><a href="#cb264-18" aria-hidden="true" tabindex="-1"></a>        :collect (process-word word)))</span>
            <span id="cb264-19"><a href="#cb264-19" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb264-20"><a href="#cb264-20" aria-hidden="true" tabindex="-1"></a>(process-sentence &#39;(java has <span class="kw">the</span> best oop <span class="kw">system</span> among all programming languages))</span></code></pre></div>
        <p>When you run the above code, the debugger will pop up with an error:</p>
        <pre class="example"><code>Condition ALMIGHTY/KAIKEI/TESTS::NAUGHTY-WORD was signalled.
   [Condition of type NAUGHTY-WORD]

Restarts:
 0: [*ABORT] Return to SLY&#39;s top level.
 1: [ABORT] abort thread (#&lt;THREAD tid=12475 &quot;slynk-worker&quot; RUNNING {70069EF533}&gt;)
        </code></pre>
        <p>We can improve our error messages by modifying the condition definition.</p>
        <div class="sourceCode" id="cb266" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">define-condition</span><span class="fu"> naughty-word </span>(<span class="kw">error</span>)</span>
            <span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a>  ((bad-word :initarg :bad-word :initform <span class="kw">nil</span> :reader bad-word))</span>
            <span id="cb266-3"><a href="#cb266-3" aria-hidden="true" tabindex="-1"></a>  (:documentation <span class="st">&quot;A condition for when naughty words are detected.&quot;</span></span>
            <span id="cb266-4"><a href="#cb266-4" aria-hidden="true" tabindex="-1"></a>   :report (<span class="kw">lambda</span> (c <span class="kw">stream</span>)</span>
            <span id="cb266-5"><a href="#cb266-5" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;Naughty bad-word detected: ~a&quot;</span> (word c)))))</span></code></pre></div>
        <p>Then we update the call to <code class="verbatim">error</code>:</p>
        <div class="sourceCode" id="cb267" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> process-word </span>(word)</span>
            <span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Signal a naughty-word condition if a word is naughty.&quot;</span></span>
            <span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">when</span> (naughty-word-p word)</span>
            <span id="cb267-4"><a href="#cb267-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="dt">&#39;naughty-word</span> :word word))</span>
            <span id="cb267-5"><a href="#cb267-5" aria-hidden="true" tabindex="-1"></a>  word)</span></code></pre></div>
        <p>Run <code class="verbatim">process-sentence</code> again and your debugger will display the following message:</p>
        <pre class="example"><code>Naughty word detected: JAVA
   [Condition of type NAUGHTY-WORD]

Restarts:
 0: [*ABORT] Return to SLY&#39;s top level.
 1: [ABORT] abort thread (#&lt;THREAD tid=12487 &quot;slynk-worker&quot; RUNNING {7007CA75C3}&gt;)

Backtrace:
 0: (PROCESS-WORD JAVA)
 1: (PROCESS-SENTENCE (JAVA HAS THE BEST OOP SYSTEM ...))
        </code></pre>
        <h2 id="0f285c94-e15c-4efb-88e6-0f95d070d3fb">Restarts</h2>
        <p>If you define a condition, it's because you want to provide the ability to recover from some error. One recovery mechanism you can provide are <code class="verbatim">restarts</code>. To provide more restarts, use <code class="verbatim">restart-case</code>.</p>
        <div class="sourceCode" id="cb269" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> replace-word </span>(word)</span>
            <span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Replace a word in a list.&quot;</span></span>
            <span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">intern</span> (<span class="kw">string-upcase</span> (<span class="kw">read-line</span>))))</span>
            <span id="cb269-4"><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb269-5"><a href="#cb269-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> process-word </span>(word)</span>
            <span id="cb269-6"><a href="#cb269-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Check a word. If it&#39;s naughty, give the user the choice to replace the word.&quot;</span></span>
            <span id="cb269-7"><a href="#cb269-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (naughty-word-p word)</span>
            <span id="cb269-8"><a href="#cb269-8" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">restart-case</span></span>
            <span id="cb269-9"><a href="#cb269-9" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">error</span> <span class="dt">&#39;naughty-word</span> :word word)</span>
            <span id="cb269-10"><a href="#cb269-10" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">continue</span> ()</span>
            <span id="cb269-11"><a href="#cb269-11" aria-hidden="true" tabindex="-1"></a>          :report <span class="st">&quot;Sticks and stones. Just leave the word as it is.&quot;</span></span>
            <span id="cb269-12"><a href="#cb269-12" aria-hidden="true" tabindex="-1"></a>          word)</span>
            <span id="cb269-13"><a href="#cb269-13" aria-hidden="true" tabindex="-1"></a>        (censor ()</span>
            <span id="cb269-14"><a href="#cb269-14" aria-hidden="true" tabindex="-1"></a>          :report <span class="st">&quot;Replace the naughty word with one you like more.&quot;</span></span>
            <span id="cb269-15"><a href="#cb269-15" aria-hidden="true" tabindex="-1"></a>          (replace-word word)))</span>
            <span id="cb269-16"><a href="#cb269-16" aria-hidden="true" tabindex="-1"></a>      word))</span></code></pre></div>
        <p>Now when you run <code class="verbatim">process-sentence</code>, you can replace any of the words found in the <code class="verbatim">*naughty-words*</code> list using a restart.</p>
        <h2 id="53b0905a-d5a5-4ccb-b9d9-a21eccc307c5">Handlers</h2>
        <p>Another recovery mechanism is via "handling". When the <code class="verbatim">naughty-word</code> condition is signaled, you can prevent the program from stopping and the debugger from opening by using either <code class="verbatim">handler-case</code>.</p>
        <div class="sourceCode" id="cb270" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> process-sentence </span>(sentence)</span>
            <span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Look through all the words in a sentence and do something if any of them are</span></span>
            <span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a><span class="st">naughty.&quot;</span></span>
            <span id="cb270-4"><a href="#cb270-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">loop</span> :for word :in sentence</span>
            <span id="cb270-5"><a href="#cb270-5" aria-hidden="true" tabindex="-1"></a>        :collect (<span class="kw">handler-case</span> (process-word word)</span>
            <span id="cb270-6"><a href="#cb270-6" aria-hidden="true" tabindex="-1"></a>                   (naughty-word () <span class="dt">&#39;***</span>))))</span>
            <span id="cb270-7"><a href="#cb270-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb270-8"><a href="#cb270-8" aria-hidden="true" tabindex="-1"></a>(process-sentence &#39;(java has <span class="kw">the</span> best oop <span class="kw">system</span> among all programming languages))</span></code></pre></div>
        <p>Now, instead of bringing up the debugger, if a naughty word is encountered during the iteration, it will simply be replaced by "<strong>*</strong>".</p>
        <h2 id="77dba755-4000-458c-8c2b-b3a2dad5fd0b"><code class="verbatim">*break-on-signals*</code></h2>
        <p>The <code class="verbatim">*break-on-signals*</code> is set to <code class="verbatim">nil</code> by default, but when set to some condition or conditions, will break just before the condition is signaled. It's useful for getting a look at the state of the program just before a condition is signaled, especially when you don't know exactly where the error is coming from (in which case, you could use Sly stickers + breaking as I wrote about earlier in <a href="id:f6a4fdc2-7295-4bfa-8551-f5cf4e242ee7">THE LISP IDE/STICKERS</a>).</p>
        <h1 id="e0493a8c-8b17-482d-b0a3-fe6af193366a">MACROS</h1>
        <h2 id="70197a75-5703-4a5c-bb35-e2167dc85d36">The Forbidden Fruit</h2>
        <p>Macros are a controversial feature of Lisp. On the one hand, they are one of the main reasons why Lisp is so powerful and flexible. They are a defining feature, enabling a masterful macro writer to bend the language to his will. There are no limits; you can rewrite the language in your own image.</p>
        <p>It's such a compelling feature that I use it to advertise this book.</p>
        <p>On the other hand, many experienced users of Lisp warn against the use of macros. While some Lisp advocates strongly encourage the use of macros, Peter Norvig in Paradigms of Artificial Intelligence Programming writes:</p>
        <blockquote>
            <p>The first step in writing a macro is to recognize that every time you write one, you are defining a new language …. Introducing a macro puts much more memory strain on the reader of your program than does introducing a function, variable or data type, so it should not be taken lightly. Introduce macros only when there is a clear need, and when the macro fits in well with your existing system.</p>
        </blockquote>
        <p>In other words, macros are powerful and require experience to use properly. In fact, they require experience just to understand their value and power. Many Lisp-skeptics question whether their benefits are worth the cost of using a niche language like Lisp over languages with more energetic ecosystems.</p>
        <p>Lisp advocates find it challenging to convince skeptics to give Lisp a serious look because demonstrating the value of macros for common programming tasks is honestly not possible, and it's easy to imagine the nightmare of domain specific languages all over the place written by people unqualified to write more than a CRUD app (like me). Macros are something that need to be experienced to be understood–similar to Lisp's image-based programming model. Unfortunately, "You have to try it to understand" sounds a lot like cope from delusional nerds advocating for solutions without recognizing the weaknesses of their solutions (something nerds are wont to do).</p>
        <p>However, Lisp-curious programmers are often attracted to the <em>platonic ideal</em> of macros. Its the One Ring, the fruit when eaten that grants forbidden knowledge that they hope will give them an edge over the programmers using lesser languages. When faced with a problem, macros are the first thing that these people (maybe even you, my smart and handsome customer) want to try to use to solve the problem. The warnings of the graybeards make macros ever more tantalizing, and the macro-skeptics create an opponent in the mind of the macro-maximalist who sees them as the losers they will crush when they finally unlock the true potential of meta programming.</p>
        <p>If you're reading this, you are likely among those curious to learn more about macros in particular. Because macros are such a deep subject, even if I were a macro wizard (which I am not), I couldn't provide a tutorial expansive and worthy enough to be called complete. Here in this chapter I can only teach the essential things to know about macros. See the RESOURCES chapter to get a list of resources for learning more about macros and more.</p>
        <h2 id="0b73d959-e42c-444c-85f6-f94d546bf212">Some Demonstrations</h2>
        <p>First, I think it's useful to see what macros can do.</p>
        <h3 id="0d0b395f-516f-45d9-be01-735032eb877f">The <code class="verbatim">hsx</code> macro</h3>
        <div class="sourceCode" id="cb271" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>(ql:quickload <span class="st">&quot;hsx&quot;</span>)</span>
            <span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> :hsx)</span>
            <span id="cb271-3"><a href="#cb271-3" aria-hidden="true" tabindex="-1"></a>(hsx</span>
            <span id="cb271-4"><a href="#cb271-4" aria-hidden="true" tabindex="-1"></a> (div :id <span class="st">&quot;card-container&quot;</span></span>
            <span id="cb271-5"><a href="#cb271-5" aria-hidden="true" tabindex="-1"></a>   (a :href <span class="st">&quot;/path/to/book-1&quot;</span></span>
            <span id="cb271-6"><a href="#cb271-6" aria-hidden="true" tabindex="-1"></a>     (div :class <span class="st">&quot;card&quot;</span></span>
            <span id="cb271-7"><a href="#cb271-7" aria-hidden="true" tabindex="-1"></a>       (h2 :class <span class="st">&quot;card-title&quot;</span> <span class="st">&quot;Book 1&quot;</span>)</span>
            <span id="cb271-8"><a href="#cb271-8" aria-hidden="true" tabindex="-1"></a>       (p :class <span class="st">&quot;card-body&quot;</span> <span class="st">&quot;This is book 1 of the series of books.&quot;</span>)))))</span>
            <span id="cb271-9"><a href="#cb271-9" aria-hidden="true" tabindex="-1"></a><span class="co">; =&gt;</span></span>
            <span id="cb271-10"><a href="#cb271-10" aria-hidden="true" tabindex="-1"></a><span class="co">; &lt;div id=&quot;card-container&quot;&gt;</span></span>
            <span id="cb271-11"><a href="#cb271-11" aria-hidden="true" tabindex="-1"></a><span class="co">;   &lt;a href=&quot;/path/to/book-1&quot;&gt;</span></span>
            <span id="cb271-12"><a href="#cb271-12" aria-hidden="true" tabindex="-1"></a><span class="co">;     &lt;div class=&quot;card&quot;&gt;</span></span>
            <span id="cb271-13"><a href="#cb271-13" aria-hidden="true" tabindex="-1"></a><span class="co">;       &lt;h2 class=&quot;card-title&quot;&gt;Book 1&lt;/h2&gt;</span></span>
            <span id="cb271-14"><a href="#cb271-14" aria-hidden="true" tabindex="-1"></a><span class="co">;       &lt;p class=&quot;card-body&quot;&gt;This is book 1 of the series of books.&lt;/p&gt;</span></span>
            <span id="cb271-15"><a href="#cb271-15" aria-hidden="true" tabindex="-1"></a><span class="co">;     &lt;/div&gt;</span></span>
            <span id="cb271-16"><a href="#cb271-16" aria-hidden="true" tabindex="-1"></a><span class="co">;   &lt;/a&gt;</span></span>
            <span id="cb271-17"><a href="#cb271-17" aria-hidden="true" tabindex="-1"></a><span class="co">; &lt;/div&gt;</span></span></code></pre></div>
        <p>This is the <code class="verbatim">hsx</code> macro from the <code class="verbatim">hsx</code> library. It produces HTML.</p>
        <h3 id="2328780b-01ad-4573-817c-0b67be34d376">The <code class="verbatim">sxql</code> macro</h3>
        <div class="sourceCode" id="cb272" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>(ql:quickload <span class="st">&quot;sxql&quot;</span>)</span>
            <span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> :sxql)</span>
            <span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a>(yield (select :*</span>
            <span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a>         (from :users)</span>
            <span id="cb272-5"><a href="#cb272-5" aria-hidden="true" tabindex="-1"></a>         (where (:= :age <span class="dv">30</span>))))</span>
            <span id="cb272-6"><a href="#cb272-6" aria-hidden="true" tabindex="-1"></a> <span class="co">; =&gt; &quot;SELECT * FROM users WHERE (age = ?)&quot;, (30)</span></span></code></pre></div>
        <p>This is a SQL query produced with the <code class="verbatim">sxql</code> library using several macros.</p>
        <h3 id="03b907b3-abdf-4b5a-ba24-25dbe8586d82">The Coalton language</h3>
        <div class="sourceCode" id="cb273" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">declare</span> create-account (AccountName -&gt; Balance -&gt; BankM (BankResult Account)))</span>
            <span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a>(define (create-account name initial-balance)</span>
            <span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Adds an account to the BankState and return the created account.&quot;</span></span>
            <span id="cb273-4"><a href="#cb273-4" aria-hidden="true" tabindex="-1"></a>  (run-resultT</span>
            <span id="cb273-5"><a href="#cb273-5" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">do</span></span>
            <span id="cb273-6"><a href="#cb273-6" aria-hidden="true" tabindex="-1"></a>    (accounts &lt;- (lift (lift <span class="kw">get</span>)))</span>
            <span id="cb273-7"><a href="#cb273-7" aria-hidden="true" tabindex="-1"></a>    (ResultT</span>
            <span id="cb273-8"><a href="#cb273-8" aria-hidden="true" tabindex="-1"></a>     (match (get-account name accounts)</span>
            <span id="cb273-9"><a href="#cb273-9" aria-hidden="true" tabindex="-1"></a>       ((Err _) (pure (Ok Unit)))</span>
            <span id="cb273-10"><a href="#cb273-10" aria-hidden="true" tabindex="-1"></a>       ((Ok _) (pure (Err (AccountAlreadyExists name))))))</span>
            <span id="cb273-11"><a href="#cb273-11" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">let</span> unvalidated-account <span class="op">=</span> (Account name initial-balance))</span>
            <span id="cb273-12"><a href="#cb273-12" aria-hidden="true" tabindex="-1"></a>     (account &lt;- (ResultT (check-account-is-valid unvalidated-account)))</span>
            <span id="cb273-13"><a href="#cb273-13" aria-hidden="true" tabindex="-1"></a>     (ResultT (set-account account)))))</span></code></pre></div>
        <p>This is <a href="https://github.com/coalton-lang/coalton/blob/main/examples/small-coalton-programs/src/monads-bank.lisp">example code</a> for <a href="https://www.youtube.com/watch?v=of92m4XNgrM">Coalton</a>, a new programming language built on top of Common Lisp. It's "just a macro".</p>
        <h3 id="4aae99c4-a600-4b85-87e7-67ff95445256">Code That Writes Code</h3>
        <p>What we see above is that macros are code that is capable of either generating, or fully implementing, entirely other languages. Of course, they can produce Lisp code, as the <code class="verbatim">defun</code> and <code class="verbatim">loop</code> macros do.</p>
        <h2 id="understanding-macros">Understanding Macros</h2>
        <p>Before I show how to write macros, it will be useful to know a little about how macros work.</p>
        <h3 id="0a5c60b9-1d45-464a-9de4-e63c9e285ace">Compilation Before Evaluation</h3>
        <p>The most important thing to know about macros is that they are compiled or expanded before they are evaluated. Because of this expansion step, macros are the only tool programmers can use to modify the evaluation of the code it expands into.</p>
        <p>In Lisp, the first symbol in a list is evaluated as a function name, and the rest of the values are evaluated from left to right. Before the function name is looked up, the parameters are evaluated.</p>
        <div class="sourceCode" id="cb274" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>(hello my name is <span class="st">&quot;Micah&quot;</span>)</span></code></pre></div>
        <p>The error you get here is about a non-existent <code class="verbatim">my</code> variable–<code class="verbatim">hello</code> will be evaluated after the arguments, and <code class="verbatim">my</code> is the first argument.</p>
        <p>But what about <code class="verbatim">defun</code>? The whole point is that the first symbol <em>is suppose to be bound to the definition that follows</em>.</p>
        <div class="sourceCode" id="cb275" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> hello </span>(name)</span>
            <span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print</span> name))</span></code></pre></div>
        <p><code class="verbatim">hello</code> isn't evaluated as a symbol containing a value–it's used as the name for the code that follows.</p>
        <p>And that's how we know <code class="verbatim">defun</code> is a macro.</p>
        <p>We can even view what the <code class="verbatim">defun</code> macro expands to right in Emacs. With the cursor over the part that says <code class="verbatim">defun hello</code>, type <code class="verbatim">SPC m m</code> (<code class="verbatim">macrostep-expand</code>). If you are using SBCL as I suggested at the beginning of the book, you should see something like this:</p>
        <div class="sourceCode" id="cb276" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">progn</span></span>
            <span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a> (<span class="kw">eval-when</span> (:compile-toplevel) (sb-c:%compiler-defun <span class="dt">&#39;hello</span> <span class="kw">t</span> <span class="kw">nil</span> <span class="kw">nil</span>))</span>
            <span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a> (sb-impl::%<span class="kw">defun</span><span class="fu"> </span><span class="dt">&#39;hello</span></span>
            <span id="cb276-4"><a href="#cb276-4" aria-hidden="true" tabindex="-1"></a>                  (sb-int:named-lambda hello</span>
            <span id="cb276-5"><a href="#cb276-5" aria-hidden="true" tabindex="-1"></a>                      (name)</span>
            <span id="cb276-6"><a href="#cb276-6" aria-hidden="true" tabindex="-1"></a>                    (<span class="kw">block</span> hello (<span class="kw">print</span> name)))))</span></code></pre></div>
        <p>Because macros can expand into more macros, you may be able to expand more macros after the first expansion.</p>
        <div class="sourceCode" id="cb277" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> hello </span>(names)</span>
            <span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">loop</span> :for name :in names</span>
            <span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a>        :do (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;Hello, ~a.~&amp;&quot;</span> name)))</span>
            <span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; expands into</span></span>
            <span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">progn</span></span>
            <span id="cb277-6"><a href="#cb277-6" aria-hidden="true" tabindex="-1"></a> (<span class="kw">eval-when</span> (:compile-toplevel) (sb-c:%compiler-defun <span class="dt">&#39;hello</span> <span class="kw">t</span> <span class="kw">nil</span> <span class="kw">nil</span>))</span>
            <span id="cb277-7"><a href="#cb277-7" aria-hidden="true" tabindex="-1"></a> (sb-impl::%<span class="kw">defun</span><span class="fu"> </span><span class="dt">&#39;hello</span></span>
            <span id="cb277-8"><a href="#cb277-8" aria-hidden="true" tabindex="-1"></a>                  (sb-int:named-lambda hello</span>
            <span id="cb277-9"><a href="#cb277-9" aria-hidden="true" tabindex="-1"></a>                      (names)</span>
            <span id="cb277-10"><a href="#cb277-10" aria-hidden="true" tabindex="-1"></a>                    (<span class="kw">block</span> hello</span>
            <span id="cb277-11"><a href="#cb277-11" aria-hidden="true" tabindex="-1"></a>                      (<span class="kw">loop</span> :for name :in names</span>
            <span id="cb277-12"><a href="#cb277-12" aria-hidden="true" tabindex="-1"></a>                            :do (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;Hello, ~a.~&amp;&quot;</span> name))))))</span>
            <span id="cb277-13"><a href="#cb277-13" aria-hidden="true" tabindex="-1"></a><span class="co">;; which further expands into... </span></span>
            <span id="cb277-14"><a href="#cb277-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">progn</span></span>
            <span id="cb277-15"><a href="#cb277-15" aria-hidden="true" tabindex="-1"></a> (<span class="kw">eval-when</span> (:compile-toplevel) (sb-c:%compiler-defun <span class="dt">&#39;hello</span> <span class="kw">t</span> <span class="kw">nil</span> <span class="kw">nil</span>))</span>
            <span id="cb277-16"><a href="#cb277-16" aria-hidden="true" tabindex="-1"></a> (sb-impl::%<span class="kw">defun</span><span class="fu"> </span><span class="dt">&#39;hello</span></span>
            <span id="cb277-17"><a href="#cb277-17" aria-hidden="true" tabindex="-1"></a>                  (sb-int:named-lambda hello</span>
            <span id="cb277-18"><a href="#cb277-18" aria-hidden="true" tabindex="-1"></a>                      (names)</span>
            <span id="cb277-19"><a href="#cb277-19" aria-hidden="true" tabindex="-1"></a>                    (<span class="kw">block</span> hello</span>
            <span id="cb277-20"><a href="#cb277-20" aria-hidden="true" tabindex="-1"></a>                      (<span class="kw">block</span> <span class="kw">nil</span></span>
            <span id="cb277-21"><a href="#cb277-21" aria-hidden="true" tabindex="-1"></a>                        (<span class="kw">let</span> ((name <span class="kw">nil</span>)</span>
            <span id="cb277-22"><a href="#cb277-22" aria-hidden="true" tabindex="-1"></a>                              (#:l548</span>
            <span id="cb277-23"><a href="#cb277-23" aria-hidden="true" tabindex="-1"></a>                               (sb-kernel:the* (<span class="kw">list</span> :use-annotations <span class="kw">t</span> :source-form names) names)))</span>
            <span id="cb277-24"><a href="#cb277-24" aria-hidden="true" tabindex="-1"></a>                          (<span class="kw">declare</span> (<span class="kw">ignorable</span> #:l548)</span>
            <span id="cb277-25"><a href="#cb277-25" aria-hidden="true" tabindex="-1"></a>                                   (<span class="kw">ignorable</span> name))</span>
            <span id="cb277-26"><a href="#cb277-26" aria-hidden="true" tabindex="-1"></a>                          (<span class="kw">tagbody</span></span>
            <span id="cb277-27"><a href="#cb277-27" aria-hidden="true" tabindex="-1"></a>                           sb-loop::next-loop</span>
            <span id="cb277-28"><a href="#cb277-28" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">when</span> (<span class="kw">endp</span> #:l548) (<span class="kw">go</span> sb-loop::end-loop))</span>
            <span id="cb277-29"><a href="#cb277-29" aria-hidden="true" tabindex="-1"></a>                            (sb-loop::loop-desetq name (<span class="kw">car</span> #:l548))</span>
            <span id="cb277-30"><a href="#cb277-30" aria-hidden="true" tabindex="-1"></a>                            (sb-loop::loop-desetq #:l548 (<span class="kw">cdr</span> #:l548))</span>
            <span id="cb277-31"><a href="#cb277-31" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;Hello, ~a.~&amp;&quot;</span> name)</span>
            <span id="cb277-32"><a href="#cb277-32" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">go</span> sb-loop::next-loop)</span>
            <span id="cb277-33"><a href="#cb277-33" aria-hidden="true" tabindex="-1"></a>                           sb-loop::end-loop)))))))</span>
            <span id="cb277-34"><a href="#cb277-34" aria-hidden="true" tabindex="-1"></a><span class="co">;; and further...</span></span>
            <span id="cb277-35"><a href="#cb277-35" aria-hidden="true" tabindex="-1"></a>(<span class="kw">progn</span></span>
            <span id="cb277-36"><a href="#cb277-36" aria-hidden="true" tabindex="-1"></a> (<span class="kw">eval-when</span> (:compile-toplevel) (sb-c:%compiler-defun <span class="dt">&#39;hello</span> <span class="kw">t</span> <span class="kw">nil</span> <span class="kw">nil</span>))</span>
            <span id="cb277-37"><a href="#cb277-37" aria-hidden="true" tabindex="-1"></a> (sb-impl::%<span class="kw">defun</span><span class="fu"> </span><span class="dt">&#39;hello</span></span>
            <span id="cb277-38"><a href="#cb277-38" aria-hidden="true" tabindex="-1"></a>                  (sb-int:named-lambda hello</span>
            <span id="cb277-39"><a href="#cb277-39" aria-hidden="true" tabindex="-1"></a>                      (names)</span>
            <span id="cb277-40"><a href="#cb277-40" aria-hidden="true" tabindex="-1"></a>                    (<span class="kw">block</span> hello</span>
            <span id="cb277-41"><a href="#cb277-41" aria-hidden="true" tabindex="-1"></a>                      (<span class="kw">block</span> <span class="kw">nil</span></span>
            <span id="cb277-42"><a href="#cb277-42" aria-hidden="true" tabindex="-1"></a>                        (<span class="kw">let</span> ((name <span class="kw">nil</span>)</span>
            <span id="cb277-43"><a href="#cb277-43" aria-hidden="true" tabindex="-1"></a>                              (#:l551</span>
            <span id="cb277-44"><a href="#cb277-44" aria-hidden="true" tabindex="-1"></a>                               (sb-kernel:the* (<span class="kw">list</span> :use-annotations <span class="kw">t</span> :source-form names) names)))</span>
            <span id="cb277-45"><a href="#cb277-45" aria-hidden="true" tabindex="-1"></a>                          (<span class="kw">declare</span> (<span class="kw">ignorable</span> #:l551)</span>
            <span id="cb277-46"><a href="#cb277-46" aria-hidden="true" tabindex="-1"></a>                                   (<span class="kw">ignorable</span> name))</span>
            <span id="cb277-47"><a href="#cb277-47" aria-hidden="true" tabindex="-1"></a>                          (<span class="kw">tagbody</span></span>
            <span id="cb277-48"><a href="#cb277-48" aria-hidden="true" tabindex="-1"></a>                           sb-loop::next-loop</span>
            <span id="cb277-49"><a href="#cb277-49" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">if</span> (<span class="kw">endp</span> #:l551)</span>
            <span id="cb277-50"><a href="#cb277-50" aria-hidden="true" tabindex="-1"></a>                                (<span class="kw">go</span> sb-loop::end-loop))</span>
            <span id="cb277-51"><a href="#cb277-51" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">setq</span> name (<span class="kw">car</span> #:l551))</span>
            <span id="cb277-52"><a href="#cb277-52" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">setq</span> #:l551 (<span class="kw">cdr</span> #:l551))</span>
            <span id="cb277-53"><a href="#cb277-53" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;Hello, ~a.~&amp;&quot;</span> name)</span>
            <span id="cb277-54"><a href="#cb277-54" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">go</span> sb-loop::next-loop)</span>
            <span id="cb277-55"><a href="#cb277-55" aria-hidden="true" tabindex="-1"></a>                           sb-loop::end-loop)))))))</span></code></pre></div>
        <p>After calling <code class="verbatim">macroexpand-step</code> the first time, you can expand one more step with <code class="verbatim">e</code>.</p>
        <p>You can undo one expansion at a time with <code class="verbatim">u</code> or completely revert all expansions everywhere with <code class="verbatim">q</code>.</p>
        <h2 id="defining-macros">Defining Macros</h2>
        <p>As you can see, macros significantly reduce the amount of visual noise in the code and make it easier to understand. But after looking at the code it expands into, you might wonder how the heck you even get started writing a macro at all?</p>
        <p>To begin defining a macro, first you need to do some wishful thinking.</p>
        <ul class="incremental">
            <li>Write the desired call.</li>
            <li>Write the desired expansion.</li>
            <li>Construct macro parameter list from call.</li>
        </ul>
        <p>For example, let's say you want to define a <code class="verbatim">when-let</code> macro that combines <code class="verbatim">let</code> and <code class="verbatim">when</code> into one form. First, you begin with the macro call you want to have:</p>
        <div class="sourceCode" id="cb278" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>(when-let (<span class="kw">user</span> (get-user id))</span>
            <span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a>  (welcome-message <span class="kw">user</span>)</span>
            <span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a>  (redirect-to-dashboard <span class="kw">user</span>))</span></code></pre></div>
        <p>Then, you write the code you want it to expand into:</p>
        <div class="sourceCode" id="cb279" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((<span class="kw">user</span> (get-user id)))</span>
            <span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">when</span> <span class="kw">user</span></span>
            <span id="cb279-3"><a href="#cb279-3" aria-hidden="true" tabindex="-1"></a>    (welcome-message <span class="kw">user</span>)</span>
            <span id="cb279-4"><a href="#cb279-4" aria-hidden="true" tabindex="-1"></a>    (redirect-to-dashboard <span class="kw">user</span>)))</span></code></pre></div>
        <p>Finally, you write the macro definition.</p>
        <div class="sourceCode" id="cb280" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> when-let </span>((var expression) &amp;body body)</span>
            <span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">let</span> ((,var ,expression))</span>
            <span id="cb280-3"><a href="#cb280-3" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">when</span> ,var</span>
            <span id="cb280-4"><a href="#cb280-4" aria-hidden="true" tabindex="-1"></a>       ,@body)))</span></code></pre></div>
        <p>Before we go further, first you need to understand backquotes.</p>
        <h3 id="backquotes">Backquotes</h3>
        <p>In the previous code, you saw a backquote in the form <code class="verbatim">`(let ...)</code>. Backquotes are like normal single-quotes–they are an abbreviation of <code class="verbatim">quote</code>, which returns the literal representation of some code.</p>
        <div class="sourceCode" id="cb281" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">quote</span> (<span class="op">+</span> <span class="dv">2</span> <span class="dv">2</span>))</span>
            <span id="cb281-2"><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (+ 2 2)</span></span>
            <span id="cb281-3"><a href="#cb281-3" aria-hidden="true" tabindex="-1"></a>&#39;(<span class="op">+</span> <span class="dv">2</span> <span class="dv">2</span>)</span>
            <span id="cb281-4"><a href="#cb281-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (+ 2 2)</span></span>
            <span id="cb281-5"><a href="#cb281-5" aria-hidden="true" tabindex="-1"></a>`(<span class="op">+</span> <span class="dv">2</span> <span class="dv">2</span>)</span>
            <span id="cb281-6"><a href="#cb281-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (+ 2 2)</span></span></code></pre></div>
        <p>Notice that those symbols aren't interpreted. They and the list they are included in are returned as-is.</p>
        <p>Backquotes have an important feature: you can tell the interpreter to actually evaluate some of parts of the code.</p>
        <ol class="incremental">
            <li><p>Comma In Backquotes</p>
                <p>To tell the interpreter to evaluate parts inside a backquoted form, type <code class="verbatim">,</code> before the part you want evaluated.</p>
                <div class="sourceCode" id="cb282" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((a <span class="dv">2</span>)</span>
                    <span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>      (b <span class="dv">3</span>))</span>
                    <span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a>  `((<span class="op">+</span> ,a ,b) is ,(<span class="op">+</span> a b)))</span>
                    <span id="cb282-4"><a href="#cb282-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; ((+ 2 3) IS 5)</span></span></code></pre></div>
                <p>There are some rules you have to follow when using backquotes:</p>
                <ul class="incremental">
                    <li>A comma must follow a backquote.</li>
                    <li>A comma can't follow another comma.</li>
                </ul>
                <p>For example:</p>
                <div class="sourceCode" id="cb283" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((a <span class="dv">2</span>)</span>
                    <span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a>      (b <span class="dv">3</span>))</span>
                    <span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Added commas    v  v</span></span>
                    <span id="cb283-4"><a href="#cb283-4" aria-hidden="true" tabindex="-1"></a>  `((<span class="op">+</span> ,a ,b) is ,(<span class="op">+</span> ,a ,b)))</span>
                    <span id="cb283-5"><a href="#cb283-5" aria-hidden="true" tabindex="-1"></a><span class="co">;; Error:</span></span>
                    <span id="cb283-6"><a href="#cb283-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Comma not inside a backquote.</span></span>
                    <span id="cb283-7"><a href="#cb283-7" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb283-8"><a href="#cb283-8" aria-hidden="true" tabindex="-1"></a><span class="co">;;   Stream: #&lt;dynamic-extent STRING-INPUT-STREAM (unavailable) from &quot;(let ((a...&quot;&gt;</span></span>
                    <span id="cb283-9"><a href="#cb283-9" aria-hidden="true" tabindex="-1"></a><span class="co">;;    [Condition of type SB-INT:SIMPLE-READER-ERROR]</span></span></code></pre></div>
                <p>If we add the commas to the second <code class="verbatim">a</code> and <code class="verbatim">b</code>, since the outer <code class="verbatim">(+ ...)</code> form is already preceded with a comma, we get that error.</p></li>
            <li><p>Comma At-Sign In Backquotes</p>
                <p>In the <code class="verbatim">when-let</code> macro, we also saw <code class="verbatim">,@body</code>. The <code class="verbatim">,@</code> "splices" the form into the backquoted code–removing the outermost parentheses.</p>
                <div class="sourceCode" id="cb284" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((a <span class="dv">5</span>)</span>
                    <span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a>      (b &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>))</span>
                    <span id="cb284-3"><a href="#cb284-3" aria-hidden="true" tabindex="-1"></a>      (c <span class="dv">9</span>))</span>
                    <span id="cb284-4"><a href="#cb284-4" aria-hidden="true" tabindex="-1"></a>  `(<span class="op">+</span> ,a ,@b ,c))</span>
                    <span id="cb284-5"><a href="#cb284-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (+ 5 1 2 3 9)</span></span></code></pre></div>
                <p><code class="verbatim">,@</code> is commonly used with macros that take an arbitrary number of arguments and passing those arguments along to another form that also takes an arbitrary number of arguments. That's what the <code class="verbatim">body</code> parameter for <code class="verbatim">when-let</code> is.</p></li>
        </ol>
        <h3 id="back-to-when-let">Back to <code class="verbatim">when-let</code></h3>
        <p>Getting back to constructing a macro, after having the call and expansion prepared, you need to look at the parts that are common between them, and then make those parameters in the <code class="verbatim">defmacro</code> lambda-list.</p>
        <p>For example, look at <code class="verbatim">user</code>. It's in the expansion code three times:</p>
        <div class="sourceCode" id="cb285" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((<span class="kw">user</span> ...))</span>
            <span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a> (... <span class="kw">user</span></span>
            <span id="cb285-3"><a href="#cb285-3" aria-hidden="true" tabindex="-1"></a>   (... <span class="kw">user</span>))</span></code></pre></div>
        <p>and in the macro call twice:</p>
        <div class="sourceCode" id="cb286" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a>(when-let (<span class="kw">user</span> ...)</span>
            <span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a>  (... <span class="kw">user</span>))</span></code></pre></div>
        <p>Which means a parameter in the <code class="verbatim">when-let</code> definition needs to correspond to this variable.</p>
        <div class="sourceCode" id="cb287" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> when-let </span>((var ...)...)</span>
            <span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a>  ...)</span></code></pre></div>
        <p>…and any instance of <code class="verbatim">var</code> in the body of the macro definition needs to be preceded with a comma.</p>
        <div class="sourceCode" id="cb288" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> when-let </span>((var ...)...)</span>
            <span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">let</span> ((,var ...))</span>
            <span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">when</span> ,var</span>
            <span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a>       ...)))</span></code></pre></div>
        <p>The same goes for <code class="verbatim">(get-user id)</code>. It appears once in the expansion and once in the macro call.</p>
        <div class="sourceCode" id="cb289" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((... (get-user id)))</span>
            <span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a> (... ...</span>
            <span id="cb289-3"><a href="#cb289-3" aria-hidden="true" tabindex="-1"></a>   (... ...)))</span>
            <span id="cb289-4"><a href="#cb289-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb289-5"><a href="#cb289-5" aria-hidden="true" tabindex="-1"></a>(when-let (... (get-user id))</span>
            <span id="cb289-6"><a href="#cb289-6" aria-hidden="true" tabindex="-1"></a>  ...)</span></code></pre></div>
        <p>So it gets a spot in the parameter list of the macro:</p>
        <div class="sourceCode" id="cb290" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> when-let </span>((... expression) ...)</span>
            <span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a>  ...)</span></code></pre></div>
        <p>And where <code class="verbatim">expression</code> appears in the macro body, it's preceded with a comma.</p>
        <div class="sourceCode" id="cb291" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> when-let </span>((... expression) ...)</span>
            <span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">let</span> ((... ,expression))</span>
            <span id="cb291-3"><a href="#cb291-3" aria-hidden="true" tabindex="-1"></a>     ...))</span></code></pre></div>
        <p>The calls to <code class="verbatim">(welcome-message user)</code> and <code class="verbatim">(redirect-to-dashboard user)</code> are actually in a space where we expect any arbitrary number of arbitrary forms. For that, we use a <code class="verbatim">&amp;body</code> parameter and splice it in with <code class="verbatim">,@</code>.</p>
        <div class="sourceCode" id="cb292" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> when-let </span>((... ...) &amp;body body)</span>
            <span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">let</span> ((... ...))</span>
            <span id="cb292-3"><a href="#cb292-3" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">when</span> ...</span>
            <span id="cb292-4"><a href="#cb292-4" aria-hidden="true" tabindex="-1"></a>       ,@body)))</span></code></pre></div>
        <p>Altogether:</p>
        <div class="sourceCode" id="cb293" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> when-let </span>((var expression) &amp;body body)</span>
            <span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">let</span> ((,var ,expression))</span>
            <span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">when</span> ,var</span>
            <span id="cb293-4"><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a>       ,@body)))</span></code></pre></div>
        <h3 id="f30cfd8d-9454-4dc6-83bd-e37c33ed1ee1">Destructuring Arbitrary List Structures In Parameters</h3>
        <p>In the example of <code class="verbatim">when-let</code>, we saw something strange in the lambda-list:</p>
        <div class="sourceCode" id="cb294" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="co">;;                  v              v</span></span>
            <span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> when-let </span>((var expression) &amp;body body)</span>
            <span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a>  ...)</span></code></pre></div>
        <p>What's going on there?</p>
        <p>Macros can take any list structure as a parameter and destructure them–binding parameters to elements within the list passed to the macro. To understand this characteristic of macro parameters, first we need to understand destructuring, represented best by <code class="verbatim">destructuring-bind</code>.</p>
        <p><code class="verbatim">destructuring-bind</code> takes an arbitrary list structure and binds the elements of the list to local variables.</p>
        <div class="sourceCode" id="cb295" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((people &#39;((<span class="st">&quot;Micah&quot;</span> <span class="dv">40</span> (<span class="st">&quot;Lisp&quot;</span> <span class="st">&quot;Hiking&quot;</span> <span class="st">&quot;Photography&quot;</span>))</span>
            <span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a>                (<span class="st">&quot;Guy&quot;</span> <span class="dv">71</span> (<span class="st">&quot;Engineering&quot;</span> <span class="st">&quot;Frogs&quot;</span> <span class="st">&quot;Education&quot;</span>))</span>
            <span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a>                (<span class="st">&quot;Joe&quot;</span> <span class="dv">50</span> (<span class="st">&quot;Games&quot;</span> <span class="st">&quot;Civilization&quot;</span> <span class="st">&quot;Finding Good Women&quot;</span>)))))</span>
            <span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">dolist</span> (person people)</span>
            <span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">destructuring-bind</span> (name age (interest1 interest2 interest3)) person</span>
            <span id="cb295-6"><a href="#cb295-6" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">print</span> interest1))))</span>
            <span id="cb295-7"><a href="#cb295-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; &quot;Lisp&quot; </span></span>
            <span id="cb295-8"><a href="#cb295-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; &quot;Engineering&quot; </span></span>
            <span id="cb295-9"><a href="#cb295-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; &quot;Games&quot;  =&gt; NIL</span></span></code></pre></div>
        <p>The first argument to <code class="verbatim">destructuring-bind</code> is a lambda-list of the variables to bind. The key is that it can bind any arbitrary element in any arbitrary list structure directly. All you need to do is mimic the structure of the list in the parameter list to <code class="verbatim">destructuring-bind</code>.</p>
        <div class="sourceCode" id="cb296" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((tree &#39;(<span class="dv">1</span> (<span class="dv">2</span> (<span class="dv">3</span> <span class="dv">4</span>) <span class="dv">5</span> ((<span class="dv">6</span> ((<span class="dv">7</span>))))))))</span>
            <span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">destructuring-bind</span> (a (b (c d) e ((f ((g)))))) tree</span>
            <span id="cb296-3"><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a + ~a = ~a&quot;</span> d f (<span class="op">+</span> d f))))</span>
            <span id="cb296-4"><a href="#cb296-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; 4 + 6 = 10 =&gt; NIL</span></span></code></pre></div>
        <p>Macros can similarly destructure lists in their parameters list:</p>
        <div class="sourceCode" id="cb297" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> add-elements </span>((a (b (c))))</span>
            <span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a>  (<span class="op">+</span> a b c))</span>
            <span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a>(add-elements (<span class="dv">1</span> (<span class="dv">2</span> (<span class="dv">3</span>))))</span>
            <span id="cb297-5"><a href="#cb297-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 6 (3 bits, #x6, #o6, #b110)</span></span></code></pre></div>
        <p>It's important to remember that we didn't call <code class="verbatim">(add-elements '(1 (2 (3)))</code> or <code class="verbatim">(add-elements (list 1 (2 (3)))</code>: those are both single elements. With a function, this would be an invalid call because the 3 (the innermost element) would be interpreted as a function-name, the Lisp evaluator would look for it, and not find it.</p>
        <p>However, macros have the previous macro expansion/compilation step, so the form <code class="verbatim">(1 (2 (3)))</code> is valid: the macro would be expanded <em>before</em> the elements are evaluated.</p>
        <h2 id="4b4876af-e200-4c46-a775-7aff1d5f328b">Redefining Macros</h2>
        <p>One thing to keep in mind with macros is that if you make a macro, use the macro to write some code and compile that code, if you redefine the macro, you also need to <em>recompile the other code</em>. Otherwise, that code is using the old macro expansion and not the new one.</p>
        <h2 id="determining-when-to-use-macros">Determining When To Use Macros</h2>
        <p>As I said before, the general rule is to be conservative with your creation of macros. But there <em>are</em> times when you just gotta use the facilities that a macro provides.</p>
        <h3 id="transformation">Transformation</h3>
        <p>Macros allow you to expand into different forms based on the arguments you send to it–<em>before the arguments are evaluated</em>. Consider the macro <code class="verbatim">setf</code>.</p>
        <div class="sourceCode" id="cb298" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defvar</span><span class="fu"> *lang*</span>)</span>
            <span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defstruct</span><span class="fu"> vehicle</span></span>
            <span id="cb298-3"><a href="#cb298-3" aria-hidden="true" tabindex="-1"></a>  make</span>
            <span id="cb298-4"><a href="#cb298-4" aria-hidden="true" tabindex="-1"></a>  model</span>
            <span id="cb298-5"><a href="#cb298-5" aria-hidden="true" tabindex="-1"></a>  color)</span>
            <span id="cb298-6"><a href="#cb298-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> person </span>()</span>
            <span id="cb298-7"><a href="#cb298-7" aria-hidden="true" tabindex="-1"></a>  ((name :initarg <span class="bu">:name</span> :initform <span class="kw">nil</span> :accessor person-name)</span>
            <span id="cb298-8"><a href="#cb298-8" aria-hidden="true" tabindex="-1"></a>   (age :initarg :age :initform <span class="kw">nil</span> :accessor person-age)))</span>
            <span id="cb298-9"><a href="#cb298-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *cruiser* </span>(make-vehicle :make <span class="st">&quot;Toyota&quot;</span> :model <span class="st">&quot;Land Cruiser 70&quot;</span> :color <span class="st">&quot;Beige&quot;</span>))</span>
            <span id="cb298-10"><a href="#cb298-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *micah* </span>(<span class="kw">make-instance</span> <span class="dt">&#39;person</span> <span class="bu">:name</span> <span class="st">&quot;Micah&quot;</span> :age <span class="dv">40</span>))</span>
            <span id="cb298-11"><a href="#cb298-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *list* </span>&#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>))</span>
            <span id="cb298-12"><a href="#cb298-12" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb298-13"><a href="#cb298-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> *lang* <span class="st">&quot;Japanese&quot;</span>)</span>
            <span id="cb298-14"><a href="#cb298-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (<span class="kw">car</span> *list*) <span class="dv">11</span>)</span>
            <span id="cb298-15"><a href="#cb298-15" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (vehicle-color *cruiser*) <span class="st">&quot;White&quot;</span>)</span>
            <span id="cb298-16"><a href="#cb298-16" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setf</span> (person-age *micah*) <span class="dv">25</span>)</span></code></pre></div>
        <p>The calls to <code class="verbatim">setf</code> expand to:</p>
        <div class="sourceCode" id="cb299" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setq</span> *lang* <span class="st">&quot;Japanese&quot;</span>)</span>
            <span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a>(sb-kernel:%<span class="kw">rplaca</span> *list* <span class="dv">11</span>)</span>
            <span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let*</span> ((#:*cruiser*575 *cruiser*) (#:new574 <span class="st">&quot;White&quot;</span>))</span>
            <span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">funcall</span> <span class="op">#&#39;</span>(<span class="kw">setf</span> vehicle-color) #:new574 #:*cruiser*575))</span>
            <span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let*</span> ((#:*micah*579 *micah*) (#:new578 <span class="dv">25</span>))</span>
            <span id="cb299-6"><a href="#cb299-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">funcall</span> <span class="op">#&#39;</span>(<span class="kw">setf</span> person-age) #:new578 #:*micah*579))</span></code></pre></div>
        <p>The <code class="verbatim">setf</code> macro looks at the arguments it receives and decides how to expand based on what it gets. If it sees <code class="verbatim">(car ...)</code> then it uses <code class="verbatim">rplaca</code>, if it sees another function like <code class="verbatim">(person-age ...)</code> then it calls a generic function <code class="verbatim">setf</code> with the <code class="verbatim">PERSON-AGE</code> setter sent to it.</p>
        <p>It does this without evaluating the expressions passed to it–it only knows the literal representations of the forms. The code is the data it works with. If you need to transform code based on the shape of its inputs, you might need a macro.</p>
        <h3 id="binding">Binding</h3>
        <p>As I said before, symbols aren't evaluated at expansion/compilation time, so if you want to bind symbols to values, macros are probably what you need. That's why <code class="verbatim">defun</code>, etc. are macros.</p>
        <h3 id="conditional-evaluation">Conditional Evaluation</h3>
        <p>Because macros can transform code and control the evaluation of code, when you need to control the order of evaluation or whether a form gets evaluated at all, you might need a macro. That's why <code class="verbatim">if</code>, <code class="verbatim">when</code>, <code class="verbatim">unless</code>, etc. conditional forms are macros.</p>
        <h3 id="91b9e527-4f67-4dd1-9048-5cb9c9b8df75">Wrapping An Environment</h3>
        <p>When you want to create a lexical environment like the <code class="verbatim">with-</code> family of macros do, then you probably want a macro.</p>
        <h2 id="61479373-1cd1-44d0-8100-595acc33a860">Determining When Not To Use Macros</h2>
        <p>There are certain situations under which you absolutely can't use macros. Macros can't be used as data, in the same way functions can.</p>
        <div class="sourceCode" id="cb300" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">mapcar</span> <span class="op">#&#39;</span>my-macro data) <span class="co">; &lt;- Error</span></span></code></pre></div>
        <p>Only functions can be passed to higher-order functions like <code class="verbatim">mapcar</code>, <code class="verbatim">reduce</code>, <code class="verbatim">remove-if-not</code>, etc.</p>
        <p>And of course, always keep in mind that if you are trying to develop a DSL, you might be overcomplicating things. If you want to collaborate with others, and you want to write DSLs, you better make them <em>good</em>.</p>
        <h2 id="variable-capture-hygiene">Variable Capture &amp; Hygiene</h2>
        <p>Macros can be tough to debug. That's partially because macros are generally harder to read because you have to keep the <em>expansion</em> code and <em>expander</em> code in your head at the same time.</p>
        <p>But macros are also more difficult to debug because they are subject to a unique class of bugs called variable capture. The subject of macro hygiene is primarily concerned with avoiding this class of bugs.</p>
        <h3 id="examples-of-macros-vulnerable-to-variable-capture">Examples Of Macros Vulnerable To Variable Capture</h3>
        <ol class="incremental">
            <li><p>Free Variables &amp; Same Binding Context</p>
                <p>The simplest example of a macro that's vulnerable to variable capture is a macro that returns a free variable.</p>
                <div class="sourceCode" id="cb301" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> might-get-captured1 </span>()</span>
                    <span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a>  &#39;(<span class="op">+</span> x <span class="dv">1</span>))</span></code></pre></div>
                <p>Why is this macro vulnerable? Because it doesn't return <code class="verbatim">'(+ x 1)</code>. It <em>expands into</em> <code class="verbatim">(+ x 1)</code>, which is then evaluated at runtime.</p>
                <div class="sourceCode" id="cb302" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a>(might-get-captured1) <span class="co">; =&gt; Error: The variable X is unbound.</span></span>
                    <span id="cb302-2"><a href="#cb302-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((x <span class="dv">1</span>))</span>
                    <span id="cb302-3"><a href="#cb302-3" aria-hidden="true" tabindex="-1"></a>  (might-get-captured1))</span>
                    <span id="cb302-4"><a href="#cb302-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 2 (2 bits, #x2, #o2, #b10)</span></span></code></pre></div>
                <p>Try expanding the code with <code class="verbatim">SPC m m</code> (<code class="verbatim">macrostep-expand</code>) to verify.</p>
                <p>Compare to a function:</p>
                <div class="sourceCode" id="cb303" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> cant-capture-me </span>()</span>
                    <span id="cb303-2"><a href="#cb303-2" aria-hidden="true" tabindex="-1"></a>  &#39;(<span class="op">+</span> x <span class="dv">1</span>))</span>
                    <span id="cb303-3"><a href="#cb303-3" aria-hidden="true" tabindex="-1"></a>(cant-capture-me)</span>
                    <span id="cb303-4"><a href="#cb303-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (+ X 1)</span></span></code></pre></div>
                <p>So it's important to remember that quotes/backquotes in functions return literal representations, whereas macros use quotes/backquotes as templates for expanding into code-to-be-evaluated.</p>
                <p>In addition to macros with free variables, macros that bind multiple variables within one <code class="verbatim">let</code> are also vulnerable to capture. Consider the following macro:</p>
                <div class="sourceCode" id="cb304" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> might-get-captured2 </span>(variable)</span>
                    <span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">let</span> ((x <span class="dv">1</span>)</span>
                    <span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a>         (,variable <span class="dv">0</span>))</span>
                    <span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">values</span> x ,variable)))</span></code></pre></div>
                <p>If we call it like this:</p>
                <div class="sourceCode" id="cb305" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((y <span class="dv">5</span>))</span>
                    <span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a>  (might-get-captured2 y))</span></code></pre></div>
                <p>What do you expect the return values to be?</p>
                <div class="sourceCode" id="cb306" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((y <span class="dv">5</span>))</span>
                    <span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a>  (might-get-captured2 y))</span>
                    <span id="cb306-3"><a href="#cb306-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 1, 0</span></span>
                    <span id="cb306-4"><a href="#cb306-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; Expanded</span></span>
                    <span id="cb306-5"><a href="#cb306-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((y <span class="dv">5</span>))</span>
                    <span id="cb306-6"><a href="#cb306-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((x <span class="dv">1</span>) (y <span class="dv">0</span>))</span>
                    <span id="cb306-7"><a href="#cb306-7" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">values</span> x y)))</span></code></pre></div>
                <p>Or what about this wombo combo:</p>
                <div class="sourceCode" id="cb307" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((x <span class="dv">5</span>))</span>
                    <span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a>  (might-get-captured2 x))</span></code></pre></div>
                <p>What is the return value? It's an error because <code class="verbatim">x</code> occurs twice in the expanded <code class="verbatim">let</code> form.</p>
                <div class="sourceCode" id="cb308" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Expanded</span></span>
                    <span id="cb308-2"><a href="#cb308-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((x <span class="dv">5</span>))</span>
                    <span id="cb308-3"><a href="#cb308-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((x <span class="dv">1</span>) (x <span class="dv">0</span>))</span>
                    <span id="cb308-4"><a href="#cb308-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">values</span> x x)))</span></code></pre></div></li>
            <li><p>Body Forms Containing Variables In Macro</p>
                <p>You don't know what symbols could be in a <code class="verbatim">&amp;body</code> parameter of a macro. A symbol used in the macro may get used in the <code class="verbatim">&amp;body</code> as well.</p>
                <div class="sourceCode" id="cb309" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> might-get-captured3 </span>(&amp;body body)</span>
                    <span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">let</span> ((x <span class="dv">5</span>))</span>
                    <span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a>     (<span class="op">+</span> x ,@body)))</span></code></pre></div>
                <p>Because the <code class="verbatim">body</code> expands into an environment where <code class="verbatim">x</code> is bound to the value 5, if the symbol <code class="verbatim">x</code> appears in the <code class="verbatim">body</code>, it will likely be overwritten in rebound by the macro's <code class="verbatim">leg</code> context.</p>
                <div class="sourceCode" id="cb310" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((x <span class="dv">70</span>)</span>
                    <span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a>      (y <span class="dv">50</span>))</span>
                    <span id="cb310-3"><a href="#cb310-3" aria-hidden="true" tabindex="-1"></a>  (might-get-captured3</span>
                    <span id="cb310-4"><a href="#cb310-4" aria-hidden="true" tabindex="-1"></a>    (<span class="op">+</span> x y)))</span>
                    <span id="cb310-5"><a href="#cb310-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; 60 (6 bits, #x3C, #o74, #b111100)</span></span></code></pre></div></li>
        </ol>
        <h3 id="avoiding-variable-capture">Avoiding Variable Capture</h3>
        <p>These are general coding patterns that help you avoid variable capture.</p>
        <ol class="incremental">
            <li><p>Better Names For Global Variables</p>
                <p>Make sure you name global variables using the <code class="verbatim">*...*</code> convention.</p></li>
            <li><p>Assign Parameters To Local Variables</p>
                <p>Instead of using parameters directly…</p>
                <div class="sourceCode" id="cb311" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Vulnerable</span></span>
                    <span id="cb311-2"><a href="#cb311-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> comes-before-p </span>(x y <span class="kw">sequence</span>)</span>
                    <span id="cb311-3"><a href="#cb311-3" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">let</span> ((<span class="kw">sequence</span> ,<span class="kw">sequence</span>))</span>
                    <span id="cb311-4"><a href="#cb311-4" aria-hidden="true" tabindex="-1"></a>     (<span class="op">&lt;</span> (<span class="kw">position</span> ,x <span class="kw">sequence</span>)</span>
                    <span id="cb311-5"><a href="#cb311-5" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">position</span> ,y <span class="kw">sequence</span>))))</span>
                    <span id="cb311-6"><a href="#cb311-6" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb311-7"><a href="#cb311-7" aria-hidden="true" tabindex="-1"></a>(comes-before-p <span class="dv">1</span> <span class="dv">5</span> &#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span>))</span>
                    <span id="cb311-8"><a href="#cb311-8" aria-hidden="true" tabindex="-1"></a> <span class="co">; =&gt; T</span></span></code></pre></div>
                <p>…assign parameters to local variables before using them.</p>
                <div class="sourceCode" id="cb312" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> comes-before-p </span>(x y <span class="kw">sequence</span>)</span>
                    <span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">let</span> ((<span class="kw">sequence</span> ,<span class="kw">sequence</span>)</span>
                    <span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a>         (xvar ,x)                         <span class="co">; different variable names</span></span>
                    <span id="cb312-4"><a href="#cb312-4" aria-hidden="true" tabindex="-1"></a>         (yvar ,y))                        <span class="co">; different variable names</span></span>
                    <span id="cb312-5"><a href="#cb312-5" aria-hidden="true" tabindex="-1"></a>     (<span class="op">&lt;</span> (<span class="kw">position</span> xvar <span class="kw">sequence</span>)</span>
                    <span id="cb312-6"><a href="#cb312-6" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">position</span> yvar <span class="kw">sequence</span>))))</span></code></pre></div></li>
            <li><p>Define Macros In Separate Packages</p>
                <p>To some extent, simply following the more modern One-Package-Per-File convention for factoring projects can also prevent some instances of variable capture. If you have <code class="verbatim">my-macro</code> with symbol <code class="verbatim">x</code> inside it, if someone uses <code class="verbatim">my-macro</code> in their own package with an <code class="verbatim">x</code> symbol, they will actually be two different symbols: <code class="verbatim">my-macro-package::x</code> and <code class="verbatim">their-package::x</code>.</p></li>
            <li><p>Use <code class="verbatim">gensym</code></p>
                <p>Even if you give variables different names, and even if you give them names that others are unlikely to use, you have no guarantees that they will <em>never</em> be used by users of your macro.</p>
                <p>Instead, you can create <em>anonymous symbols</em> with <code class="verbatim">gensym</code>.</p>
                <div class="sourceCode" id="cb313" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">gensym</span>)</span>
                    <span id="cb313-2"><a href="#cb313-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #:G586</span></span></code></pre></div>
                <p>Every time you call <code class="verbatim">gensym</code>, it will generate a symbol with a unique name.</p>
                <p>Above, we expanded several different calls to <code class="verbatim">setf</code> to show how it transforms based on the data it's passed. When we passed it <code class="verbatim">(vehicle-color *cruiser*)</code>, it expanded into this:</p>
                <div class="sourceCode" id="cb314" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let*</span> ((#:*cruiser*575 *cruiser*) (#:new574 <span class="st">&quot;White&quot;</span>))</span>
                    <span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">funcall</span> <span class="op">#&#39;</span>(<span class="kw">setf</span> vehicle-color) #:new574 #:*cruiser*575))</span></code></pre></div>
                <p>You can see the variables generated by <code class="verbatim">gensym</code>: <code class="verbatim">#:*cruiser*575</code> and <code class="verbatim">#:new574</code>. By default, symbols generated with <code class="verbatim">gensym</code> are prefixed with <code class="verbatim">G</code>, but we can change that:</p>
                <div class="sourceCode" id="cb315" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">gensym</span> <span class="st">&quot;*CRUISER*&quot;</span>)</span>
                    <span id="cb315-2"><a href="#cb315-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #:*CRUISER*592</span></span></code></pre></div>
                <p>We can even change the suffix number (usually derived from <code class="verbatim">*gensym-counter*</code>) if we pass an integer.</p>
                <div class="sourceCode" id="cb316" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">gensym</span> <span class="dv">500</span>)</span>
                    <span id="cb316-2"><a href="#cb316-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #:G500</span></span></code></pre></div>
                <p>Importantly, these anonymous symbols aren't interned, so you can't even find them if you go searching.</p>
                <div class="sourceCode" id="cb317" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">find-symbol</span> <span class="st">&quot;*CRUISER*592&quot;</span> )</span>
                    <span id="cb317-2"><a href="#cb317-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL, NIL</span></span></code></pre></div>
                <p>And in fact, even if they appear to have the same name, two symbols generated with <code class="verbatim">gensyms</code> are still entirely different objects in memory.</p>
                <div class="sourceCode" id="cb318" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((a (<span class="kw">gensym</span> <span class="dv">100</span>))</span>
                    <span id="cb318-2"><a href="#cb318-2" aria-hidden="true" tabindex="-1"></a>      (b (<span class="kw">gensym</span> <span class="dv">100</span>)))</span>
                    <span id="cb318-3"><a href="#cb318-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">values</span> a b))</span>
                    <span id="cb318-4"><a href="#cb318-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #:G100, #:G100</span></span>
                    <span id="cb318-5"><a href="#cb318-5" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb318-6"><a href="#cb318-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((a (<span class="kw">gensym</span> <span class="dv">100</span>))</span>
                    <span id="cb318-7"><a href="#cb318-7" aria-hidden="true" tabindex="-1"></a>      (b (<span class="kw">gensym</span> <span class="dv">100</span>)))</span>
                    <span id="cb318-8"><a href="#cb318-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">eq</span> a b))</span>
                    <span id="cb318-9"><a href="#cb318-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span></code></pre></div>
                <p>Once you find a variable that can possibly be captured, saving it to an anonymous symbol is a bulletproof way to avoid capture.</p>
                <div class="sourceCode" id="cb319" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> comes-before-p </span>(x y <span class="kw">sequence</span>)</span>
                    <span id="cb319-2"><a href="#cb319-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((xvar (<span class="kw">gensym</span>))</span>
                    <span id="cb319-3"><a href="#cb319-3" aria-hidden="true" tabindex="-1"></a>        (yvar (<span class="kw">gensym</span>)))</span>
                    <span id="cb319-4"><a href="#cb319-4" aria-hidden="true" tabindex="-1"></a>    `(<span class="kw">let</span> ((<span class="kw">sequence</span> ,<span class="kw">sequence</span>)</span>
                    <span id="cb319-5"><a href="#cb319-5" aria-hidden="true" tabindex="-1"></a>           (,xvar ,x) </span>
                    <span id="cb319-6"><a href="#cb319-6" aria-hidden="true" tabindex="-1"></a>           (,yvar ,y))</span>
                    <span id="cb319-7"><a href="#cb319-7" aria-hidden="true" tabindex="-1"></a>       (<span class="op">&lt;</span> (<span class="kw">position</span> ,xvar <span class="kw">sequence</span>)</span>
                    <span id="cb319-8"><a href="#cb319-8" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">position</span> ,yvar <span class="kw">sequence</span>)))))</span></code></pre></div></li>
        </ol>
        <h1 id="8bccc2d1-f92f-423b-9c76-57b8c45a4604">ORGANIZING CODE</h1>
        <h2 id="dae908ab-7786-4cf1-bc58-d3246c48af23">Packages</h2>
        <h3 id="752a868b-d7c7-4ddb-b293-5e3fd950dc54">What Are Packages?</h3>
        <p>Packages are namespaces for symbols.</p>
        <h3 id="823e54ec-ae4c-4d3c-a7da-4b23795e77af">Defining Packages</h3>
        <p>Packages are defined with <code class="verbatim">defpackage</code>.</p>
        <div class="sourceCode" id="cb320" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:my-package</span>
            <span id="cb320-2"><a href="#cb320-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl))</span></code></pre></div>
        <p><code class="verbatim">my-package</code> inherits or "uses" all of the external symbols of <code class="verbatim">cl</code>, a nickname for the <code class="verbatim">common-lisp</code> package, which contains all of the standard Common Lisp symbols.</p>
        <div class="sourceCode" id="cb321" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">describe</span> <span class="dt">&#39;cl</span>:defun)</span>
            <span id="cb321-2"><a href="#cb321-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; COMMON-LISP:DEFUN</span></span>
            <span id="cb321-3"><a href="#cb321-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;   [symbol]</span></span>
            <span id="cb321-4"><a href="#cb321-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb321-5"><a href="#cb321-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; DEFUN names a macro:</span></span>
            <span id="cb321-6"><a href="#cb321-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;   Lambda-list: (NAME LAMBDA-LIST &amp;BODY BODY)</span></span>
            <span id="cb321-7"><a href="#cb321-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;   Documentation:</span></span>
            <span id="cb321-8"><a href="#cb321-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;     Define a function at top level.</span></span>
            <span id="cb321-9"><a href="#cb321-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;   Source file: SYS:SRC;CODE;MACROS.LISP</span></span>
            <span id="cb321-10"><a href="#cb321-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; ; No value</span></span></code></pre></div>
        <p>If you don't include this line, you will need to add a package-qualifier to all of the symbols built into Common Lisp.</p>
        <div class="sourceCode" id="cb322" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:messy-package)</span>
            <span id="cb322-2"><a href="#cb322-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:messy-package)</span>
            <span id="cb322-3"><a href="#cb322-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb322-4"><a href="#cb322-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> hello-world </span>()</span>
            <span id="cb322-5"><a href="#cb322-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print</span> <span class="st">&quot;Hello world&quot;</span>))</span></code></pre></div>
        <p>If you evaluate this code, you'll get a strange error:</p>
        <div class="sourceCode" id="cb323" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a>The variable HELLO-WORLD is unbound.</span>
            <span id="cb323-2"><a href="#cb323-2" aria-hidden="true" tabindex="-1"></a>   [Condition of <span class="kw">type</span> COMMON-LISP:UNBOUND-VARIABLE]</span></code></pre></div>
        <p>Why? Because the <code class="verbatim">defun</code> special operator is actually a <em>macro</em> whose first argument is a name for the function you are defining. Because it's a macro, the order of operations is to first <em>expand</em> the macro and then execute the code. During the macro expansion, the <code class="verbatim">hello-world</code> symbol will be interned and its <em>function name</em> value will be bound to <code class="verbatim">hello-world</code>.</p>
        <p>However, because we didn't <code class="verbatim">:use #:cl</code>, <code class="verbatim">defun</code> is interpreted as the name of a <em>function</em>, which requires first that all inner forms be evaluated and their values returned. And since <code class="verbatim">hello-world</code> isn't bound to any value yet, we get the above error.</p>
        <p>All that is to say, unless you're a Lisp wizard concocting a sexp brew, you should be adding <code class="verbatim">(:use #:cl)</code> to all of your package definitions.</p>
        <h3 id="68714d67-664f-42f3-b586-345e371a8366"><span class="todo TODO">TODO</span> Using, Importing &amp; Exporting</h3>
        <p>Let's expand the example:</p>
        <div class="sourceCode" id="cb324" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:my-package</span>
            <span id="cb324-2"><a href="#cb324-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb324-3"><a href="#cb324-3" aria-hidden="true" tabindex="-1"></a>  (:export #:*global*))</span>
            <span id="cb324-4"><a href="#cb324-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb324-5"><a href="#cb324-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:my-package)</span>
            <span id="cb324-6"><a href="#cb324-6" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb324-7"><a href="#cb324-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *global* </span><span class="st">&quot;This is a global variable.&quot;</span>)</span>
            <span id="cb324-8"><a href="#cb324-8" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb324-9"><a href="#cb324-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:your-package</span>
            <span id="cb324-10"><a href="#cb324-10" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb324-11"><a href="#cb324-11" aria-hidden="true" tabindex="-1"></a>  (:import-from #:my-package))</span>
            <span id="cb324-12"><a href="#cb324-12" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:your-package)</span>
            <span id="cb324-13"><a href="#cb324-13" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb324-14"><a href="#cb324-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">print</span> my-package:*global*)</span>
            <span id="cb324-15"><a href="#cb324-15" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; &quot;This is a global variable.&quot;  =&gt; &quot;This is a global variable.&quot;</span></span>
            <span id="cb324-16"><a href="#cb324-16" aria-hidden="true" tabindex="-1"></a>(<span class="kw">symbol-package</span> <span class="dt">&#39;my-package</span>:*global*)</span>
            <span id="cb324-17"><a href="#cb324-17" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;PACKAGE &quot;MY-PACKAGE&quot;&gt;</span></span>
            <span id="cb324-18"><a href="#cb324-18" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb324-19"><a href="#cb324-19" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((my-package:*global* <span class="st">&quot;Symbol from MY-PACKAGE lexically rebound in YOUR-PACKAGE&quot;</span>))</span>
            <span id="cb324-20"><a href="#cb324-20" aria-hidden="true" tabindex="-1"></a>  my-package:*global*)</span>
            <span id="cb324-21"><a href="#cb324-21" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;Symbol from MY-PACKAGE lexically rebound in YOUR-PACKAGE&quot;</span></span>
            <span id="cb324-22"><a href="#cb324-22" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb324-23"><a href="#cb324-23" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *global* </span><span class="st">&quot;Global variable interned in YOUR-PACKAGE.&quot;</span>)</span>
            <span id="cb324-24"><a href="#cb324-24" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb324-25"><a href="#cb324-25" aria-hidden="true" tabindex="-1"></a>(<span class="kw">symbol-package</span> <span class="dt">&#39;*global*</span>)</span>
            <span id="cb324-26"><a href="#cb324-26" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;PACKAGE &quot;YOUR-PACKAGE&quot;&gt;</span></span></code></pre></div>
        <p>By importing packages, you can reuse symbol names without naming conflicts.</p>
        <p>You may also want to import the symbol, allowing you to use it without a package-name qualifier.</p>
        <div class="sourceCode" id="cb325" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:your-package</span>
            <span id="cb325-2"><a href="#cb325-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb325-3"><a href="#cb325-3" aria-hidden="true" tabindex="-1"></a>  (:import-from #:my-package</span>
            <span id="cb325-4"><a href="#cb325-4" aria-hidden="true" tabindex="-1"></a>                #:*global*))</span></code></pre></div>
        <p>If you start this way, then you won't need a package name qualifier when you use it.</p>
        <h3 id="7ad07caa-ae26-4e26-952f-9c8326a07f7c">Shadowing And Conflicts</h3>
        <p>This is not the case if you <code class="verbatim">use</code> <code class="verbatim">my-package</code>. Change the definition of <code class="verbatim">your-package</code>:</p>
        <div class="sourceCode" id="cb326" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:your-package</span>
            <span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl #:my-package))</span></code></pre></div>
        <p>If you compile that form you will get this error:</p>
        <pre><code>USE-PACKAGE (MY-PACKAGE:*GLOBAL*) causes name-conflicts in
#&lt;PACKAGE &quot;YOUR-PACKAGE&quot;&gt; between the following symbols:
  YOUR-PACKAGE::*GLOBAL*, MY-PACKAGE:*GLOBAL*
   [Condition of type SB-EXT:NAME-CONFLICT]

Restarts:
 0: [KEEP-OLD] Keep YOUR-PACKAGE::*GLOBAL* accessible in YOUR-PACKAGE (shadowing MY-PACKAGE:*GLOBAL*).
 1: [TAKE-NEW] Make MY-PACKAGE:*GLOBAL* accessible in YOUR-PACKAGE (uninterning YOUR-PACKAGE::*GLOBAL*).
 2: [RESOLVE-CONFLICT] Resolve conflict.
 3: [ABORT] Abort compilation.
 4: [*ABORT] Return to SLY&#39;s top level.
 5: [ABORT] abort thread (#&lt;THREAD tid=20391 &quot;slynk-worker&quot; RUNNING {7005097833}&gt;)
        </code></pre>
        <p>Now you'll have several different <code class="verbatim">restarts</code> to choose from, including <code class="verbatim">TAKE-NEW</code>, <code class="verbatim">KEEP-OLD</code>, etc. and a bit of a mess to clean up. My recommendation is to only use <code class="verbatim">:use</code> sparingly in situations you know you aren't going to have conflicts later (like in your testing packages).</p>
        <p>If you choose <code class="verbatim">KEEP-OLD</code>, you will <em>shadow</em> the <code class="verbatim">my-package:*global*</code> with <code class="verbatim">your-package:*global*</code>. Shadowing means that the imported symbol is hidden, allowing the same symbol in the current package.</p>
        <p>My experience has been that doing anything short of aborting, <code class="verbatim">unintern</code> ing the symbol or <code class="verbatim">unuse-package</code> ing the package I'm using leads to frustration. You're better off not using <code class="verbatim">:use</code> in the first place.</p>
        <p>Even if you do as I recommend you might still have this name conflict problem. Consider this situation:</p>
        <div class="sourceCode" id="cb328" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:my-package</span>
            <span id="cb328-2"><a href="#cb328-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb328-3"><a href="#cb328-3" aria-hidden="true" tabindex="-1"></a>  (:export #:my-function))</span>
            <span id="cb328-4"><a href="#cb328-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:my-package)</span>
            <span id="cb328-5"><a href="#cb328-5" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb328-6"><a href="#cb328-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> my-function </span>() (<span class="kw">print</span> <span class="st">&quot;my-function&quot;</span>))</span>
            <span id="cb328-7"><a href="#cb328-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb328-8"><a href="#cb328-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:my-other-package</span>
            <span id="cb328-9"><a href="#cb328-9" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb328-10"><a href="#cb328-10" aria-hidden="true" tabindex="-1"></a>  (:import-from #:my-package))</span>
            <span id="cb328-11"><a href="#cb328-11" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb328-12"><a href="#cb328-12" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:my-other-package)</span>
            <span id="cb328-13"><a href="#cb328-13" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb328-14"><a href="#cb328-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> my-other-function </span>()</span>
            <span id="cb328-15"><a href="#cb328-15" aria-hidden="true" tabindex="-1"></a>  (my-package:my-function))</span>
            <span id="cb328-16"><a href="#cb328-16" aria-hidden="true" tabindex="-1"></a>(my-other-function)</span></code></pre></div>
        <p>Right now, we have a couple of problems.</p>
        <ol class="incremental">
            <li>I forgot to <strong>export the symbol from my-package</strong>.</li>
            <li>I don't have a package-qualifier attached to <code class="verbatim">my-function</code> when I try to use it.</li>
        </ol>
        <p>When I try to compile <code class="verbatim">my-other-function</code>, I'll get a style-warning about an undefined function. At this point, there are two options:</p>
        <ol class="incremental">
            <li>Add a package name qualifier, as in <code class="verbatim">(my-package:my-function)</code>; or</li>
            <li>Add the function symbol in the imports as below</li>
        </ol>
        <div class="sourceCode" id="cb329" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:my-other-package</span>
            <span id="cb329-2"><a href="#cb329-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb329-3"><a href="#cb329-3" aria-hidden="true" tabindex="-1"></a>  (:import-from #:my-package</span>
            <span id="cb329-4"><a href="#cb329-4" aria-hidden="true" tabindex="-1"></a>                #:my-function))</span>
            <span id="cb329-5"><a href="#cb329-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:my-other-package)</span></code></pre></div>
        <p>If you add the package name qualifier, you'll get this error:</p>
        <div class="sourceCode" id="cb330" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a>*Org Src essentials.org[ <span class="kw">lisp</span> ]*:<span class="dv">14</span>:<span class="dv">25</span>:</span>
            <span id="cb330-2"><a href="#cb330-2" aria-hidden="true" tabindex="-1"></a>  read-error: </span>
            <span id="cb330-3"><a href="#cb330-3" aria-hidden="true" tabindex="-1"></a>    READ <span class="kw">error</span> during COMPILE-FILE:</span>
            <span id="cb330-4"><a href="#cb330-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb330-5"><a href="#cb330-5" aria-hidden="true" tabindex="-1"></a>      The <span class="kw">symbol</span> <span class="st">&quot;MY-FUNCTION&quot;</span> is <span class="kw">not</span> external in <span class="kw">the</span> MY-PACKAGE <span class="kw">package</span>.</span>
            <span id="cb330-6"><a href="#cb330-6" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb330-7"><a href="#cb330-7" aria-hidden="true" tabindex="-1"></a>        Line: <span class="dv">2</span>, Column: <span class="dv">25</span>, File-Position: <span class="dv">52</span></span>
            <span id="cb330-8"><a href="#cb330-8" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb330-9"><a href="#cb330-9" aria-hidden="true" tabindex="-1"></a>        Stream: #&lt;SB-INT:FORM-TRACKING-STREAM for <span class="st">&quot;file /var/tmp/slime1YpOBd&quot;</span> {<span class="dv">7008</span>A37DA3}<span class="op">&gt;</span></span>
            <span id="cb330-10"><a href="#cb330-10" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb330-11"><a href="#cb330-11" aria-hidden="true" tabindex="-1"></a>Compilation failed.</span></code></pre></div>
        <p>Oh bother, forgot to export it.</p>
        <div class="sourceCode" id="cb331" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:my-function</span>
            <span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb331-3"><a href="#cb331-3" aria-hidden="true" tabindex="-1"></a>  (:export #:my-function))</span></code></pre></div>
        <p>Recompile and continue.</p>
        <p>If you fix the problem while it is just a style-warning, you'll be okay. But if you happen to execute code that uses <code class="verbatim">my-function</code>, then you'll get an error message:</p>
        <div class="sourceCode" id="cb332" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a>The <span class="kw">function</span> MY-OTHER-PACKAGE::MY-FUNCTION is undefined.</span>
            <span id="cb332-2"><a href="#cb332-2" aria-hidden="true" tabindex="-1"></a>   [Condition of <span class="kw">type</span> UNDEFINED-FUNCTION]</span>
            <span id="cb332-3"><a href="#cb332-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb332-4"><a href="#cb332-4" aria-hidden="true" tabindex="-1"></a>Restarts:</span>
            <span id="cb332-5"><a href="#cb332-5" aria-hidden="true" tabindex="-1"></a> <span class="dv">0</span>: [CONTINUE] Retry calling MY-FUNCTION.</span>
            <span id="cb332-6"><a href="#cb332-6" aria-hidden="true" tabindex="-1"></a> <span class="dv">1</span>: [USE-VALUE] Call specified <span class="kw">function</span>.</span>
            <span id="cb332-7"><a href="#cb332-7" aria-hidden="true" tabindex="-1"></a> <span class="dv">2</span>: [RETURN-VALUE] Return specified <span class="kw">values</span>.</span>
            <span id="cb332-8"><a href="#cb332-8" aria-hidden="true" tabindex="-1"></a> <span class="dv">3</span>: [RETURN-NOTHING] Return zero <span class="kw">values</span>.</span>
            <span id="cb332-9"><a href="#cb332-9" aria-hidden="true" tabindex="-1"></a> <span class="dv">4</span>: [*ABORT] Return to SLY<span class="dt">&#39;s</span> top level.</span>
            <span id="cb332-10"><a href="#cb332-10" aria-hidden="true" tabindex="-1"></a> <span class="dv">5</span>: [ABORT] <span class="kw">abort</span> thread (#&lt;THREAD tid=<span class="dv">15507</span> <span class="st">&quot;slynk-worker&quot;</span> RUNNING {<span class="dv">7005</span>A4AA33}<span class="op">&gt;</span>)</span></code></pre></div>
        <p>Whoops, <em>now</em> let's add it to imports and recompile.</p>
        <pre><code>IMPORT (MY-PACKAGE::MY-FUNCTION) causes name-conflicts in
#&lt;PACKAGE &quot;MY-OTHER-PACKAGE&quot;&gt; between the following symbols:
  MY-OTHER-PACKAGE::MY-FUNCTION, MY-PACKAGE::MY-FUNCTION
   [Condition of type SB-EXT:NAME-CONFLICT]

Restarts:
 0: [SHADOWING-IMPORT-IT] Shadowing-import MY-PACKAGE::MY-FUNCTION, uninterning MY-OTHER-PACKAGE::MY-FUNCTION.
 1: [DONT-IMPORT-IT] Don&#39;t import MY-PACKAGE::MY-FUNCTION, keeping MY-OTHER-PACKAGE::MY-FUNCTION.
 2: [RESOLVE-CONFLICT] Resolve conflict.
 3: [ABORT] Abort compilation.
 4: [*ABORT] Return to SLY&#39;s top level.
 5: [ABORT] abort thread (#&lt;THREAD tid=20827 &quot;slynk-worker&quot; RUNNING {700670E963}&gt;)
        </code></pre>
        <p>If you choose <code class="verbatim">SHADOWING-IMPORT-IT</code> and try to recompile your code again, you'll get a similar error:</p>
        <div class="sourceCode" id="cb334" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a>*Org Src essentials.org[ <span class="kw">lisp</span> ]*:<span class="dv">7</span>:<span class="dv">1</span>:</span>
            <span id="cb334-2"><a href="#cb334-2" aria-hidden="true" tabindex="-1"></a>  warning: </span>
            <span id="cb334-3"><a href="#cb334-3" aria-hidden="true" tabindex="-1"></a>    MY-OTHER-PACKAGE also shadows <span class="kw">the</span> following symbols:</span>
            <span id="cb334-4"><a href="#cb334-4" aria-hidden="true" tabindex="-1"></a>      (MY-PACKAGE::MY-FUNCTION)</span>
            <span id="cb334-5"><a href="#cb334-5" aria-hidden="true" tabindex="-1"></a>    ==&gt;</span>
            <span id="cb334-6"><a href="#cb334-6" aria-hidden="true" tabindex="-1"></a>      (SB-IMPL::%DEFPACKAGE <span class="st">&quot;MY-OTHER-PACKAGE&quot;</span> <span class="dt">&#39;NIL</span> <span class="dt">&#39;NIL</span> <span class="dt">&#39;NIL</span> <span class="dt">&#39;NIL</span> &#39;(<span class="st">&quot;CL&quot;</span>)</span>
            <span id="cb334-7"><a href="#cb334-7" aria-hidden="true" tabindex="-1"></a>                            &#39;((<span class="st">&quot;MY-PACKAGE&quot;</span> <span class="st">&quot;MY-FUNCTION&quot;</span>)) <span class="dt">&#39;NIL</span> <span class="dt">&#39;NIL</span></span>
            <span id="cb334-8"><a href="#cb334-8" aria-hidden="true" tabindex="-1"></a>                            &#39;(<span class="st">&quot;MY-OTHER-PACKAGE&quot;</span>) <span class="dt">&#39;NIL</span> ...)</span>
            <span id="cb334-9"><a href="#cb334-9" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb334-10"><a href="#cb334-10" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb334-11"><a href="#cb334-11" aria-hidden="true" tabindex="-1"></a>Compilation failed.</span></code></pre></div>
        <p>If all this has your head spinning now, you're not alone.</p>
        <p>To reiterate, you have two options:</p>
        <div class="sourceCode" id="cb335" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; * Option 1: Add a package name qualifier</span></span>
            <span id="cb335-2"><a href="#cb335-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:my-package</span>
            <span id="cb335-3"><a href="#cb335-3" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb335-4"><a href="#cb335-4" aria-hidden="true" tabindex="-1"></a>  (:export #:my-function))              <span class="co">; &lt;- Don&#39;t forget to export.</span></span>
            <span id="cb335-5"><a href="#cb335-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:my-package)</span>
            <span id="cb335-6"><a href="#cb335-6" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb335-7"><a href="#cb335-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> my-function </span>() (<span class="kw">print</span> <span class="st">&quot;my-function&quot;</span>))</span>
            <span id="cb335-8"><a href="#cb335-8" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb335-9"><a href="#cb335-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:my-other-package</span>
            <span id="cb335-10"><a href="#cb335-10" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb335-11"><a href="#cb335-11" aria-hidden="true" tabindex="-1"></a>  (:import-from #:my-package))</span>
            <span id="cb335-12"><a href="#cb335-12" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb335-13"><a href="#cb335-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:my-other-package)</span>
            <span id="cb335-14"><a href="#cb335-14" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb335-15"><a href="#cb335-15" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> my-other-function </span>()</span>
            <span id="cb335-16"><a href="#cb335-16" aria-hidden="true" tabindex="-1"></a>  (my-package:my-function))             <span class="co">; &lt;- Added package name qualifier</span></span>
            <span id="cb335-17"><a href="#cb335-17" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb335-18"><a href="#cb335-18" aria-hidden="true" tabindex="-1"></a>(my-other-function)</span>
            <span id="cb335-19"><a href="#cb335-19" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb335-20"><a href="#cb335-20" aria-hidden="true" tabindex="-1"></a><span class="co">;; * Option 2: Add MY-FUNCTION to your imports</span></span>
            <span id="cb335-21"><a href="#cb335-21" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:my-package</span>
            <span id="cb335-22"><a href="#cb335-22" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb335-23"><a href="#cb335-23" aria-hidden="true" tabindex="-1"></a>  (:export #:my-function))</span>
            <span id="cb335-24"><a href="#cb335-24" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:my-package)</span>
            <span id="cb335-25"><a href="#cb335-25" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb335-26"><a href="#cb335-26" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> my-function </span>() (<span class="kw">print</span> <span class="st">&quot;my-function&quot;</span>))</span>
            <span id="cb335-27"><a href="#cb335-27" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb335-28"><a href="#cb335-28" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:my-other-package</span>
            <span id="cb335-29"><a href="#cb335-29" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb335-30"><a href="#cb335-30" aria-hidden="true" tabindex="-1"></a>  (:import-from #:my-package</span>
            <span id="cb335-31"><a href="#cb335-31" aria-hidden="true" tabindex="-1"></a>                #:my-function)) <span class="co">; &lt;- Added import</span></span>
            <span id="cb335-32"><a href="#cb335-32" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb335-33"><a href="#cb335-33" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:my-other-package)</span>
            <span id="cb335-34"><a href="#cb335-34" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb335-35"><a href="#cb335-35" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> my-other-function </span>()</span>
            <span id="cb335-36"><a href="#cb335-36" aria-hidden="true" tabindex="-1"></a>  (my-function))</span>
            <span id="cb335-37"><a href="#cb335-37" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb335-38"><a href="#cb335-38" aria-hidden="true" tabindex="-1"></a><span class="co">;; Then while in MY-OTHER-PACKAGE, unintern MY-FUNCTION.</span></span>
            <span id="cb335-39"><a href="#cb335-39" aria-hidden="true" tabindex="-1"></a>(<span class="kw">unintern</span> <span class="dt">&#39;my-function</span>)</span>
            <span id="cb335-40"><a href="#cb335-40" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb335-41"><a href="#cb335-41" aria-hidden="true" tabindex="-1"></a><span class="co">;; Recompile MY-OTHER-PACKAGE&#39;s defpackage form above.</span></span>
            <span id="cb335-42"><a href="#cb335-42" aria-hidden="true" tabindex="-1"></a><span class="co">;; It should now succeed.</span></span>
            <span id="cb335-43"><a href="#cb335-43" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb335-44"><a href="#cb335-44" aria-hidden="true" tabindex="-1"></a><span class="co">;; Now you can call your code.</span></span>
            <span id="cb335-45"><a href="#cb335-45" aria-hidden="true" tabindex="-1"></a>(my-other-function)</span></code></pre></div>
        <p>It'll take some getting used to, but eventually you'll know how to clean up any messes you make.</p>
        <h3 id="763bdaad-9f62-4a7e-b767-b7e1fd8913a5">Nicknames</h3>
        <p>It's possible for packages to define nicknames. Nicknames are useful for calling individual symbols from packages that have long names.</p>
        <div class="sourceCode" id="cb336" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:a-package-with-a-long/and-annoying/name</span>
            <span id="cb336-2"><a href="#cb336-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb336-3"><a href="#cb336-3" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:nicknames</span> #:smol-name)</span>
            <span id="cb336-4"><a href="#cb336-4" aria-hidden="true" tabindex="-1"></a>  (:export #:smol-hello))</span>
            <span id="cb336-5"><a href="#cb336-5" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb336-6"><a href="#cb336-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:a-package-with-a-long/and-annoying/name)</span>
            <span id="cb336-7"><a href="#cb336-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb336-8"><a href="#cb336-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> smol-hello </span>()</span>
            <span id="cb336-9"><a href="#cb336-9" aria-hidden="true" tabindex="-1"></a>  :hi)</span>
            <span id="cb336-10"><a href="#cb336-10" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb336-11"><a href="#cb336-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:my-package</span>
            <span id="cb336-12"><a href="#cb336-12" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb336-13"><a href="#cb336-13" aria-hidden="true" tabindex="-1"></a>  (:import-from #:some-package))</span>
            <span id="cb336-14"><a href="#cb336-14" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb336-15"><a href="#cb336-15" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:my-package)</span>
            <span id="cb336-16"><a href="#cb336-16" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb336-17"><a href="#cb336-17" aria-hidden="true" tabindex="-1"></a>(smol-name:smol-hello) <span class="co">; =&gt; :HI</span></span></code></pre></div>
        <p>If a package doesn't define its own nickname, you can define a nickname local to your package:</p>
        <div class="sourceCode" id="cb337" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:a-package-with-a-long/and-annoying/name</span>
            <span id="cb337-2"><a href="#cb337-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb337-3"><a href="#cb337-3" aria-hidden="true" tabindex="-1"></a>  (:export #:smol-hello))</span>
            <span id="cb337-4"><a href="#cb337-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb337-5"><a href="#cb337-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:a-package-with-a-long/and-annoying/name)</span>
            <span id="cb337-6"><a href="#cb337-6" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb337-7"><a href="#cb337-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> smol-hello </span>()</span>
            <span id="cb337-8"><a href="#cb337-8" aria-hidden="true" tabindex="-1"></a>  :hi)</span>
            <span id="cb337-9"><a href="#cb337-9" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb337-10"><a href="#cb337-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:my-package</span>
            <span id="cb337-11"><a href="#cb337-11" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb337-12"><a href="#cb337-12" aria-hidden="true" tabindex="-1"></a>  (:local-nicknames (#:annoying #:a-package-with-a-long/and-annoying/name)))</span>
            <span id="cb337-13"><a href="#cb337-13" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb337-14"><a href="#cb337-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:my-package)</span>
            <span id="cb337-15"><a href="#cb337-15" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb337-16"><a href="#cb337-16" aria-hidden="true" tabindex="-1"></a>(annoying:smol-hello) <span class="co">; =&gt; :HI</span></span></code></pre></div>
        <p>Unfortunately, you can't define nicknames for individual symbols.</p>
        <div class="sourceCode" id="cb338" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:a-package-with-a-long/and-annoying/name</span>
            <span id="cb338-2"><a href="#cb338-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb338-3"><a href="#cb338-3" aria-hidden="true" tabindex="-1"></a>  (:export #:a-very-long-and-annoying-function-or-macro-name</span>
            <span id="cb338-4"><a href="#cb338-4" aria-hidden="true" tabindex="-1"></a>           #:smol-hello))</span>
            <span id="cb338-5"><a href="#cb338-5" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb338-6"><a href="#cb338-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:a-package-with-a-long/and-annoying/name)</span>
            <span id="cb338-7"><a href="#cb338-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb338-8"><a href="#cb338-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> smol-hello </span>()</span>
            <span id="cb338-9"><a href="#cb338-9" aria-hidden="true" tabindex="-1"></a>  :hi)</span>
            <span id="cb338-10"><a href="#cb338-10" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb338-11"><a href="#cb338-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> a-very-long-and-annoying-function-or-macro-name </span>()</span>
            <span id="cb338-12"><a href="#cb338-12" aria-hidden="true" tabindex="-1"></a>  :oof)</span>
            <span id="cb338-13"><a href="#cb338-13" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb338-14"><a href="#cb338-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:my-package</span>
            <span id="cb338-15"><a href="#cb338-15" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb338-16"><a href="#cb338-16" aria-hidden="true" tabindex="-1"></a>  (:local-nicknames (#:annoying #:a-package-with-a-long/and-annoying/name)))</span>
            <span id="cb338-17"><a href="#cb338-17" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb338-18"><a href="#cb338-18" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:my-package)</span>
            <span id="cb338-19"><a href="#cb338-19" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb338-20"><a href="#cb338-20" aria-hidden="true" tabindex="-1"></a><span class="co">;; Deal with it.</span></span>
            <span id="cb338-21"><a href="#cb338-21" aria-hidden="true" tabindex="-1"></a>(annoying:a-very-long-and-annoying-function-or-macro-name) <span class="co">; =&gt; :OOF</span></span></code></pre></div>
        <h3 id="3b1265c5-5d0d-4f9b-b108-bf95262b5ce4"><code class="verbatim">uiop:define-package</code></h3>
        <p>UIOP is a cross-implementation compatibility library that comes with ASDF (more on that in a second). Its <code class="verbatim">define-package</code> macro provides some extra capabilities that the standard <code class="verbatim">defpackage</code> doesn't. We'll see them in use later when discussing different factoring styles.</p>
        <h2 id="1753f901-96b0-4f45-8d05-cacef30455af">Systems</h2>
        <h3 id="cf1a28ca-e926-4e15-acf3-97abc0741f39">What Are Systems?</h3>
        <p>Common Lisp system are what other languages might call "packages".</p>
        <p>A project may have code organized across many different files. In order to call code from one file in another file, you will need to have that file loaded into your Lisp image. If <code class="verbatim">core.lisp</code> calls and relies on <code class="verbatim">utils.lisp</code> code, then <code class="verbatim">utils.lisp</code> code needs to be loaded before <code class="verbatim">core.lisp</code> is loaded and run. If you have a lot of files that need to be loaded in a particular order, you probably want a way to automate this process. Systems, defined with <code class="verbatim">defsystem</code> and the <code class="verbatim">ASDF</code> library, are declarations of groups of code loaded in a particular order.</p>
        <p>When you need to coordinate the loading of multiple files, including third-party systems, then it's time to think about your <code class="verbatim">defsystem</code>.</p>
        <h3 id="b0ee5c2c-5415-4ebc-bcec-5b50aca3eb8c">What Is ASDF?</h3>
        <p>ASDF is the defacto-standard library (available out of the box with SBCL and other implementations) that adds convenient code loading orchestration capabilities to Lisp. You do so by defining a <code class="verbatim">defsystem</code> in a <code class="verbatim">.asd</code> file in your project's root directory and then loading the system. When you load the system, ASDF will load your other files depending on your system definition.</p>
        <p>Because <code class="verbatim">defsystem</code> is a third-party extension to Lisp and was not previously available, there are different styles of organizing packages and systems in older projects that are less common in more modern projects. We'll be taking a look at different styles of factoring later, but for now let's focus on <code class="verbatim">defsystem</code> alone.</p>
        <h3 id="5d0f376c-59ac-49b2-90ca-5b10fc4d5df4">Defining Systems</h3>
        <p>Let's say we have a project that looks like this:</p>
        <pre class="example"><code>% tree
.
├── almighty-system.asd
└── src
    └── core.lisp
        </code></pre>
        <p>This is our <code class="verbatim">defsystem</code>:</p>
        <div class="sourceCode" id="cb340" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a>(defsystem <span class="st">&quot;almighty-system&quot;</span></span>
            <span id="cb340-2"><a href="#cb340-2" aria-hidden="true" tabindex="-1"></a>  :author <span class="st">&quot;Micah Killian&quot;</span></span>
            <span id="cb340-3"><a href="#cb340-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">:version</span> <span class="st">&quot;0.0.1&quot;</span></span>
            <span id="cb340-4"><a href="#cb340-4" aria-hidden="true" tabindex="-1"></a>  :description <span class="st">&quot;A system for demonstrating how to define systems.&quot;</span></span>
            <span id="cb340-5"><a href="#cb340-5" aria-hidden="true" tabindex="-1"></a>  :depends-on (<span class="st">&quot;local-time&quot;</span>)</span>
            <span id="cb340-6"><a href="#cb340-6" aria-hidden="true" tabindex="-1"></a>  :components (:module <span class="st">&quot;src&quot;</span></span>
            <span id="cb340-7"><a href="#cb340-7" aria-hidden="true" tabindex="-1"></a>               :pathname <span class="st">&quot;src&quot;</span></span>
            <span id="cb340-8"><a href="#cb340-8" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;core&quot;</span>)))</span></code></pre></div>
        <p>If we load this system (more on that later), ASDF will look for a local copy of the <code class="verbatim">local-time</code> library, downloading it with <code class="verbatim">Quicklisp</code> (more on that later) if a local copy doesn't exist. After loading the <code class="verbatim">defsystem</code> defined by <code class="verbatim">local-time</code>, ASDF will read the <code class="verbatim">core.lisp</code> file in the <code class="verbatim">src</code> directory and load it into the Lisp image.</p>
        <h3 id="07835721-5629-4d7c-a4c2-3f721fbaf04e"><span class="todo TODO">TODO</span> Loading Systems</h3>
        <p>Loading a system requires first that the <code class="verbatim">.asd</code> file is loaded.</p>
        <div class="sourceCode" id="cb341" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a>(asdf:load-asd (<span class="kw">merge-pathnames</span> <span class="va">*default-pathname-defaults*</span> <span class="st">&quot;almighty-system.asd&quot;</span>))</span></code></pre></div>
        <p>This requires some explanation. <code class="verbatim">asdf:load-system</code> takes a <code class="verbatim">pathname</code> to the <code class="verbatim">.asd</code> file. If you have the absolute path available, you can use that:</p>
        <div class="sourceCode" id="cb342" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a>(asdf:load-asd <span class="st">&quot;/Users/micah/lisp/almighty/content/essentials/code/projects/almighty-system/almighty-system.asd&quot;</span>)</span></code></pre></div>
        <p>Or, in the REPL, you can type <code class="verbatim">,</code> (<code class="verbatim">sly-mrepl-shortcut</code>) and select <code class="verbatim">set-directory</code> and ensure that the current working directory is set to the project root (where the <code class="verbatim">.asd</code> file lives), and then run the other line above. <code class="verbatim">set-directory</code> will set the value of <code class="verbatim">*default-pathname-defaults*</code>, and <code class="verbatim">merge-pathnames</code> does what it says. Thus, it's equivalent to the following:</p>
        <div class="sourceCode" id="cb343" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a>(asdf:load-asd (<span class="kw">merge-pathnames</span> <span class="st">&quot;/Users/micah/lisp/almighty/content/essentials/code/projects/almighty-system/&quot;</span> <span class="st">&quot;almighty-system.asd&quot;</span>))</span></code></pre></div>
        <p>After you load the asd file, you can load the system with <code class="verbatim">,</code> and <code class="verbatim">load system</code> or <code class="verbatim">(asdf:load-system "almighty-system")</code> in the REPL.</p>
        <h2 id="82baf037-8bab-48d5-837c-dcfdf0700929">Styles of Factoring Packages &amp; Systems</h2>
        <p>Instead of dealing with systems separately from packages, it's useful to see how systems can be configured depending on different code organization strategies. As you might expect, the way you organize a project is heavily influenced by how large the project is.</p>
        <h3 id="d1332366-9281-475f-b732-33b49705992f">Mother Of All Package Strategy</h3>
        <p>A good representation of the Mother Of All package strategy of Common Lisp code organization is <code class="verbatim">hunchentoot</code>–a popular Lisp web server and web dev framework. If we take a look at the file tree it looks like this:</p>
        <pre class="example"><code>% tree
.
├── acceptor.lisp
├── CHANGELOG
├── CHANGELOG_TBNL
├── compat.lisp
├── conditions.lisp
├── cookie.lisp
├── docs
│   ├── hunchentoot.gif
│   ├── index.html
│   └── LICENSE.txt
├── easy-handlers.lisp
├── headers.lisp
├── hunchentoot.asd
├── lispworks.lisp
├── log.lisp
├── make-docstrings.lisp
├── mime-types.lisp
├── misc.lisp
├── packages.lisp
├── README.md
├── release-checklist.txt
├── reply.lisp
├── request.lisp
├── run-test.lisp
├── session.lisp
├── set-timeouts.lisp
├── specials.lisp
├── ssl.lisp
├── taskmaster.lisp
├── test
│   ├── ca-built-via-xca.xdb
│   ├── ca.crt
│   ├── client.crt
│   ├── favicon.ico
│   ├── fz.jpg
│   ├── packages.lisp
│   ├── script-engine.lisp
│   ├── script.lisp
│   ├── server.crt
│   ├── server+ca.crt
│   ├── test-handlers.lisp
│   ├── test-key-no-password.key
│   └── UTF-8-demo.html
├── url-rewrite
│   ├── packages.lisp
│   ├── primitives.lisp
│   ├── specials.lisp
│   ├── url-rewrite.lisp
│   └── util.lisp
└── util.lisp
        </code></pre>
        <p>The organization is flat, lots of separate files, mostly in the project root directory.</p>
        <p>Hunchentoot has one package definition (well, two), found in the <code class="verbatim">packages.lisp</code> file.</p>
        <div class="sourceCode" id="cb345" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> :cl-user)</span>
            <span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb345-3"><a href="#cb345-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:hunchentoot</span>
            <span id="cb345-4"><a href="#cb345-4" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:nicknames</span> #:tbnl)</span>
            <span id="cb345-5"><a href="#cb345-5" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> :cl :cl-ppcre :chunga :flexi-streams :url-rewrite :alexandria)</span>
            <span id="cb345-6"><a href="#cb345-6" aria-hidden="true" tabindex="-1"></a>  (:shadow #:defconstant</span>
            <span id="cb345-7"><a href="#cb345-7" aria-hidden="true" tabindex="-1"></a>           #:url-encode)</span>
            <span id="cb345-8"><a href="#cb345-8" aria-hidden="true" tabindex="-1"></a>  (:export #:*acceptor*</span>
            <span id="cb345-9"><a href="#cb345-9" aria-hidden="true" tabindex="-1"></a>           #:*catch-errors-p*</span>
            <span id="cb345-10"><a href="#cb345-10" aria-hidden="true" tabindex="-1"></a>           #+:lispworks</span>
            <span id="cb345-11"><a href="#cb345-11" aria-hidden="true" tabindex="-1"></a>           #:*cleanup-function*</span>
            <span id="cb345-12"><a href="#cb345-12" aria-hidden="true" tabindex="-1"></a>           #+:lispworks</span>
            <span id="cb345-13"><a href="#cb345-13" aria-hidden="true" tabindex="-1"></a>           #:*cleanup-interval*</span>
            <span id="cb345-14"><a href="#cb345-14" aria-hidden="true" tabindex="-1"></a>           #:*content-types-for-url-rewrite*</span>
            <span id="cb345-15"><a href="#cb345-15" aria-hidden="true" tabindex="-1"></a>           #:*default-connection-timeout*</span>
            <span id="cb345-16"><a href="#cb345-16" aria-hidden="true" tabindex="-1"></a>           #:*default-content-type*</span>
            <span id="cb345-17"><a href="#cb345-17" aria-hidden="true" tabindex="-1"></a>           #:*dispatch-table*</span>
            <span id="cb345-18"><a href="#cb345-18" aria-hidden="true" tabindex="-1"></a>           #:*file-upload-hook*</span>
            <span id="cb345-19"><a href="#cb345-19" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; ... and many more</span></span>
            <span id="cb345-20"><a href="#cb345-20" aria-hidden="true" tabindex="-1"></a>           ))                           </span></code></pre></div>
        <p><code class="verbatim">:nicknames</code> defines what other package name qualifiers you can use besides <code class="verbatim">hunchentoot</code>. That means that Hunchentoot itself provides you the ability to use <code class="verbatim">(tbnl:*acceptor*)</code> if you want. Useful for allowing users to use a smaller package name qualifier on their symbols.</p>
        <p>Hunchentoot uses <code class="verbatim">:use</code> for several utility libraries. Again, I don't recommend it, but it is not uncommon.</p>
        <p><code class="verbatim">:shadow</code> here creates an symbol or symbols that are initially unbound in the package. Clearly, there was a naming conflict somewhere between Common Lisp's built-in <code class="verbatim">defconstant</code> and the <code class="verbatim">url-encode</code> symbol intended to have two different values (<code class="verbatim">utils.lisp</code> and <code class="verbatim">url-rewrite/url-rewrite.lisp</code> both define <code class="verbatim">url-encode</code> functions). What this means is that in the <code class="verbatim">hunchentoot</code> package, if you write <code class="verbatim">url-encode</code> while you are in the <code class="verbatim">hunchentoot</code> package, it has a different value than if you are in the <code class="verbatim">url-rewrite</code> package.</p>
        <p>It's a wonky way of preventing a naming conflict error because the <code class="verbatim">hunchentoot</code> package <em>uses</em> <code class="verbatim">:url-rewrite</code> instead of importing it. However, you might sometimes need to use <code class="verbatim">:shadow</code> to get around naming conflicts caused by other systems/libraries that use Common Lisp symbol names, so it's something to keep in mind.</p>
        <p>The important point is this: All of the files in the project root begin with <code class="verbatim">(in-package :hunchentoot)</code>. Each file contributes their defined symbols to the <code class="verbatim">:hunchentoot</code> package.</p>
        <p>If all this package talk has the ol' nogging working overtime, you might be thinking, "Hey Micah, doesn't that assume that the <code class="verbatim">packages.lisp</code> file is loaded before all the others?"</p>
        <p>Yes, yes it does. Let's take a look at the <code class="verbatim">hunchentoot.asd</code> file:</p>
        <div class="sourceCode" id="cb346" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a>(defsystem :hunchentoot</span>
            <span id="cb346-2"><a href="#cb346-2" aria-hidden="true" tabindex="-1"></a>  :serial <span class="kw">t</span></span>
            <span id="cb346-3"><a href="#cb346-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">:version</span> <span class="st">&quot;1.3.1&quot;</span></span>
            <span id="cb346-4"><a href="#cb346-4" aria-hidden="true" tabindex="-1"></a>  :description <span class="st">&quot;Hunchentoot is a HTTP server based on USOCKET and</span></span>
            <span id="cb346-5"><a href="#cb346-5" aria-hidden="true" tabindex="-1"></a><span class="st">  BORDEAUX-THREADS.  It supports HTTP 1.1, serves static files, has a</span></span>
            <span id="cb346-6"><a href="#cb346-6" aria-hidden="true" tabindex="-1"></a><span class="st">  simple framework for user-defined handlers and can be extended</span></span>
            <span id="cb346-7"><a href="#cb346-7" aria-hidden="true" tabindex="-1"></a><span class="st">  through subclassing.&quot;</span></span>
            <span id="cb346-8"><a href="#cb346-8" aria-hidden="true" tabindex="-1"></a>  :license <span class="st">&quot;BSD-2-Clause&quot;</span></span>
            <span id="cb346-9"><a href="#cb346-9" aria-hidden="true" tabindex="-1"></a>  :depends-on (:chunga</span>
            <span id="cb346-10"><a href="#cb346-10" aria-hidden="true" tabindex="-1"></a>               :cl-base64</span>
            <span id="cb346-11"><a href="#cb346-11" aria-hidden="true" tabindex="-1"></a>               :cl-fad</span>
            <span id="cb346-12"><a href="#cb346-12" aria-hidden="true" tabindex="-1"></a>               :cl-ppcre</span>
            <span id="cb346-13"><a href="#cb346-13" aria-hidden="true" tabindex="-1"></a>               :flexi-streams</span>
            <span id="cb346-14"><a href="#cb346-14" aria-hidden="true" tabindex="-1"></a>               (:feature (:not (:or :lispworks :hunchentoot-no-ssl))</span>
            <span id="cb346-15"><a href="#cb346-15" aria-hidden="true" tabindex="-1"></a>                         :cl+ssl)</span>
            <span id="cb346-16"><a href="#cb346-16" aria-hidden="true" tabindex="-1"></a>               :md5</span>
            <span id="cb346-17"><a href="#cb346-17" aria-hidden="true" tabindex="-1"></a>               :alexandria</span>
            <span id="cb346-18"><a href="#cb346-18" aria-hidden="true" tabindex="-1"></a>               :rfc2388</span>
            <span id="cb346-19"><a href="#cb346-19" aria-hidden="true" tabindex="-1"></a>               :trivial-backtrace</span>
            <span id="cb346-20"><a href="#cb346-20" aria-hidden="true" tabindex="-1"></a>               (:feature (:not :lispworks) :usocket)</span>
            <span id="cb346-21"><a href="#cb346-21" aria-hidden="true" tabindex="-1"></a>               (:feature (:not :lispworks) :bordeaux-threads))</span>
            <span id="cb346-22"><a href="#cb346-22" aria-hidden="true" tabindex="-1"></a>  :components ((:module <span class="st">&quot;url-rewrite&quot;</span></span>
            <span id="cb346-23"><a href="#cb346-23" aria-hidden="true" tabindex="-1"></a>                :serial <span class="kw">t</span></span>
            <span id="cb346-24"><a href="#cb346-24" aria-hidden="true" tabindex="-1"></a>                :components ((:file <span class="st">&quot;packages&quot;</span>)</span>
            <span id="cb346-25"><a href="#cb346-25" aria-hidden="true" tabindex="-1"></a>                             (:file <span class="st">&quot;specials&quot;</span>)</span>
            <span id="cb346-26"><a href="#cb346-26" aria-hidden="true" tabindex="-1"></a>                             (:file <span class="st">&quot;primitives&quot;</span>)</span>
            <span id="cb346-27"><a href="#cb346-27" aria-hidden="true" tabindex="-1"></a>                             (:file <span class="st">&quot;util&quot;</span>)</span>
            <span id="cb346-28"><a href="#cb346-28" aria-hidden="true" tabindex="-1"></a>                             (:file <span class="st">&quot;url-rewrite&quot;</span>)))</span>
            <span id="cb346-29"><a href="#cb346-29" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;packages&quot;</span>)</span>
            <span id="cb346-30"><a href="#cb346-30" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;lispworks&quot;</span> :if-feature :lispworks)</span>
            <span id="cb346-31"><a href="#cb346-31" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;compat&quot;</span> :if-feature (:not :lispworks))</span>
            <span id="cb346-32"><a href="#cb346-32" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;specials&quot;</span>)</span>
            <span id="cb346-33"><a href="#cb346-33" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;conditions&quot;</span>)</span>
            <span id="cb346-34"><a href="#cb346-34" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;mime-types&quot;</span>)</span>
            <span id="cb346-35"><a href="#cb346-35" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;util&quot;</span>)</span>
            <span id="cb346-36"><a href="#cb346-36" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;log&quot;</span>)</span>
            <span id="cb346-37"><a href="#cb346-37" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;cookie&quot;</span>)</span>
            <span id="cb346-38"><a href="#cb346-38" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;reply&quot;</span>)</span>
            <span id="cb346-39"><a href="#cb346-39" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;request&quot;</span>)</span>
            <span id="cb346-40"><a href="#cb346-40" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;session&quot;</span>)</span>
            <span id="cb346-41"><a href="#cb346-41" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;misc&quot;</span>)</span>
            <span id="cb346-42"><a href="#cb346-42" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;headers&quot;</span>)</span>
            <span id="cb346-43"><a href="#cb346-43" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;set-timeouts&quot;</span>)</span>
            <span id="cb346-44"><a href="#cb346-44" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;taskmaster&quot;</span>)</span>
            <span id="cb346-45"><a href="#cb346-45" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;acceptor&quot;</span>)</span>
            <span id="cb346-46"><a href="#cb346-46" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;ssl&quot;</span> :if-feature (:not :hunchentoot-no-ssl))</span>
            <span id="cb346-47"><a href="#cb346-47" aria-hidden="true" tabindex="-1"></a>               (:file <span class="st">&quot;easy-handlers&quot;</span>))</span>
            <span id="cb346-48"><a href="#cb346-48" aria-hidden="true" tabindex="-1"></a>  :perform (test-op (o c) (<span class="kw">load</span> (<span class="kw">merge-pathnames</span> <span class="st">&quot;run-test.lisp&quot;</span> (system-source-directory c)))))</span></code></pre></div>
        <p>Notice <code class="verbatim">:serial t</code> up at the top. That means that all of the <code class="verbatim">:components</code> will be loaded <em>in the order they are listed</em>. So, after all of the <code class="verbatim">:depends-on</code> dependency systems are loaded, the <code class="verbatim">url-rewrite</code> module will be loaded. Its contents will also be loaded in order, and so first the <code class="verbatim">url-rewrite/packages.lisp</code> file will be loaded, then <code class="verbatim">specials.lisp</code>, <code class="verbatim">primitives.lisp</code>, etc. After that module is loaded, the first file in the project root that will be loaded is its <code class="verbatim">packages.lisp</code> file that we look at before. The Mother Of All <code class="verbatim">packages.lisp</code> is where all the symbols for the majority of the project live and are namespaced.</p>
        <p>There are only two other systems in the Hunchentoot project: one for development and the other for testing. They don't provide any further insight into this strategy, so we will skip them.</p>
        <p>In summary, the Mother Of All Package Strategy is this: you have one package (<code class="verbatim">defpackage :hunchentoot</code>) and one system (<code class="verbatim">defsystem :hunchentoot</code>), and that one package <code class="verbatim">:uses</code> or imports from several other packages. Other code files begin with <code class="verbatim">(in-package :hunchentoot)</code>, giving them access to the symbols defined in other files and contributing the symbols they define to that package. The <code class="verbatim">packages.lisp</code> file's exports define the public interface for users. This style is "retro", but still perfectly usable especially on smaller projects, and even larger projects like Hunchentoot. The <code class="verbatim">vend</code> library is a modern Lisp library that use this Mother of All Package Strategy.</p>
        <h3 id="48f988a2-de23-48b4-aa34-c719f982f1b4">Multiple Systems Strategy</h3>
        <p>It's also possible that a single project might have several systems, primarily used as optional extensions to the library's core functionality. <code class="verbatim">transducers</code> is one such library, as is <code class="verbatim">mito</code>. However, <code class="verbatim">transducers</code> still uses just one package for the core functionality. It's <code class="verbatim">defsystem</code> definition also uses the <code class="verbatim">serial t</code> approach of loading source files in order. This Multi-System Strategy is modular, yet does not exclude the possibility of using the Mother Of All Package Strategy.</p>
        <h3 id="d4af57a6-0692-4a7a-987e-e9ee6bc117df">One Package Per File Strategy</h3>
        <p><code class="verbatim">mito</code>, on the other hand, in addition to having multiple systems–one for core functionality and others for auxiliary functionality–also uses the One Package Per File Strategy. This is a more "modern" approach and considered by some to be the preferred strategy generally.</p>
        <p>Let's take a look at the <code class="verbatim">mito</code> system:</p>
        <div class="sourceCode" id="cb347" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a>(defsystem <span class="st">&quot;mito&quot;</span></span>
            <span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">:version</span> <span class="st">&quot;0.2.0&quot;</span></span>
            <span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a>  :author <span class="st">&quot;Eitaro Fukamachi&quot;</span></span>
            <span id="cb347-4"><a href="#cb347-4" aria-hidden="true" tabindex="-1"></a>  :license <span class="st">&quot;BSD 3-Clause&quot;</span></span>
            <span id="cb347-5"><a href="#cb347-5" aria-hidden="true" tabindex="-1"></a>  :depends-on (<span class="st">&quot;mito-core&quot;</span></span>
            <span id="cb347-6"><a href="#cb347-6" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;mito-migration&quot;</span></span>
            <span id="cb347-7"><a href="#cb347-7" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;lack-middleware-mito&quot;</span></span>
            <span id="cb347-8"><a href="#cb347-8" aria-hidden="true" tabindex="-1"></a>               (:feature :sb-package-locks <span class="st">&quot;cl-package-locks&quot;</span>))</span>
            <span id="cb347-9"><a href="#cb347-9" aria-hidden="true" tabindex="-1"></a>  :components ((:file <span class="st">&quot;src/mito&quot;</span>))</span>
            <span id="cb347-10"><a href="#cb347-10" aria-hidden="true" tabindex="-1"></a>  :description <span class="st">&quot;Abstraction layer for DB schema&quot;</span></span>
            <span id="cb347-11"><a href="#cb347-11" aria-hidden="true" tabindex="-1"></a>  :in-order-to ((test-op (test-op <span class="st">&quot;mito-test&quot;</span>))))</span></code></pre></div>
        <p>Here, we notice that the <code class="verbatim">:depends-on</code> list is three other subsystems in the <code class="verbatim">mito</code> project. Let's look at <code class="verbatim">mito-core.asd</code>:</p>
        <div class="sourceCode" id="cb348" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a>(defsystem <span class="st">&quot;mito-core&quot;</span></span>
            <span id="cb348-2"><a href="#cb348-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">:version</span> <span class="st">&quot;0.2.0&quot;</span></span>
            <span id="cb348-3"><a href="#cb348-3" aria-hidden="true" tabindex="-1"></a>  :author <span class="st">&quot;Eitaro Fukamachi&quot;</span></span>
            <span id="cb348-4"><a href="#cb348-4" aria-hidden="true" tabindex="-1"></a>  :license <span class="st">&quot;BSD 3-Clause&quot;</span></span>
            <span id="cb348-5"><a href="#cb348-5" aria-hidden="true" tabindex="-1"></a>  :depends-on ((<span class="bu">:version</span> <span class="st">&quot;dbi&quot;</span> <span class="st">&quot;0.11.1&quot;</span>)</span>
            <span id="cb348-6"><a href="#cb348-6" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;sxql&quot;</span></span>
            <span id="cb348-7"><a href="#cb348-7" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;cl-ppcre&quot;</span></span>
            <span id="cb348-8"><a href="#cb348-8" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;closer-mop&quot;</span></span>
            <span id="cb348-9"><a href="#cb348-9" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;dissect&quot;</span></span>
            <span id="cb348-10"><a href="#cb348-10" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;trivia&quot;</span></span>
            <span id="cb348-11"><a href="#cb348-11" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;local-time&quot;</span></span>
            <span id="cb348-12"><a href="#cb348-12" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;uuid&quot;</span></span>
            <span id="cb348-13"><a href="#cb348-13" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;alexandria&quot;</span>)</span>
            <span id="cb348-14"><a href="#cb348-14" aria-hidden="true" tabindex="-1"></a>  :components ((:file <span class="st">&quot;src/core&quot;</span> :depends-on (<span class="st">&quot;core-components&quot;</span>))</span>
            <span id="cb348-15"><a href="#cb348-15" aria-hidden="true" tabindex="-1"></a>               (:module <span class="st">&quot;core-components&quot;</span></span>
            <span id="cb348-16"><a href="#cb348-16" aria-hidden="true" tabindex="-1"></a>                :pathname <span class="st">&quot;src/core&quot;</span></span>
            <span id="cb348-17"><a href="#cb348-17" aria-hidden="true" tabindex="-1"></a>                :components</span>
            <span id="cb348-18"><a href="#cb348-18" aria-hidden="true" tabindex="-1"></a>                ((:file <span class="st">&quot;dao&quot;</span> :depends-on (<span class="st">&quot;dao-components&quot;</span>))</span>
            <span id="cb348-19"><a href="#cb348-19" aria-hidden="true" tabindex="-1"></a>                 (:module <span class="st">&quot;dao-components&quot;</span></span>
            <span id="cb348-20"><a href="#cb348-20" aria-hidden="true" tabindex="-1"></a>                  :pathname <span class="st">&quot;dao&quot;</span></span>
            <span id="cb348-21"><a href="#cb348-21" aria-hidden="true" tabindex="-1"></a>                  :depends-on (<span class="st">&quot;connection&quot;</span> <span class="st">&quot;class&quot;</span> <span class="st">&quot;db&quot;</span> <span class="st">&quot;conversion&quot;</span> <span class="st">&quot;logger&quot;</span> <span class="st">&quot;util&quot;</span>)</span>
            <span id="cb348-22"><a href="#cb348-22" aria-hidden="true" tabindex="-1"></a>                  :components</span>
            <span id="cb348-23"><a href="#cb348-23" aria-hidden="true" tabindex="-1"></a>                  ((:file <span class="st">&quot;table&quot;</span> :depends-on (<span class="st">&quot;column&quot;</span> <span class="st">&quot;mixin&quot;</span> <span class="st">&quot;view&quot;</span>))</span>
            <span id="cb348-24"><a href="#cb348-24" aria-hidden="true" tabindex="-1"></a>                   (:file <span class="st">&quot;view&quot;</span> :depends-on (<span class="st">&quot;column&quot;</span>))</span>
            <span id="cb348-25"><a href="#cb348-25" aria-hidden="true" tabindex="-1"></a>                   (:file <span class="st">&quot;mixin&quot;</span> :depends-on (<span class="st">&quot;column&quot;</span>))</span>
            <span id="cb348-26"><a href="#cb348-26" aria-hidden="true" tabindex="-1"></a>                   (:file <span class="st">&quot;column&quot;</span>)))</span>
            <span id="cb348-27"><a href="#cb348-27" aria-hidden="true" tabindex="-1"></a>                 (:file <span class="st">&quot;class&quot;</span> :depends-on (<span class="st">&quot;class-components&quot;</span>))</span>
            <span id="cb348-28"><a href="#cb348-28" aria-hidden="true" tabindex="-1"></a>                 (:module <span class="st">&quot;class-components&quot;</span></span>
            <span id="cb348-29"><a href="#cb348-29" aria-hidden="true" tabindex="-1"></a>                  :pathname <span class="st">&quot;class&quot;</span></span>
            <span id="cb348-30"><a href="#cb348-30" aria-hidden="true" tabindex="-1"></a>                  :depends-on (<span class="st">&quot;error&quot;</span> <span class="st">&quot;util&quot;</span>)</span>
            <span id="cb348-31"><a href="#cb348-31" aria-hidden="true" tabindex="-1"></a>                  :components</span>
            <span id="cb348-32"><a href="#cb348-32" aria-hidden="true" tabindex="-1"></a>                  ((:file <span class="st">&quot;table&quot;</span> :depends-on (<span class="st">&quot;column&quot;</span>))</span>
            <span id="cb348-33"><a href="#cb348-33" aria-hidden="true" tabindex="-1"></a>                   (:file <span class="st">&quot;column&quot;</span>)))</span>
            <span id="cb348-34"><a href="#cb348-34" aria-hidden="true" tabindex="-1"></a>                 (:file <span class="st">&quot;connection&quot;</span> :depends-on (<span class="st">&quot;error&quot;</span>))</span>
            <span id="cb348-35"><a href="#cb348-35" aria-hidden="true" tabindex="-1"></a>                 (:file <span class="st">&quot;type&quot;</span> :depends-on (<span class="st">&quot;db&quot;</span>))</span>
            <span id="cb348-36"><a href="#cb348-36" aria-hidden="true" tabindex="-1"></a>                 (:file <span class="st">&quot;db&quot;</span> :depends-on (<span class="st">&quot;db-drivers&quot;</span> <span class="st">&quot;connection&quot;</span> <span class="st">&quot;class&quot;</span> <span class="st">&quot;util&quot;</span>))</span>
            <span id="cb348-37"><a href="#cb348-37" aria-hidden="true" tabindex="-1"></a>                 (:module <span class="st">&quot;db-drivers&quot;</span></span>
            <span id="cb348-38"><a href="#cb348-38" aria-hidden="true" tabindex="-1"></a>                  :pathname <span class="st">&quot;db&quot;</span></span>
            <span id="cb348-39"><a href="#cb348-39" aria-hidden="true" tabindex="-1"></a>                  :depends-on (<span class="st">&quot;logger&quot;</span> <span class="st">&quot;util&quot;</span>)</span>
            <span id="cb348-40"><a href="#cb348-40" aria-hidden="true" tabindex="-1"></a>                  :components</span>
            <span id="cb348-41"><a href="#cb348-41" aria-hidden="true" tabindex="-1"></a>                  ((:file <span class="st">&quot;mysql&quot;</span>)</span>
            <span id="cb348-42"><a href="#cb348-42" aria-hidden="true" tabindex="-1"></a>                   (:file <span class="st">&quot;postgres&quot;</span>)</span>
            <span id="cb348-43"><a href="#cb348-43" aria-hidden="true" tabindex="-1"></a>                   (:file <span class="st">&quot;sqlite3&quot;</span>)))</span>
            <span id="cb348-44"><a href="#cb348-44" aria-hidden="true" tabindex="-1"></a>                 (:file <span class="st">&quot;conversion&quot;</span>)</span>
            <span id="cb348-45"><a href="#cb348-45" aria-hidden="true" tabindex="-1"></a>                 (:file <span class="st">&quot;logger&quot;</span>)</span>
            <span id="cb348-46"><a href="#cb348-46" aria-hidden="true" tabindex="-1"></a>                 (:file <span class="st">&quot;error&quot;</span>)</span>
            <span id="cb348-47"><a href="#cb348-47" aria-hidden="true" tabindex="-1"></a>                 (:file <span class="st">&quot;util&quot;</span>)))))</span></code></pre></div>
        <p>Now we see some third-party systems in the <code class="verbatim">:depends-on</code> list. What's more interesting here is the definition in <code class="verbatim">:components</code>: Many of the files use <code class="verbatim">:depends-on</code> as well, pointing to other files within the system. We don't see <code class="verbatim">:serial t</code> here, either. Instead of a linear dependency tree, we have a graph. In the <code class="verbatim">hunchentoot</code> system, we saw that the more minor, prerequisite files like <code class="verbatim">packages.lisp</code> came <em>first</em>. Here in the <code class="verbatim">mito-core</code> system, the major files are listed first, with their prerequisites coming later in the list. The order is inverted.</p>
        <p>Let's take a look inside <code class="verbatim">src/mito.lisp</code> (the only component in the <code class="verbatim">mito.asd</code> file above):</p>
        <div class="sourceCode" id="cb349" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a>(uiop:define-package #:mito</span>
            <span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb349-3"><a href="#cb349-3" aria-hidden="true" tabindex="-1"></a>  (:use-reexport #:mito.core</span>
            <span id="cb349-4"><a href="#cb349-4" aria-hidden="true" tabindex="-1"></a>                 #:mito.migration))</span>
            <span id="cb349-5"><a href="#cb349-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:mito)</span></code></pre></div>
        <p>Instead of <code class="verbatim">defpackage</code>, Mito uses UIOP's <code class="verbatim">define-package</code> macro. It uses it because it provides a new option, <code class="verbatim">:use-reexport</code>. It's like <code class="verbatim">:use</code>, but with two important differences:</p>
        <ol class="incremental">
            <li>It will import all of the <em>exported</em> symbols of the packages that are passed as arguments, and then <em>reexport them</em>.</li>
            <li>If there is a naming conflict between symbols in the packages passed in the form, <em>the first one takes precedence</em>, shadowing versions that come later. That means that if there is a <code class="verbatim">mito.core:cool-symbol</code> and a <code class="verbatim">mito.migration:cool-symbol</code>, because <code class="verbatim">mito.core</code> comes first in the above definition, the <code class="verbatim">mito</code> package with inherit <code class="verbatim">mito.core:cool-symbol</code> and then that version will be reexported.</li>
        </ol>
        <p>In systems like Mito, the <code class="verbatim">reexport</code> options (<code class="verbatim">:reexport</code>, <code class="verbatim">:use-reexport</code>, and <code class="verbatim">:mix-reexport</code>) are used to help easily "bubble up" exports from peripheral packages into one final public API.</p>
        <p>However, although Mito bubbles up dependencies with <code class="verbatim">:depends-on</code>, using the One Package Per File Strategy doesn't preclude using <code class="verbatim">:serial t</code>, either.</p>
        <h3 id="ad0a0ba7-ad2f-4dbd-a4e4-4e37daeb817b">One System Per Package</h3>
        <p>There is one other strategy worth noting. It's perhaps best represented by the <code class="verbatim">utopian</code> web framework. Let's take a look at its system definition:</p>
        <div class="sourceCode" id="cb350" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a>(defsystem <span class="st">&quot;utopian&quot;</span></span>
            <span id="cb350-2"><a href="#cb350-2" aria-hidden="true" tabindex="-1"></a>  :class :package-inferred-system</span>
            <span id="cb350-3"><a href="#cb350-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">:version</span> <span class="st">&quot;0.9.1&quot;</span></span>
            <span id="cb350-4"><a href="#cb350-4" aria-hidden="true" tabindex="-1"></a>  :author <span class="st">&quot;Eitaro Fukamachi&quot;</span></span>
            <span id="cb350-5"><a href="#cb350-5" aria-hidden="true" tabindex="-1"></a>  :license <span class="st">&quot;LLGPL&quot;</span></span>
            <span id="cb350-6"><a href="#cb350-6" aria-hidden="true" tabindex="-1"></a>  :description <span class="st">&quot;Web application framework&quot;</span></span>
            <span id="cb350-7"><a href="#cb350-7" aria-hidden="true" tabindex="-1"></a>  :pathname <span class="st">&quot;src&quot;</span></span>
            <span id="cb350-8"><a href="#cb350-8" aria-hidden="true" tabindex="-1"></a>  :depends-on (<span class="st">&quot;utopian/main&quot;</span>)</span>
            <span id="cb350-9"><a href="#cb350-9" aria-hidden="true" tabindex="-1"></a>  :in-order-to ((test-op (test-op <span class="st">&quot;utopian-tests&quot;</span>))))</span>
            <span id="cb350-10"><a href="#cb350-10" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb350-11"><a href="#cb350-11" aria-hidden="true" tabindex="-1"></a>(register-system-packages <span class="st">&quot;lack-component&quot;</span> &#39;(#:lack.component))</span>
            <span id="cb350-12"><a href="#cb350-12" aria-hidden="true" tabindex="-1"></a>(register-system-packages <span class="st">&quot;lack-request&quot;</span> &#39;(#:lack.request))</span>
            <span id="cb350-13"><a href="#cb350-13" aria-hidden="true" tabindex="-1"></a>(register-system-packages <span class="st">&quot;lack-response&quot;</span> &#39;(#:lack.response))</span>
            <span id="cb350-14"><a href="#cb350-14" aria-hidden="true" tabindex="-1"></a>(register-system-packages <span class="st">&quot;mystic&quot;</span> &#39;(#:mystic.util))</span>
            <span id="cb350-15"><a href="#cb350-15" aria-hidden="true" tabindex="-1"></a>(register-system-packages <span class="st">&quot;mystic-file-mixin&quot;</span> &#39;(#:mystic.template.file))</span></code></pre></div>
        <p>The first thing you'll notice is that the definition is short. The dependencies only include…another file in the system? And there are no <code class="verbatim">:components</code>! To investigate, let's look in the "utopian/main"… file? Package? System?</p>
        <p>It's found in <code class="verbatim">src/main.lisp</code>:</p>
        <div class="sourceCode" id="cb351" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a>(uiop:define-package #:utopian</span>
            <span id="cb351-2"><a href="#cb351-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:nicknames</span> #:utopian/main)</span>
            <span id="cb351-3"><a href="#cb351-3" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb351-4"><a href="#cb351-4" aria-hidden="true" tabindex="-1"></a>  (:mix-reexport #:utopian/routes</span>
            <span id="cb351-5"><a href="#cb351-5" aria-hidden="true" tabindex="-1"></a>                 #:utopian/views</span>
            <span id="cb351-6"><a href="#cb351-6" aria-hidden="true" tabindex="-1"></a>                 #:utopian/context</span>
            <span id="cb351-7"><a href="#cb351-7" aria-hidden="true" tabindex="-1"></a>                 #:utopian/app</span>
            <span id="cb351-8"><a href="#cb351-8" aria-hidden="true" tabindex="-1"></a>                 #:utopian/config</span>
            <span id="cb351-9"><a href="#cb351-9" aria-hidden="true" tabindex="-1"></a>                 #:utopian/exceptions))</span>
            <span id="cb351-10"><a href="#cb351-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:utopian)</span></code></pre></div>
        <p>We already saw <code class="verbatim">:nicknames</code> in the Hunchentoot <code class="verbatim">packages.lisp</code> file. <code class="verbatim">:mix-reexport</code> is like <code class="verbatim">:use-reexport</code> that we saw in Mito, except that it will inherit <em>all</em> symbols, exported and not, from the packages that follow into the current package. Every single symbol from those six packages above are going to be inherited into the <code class="verbatim">#:utopian</code> package.</p>
        <p>But now you may be wondering, "How do they get loaded if the system file doesn't list them in <code class="verbatim">:components</code>?"</p>
        <p>That's not all, friends. The mystery deepens when we look in the <code class="verbatim">utopian/routes</code> package file:</p>
        <div class="sourceCode" id="cb352" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:utopian/routes</span>
            <span id="cb352-2"><a href="#cb352-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb352-3"><a href="#cb352-3" aria-hidden="true" tabindex="-1"></a>  (:import-from #:utopian/context</span>
            <span id="cb352-4"><a href="#cb352-4" aria-hidden="true" tabindex="-1"></a>                #:*request*</span>
            <span id="cb352-5"><a href="#cb352-5" aria-hidden="true" tabindex="-1"></a>                #:*response*)</span>
            <span id="cb352-6"><a href="#cb352-6" aria-hidden="true" tabindex="-1"></a>  (:import-from #:utopian/file-loader</span>
            <span id="cb352-7"><a href="#cb352-7" aria-hidden="true" tabindex="-1"></a>                #:intern-rule)</span>
            <span id="cb352-8"><a href="#cb352-8" aria-hidden="true" tabindex="-1"></a>  (:import-from #:myway</span>
            <span id="cb352-9"><a href="#cb352-9" aria-hidden="true" tabindex="-1"></a>                #:make-mapper</span>
            <span id="cb352-10"><a href="#cb352-10" aria-hidden="true" tabindex="-1"></a>                #:connect</span>
            <span id="cb352-11"><a href="#cb352-11" aria-hidden="true" tabindex="-1"></a>                #:next-route)</span>
            <span id="cb352-12"><a href="#cb352-12" aria-hidden="true" tabindex="-1"></a>  (:import-from #:lack.request</span>
            <span id="cb352-13"><a href="#cb352-13" aria-hidden="true" tabindex="-1"></a>                #:request-parameters)</span>
            <span id="cb352-14"><a href="#cb352-14" aria-hidden="true" tabindex="-1"></a>  (:export #:defroutes</span>
            <span id="cb352-15"><a href="#cb352-15" aria-hidden="true" tabindex="-1"></a>           #:routes</span>
            <span id="cb352-16"><a href="#cb352-16" aria-hidden="true" tabindex="-1"></a>           #:routes-mapper</span>
            <span id="cb352-17"><a href="#cb352-17" aria-hidden="true" tabindex="-1"></a>           #:routes-controllers-directory</span>
            <span id="cb352-18"><a href="#cb352-18" aria-hidden="true" tabindex="-1"></a>           #:route</span>
            <span id="cb352-19"><a href="#cb352-19" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb352-20"><a href="#cb352-20" aria-hidden="true" tabindex="-1"></a>           <span class="co">;; from MyWay</span></span>
            <span id="cb352-21"><a href="#cb352-21" aria-hidden="true" tabindex="-1"></a>           #:next-route))</span>
            <span id="cb352-22"><a href="#cb352-22" aria-hidden="true" tabindex="-1"></a><span class="co">;; ...</span></span></code></pre></div>
        <p>Wait, there is a third-party library–<code class="verbatim">myway</code>–imported in this package! That wasn't in the system definition!</p>
        <p>Actually, it is. Look again. See this line?</p>
        <div class="sourceCode" id="cb353" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a>:class :package-inferred-system</span></code></pre></div>
        <p>That one line drastically changes how packages and systems work.</p>
        <p><strong>All packages in a <code class="verbatim">:package-inferred-system</code> are treated as entire systems themselves</strong>.</p>
        <p>Package inferred systems will all have an entry-point into the system, like <code class="verbatim">:depends-on ("utopian/main")</code>. Remember: up until now, dependencies were systems. We were confused because <code class="verbatim">:utopian</code> is a <em>package</em>, not a <em>system</em>. But because of <code class="verbatim">:package-inferred-system</code>, <code class="verbatim">:utopian</code> and all of its dependent packages are treated like their own systems by ASDF! That's why the files for the rest of the project aren't listed in <code class="verbatim">:depends-on</code>: <code class="verbatim">utopian/main</code> is treated like a system, where its prerequisite packages are as well. ASDF will do the work of resolving the dependencies, hence why you don't need to list them manually. It will <code class="verbatim">load</code> prerequisite packages/systems both in the <code class="verbatim">utopian</code> project, <strong>including third-party libraries</strong>, downloading them if necessary.</p>
        <p>Package inferred systems are the Package Per File taken to its limit: System Per File.</p>
        <p>Using package inferred systems requires following a few rules which I'll demonstrate.</p>
        <div class="sourceCode" id="cb354" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a>(defsystem <span class="st">&quot;almighty&quot;</span></span>
            <span id="cb354-2"><a href="#cb354-2" aria-hidden="true" tabindex="-1"></a>  :class :package-inferred-system</span>
            <span id="cb354-3"><a href="#cb354-3" aria-hidden="true" tabindex="-1"></a>  :author <span class="st">&quot;Micah Killian&quot;</span></span>
            <span id="cb354-4"><a href="#cb354-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">:version</span> <span class="st">&quot;0.0.1&quot;</span></span>
            <span id="cb354-5"><a href="#cb354-5" aria-hidden="true" tabindex="-1"></a>  :description <span class="st">&quot;A system for demonstrating how to define systems.&quot;</span></span>
            <span id="cb354-6"><a href="#cb354-6" aria-hidden="true" tabindex="-1"></a>  :pathname <span class="st">&quot;src&quot;</span></span>
            <span id="cb354-7"><a href="#cb354-7" aria-hidden="true" tabindex="-1"></a>  :depends-on (<span class="st">&quot;almighty/main&quot;</span>))</span></code></pre></div>
        <p>Notice here that the system is named <code class="verbatim">almighty</code>, and that the package/system in <code class="verbatim">:depends-on</code> begins with <code class="verbatim">almighty</code>. The entry-point and all subsequent packages in your package-inferred-system must begin with <code class="verbatim">almighty</code>.</p>
        <p>Notice also that <code class="verbatim">:pathname</code> is set. The tree view of this project looks like this:</p>
        <div class="sourceCode" id="cb355" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a>.</span>
            <span id="cb355-2"><a href="#cb355-2" aria-hidden="true" tabindex="-1"></a>├── almighty.asd</span>
            <span id="cb355-3"><a href="#cb355-3" aria-hidden="true" tabindex="-1"></a>└── src</span>
            <span id="cb355-4"><a href="#cb355-4" aria-hidden="true" tabindex="-1"></a>    ├── config.<span class="kw">lisp</span></span>
            <span id="cb355-5"><a href="#cb355-5" aria-hidden="true" tabindex="-1"></a>    ├── db.<span class="kw">lisp</span></span>
            <span id="cb355-6"><a href="#cb355-6" aria-hidden="true" tabindex="-1"></a>    ├── main.<span class="kw">lisp</span></span>
            <span id="cb355-7"><a href="#cb355-7" aria-hidden="true" tabindex="-1"></a>    └── models</span>
            <span id="cb355-8"><a href="#cb355-8" aria-hidden="true" tabindex="-1"></a>        └── person.<span class="kw">lisp</span></span></code></pre></div>
        <p>And the files look like this:</p>
        <div class="sourceCode" id="cb356" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; src/main.lisp</span></span>
            <span id="cb356-2"><a href="#cb356-2" aria-hidden="true" tabindex="-1"></a>(uiop:define-package #:almighty</span>
            <span id="cb356-3"><a href="#cb356-3" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb356-4"><a href="#cb356-4" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:nicknames</span> #:almighty/main)</span>
            <span id="cb356-5"><a href="#cb356-5" aria-hidden="true" tabindex="-1"></a>  (:use-reexport #:almighty/config</span>
            <span id="cb356-6"><a href="#cb356-6" aria-hidden="true" tabindex="-1"></a>                 #:almighty/db</span>
            <span id="cb356-7"><a href="#cb356-7" aria-hidden="true" tabindex="-1"></a>                 #:almighty/models/person))</span>
            <span id="cb356-8"><a href="#cb356-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:almighty)</span>
            <span id="cb356-9"><a href="#cb356-9" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb356-10"><a href="#cb356-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; src/db.lisp</span></span>
            <span id="cb356-11"><a href="#cb356-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:almighty/db</span>
            <span id="cb356-12"><a href="#cb356-12" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb356-13"><a href="#cb356-13" aria-hidden="true" tabindex="-1"></a>  (:export #:hello-from-db))</span>
            <span id="cb356-14"><a href="#cb356-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:almighty/db)</span>
            <span id="cb356-15"><a href="#cb356-15" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb356-16"><a href="#cb356-16" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> hello-from-db </span>()</span>
            <span id="cb356-17"><a href="#cb356-17" aria-hidden="true" tabindex="-1"></a>  :hello-from-deebee)</span>
            <span id="cb356-18"><a href="#cb356-18" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb356-19"><a href="#cb356-19" aria-hidden="true" tabindex="-1"></a><span class="co">;; src/config.lisp</span></span>
            <span id="cb356-20"><a href="#cb356-20" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:almighty/config</span>
            <span id="cb356-21"><a href="#cb356-21" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb356-22"><a href="#cb356-22" aria-hidden="true" tabindex="-1"></a>  (:export #:hello-from-config))</span>
            <span id="cb356-23"><a href="#cb356-23" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:almighty/config)</span>
            <span id="cb356-24"><a href="#cb356-24" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb356-25"><a href="#cb356-25" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> hello-from-config </span>()</span>
            <span id="cb356-26"><a href="#cb356-26" aria-hidden="true" tabindex="-1"></a>  :hello-from-config)</span>
            <span id="cb356-27"><a href="#cb356-27" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb356-28"><a href="#cb356-28" aria-hidden="true" tabindex="-1"></a><span class="co">;; src/models/person.lisp</span></span>
            <span id="cb356-29"><a href="#cb356-29" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:almighty/models/person</span>
            <span id="cb356-30"><a href="#cb356-30" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
            <span id="cb356-31"><a href="#cb356-31" aria-hidden="true" tabindex="-1"></a>  (:export</span>
            <span id="cb356-32"><a href="#cb356-32" aria-hidden="true" tabindex="-1"></a>   #:hello-person))</span>
            <span id="cb356-33"><a href="#cb356-33" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:almighty/models/person)</span>
            <span id="cb356-34"><a href="#cb356-34" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb356-35"><a href="#cb356-35" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> hello-person </span>()</span>
            <span id="cb356-36"><a href="#cb356-36" aria-hidden="true" tabindex="-1"></a>  :i-am-a-person)</span></code></pre></div>
        <p>In a PIS, The package name of a system begins with the system name, <code class="verbatim">almighty</code>. The part that follows is the file name, such as <code class="verbatim">almighty/db</code> for <code class="verbatim">src/db.lisp</code>. If a package's file is in a subdirectory, the name of the directory comes before the file name, as in <code class="verbatim">almighty/models/person</code> for <code class="verbatim">src/models/person.lisp</code>.</p>
        <p>If you don't follow these rules, ASDF won't be able to find the files. For example, if you have a file <code class="verbatim">src/wrong-name.lisp</code> that defines a package <code class="verbatim">almighty/correct-name</code> and try to <code class="verbatim">:import-from</code>, <code class="verbatim">:use-reexport</code>, etc. the package <code class="verbatim">almighty/correct-name</code> in another package like <code class="verbatim">almighty/db</code>, you will receive an error stating:</p>
        <pre class="example"><code>Unknown location:
  error:
    Component &quot;almighty/correct-name&quot; not found, required by
    #&lt;PACKAGE-INFERRED-SYSTEM &quot;almighty/db&quot;&gt;

Compilation failed.
        </code></pre>
        <p>With the exceptions of the different system definition and file and package naming conventions imposed by them, PIS are the same as the One Package Per File Strategy above.</p>
        <h2 id="c4e91255-4042-4978-b97b-4be1da07c166">The Great Debate: Package &amp; System Best Practices</h2>
        <p>As a newcomer to Lisp, you might want to be able to fit in with the broader ecosystem. You want to learn the idioms and patterns common to Lisp users, private and professional. So even if you're a sophisticated senior who knows that "it depends" is probably the answer, you still ask the question, "Which strategy is should I choose? Which one's the best?"</p>
        <h3 id="19a19840-bbfc-47d0-8786-2261aaf08916">Argument in Favor of PIS</h3>
        <p>The architect of ASDF wrote <a href="https://github.com/fare/asdf/blob/master/doc/best_practices.md">a document</a> precisely to answer this question. Unfortunately, it leaves more questions than answers. First, it explains problems with the other strategies we've covered:</p>
        <blockquote>
            <p>When you start writing large enough systems, putting everything in one big package leads to a big mess: it's hard to find what function is defined where, or should be defined where; you invent your own symbol prefixing system to avoid name clashes; totally unrelated things end up in the same mother-of-all package; you divide your mother-of-all package into a few subpackages, but as the software keeps growing each of these packages in turn becomes too big.</p>
            <p>Meanwhile, as you grow large enough libraries, you find that you loading a big library just to use a small part of it becomes a big hassle, leading to code bloat, too much recompilation, too much re-testing, and not enough understanding of what's going on.</p>
        </blockquote>
        <p>So the problems with the Mother Of All Package Strategy are:</p>
        <ol class="incremental">
            <li>Naming conflicts.</li>
            <li>Hard to understand.</li>
            <li>A hassle to load and recompile.</li>
        </ol>
        <p>We saw with Hunchentoot that "shadowing" of symbols was a little hard to understand, yet appears to be the solution to naming conflicts in a project factored as it is. If you have files using symbol names found in other files in project, it can be hard to understand which symbol's value is the <em>actual</em> value used in the overall package. Thus, you namespace using some sort of naming convention.</p>
        <p>Additionally, you might try dividing into some sub-packages, but it's somewhat arbitrary, meaning developers have to come up with their own coding conventions regarding package management. Whether you use one package or multiple, if your system is large enough, those strategies will ultimately cause trouble.</p>
        <p>After explaining how Package Inferred Systems work, he explains how they solve the above problems:</p>
        <blockquote>
            <p>This allows for large modular libraries, wherein you may use one file, and only that file and its transitive dependencies will be loaded, rather than the entire humongous library.</p>
            <p>This also helps you enforce a discipline wherein it is always clear in which file each symbol is defined, which files have symbols used by any other file, etc.</p>
        </blockquote>
        <p>In <a href="https://x.com/killian_arts/status/1938416300826759368?s=20">a discussion I had with the author on X</a>, our friend François-René Rideau (or <a href="https://github.com/fare">fare on Github</a>), I asked about the rationale behind PIS, why it is the best practice, etc. He said that the motivation to create PIS was to help large teams, but he also said that PIS can be useful for individuals with large or ambitious projects. He said that large .asd files (remember Mito's system?) tend to be error-prone. Further, he says,</p>
        <blockquote>
            <p>[In large .asd files] you often leave a lot of obsolete dependencies that slow the build and the understanding of the code by newcomers.</p>
        </blockquote>
        <p>So large system definitions are scary to mess with, making it safer and therefore more likely for teams to leave unused dependencies in the system. That can make understanding the code more difficult, and make builds unnecessarily slower.</p>
        <p>While ultimately he didn't make a conclusive recommendation to use PIS, he appears to prefer using PIS from the beginning to improve modularity and understandability of code, and to make coordination with other developers easier.</p>
        <h3 id="569b0865-6f06-492e-b290-3ebf596f68cc">Arguments Against PIS</h3>
        <p>So the argument in favor of Package Inferred Systems boils down to this:</p>
        <ol class="incremental">
            <li>It helps reduce problems of coordination with other developers.</li>
            <li>It helps make the code more understandable.</li>
            <li>It helps reduce the amount of unnecessary code that remains in the project.</li>
        </ol>
        <p>The question is: Does it really do all those things? And are PIS more effective than the alternatives?</p>
        <p>Understanding packages and systems is one of the more challenging things about learning Common Lisp for newcomers. That's why I've gone into more detail here on the subject than I have with other language features.</p>
        <p>Before I make my counter-argument to PIS, I must emphasize that I have no professional experience with Common Lisp, nor have I written any large projects with it. Fare, on the other hand, is an accomplished Lisper with experience writing Lisp in large teams. The odds that I am not understanding the benefits of PIS because of a lack of experience are astronomically high. I make my counter-arguments with fear and trepidation in my heart. All I have to guide me are my small brain and an intuition–as limited as it may be–about how simple programs and programming should be.</p>
        <p>My experience of package inferred systems is that they actually led to <em>more</em> confusion, not less. Perhaps you felt it too as we took our journey through these different strategies.</p>
        <p>Hunchentoot listed all third-party dependencies in the system definition–thus you had a sense of what code you needed to download, and what your potential exposure to bugs or security problems was. The <code class="verbatim">defsystem</code> used the <code class="verbatim">:serial t</code> option to let you, the newcomer, know that all of the <code class="verbatim">:component</code> files were loaded in the order they were listed. The Mother Of All <code class="verbatim">packages.lisp</code> gave us an easy to read overview of the public API. Without any sophisticated knowledge or tools, the code was understandable (with perhaps the exception of the use of <code class="verbatim">:shadow</code> for a couple of symbols).</p>
        <p>Was it always that way? How many challenges did the project have with coordination or understandability before it reached the point where we saw it? How much unseen discipline was practiced in the naming and organization of symbols in the project? For example, perhaps it was difficult to organize and line up the files in the <code class="verbatim">defsystem</code> definition so that all of the right code was loaded in the correct order? Is the project bloated? We see only a snapshot of the project as it is now. We can't know the challenges of coordination, dependency management, and code factoring that had to be overcome just from looking at the source.</p>
        <p>However, when we look at the source, the design of the system is undeniably <em>simple</em> and <em>easy to understand</em>, even for a dummy newcomer like me.</p>
        <p>The same is true of the <code class="verbatim">vend</code> library, which uses a similar strategy.</p>
        <p><code class="verbatim">mito</code>, on the other hand, has a somewhat more difficult to follow <code class="verbatim">defsystem</code>: the liberal use of <code class="verbatim">:depends-on</code> and the inversion of the dependency tree makes the system definition much more difficult to follow. The system has several subsystems, and some of the packages use options like <code class="verbatim">:use-reexport</code> and so-on. You need to have a deeper understanding of how systems work, how shadowing works, and how those package options will effect the final shape of the system. While Hunchentoot was fairly transparent, Mito's system architecture introduced a fair bit of noisy abstractions that make reasoning about the system difficult at a glance.</p>
        <p>But perhaps with experience I would see the value in the abstractions? Perhaps the alternative would have been noisier, more difficult to extend with other developers, and more bloated?</p>
        <p>And then there's <code class="verbatim">utopian</code> and <code class="verbatim">:package-inferred-system</code>. The .asd file is small, but that just left us more questions than answers. Chief among them is: how many dependencies does it have, and where do they come from? What does the final public API actually look like after all subsystem symbols are bubbled up to the top system? What code is loaded (and potentially executed), and when?</p>
        <p>About API discoverability, Fare said the following in our discussion on X:</p>
        <blockquote>
            <p>The SLIME REPL, not the unaided source code, is how you discover the code. Plus the generated documentation.</p>
        </blockquote>
        <p>This is an important point: Great tools can make a developer's job easier. That's why one of the goals of this book is to help you understand all of the tools available to you in Emacs. If you code Common Lisp in Emacs without knowing about window management, REPL shortcuts, SLY debugger restarts/keybindings, <code class="verbatim">evil-mode</code> VIM keybindings, etc. you are missing out on a great number of very powerful tools for efficient and pleasant coding.</p>
        <p>However, I disagree with Fare about how code is discovered. Yes, we can type <code class="verbatim">SPC m g d</code> or <code class="verbatim">g d</code> to use <code class="verbatim">sly-edit-definition</code> to go to the definition of some symbol. Yes, we can look at the documentation. But none of those provide a clear overview of third-party dependencies of the project nor a clear view of the shape of the system as a whole. Tools like PIS blur our vision of the whole system. When I look at projects that use those tools, every bone in my body screams, "Complexity spirit demon."</p>
        <p>Unfortunately, I am not the only one that feels this way. Do a search for "package-inferred-system" on X and you'll find a lot of confusion or even distaste for it.</p>
        <p>Still, there are some notable people that really enjoy it. The most well-known users are probably the <a href="https://github.com/fukamachi/">Eitaro Fukamachi (<span>https://github.com/fukamachi</span>)</a> (author of <code class="verbatim">mito</code> and many other libraries) and <a href="https://github.com/svetlyak40wt">Alexander Artemenko (<span>https://github.com/svetlyak40wt</span>)</a>–the man behind <a href="https://github.com/40ants">40ants (<span>https://github.com/40ants</span>)</a> and Ultralisp–both of whom are prolific giants in the Common Lisp community (I think I'm starting to sweat here). Alexander has explained why he likes PIS <a href="https://x.com/svetlyak40wt/status/1179260459255549952?s=20">on X</a>:</p>
        <blockquote>
            <p>For me this more important consequence is that I have not to figure out dependencies between files anymore and to hardcode them in the *.asd files. System definition can be just: (defsystem "foo" :class :package-inferred-system :depends-on ("foo/main"))</p>
        </blockquote>
        <p>This echos what Fare says about system understandability and ease of code factoring. So maybe there is something to the arguments about the challenges of factoring that standard <code class="verbatim">defsystem</code> definitions impose.</p>
        <p>My brain may not be big enough to understand the ease-of-use and ease-of-understanding arguments. There's a good chance it's a skill issue.</p>
        <p>However, there is one feature of PIS that unfortunately I can't forgive, no matter how small my brain.</p>
        <p>The fact that third-party dependencies are not defined in the .asd file, but instead are spread across the codebase, is simply not acceptable. As an Almighty Lisp programmer, dependency management needs to be crystal clear both for understanding and for containment. Package inferred systems simply make it too easy to introduce dependencies in unknown places. My goal is the keep my use of dependencies limited, decreasing my dependencies over time. If it's easy to add and forget about them, then the temptation to increase my dependencies will be too great.</p>
        <p>The community doesn't appear to view PIS as the way forward. Community adoption of PIS is very low. Package inferred systems have been around since 2014, more than 10 years ago. At present, while there are nearly 5000 systems available on the Quicklisp repository, only around 60 unique systems use <code class="verbatim">:package-inferred-system</code>.</p>
        <p>LEM–an Emacs clone written from scratch in Common Lisp–and Coalton–a new Lisp language implementing a Haskell-like type system–are among the largest and most ambitious publicly available projects. Neither use PIS. Both use the <code class="verbatim">:serial t</code> option for the <code class="verbatim">:components</code>, manually listing dependencies and files to load from the project. Both make heavy use of the One Package Per File Strategy, but LEM also uses a hybrid Mother Of All Package. Coalton provides a public API in a <code class="verbatim">package.lisp</code> file! In fact, Coalton uses a strategy similar to Fare's <code class="verbatim">LIL</code> library–providing a <code class="verbatim">package.lisp</code> file for smaller "modules" in the system (modules by convention) and reexporting the symbols from the module files, allowing the system to bubble up symbols to the top level packages.</p>
        <h3 id="0de8a5a6-38df-43a6-b667-ef3111bf1777">Conclusion</h3>
        <p>So to answer the question, "Is it essential to learn and use package inferred systems?", the answer is <strong>No</strong>. For small projects, a Mother Of All package can work fine, but the most common approach on modern projects by far is One Package Per File with some strategy for bubbling up and potentially listing exported symbols into a final API.</p>
        <h1 id="c77ac05f-439c-43aa-97e9-dd2132d3cc06">THE ECOSYSTEM</h1>
        <h2 id="e2c5ced2-4b10-4dbb-b10f-5e347192b818">QUICKLISP</h2>
        <p>There is a surprising amount of open source code available for Lisp. The most common way to obtain it is through <code class="verbatim">quicklisp</code>, the defacto-standard library manager for Lisp. As I said before, ASDF by default uses quicklisp to download systems defined in the <code class="verbatim">:depends-on</code> portion of the <code class="verbatim">defsystem</code> if no local copy exists (in the <code class="verbatim">~/quicklisp</code> folder). When you want third-party libraries, you will likely begin by using quicklisp.</p>
        <h3 id="4fcd1518-a62a-41b6-ab5f-1f781fbda52a">Using Quicklisp</h3>
        <p>Using quicklisp is simple. Let's say you want to load the <code class="verbatim">local-time</code> system. To do that:</p>
        <div class="sourceCode" id="cb358" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a>(ql:quickload <span class="st">&quot;local-time&quot;</span>)</span></code></pre></div>
        <p>If you don't already have <code class="verbatim">local-time</code> in your <code class="verbatim">~/quicklisp</code> folder, quicklisp will download it from the quicklisp repository. After downloading it, it will then load the system as if you had run <code class="verbatim">asdf:load-system</code>. To text it, try running <code class="verbatim">(local-time:now)</code> in the REPL.</p>
        <h3 id="2401f0fd-e686-4c08-af6d-045998b2f6e6">Local Code</h3>
        <p>Quicklisp will download and load code from the <code class="verbatim">quicklisp</code> "dist". What if you want to load your own local code? How do you create your own library that you can add to a <code class="verbatim">.asd</code> file and load seamlessly like any other library?</p>
        <p>To do that with Quicklisp, you can add code to either the <code class="verbatim">~/common-lisp</code> or <code class="verbatim">~/quicklisp/local-projects</code> folders.</p>
        <p>I've personally had trouble with Quicklisp loading code from these folders, rather than the code I've vendored (using <code class="verbatim">vend</code>, introduced below). As a result, I don't like using either of these folders, but you might have better results than I did.</p>
        <h2 id="7294a3d4-913d-4f4e-bd6f-33cbc750db46">ULTRALISP</h2>
        <p>Quicklisp is a repository that is only infrequently updated (by one guy). As a result, you might not be able to get the latest version of a project, or it may never be available at all on Quicklisp.</p>
        <p>An alternative to Quicklisp is <code class="verbatim">ultralisp</code>. Ultralisp is a "dist" that is installed on Quicklisp (which has its own default "dist" named <code class="verbatim">quicklisp</code>) and that is updated every five minutes. If you go to <a href="https://ultralisp.org">https://ultralisp.org</a> you can get instructions on how to install and use it. I haven't ever used it, so I can't give my opinion one way or the other.</p>
        <p>In passing, I've seen people have trouble using Ultralisp because they may inadvertently install different versions of the same library and getting Quicklisp (the library manager, not the dist) to load one or the other can be a bit troublesome. This might be similar to the problems I've had with using local code with Quicklisp as I explained above.</p>
        <h2 id="d81ec76f-90b4-474d-a881-9c07f866be69">QLOT</h2>
        <p><code class="verbatim">Qlot</code> is an alternative library dependency library, found at <a href="https://qlot.tech/">https://qlot.tech/</a>. It is designed to essentially solve "versioning" problems above. It allows you to pin your dependencies to certain versions of libraries–as found on the Quicklisp "dist".</p>
        <p>Qlot is worthy of taking a closer look at. It includes useful command-line commands and library dependencies are defined in separate <code class="verbatim">qlfile</code> and <code class="verbatim">qlfile.lock</code> files, making it feel a bit more familiar to library management systems found in other ecosystems. After getting set up, you might find it more comfortable to use than Quicklisp or Ultralisp.</p>
        <h2 id="ocicl">OCICL</h2>
        <p><code class="verbatim">ocicl</code> is another alternative to Quicklisp that does more than just package management. It also does linting and has project scaffolding capabilities. It's developed by a programmer at Red Hat. It's Github page states:</p>
        <blockquote>
            <p>The main innovation behind ocicl is the idea of applying the ecosystem of tooling and services from the world of application container images to ordinary tarballs of Lisp code. In essence, OCI + CL = ocicl.</p>
        </blockquote>
        <p>If you know what it means for software to be packaged as "OCI-compliant artifacts", you might find ocicl of interest. I'm not sophisticated enough to understand the value proposition, so I've never used it.</p>
        <h2 id="vend">VEND</h2>
        <p><code class="verbatim">vend</code> (<a href="https://github.com/fosskers/vend">https://github.com/fosskers/vend</a>) is my preferred alternative to Quicklisp. The vend philosophy is this: vendor dependencies, and make that simple.</p>
        <p>Unlike the other alternatives above, it makes no use of either Quicklisp the tool or the "dist". Instead, it downloads dependencies directly from git repositories. It has its own repository–just a list of libraries and their git repo link.</p>
        <p>The marketing copy from the <code class="verbatim">vend</code> Github readme states:</p>
        <blockquote>
            <p>Why vend?</p>
            <p>Dependency management in Common Lisp has traditionally centred around Quicklisp. A desire for access to more rapid package updates spawned Ultralisp. The need for version pinning and isolation birthed Qlot. The want for a better distribution system brought us ocicl.</p>
            <p>But, could there be a simpler paradigm than just downloading the code and putting it right there?</p>
            <p>With vend:</p>
            <p>We need not perform bespoke installation scripts to get started. We need not wait for Quicklisp to update. We need not relegate all our systems to ~/common-lisp/. We need not worry about where ASDF is looking for systems. We need not fret over tools performing strange internal overrides. We need not manage extra config files or lockfiles. Plus, vend is actually an external tool with extra commands to help you inspect and manage your dependencies.</p>
        </blockquote>
        <p>If we, as almighty developers, want to defeat the machines, we need to consciously seek ways of doing more work in fewer steps. Finding and using the simplest way to do things is a matter of survival. Vend is an important for simplifying our tech stack and empowering us to do more. That's why for projects in the next chapter, we will be using <code class="verbatim">vend</code>.</p>
        <p>I will explain how to install and use <code class="verbatim">vend</code> when it becomes necessary.</p>
        <h1 id="1e5bf4b1-f91c-4319-9c74-6fce6b9d1b78"><span class="todo TODO">TODO</span> PROJECTS</h1>
        <h2 id="5d85ea8f-5c37-4ae8-9940-59c885aff94a"><code class="verbatim">ALMIGHTY-MONEY</code></h2>
        <h3 id="c04e332a-464a-4581-b3b1-afd65b5af134">Introduction</h3>
        <p>For this project, we are going to build a simple library for dealing with money.</p>
        <p>In our library, money will be an integer with some extras. Money has a currency–USD, JPY, etc.–that both limits how mathematical operations can be conducted on it and how it is displayed. You can add 5 to 5, but you can't add 5 USD into 5 JPY directly. USD is displayed with dollars on the left of a decimal, cents on the right: $10.52. 1000 USD is displayed with a comma after the 1: $1,000. This is true of every fourth digit–counting from right to left on the dollars side. USD uses the $ sign, and it's placed at the beginning of the number.</p>
        <p>The functions that will be implemented for this library are simple: <code class="verbatim">money+</code>, <code class="verbatim">money-</code>, <code class="verbatim">money*</code>, <code class="verbatim">money/</code>, <code class="verbatim">money=</code>, <code class="verbatim">money&gt;</code>, and <code class="verbatim">money&lt;</code>. We won't be doing any currency conversion here; we just want a way to do simple math on numbers that are a little special.</p>
        <p>We will use Common Lisp's hash-tables and OOP facilities to make our library extensible: I don't know how to display whatever the currency is in India or Transylvania, but we'll make it easy for someone from there to add support for those currencies without modifying our code.</p>
        <p>The necessary functionality is basic, so our use of hash-tables and OOP will also only be the basics.</p>
        <h3 id="project-setup">Project Setup</h3>
        <p>This is going to be a simple project, requiring only one lisp file and a system file.</p>
        <ol class="incremental">
            <li><p>Make Directory &amp; Files</p>
                <p>Make a file named <code class="verbatim">almighty-money.asd</code> in a directory called <code class="verbatim">almighty-money</code>. Save that file and make another file in that same directory named <code class="verbatim">almighty-money.lisp</code>. Save that one, too. Those are the only files we'll need. Very small library.</p></li>
            <li><p>Define System</p>
                <p>In <code class="verbatim">almighty-money.asd</code>, add this code:</p>
                <div class="sourceCode" id="cb359" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a>(defsystem <span class="st">&quot;almighty-money&quot;</span></span>
                    <span id="cb359-2"><a href="#cb359-2" aria-hidden="true" tabindex="-1"></a>  :author <span class="st">&quot;Micah Killian&quot;</span></span>
                    <span id="cb359-3"><a href="#cb359-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">:version</span> <span class="st">&quot;0.0.1&quot;</span></span>
                    <span id="cb359-4"><a href="#cb359-4" aria-hidden="true" tabindex="-1"></a>  :description <span class="st">&quot;A Library for Safely Handling Money&quot;</span></span>
                    <span id="cb359-5"><a href="#cb359-5" aria-hidden="true" tabindex="-1"></a>  :components ((:file <span class="st">&quot;almighty-money&quot;</span>)))</span></code></pre></div>
                <p>The rest of the code for this project will go inside the <code class="verbatim">almighty-money.lisp</code> file.</p></li>
        </ol>
        <h3 id="6d7264ec-68ad-4ace-8634-4b657f82fad5">A <code class="verbatim">money</code> type</h3>
        <p>Let's say that we have two numbers, 5000 and 3000. We want to add those numbers, but there's a catch: we need to know that they are the same <em>type</em> of number. If we are putting $5,000 and ¥3,000 into our wallet, we want to keep them separate. 7/11 in Japan doesn't want our dollars, and 7/11 in the US doesn't want our yen, so we can't mix them all willy nilly. We need to keep them separate and treat them as two entirely different <em>types</em> of money.</p>
        <p>In Common Lisp, to create a new type, we use <code class="verbatim">defclass</code>. So let's create a <code class="verbatim">money</code> type:</p>
        <div class="sourceCode" id="cb360" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> money </span>()</span>
            <span id="cb360-2"><a href="#cb360-2" aria-hidden="true" tabindex="-1"></a>  ((amount :initarg :amount :initform <span class="dv">0</span> :accessor amount)</span>
            <span id="cb360-3"><a href="#cb360-3" aria-hidden="true" tabindex="-1"></a>   (currency-code :initarg :currency-code :initform <span class="kw">nil</span> :accessor currency-code)</span>
            <span id="cb360-4"><a href="#cb360-4" aria-hidden="true" tabindex="-1"></a>   (currency-sign :initarg :currency-sign :initform <span class="kw">nil</span> :accessor currency-sign))</span>
            <span id="cb360-5"><a href="#cb360-5" aria-hidden="true" tabindex="-1"></a>  (:documentation <span class="st">&quot;A class that holds all the information about some money. Any</span></span>
            <span id="cb360-6"><a href="#cb360-6" aria-hidden="true" tabindex="-1"></a><span class="st"> class that inherits from the MONEY class must provide a default CURRENCY-CODE</span></span>
            <span id="cb360-7"><a href="#cb360-7" aria-hidden="true" tabindex="-1"></a><span class="st"> and CURRENCY-SIGN.</span></span>
            <span id="cb360-8"><a href="#cb360-8" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb360-9"><a href="#cb360-9" aria-hidden="true" tabindex="-1"></a><span class="st">AMOUNT is an integer. Ex. 1000000. This value reflects the smallest monetary</span></span>
            <span id="cb360-10"><a href="#cb360-10" aria-hidden="true" tabindex="-1"></a><span class="st">unit for each currency. A MONEY object with AMOUNT 5000 and CURRENCY-CODE USD</span></span>
            <span id="cb360-11"><a href="#cb360-11" aria-hidden="true" tabindex="-1"></a><span class="st">means $50.00, or 5,000 cents.</span></span>
            <span id="cb360-12"><a href="#cb360-12" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb360-13"><a href="#cb360-13" aria-hidden="true" tabindex="-1"></a><span class="st">CURRENCY-CODE is a string using the ISO 4217 format. Ex. </span><span class="sc">\&quot;</span><span class="st">USD</span><span class="sc">\&quot;</span></span>
            <span id="cb360-14"><a href="#cb360-14" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb360-15"><a href="#cb360-15" aria-hidden="true" tabindex="-1"></a><span class="st">CURRENCY-SIGN is a string. It is some symbol to represent the type of money</span></span>
            <span id="cb360-16"><a href="#cb360-16" aria-hidden="true" tabindex="-1"></a><span class="st">being displayed. Ex. </span><span class="sc">\&quot;</span><span class="st">$</span><span class="sc">\&quot;</span><span class="st">&quot;</span>))</span></code></pre></div>
        <p>We could add <code class="verbatim">:type</code> specifications to each of the slots, but how the compiler enforces the types is <em>implementation dependent</em>. That means we can't be sure if, how, or under what conditions our implementation will enforce those types. <code class="verbatim">:type</code> might be useful under certain circumstances (and perhaps the mere value of defining <code class="verbatim">:type</code> as documentation is useful to you), but for now we'll keep things simple.</p>
        <p>The ~amount= slot is an integer, and it represents the smallest monetary unit for its currency. That means that 5000 USD is $50.00 and 5000 JPY is ¥5,000.</p>
        <h3 id="67f9ab15-7346-4bab-b5bf-b526e5b80df9">Making money</h3>
        <p>Now, let's try making some money:</p>
        <div class="sourceCode" id="cb361" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">make-instance</span> <span class="dt">&#39;money</span> :amount <span class="dv">4000</span> :currency-code <span class="st">&quot;USD&quot;</span> :currency-sign <span class="st">&quot;$&quot;</span>)</span>
            <span id="cb361-2"><a href="#cb361-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;MONEY {7006D80343}&gt;</span></span></code></pre></div>
        <p>We now see one of the downsides of using OOP: the representation of the <code class="verbatim">money</code> object in the REPL is unhelpful. We will fix DX problems like that later. For now, let's define a <code class="verbatim">make-money</code> function to make the code a bit less verbose:</p>
        <div class="sourceCode" id="cb362" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> make-money </span>(&amp;optional (amount <span class="dv">0</span>) (currency *default-currency*))</span>
            <span id="cb362-2"><a href="#cb362-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">assert</span> (<span class="kw">and</span> (<span class="kw">integerp</span> amount)) (amount)</span>
            <span id="cb362-3"><a href="#cb362-3" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;AMOUNT must be an integer, got ~a.&quot;</span> amount)</span>
            <span id="cb362-4"><a href="#cb362-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">etypecase</span> currency</span>
            <span id="cb362-5"><a href="#cb362-5" aria-hidden="true" tabindex="-1"></a>    (money (<span class="kw">make-instance</span> (<span class="kw">type-of</span> currency) :amount amount))</span>
            <span id="cb362-6"><a href="#cb362-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">string</span> (<span class="kw">make-instance</span> (get-registered-currency currency) :amount amount))</span>
            <span id="cb362-7"><a href="#cb362-7" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">symbol</span> (<span class="kw">make-instance</span> currency :amount amount))))</span>
            <span id="cb362-8"><a href="#cb362-8" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb362-9"><a href="#cb362-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((<span class="dv">50</span><span class="op">-</span>bucks (make-money <span class="dv">50</span>)))</span>
            <span id="cb362-10"><a href="#cb362-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">list</span> (amount <span class="dv">50</span><span class="op">-</span>bucks) (currency-code <span class="dv">50</span><span class="op">-</span>bucks) (currency-sign <span class="dv">50</span><span class="op">-</span>bucks)))</span>
            <span id="cb362-11"><a href="#cb362-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (50 &quot;USD&quot; &quot;$&quot;)</span></span></code></pre></div>
        <p>For the <code class="verbatim">currency</code> argument, <code class="verbatim">make-money</code> can take either another <code class="verbatim">money</code> object, a string like "USD", or a symbol like <code class="verbatim">'us-dollar</code>. Internally, we'll be sending <code class="verbatim">money</code> objects or using symbols, but users of the library might prefer to just use currency codes instead without importing the <code class="verbatim">defclass</code> of their desired currency everywhere they want to use <code class="verbatim">make-money</code>.</p>
        <p>Our system for registering and looking up currencies is simple: We use a hash-table to store and look up currency classes by currency code.</p>
        <div class="sourceCode" id="cb363" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *default-currency* </span><span class="st">&quot;USD&quot;</span>)</span>
            <span id="cb363-2"><a href="#cb363-2" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb363-3"><a href="#cb363-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *registered-currencies* </span>(<span class="kw">make-hash-table</span> <span class="bu">:test</span> <span class="op">#&#39;</span>equalp))</span>
            <span id="cb363-4"><a href="#cb363-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb363-5"><a href="#cb363-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> register-currency </span>(currency-code currency-class)</span>
            <span id="cb363-6"><a href="#cb363-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">setf</span> (<span class="kw">gethash</span> currency-code *registered-currencies*) currency-class))</span>
            <span id="cb363-7"><a href="#cb363-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb363-8"><a href="#cb363-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> get-registered-currency </span>(currency-code)</span>
            <span id="cb363-9"><a href="#cb363-9" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb363-10"><a href="#cb363-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">gethash</span> currency-code *registered-currencies*))</span></code></pre></div>
        <p>Let's add USD as a type:</p>
        <div class="sourceCode" id="cb364" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb364-1"><a href="#cb364-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; * USD</span></span>
            <span id="cb364-2"><a href="#cb364-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> us-dollar </span>(money)</span>
            <span id="cb364-3"><a href="#cb364-3" aria-hidden="true" tabindex="-1"></a>  ((currency-code :initform <span class="st">&quot;USD&quot;</span>)</span>
            <span id="cb364-4"><a href="#cb364-4" aria-hidden="true" tabindex="-1"></a>   (currency-sign :initform <span class="st">&quot;$&quot;</span>)))</span>
            <span id="cb364-5"><a href="#cb364-5" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb364-6"><a href="#cb364-6" aria-hidden="true" tabindex="-1"></a>(register-currency <span class="st">&quot;USD&quot;</span> <span class="dt">&#39;us-dollar</span>)</span>
            <span id="cb364-7"><a href="#cb364-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb364-8"><a href="#cb364-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> usd </span>(amount)</span>
            <span id="cb364-9"><a href="#cb364-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">assert</span> (<span class="kw">and</span> (<span class="kw">integerp</span> amount)) (amount)</span>
            <span id="cb364-10"><a href="#cb364-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;AMOUNT must be an integer, got ~a.&quot;</span> amount)</span>
            <span id="cb364-11"><a href="#cb364-11" aria-hidden="true" tabindex="-1"></a>  (make-money amount <span class="dt">&#39;us-dollar</span>))</span>
            <span id="cb364-12"><a href="#cb364-12" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb364-13"><a href="#cb364-13" aria-hidden="true" tabindex="-1"></a>(usd <span class="dv">50</span>)</span>
            <span id="cb364-14"><a href="#cb364-14" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;USD {7006D80343}&gt;</span></span></code></pre></div>
        <h3 id="b95656cb-a51b-4409-bf9e-b117341f4f92">Adding money</h3>
        <p>The core purpose of this library is this: ensure that only money of the same currency is combined or compared mathematically. That means that the implementation of the <code class="verbatim">money+</code> function is going to be simple:</p>
        <div class="sourceCode" id="cb365" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> moneyp </span>(x)</span>
            <span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">typep</span> x <span class="dt">&#39;money</span>))</span>
            <span id="cb365-3"><a href="#cb365-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb365-4"><a href="#cb365-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> currencies-match-p </span>(expected received)</span>
            <span id="cb365-5"><a href="#cb365-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">equal</span> (<span class="kw">type-of</span> expected) (<span class="kw">type-of</span> received)))</span>
            <span id="cb365-6"><a href="#cb365-6" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb365-7"><a href="#cb365-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> money+ </span>(&amp;<span class="kw">rest</span> moneys)</span>
            <span id="cb365-8"><a href="#cb365-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((expected-currency (<span class="kw">first</span> moneys)))</span>
            <span id="cb365-9"><a href="#cb365-9" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">unless</span> (moneyp expected-currency)</span>
            <span id="cb365-10"><a href="#cb365-10" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="dt">&#39;type-error</span> :expected-type <span class="dt">&#39;money</span> :datum expected-currency))</span>
            <span id="cb365-11"><a href="#cb365-11" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> ((total (amount expected-currency)))</span>
            <span id="cb365-12"><a href="#cb365-12" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">dolist</span> (current-currency (<span class="kw">rest</span> moneys))</span>
            <span id="cb365-13"><a href="#cb365-13" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">etypecase</span> current-currency</span>
            <span id="cb365-14"><a href="#cb365-14" aria-hidden="true" tabindex="-1"></a>          (money</span>
            <span id="cb365-15"><a href="#cb365-15" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">unless</span> (currencies-match-p expected-currency current-currency)</span>
            <span id="cb365-16"><a href="#cb365-16" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">error</span> <span class="dt">&#39;mismatched-currencies</span> :expected expected-currency</span>
            <span id="cb365-17"><a href="#cb365-17" aria-hidden="true" tabindex="-1"></a>                                           :received current-currency))</span>
            <span id="cb365-18"><a href="#cb365-18" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">setf</span> total (<span class="op">+</span> total (amount current-currency))))))</span>
            <span id="cb365-19"><a href="#cb365-19" aria-hidden="true" tabindex="-1"></a>      (make-money total expected-currency))))</span></code></pre></div>
        <p><code class="verbatim">money+</code> takes an arbitrary number of arguments. We check each argument with <code class="verbatim">dolist</code>: in the case where <code class="verbatim">current-currency</code> is of type <code class="verbatim">money</code> and the currencies of <code class="verbatim">expected-currency</code> and <code class="verbatim">current-currency</code> match, we add its ~amount= to <code class="verbatim">total</code>.</p>
        <p>This function only takes <code class="verbatim">money</code> objects. We try to detect non-money objects early by checking if the first argument is <code class="verbatim">moneyp</code>, but <code class="verbatim">etypecase</code> takes care of the rest.</p>
        <p>If the currencies of the expected and current currency don't match, then <code class="verbatim">money+</code> signals a <code class="verbatim">mismatched-currencies</code> condition.</p>
        <div class="sourceCode" id="cb366" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb366-1"><a href="#cb366-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">define-condition</span><span class="fu"> mismatched-currencies </span>(<span class="kw">error</span>)</span>
            <span id="cb366-2"><a href="#cb366-2" aria-hidden="true" tabindex="-1"></a>  ((expected :initarg :expected :initform <span class="kw">nil</span> :reader expected)</span>
            <span id="cb366-3"><a href="#cb366-3" aria-hidden="true" tabindex="-1"></a>   (received :initarg :received :initform <span class="kw">nil</span> :reader received))</span>
            <span id="cb366-4"><a href="#cb366-4" aria-hidden="true" tabindex="-1"></a>  (:report (<span class="kw">lambda</span> (c <span class="kw">stream</span>)</span>
            <span id="cb366-5"><a href="#cb366-5" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;Mismatched currencies. Expected ~a, received ~a.&quot;</span> (expected c) (received c)))))</span></code></pre></div>
        <p>It's not strictly necessary to make a condition. We could just use a simple <code class="verbatim">error</code>:</p>
        <div class="sourceCode" id="cb367" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">error</span> <span class="st">&quot;Mismatched currencies. Expected ~a, received ~a.&quot;</span> expected-currency current-currency)</span></code></pre></div>
        <p>Having a custom condition saves us the trouble of copying the same error in several later functions; convenient but no big deal.</p>
        <p>The real utility is allowing us (sometime later in a different library) or others (in their own application code) to act specifically on this condition. We aren't going to implement currency conversion functionality in this library, but we or others might want to be able to make a currency conversion when currencies are mismatched. Or maybe that would be a silly idea. I don't know, but I'm leaving that up to the next guy to decide. With a tiny bit of effort, I can provide myself and others that flexibility.</p>
        <h3 id="6db38ac3-4ff6-4c7c-bbdb-d7c15ed5e54d">The rest of the math functions</h3>
        <p><code class="verbatim">money-</code> is only going to look a little different:</p>
        <div class="sourceCode" id="cb368" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb368-1"><a href="#cb368-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> money- </span>(&amp;<span class="kw">rest</span> moneys)</span>
            <span id="cb368-2"><a href="#cb368-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function for subtracting the AMOUNTs of MONEY objects of the same currency. If</span></span>
            <span id="cb368-3"><a href="#cb368-3" aria-hidden="true" tabindex="-1"></a><span class="st">passed one MONEY object, will negate the AMOUNT&quot;</span></span>
            <span id="cb368-4"><a href="#cb368-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((expected-currency (<span class="kw">first</span> moneys)))</span>
            <span id="cb368-5"><a href="#cb368-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">unless</span> (moneyp expected-currency)</span>
            <span id="cb368-6"><a href="#cb368-6" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="dt">&#39;type-error</span> :expected-type <span class="dt">&#39;money</span> :datum expected-currency))</span>
            <span id="cb368-7"><a href="#cb368-7" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> ((total (amount expected-currency)))</span>
            <span id="cb368-8"><a href="#cb368-8" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">cond</span> ((<span class="op">=</span> (<span class="kw">length</span> moneys) <span class="dv">1</span>)</span>
            <span id="cb368-9"><a href="#cb368-9" aria-hidden="true" tabindex="-1"></a>             (make-money (<span class="op">-</span> (amount expected-currency)) expected-currency))</span>
            <span id="cb368-10"><a href="#cb368-10" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">t</span></span>
            <span id="cb368-11"><a href="#cb368-11" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">dolist</span> (current-currency (<span class="kw">rest</span> moneys))</span>
            <span id="cb368-12"><a href="#cb368-12" aria-hidden="true" tabindex="-1"></a>               (<span class="kw">etypecase</span> current-currency</span>
            <span id="cb368-13"><a href="#cb368-13" aria-hidden="true" tabindex="-1"></a>                 (money</span>
            <span id="cb368-14"><a href="#cb368-14" aria-hidden="true" tabindex="-1"></a>                  (<span class="kw">unless</span> (currencies-match-p expected-currency current-currency)</span>
            <span id="cb368-15"><a href="#cb368-15" aria-hidden="true" tabindex="-1"></a>                    (<span class="kw">error</span> <span class="dt">&#39;mismatched-currencies</span> :expected expected-currency</span>
            <span id="cb368-16"><a href="#cb368-16" aria-hidden="true" tabindex="-1"></a>                                                  :received current-currency))</span>
            <span id="cb368-17"><a href="#cb368-17" aria-hidden="true" tabindex="-1"></a>                  (<span class="kw">setf</span> total (<span class="op">-</span> total (amount current-currency))))))</span>
            <span id="cb368-18"><a href="#cb368-18" aria-hidden="true" tabindex="-1"></a>             (make-money total expected-currency))))))</span></code></pre></div>
        <p>The only difference here is that we check if there is more than one argument passed to <code class="verbatim">money-</code>. If you pass only one argument, then it will negate the total.</p>
        <p><code class="verbatim">money*</code> and <code class="verbatim">money/</code> are nearly the identical to each others:</p>
        <div class="sourceCode" id="cb369" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> money* </span>(&amp;<span class="kw">rest</span> moneys)</span>
            <span id="cb369-2"><a href="#cb369-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function for multiplying the amounts of MONEY objects of the same currency. If</span></span>
            <span id="cb369-3"><a href="#cb369-3" aria-hidden="true" tabindex="-1"></a><span class="st">passed an integer after the first MONEY object, will multiply the AMOUNT of the</span></span>
            <span id="cb369-4"><a href="#cb369-4" aria-hidden="true" tabindex="-1"></a><span class="st">MONEY by the integer.&quot;</span></span>
            <span id="cb369-5"><a href="#cb369-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((expected-currency (<span class="kw">first</span> moneys)))</span>
            <span id="cb369-6"><a href="#cb369-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">unless</span> (moneyp expected-currency)</span>
            <span id="cb369-7"><a href="#cb369-7" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="dt">&#39;type-error</span> :expected-type <span class="dt">&#39;money</span> :datum expected-currency))</span>
            <span id="cb369-8"><a href="#cb369-8" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> ((total (amount expected-currency)))</span>
            <span id="cb369-9"><a href="#cb369-9" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">dolist</span> (current-currency (<span class="kw">rest</span> moneys))</span>
            <span id="cb369-10"><a href="#cb369-10" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">etypecase</span> current-currency</span>
            <span id="cb369-11"><a href="#cb369-11" aria-hidden="true" tabindex="-1"></a>          (money</span>
            <span id="cb369-12"><a href="#cb369-12" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">unless</span> (currencies-match-p expected-currency current-currency)</span>
            <span id="cb369-13"><a href="#cb369-13" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">error</span> <span class="dt">&#39;mismatched-currencies</span> :expected expected-currency</span>
            <span id="cb369-14"><a href="#cb369-14" aria-hidden="true" tabindex="-1"></a>                                           :received current-currency))</span>
            <span id="cb369-15"><a href="#cb369-15" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">setf</span> total (<span class="op">*</span> (amount current-currency) total)))</span>
            <span id="cb369-16"><a href="#cb369-16" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">integer</span> (<span class="kw">setf</span> total (<span class="kw">floor</span> (<span class="op">*</span> total current-currency))))))</span>
            <span id="cb369-17"><a href="#cb369-17" aria-hidden="true" tabindex="-1"></a>      (make-money total expected-currency))))</span>
            <span id="cb369-18"><a href="#cb369-18" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb369-19"><a href="#cb369-19" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> money/ </span>(&amp;<span class="kw">rest</span> moneys)</span>
            <span id="cb369-20"><a href="#cb369-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function for dividing the amounts of MONEY objects of the same currency. If</span></span>
            <span id="cb369-21"><a href="#cb369-21" aria-hidden="true" tabindex="-1"></a><span class="st">passed an integer after the first MONEY object, will divide the AMOUNT of the</span></span>
            <span id="cb369-22"><a href="#cb369-22" aria-hidden="true" tabindex="-1"></a><span class="st">MONEY by the integer.&quot;</span></span>
            <span id="cb369-23"><a href="#cb369-23" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((expected-currency (<span class="kw">first</span> moneys)))</span>
            <span id="cb369-24"><a href="#cb369-24" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">unless</span> (moneyp expected-currency)</span>
            <span id="cb369-25"><a href="#cb369-25" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="dt">&#39;type-error</span> :expected-type <span class="dt">&#39;money</span> :datum expected-currency))</span>
            <span id="cb369-26"><a href="#cb369-26" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> ((total (amount expected-currency)))</span>
            <span id="cb369-27"><a href="#cb369-27" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">dolist</span> (current-currency (<span class="kw">rest</span> moneys))</span>
            <span id="cb369-28"><a href="#cb369-28" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">etypecase</span> current-currency</span>
            <span id="cb369-29"><a href="#cb369-29" aria-hidden="true" tabindex="-1"></a>          (money</span>
            <span id="cb369-30"><a href="#cb369-30" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">unless</span> (currencies-match-p expected-currency current-currency)</span>
            <span id="cb369-31"><a href="#cb369-31" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">error</span> <span class="dt">&#39;mismatched-currencies</span> :expected expected-currency</span>
            <span id="cb369-32"><a href="#cb369-32" aria-hidden="true" tabindex="-1"></a>                                           :received current-currency))</span>
            <span id="cb369-33"><a href="#cb369-33" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">setf</span> total (<span class="op">/</span> total (amount current-currency))))</span>
            <span id="cb369-34"><a href="#cb369-34" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">integer</span> (<span class="kw">setf</span> total (<span class="kw">floor</span> (<span class="op">/</span> total current-currency))))))</span>
            <span id="cb369-35"><a href="#cb369-35" aria-hidden="true" tabindex="-1"></a>      (make-money total expected-currency))))</span></code></pre></div>
        <p>Here, we actually allow an integer type to be passed as an argument. It feels a bit odd to multiply currencies into each other, but it does make sense to say "double the amount of money" or "apply a 25% discount".</p>
        <p>Finally, we'll add three more simple math functions:</p>
        <div class="sourceCode" id="cb370" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb370-1"><a href="#cb370-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> money</span>= (money1 money2)</span>
            <span id="cb370-2"><a href="#cb370-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function to check if the AMOUNTs of two MONEY objects are =.&quot;</span></span>
            <span id="cb370-3"><a href="#cb370-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (moneyp money1)</span>
            <span id="cb370-4"><a href="#cb370-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="dt">&#39;type-error</span> :expected-type <span class="dt">&#39;money</span> :datum money1))</span>
            <span id="cb370-5"><a href="#cb370-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (moneyp money2)</span>
            <span id="cb370-6"><a href="#cb370-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="dt">&#39;type-error</span> :expected-type <span class="dt">&#39;money</span> :datum money2))</span>
            <span id="cb370-7"><a href="#cb370-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (currencies-match-p money1 money2)</span>
            <span id="cb370-8"><a href="#cb370-8" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="dt">&#39;mismatched-currencies</span> :expected money1</span>
            <span id="cb370-9"><a href="#cb370-9" aria-hidden="true" tabindex="-1"></a>                                  :received money2))</span>
            <span id="cb370-10"><a href="#cb370-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">and</span> (<span class="op">=</span> (amount money1) (amount money2))</span>
            <span id="cb370-11"><a href="#cb370-11" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">equal</span> (<span class="kw">type-of</span> money1) (<span class="kw">type-of</span> money2))))</span>
            <span id="cb370-12"><a href="#cb370-12" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb370-13"><a href="#cb370-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> money&gt; </span>(money1 money2)</span>
            <span id="cb370-14"><a href="#cb370-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function that checks if the AMOUNT of one MONEY object is greater than that of</span></span>
            <span id="cb370-15"><a href="#cb370-15" aria-hidden="true" tabindex="-1"></a><span class="st">the other.&quot;</span></span>
            <span id="cb370-16"><a href="#cb370-16" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (moneyp money1)</span>
            <span id="cb370-17"><a href="#cb370-17" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="dt">&#39;type-error</span> :expected-type <span class="dt">&#39;money</span> :datum money1))</span>
            <span id="cb370-18"><a href="#cb370-18" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (moneyp money2)</span>
            <span id="cb370-19"><a href="#cb370-19" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="dt">&#39;type-error</span> :expected-type <span class="dt">&#39;money</span> :datum money2))</span>
            <span id="cb370-20"><a href="#cb370-20" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (currencies-match-p money1 money2)</span>
            <span id="cb370-21"><a href="#cb370-21" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="dt">&#39;mismatched-currencies</span> :expected money1</span>
            <span id="cb370-22"><a href="#cb370-22" aria-hidden="true" tabindex="-1"></a>                                  :received money2))</span>
            <span id="cb370-23"><a href="#cb370-23" aria-hidden="true" tabindex="-1"></a>  (<span class="op">&gt;</span> (amount money1) (amount money2)))</span>
            <span id="cb370-24"><a href="#cb370-24" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb370-25"><a href="#cb370-25" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> money&lt; </span>(money1 money2)</span>
            <span id="cb370-26"><a href="#cb370-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function that checks if the AMOUNT of one MONEY object is greater than that of</span></span>
            <span id="cb370-27"><a href="#cb370-27" aria-hidden="true" tabindex="-1"></a><span class="st">the other.&quot;</span></span>
            <span id="cb370-28"><a href="#cb370-28" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (moneyp money1)</span>
            <span id="cb370-29"><a href="#cb370-29" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="dt">&#39;type-error</span> :expected-type <span class="dt">&#39;money</span> :datum money1))</span>
            <span id="cb370-30"><a href="#cb370-30" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (moneyp money2)</span>
            <span id="cb370-31"><a href="#cb370-31" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="dt">&#39;type-error</span> :expected-type <span class="dt">&#39;money</span> :datum money2))</span>
            <span id="cb370-32"><a href="#cb370-32" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (currencies-match-p money1 money2)</span>
            <span id="cb370-33"><a href="#cb370-33" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="dt">&#39;mismatched-currencies</span> :expected money1</span>
            <span id="cb370-34"><a href="#cb370-34" aria-hidden="true" tabindex="-1"></a>                                  :received money2))</span>
            <span id="cb370-35"><a href="#cb370-35" aria-hidden="true" tabindex="-1"></a>  (<span class="op">&lt;</span> (amount money1) (amount money2)))</span></code></pre></div>
        <p>I'm purposefully limiting these functions to only two arguments because I can't imagine myself trying to check more than two using any of these functions. If you can think of a scenario where checking the equality of 3 or more <code class="verbatim">money</code> objects would be useful, let me know.</p>
        <h3 id="bc3b527d-ecb1-46ad-aa52-6649b48708a8">Improving Ergonomics</h3>
        <p>And that's it: the critical functionality of our library is complete. However, we really should improve the ergonomics a bit. When we print a <code class="verbatim">money</code> object, it looks like this:</p>
        <pre class="example"><code>#&lt;USD {7006D80343}&gt;
        </code></pre>
        <p>What we really want is for it to look like this:</p>
        <pre class="example"><code>#&lt;USD 5000&gt;
        </code></pre>
        <p>We do that with the <code class="verbatim">print-object</code> generic function. We can change how an object is printed by creating a method specialized on our <code class="verbatim">money</code> or <code class="verbatim">us-dollar</code> types.</p>
        <div class="sourceCode" id="cb373" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> print-object </span>((this money) <span class="kw">stream</span>)</span>
            <span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print-unreadable-object</span> (this <span class="kw">stream</span>)</span>
            <span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;MONEY ~a ~a&quot;</span> (<span class="kw">slot-value</span> this <span class="dt">&#39;amount</span>) (<span class="kw">slot-value</span> this <span class="dt">&#39;currency-code</span>))))</span>
            <span id="cb373-4"><a href="#cb373-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb373-5"><a href="#cb373-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> print-object </span>((this us-dollar) <span class="kw">stream</span>)</span>
            <span id="cb373-6"><a href="#cb373-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print-unreadable-object</span> (this <span class="kw">stream</span>)</span>
            <span id="cb373-7"><a href="#cb373-7" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a ~a&quot;</span> (<span class="kw">slot-value</span> this <span class="dt">&#39;currency-code</span>) (<span class="kw">slot-value</span> this <span class="dt">&#39;amount</span>))))</span></code></pre></div>
        <p>The <code class="verbatim">print-unreadable-object</code> function needs some explanation. When you return an object in the REPL, you can highlight it with the cursor and type <code class="verbatim">Enter</code> or left-click it with your mouse to <code class="verbatim">inspect</code> the object. This default behavior is preserved for <code class="verbatim">print-object</code> methods that you specialize on classes you define if you wrap the call to <code class="verbatim">format</code> in <code class="verbatim">print-unreadable-object</code>.</p>
        <h3 id="b91f5942-9ca1-4181-9a96-c5a9b24f5181">Formatting for Human Consumption</h3>
        <p>One last important job for our library will be displaying the money amount as normal people expect money amounts to be displayed. That means that <code class="verbatim">#&lt;USD 5000&gt;</code> needs to be formatted as $50.00 and <code class="verbatim">#&lt;JPY 5000&gt;</code> needs to be formatted as <code class="verbatim">¥5,000</code>. We want one function to be able to format any currency properly. We could have one function with a big <code class="verbatim">cond</code> do that:</p>
        <div class="sourceCode" id="cb374" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> format-money </span>(money-obj)</span>
            <span id="cb374-2"><a href="#cb374-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span> ((usdp money-obj) (format-usd money-obj))</span>
            <span id="cb374-3"><a href="#cb374-3" aria-hidden="true" tabindex="-1"></a>        ((jpyp money-obj) (format-jpy money-obj))</span>
            <span id="cb374-4"><a href="#cb374-4" aria-hidden="true" tabindex="-1"></a>        ((gbpp money-obj) (format-gbp money-obj))</span>
            <span id="cb374-5"><a href="#cb374-5" aria-hidden="true" tabindex="-1"></a>        ...))</span></code></pre></div>
        <p>But that has the one downside that it requires updating this one function any time we want to add support for a currency to the library. It's not a huge burden, it's true, and some people may even prefer it. However, Common Lisp has an OOP solution to make our code more extensible: generic functions.</p>
        <div class="sourceCode" id="cb375" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defgeneric</span><span class="fu"> format-money </span>(<span class="kw">stream</span> currency)</span>
            <span id="cb375-2"><a href="#cb375-2" aria-hidden="true" tabindex="-1"></a>  (:documentation <span class="st">&quot;A generic function that takes a currency object and formats it in for human</span></span>
            <span id="cb375-3"><a href="#cb375-3" aria-hidden="true" tabindex="-1"></a><span class="st">consumption.&quot;</span>))</span></code></pre></div>
        <p>Then we need to make a generic <em>method</em> to format USD:</p>
        <div class="sourceCode" id="cb376" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> format-money </span>(<span class="kw">stream</span> (this us-dollar))</span>
            <span id="cb376-2"><a href="#cb376-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((total-cents (amount this)))</span>
            <span id="cb376-3"><a href="#cb376-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span> ((<span class="op">&lt;</span> total-cents <span class="dv">0</span>)</span>
            <span id="cb376-4"><a href="#cb376-4" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">let*</span> ((total-cents (<span class="op">-</span> total-cents))</span>
            <span id="cb376-5"><a href="#cb376-5" aria-hidden="true" tabindex="-1"></a>                  (dollars (<span class="kw">floor</span> total-cents <span class="dv">100</span>))</span>
            <span id="cb376-6"><a href="#cb376-6" aria-hidden="true" tabindex="-1"></a>                  (cents (<span class="kw">mod</span> total-cents <span class="dv">100</span>)))</span>
            <span id="cb376-7"><a href="#cb376-7" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;-~a~:D.~2,&#39;0D&quot;</span> (currency-sign this) dollars cents)))</span>
            <span id="cb376-8"><a href="#cb376-8" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">t</span></span>
            <span id="cb376-9"><a href="#cb376-9" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">let</span> ((dollars (<span class="kw">floor</span> total-cents <span class="dv">100</span>))</span>
            <span id="cb376-10"><a href="#cb376-10" aria-hidden="true" tabindex="-1"></a>                 (cents (<span class="kw">mod</span> total-cents <span class="dv">100</span>)))</span>
            <span id="cb376-11"><a href="#cb376-11" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a~:D.~2,&#39;0D&quot;</span> (currency-sign this) dollars cents))))))</span></code></pre></div>
        <p>For small, negative values of <code class="verbatim">total-cents</code>, <code class="verbatim">floor</code> will be inaccurate (<code class="verbatim">(floor -5 100)</code> will return <code class="verbatim">-1</code> rather than <code class="verbatim">0</code>), so we make all negative integers positive before formatting them, adding the minus-sign back at the beginning of the format string.</p>
        <p><code class="verbatim">~2,'0D</code> looks crazy, I know. Format directives can be modified by optional parameters–separated by commas–and by modifiers <code class="verbatim">COLON</code> or <code class="verbatim">AT-SIGN</code>. For <code class="verbatim">Tilde D</code>, we have four possible parameters:</p>
        <ol class="incremental">
            <li>mincol</li>
            <li>padchar</li>
            <li>comma</li>
            <li>interval</li>
        </ol>
        <p>Let's take a look at them in action:</p>
        <div class="sourceCode" id="cb377" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((small-num <span class="dv">7</span>)</span>
            <span id="cb377-2"><a href="#cb377-2" aria-hidden="true" tabindex="-1"></a>      (big-num <span class="dv">987654321</span>))</span>
            <span id="cb377-3"><a href="#cb377-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~d | ~d&quot;</span>                          <span class="st">&quot;no modifications&quot;</span>                  small-num big-num)</span>
            <span id="cb377-4"><a href="#cb377-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4d | ~4d&quot;</span>                        <span class="st">&quot;mincol of 4&quot;</span>                       small-num big-num)</span>
            <span id="cb377-5"><a href="#cb377-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4,&#39;xd | ~4,&#39;xd&quot;</span>                  <span class="st">&quot;mincol padding using character x&quot;</span>  small-num big-num)</span>
            <span id="cb377-6"><a href="#cb377-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4,&#39;x:d | ~4,&#39;x:d&quot;</span>                <span class="st">&quot;colon added&quot;</span>                       small-num big-num)</span>
            <span id="cb377-7"><a href="#cb377-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4,&#39;x,&#39;x:d | ~4,&#39;x,&#39;x:d&quot;</span>          <span class="st">&quot;commas replaced with x&quot;</span>            small-num big-num)</span>
            <span id="cb377-8"><a href="#cb377-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4,&#39;x,&#39;x,1:d | ~4,&#39;x,&#39;x,1:d&quot;</span>      <span class="st">&quot;comma interval set to 1&quot;</span>           small-num big-num)</span>
            <span id="cb377-9"><a href="#cb377-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4,&#39;x@d | ~4,&#39;x,&#39;x,1@d&quot;</span>           <span class="st">&quot;colon replaced with at-sign&quot;</span>       small-num big-num)</span>
            <span id="cb377-10"><a href="#cb377-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%~40a | ~4,&#39;x@:d | ~4,&#39;x,&#39;x,1@:d&quot;</span>         <span class="st">&quot;at-sign and colon combined&quot;</span>        small-num big-num))</span></code></pre></div>
        <p>Returns:</p>
        <pre class="example"><code>no modifications                         | 7 | 987654321
mincol of 4                              |    7 | 987654321
mincol padding using character x         | xxx7 | 987654321
colon added                              | xxx7 | 987,654,321
commas replaced with x                   | xxx7 | 987x654x321
comma interval set to 1                  | xxx7 | 9x8x7x6x5x4x3x2x1
colon replaced with at-sign              | xx+7 | +987654321
at-sign and colon combined               | xx+7 | +9x8x7x6x5x4x3x2x1 =&gt; NIL
        </code></pre>
        <p>It should be a bit easier now to understand the format string for <code class="verbatim">format-money</code>: <code class="verbatim">~a</code>, just display the <code class="verbatim">currency-sign</code>. <code class="verbatim">~:D</code>, add commas to dollars side where appropriate. <code class="verbatim">.</code>, we add the dot. <code class="verbatim">~2,'0D</code>, set the <code class="verbatim">mincol</code> to 2 and pad empty space with 0s. This ensures that <code class="verbatim">(usd 5)</code> returns <code class="verbatim">$0.05</code> and not <code class="verbatim">$0.5</code>.</p>
        <p>Also, for the big-brains screaming, "Micah! What about ~$ you dummy?", <code class="verbatim">Tilde $</code> won't add commas to the number, and there's no way to combine both the effects of <code class="verbatim">Tilde $</code> and <code class="verbatim">Tilde D</code>.</p>
        <h3 id="dafd9652-69e7-4507-a4fc-bbd2b67adcdd">Adding Currencies</h3>
        <p>The library is "complete", in the sense that it does everything we want it to do. One catch: it only works with USD.</p>
        <p>How do we add support for more currencies?</p>
        <p>It's fairly simple. We'll do it with Japanese Yen:</p>
        <div class="sourceCode" id="cb379" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; * JPY</span></span>
            <span id="cb379-2"><a href="#cb379-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> japanese-yen </span>(money)</span>
            <span id="cb379-3"><a href="#cb379-3" aria-hidden="true" tabindex="-1"></a>  ((currency-code :initform <span class="st">&quot;JPY&quot;</span>)</span>
            <span id="cb379-4"><a href="#cb379-4" aria-hidden="true" tabindex="-1"></a>   (currency-sign :initform <span class="st">&quot;¥&quot;</span>)))</span>
            <span id="cb379-5"><a href="#cb379-5" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb379-6"><a href="#cb379-6" aria-hidden="true" tabindex="-1"></a>(register-currency <span class="st">&quot;JPY&quot;</span> <span class="dt">&#39;japanese-yen</span>)</span>
            <span id="cb379-7"><a href="#cb379-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb379-8"><a href="#cb379-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> format-money </span>(<span class="kw">stream</span> (this japanese-yen))</span>
            <span id="cb379-9"><a href="#cb379-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a~:d&quot;</span> (currency-sign this) (amount this)))</span>
            <span id="cb379-10"><a href="#cb379-10" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb379-11"><a href="#cb379-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> print-object </span>((this japanese-yen) <span class="kw">stream</span>)</span>
            <span id="cb379-12"><a href="#cb379-12" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print-unreadable-object</span> (this <span class="kw">stream</span>)</span>
            <span id="cb379-13"><a href="#cb379-13" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a ~a&quot;</span> (<span class="kw">slot-value</span> this <span class="dt">&#39;currency-code</span>) (<span class="kw">slot-value</span> this <span class="dt">&#39;amount</span>))))</span>
            <span id="cb379-14"><a href="#cb379-14" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb379-15"><a href="#cb379-15" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> jpy </span>(amount)</span>
            <span id="cb379-16"><a href="#cb379-16" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">assert</span> (<span class="kw">integerp</span> amount) (amount)</span>
            <span id="cb379-17"><a href="#cb379-17" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;AMOUNT must be an integer, got ~a.&quot;</span> amount)</span>
            <span id="cb379-18"><a href="#cb379-18" aria-hidden="true" tabindex="-1"></a>  (make-money amount <span class="dt">&#39;japanese-yen</span>))</span></code></pre></div>
        <p>We inherit and extend the <code class="verbatim">money</code> class with the <code class="verbatim">japanese-yen</code> class, assigning default values to <code class="verbatim">currency-code</code> and <code class="verbatim">currency-sign</code>.</p>
        <p>We register the new currency so that <code class="verbatim">make-money</code> will work properly if called like this: <code class="verbatim">(make-money 5000 "JPY")</code>. It's likely that people will only use <code class="verbatim">jpy</code>, but who knows?</p>
        <p>We specialize the <code class="verbatim">format-money</code> and <code class="verbatim">print-object</code> generic functions with methods for the new <code class="verbatim">japanese-yen</code> type. Formatting Japanese yen is even easier than USD: The lowest and <em>only</em> monetary unit is the yen, so no need for a decimal or the yen equivalent of "cents".</p>
        <p>Then we make a helper-function to make Japanese Yen.</p>
        <p>Neither we nor future developers will need to modify any existing code; we use OOP modularity and extensibility that would make every senior Java developer proud.</p>
        <p>And thus, our library is complete and ready to be upgraded with support for other currencies in the future.</p>
        <h2 id="almighty-kaikei"><code class="verbatim">ALMIGHTY-KAIKEI</code></h2>
        <h3 id="a-double-entry-accounting-system">A Double-Entry Accounting System</h3>
        <p>For this project, we will be building the foundation for a double-entry accounting system called <code class="verbatim">almighty-kaikei</code>. double-entry accounting is a system that is designed to prevent or detect accounting errors by tracking two sides of a ledger: the debit and credit sides.</p>
        <ol class="incremental">
            <li><p>Types of Accounts</p>
                <p>There are five basic types of accounts in an double-entry accounting system: Asset, Expense, Income, Liability, and Equity. All of the accounts are recorded in what's called a Chart of Accounts.</p>
                <p>The types are divided into two groups: <strong>left hand side</strong> (LHS) and <strong>right hand side</strong> (RHS) accounts. Assets and Expenses are LHS account, the rest are RHS accounts.</p></li>
            <li><p>Balancing One Account</p>
                <p>The balance of an account's ledger is calculated based on all of its debits and credits. For example, for a Sales Revenue account:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Debit</th>
                            <th>Credit</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>2025-11-4</td>
                            <td>Opening Balance</td>
                            <td></td>
                            <td></td>
                            <td>0</td>
                        </tr>
                        <tr>
                            <td>2025-11-5</td>
                            <td>Cash Sale</td>
                            <td></td>
                            <td>100</td>
                            <td>100</td>
                        </tr>
                        <tr>
                            <td>2025-11-5</td>
                            <td>Cash Sale</td>
                            <td></td>
                            <td>50</td>
                            <td>150</td>
                        </tr>
                        <tr>
                            <td>2025-11-6</td>
                            <td>Return</td>
                            <td>20</td>
                            <td></td>
                            <td>130</td>
                        </tr>
                        <tr>
                            <td>2025-11-7</td>
                            <td>Cash Sale</td>
                            <td></td>
                            <td>200</td>
                            <td>330</td>
                        </tr>
                        <tr>
                            <td>———</td>
                            <td>—————</td>
                            <td>—–</td>
                            <td>——</td>
                            <td>——-</td>
                        </tr>
                        <tr>
                            <td>Total</td>
                            <td></td>
                            <td>20</td>
                            <td>350</td>
                            <td>330</td>
                        </tr>
                    </tbody>
                </table>
                <p>On the other hand, the Cost of Goods Sold (COGS) account for these transactions will look like this:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Debit</th>
                            <th>Credit</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>2025-11-4</td>
                            <td>Opening Balance</td>
                            <td></td>
                            <td></td>
                            <td>0</td>
                        </tr>
                        <tr>
                            <td>2025-11-5</td>
                            <td>Cash Sale</td>
                            <td>60</td>
                            <td></td>
                            <td>60</td>
                        </tr>
                        <tr>
                            <td>2025-11-5</td>
                            <td>Cash Sale</td>
                            <td>20</td>
                            <td></td>
                            <td>80</td>
                        </tr>
                        <tr>
                            <td>2025-11-6</td>
                            <td>Return</td>
                            <td></td>
                            <td>10</td>
                            <td>70</td>
                        </tr>
                        <tr>
                            <td>2025-11-7</td>
                            <td>Cash Sale</td>
                            <td>150</td>
                            <td></td>
                            <td>220</td>
                        </tr>
                        <tr>
                            <td>———</td>
                            <td>—————</td>
                            <td>—–</td>
                            <td>——</td>
                            <td>——-</td>
                        </tr>
                        <tr>
                            <td>Total</td>
                            <td></td>
                            <td>230</td>
                            <td>10</td>
                            <td>220</td>
                        </tr>
                    </tbody>
                </table>
                <p>Notice that the value of the balance for the Sales (income/revenue) account increases with credits, but for the COGS (an asset account) the balance increases with debits.</p>
                <p>For LHS accounts, <strong>credits increase</strong> the balance, <strong>debits decrease</strong> the balance. For RHS accounts, <strong>debits increase</strong> the balance, <strong>credits decrease</strong> the balance.</p>
                <p>Thus,</p>
                <ul class="incremental">
                    <li>For LHS accounts, <code>(= balance (- debits credits))</code>.</li>
                    <li>For RHS accounts, <code>(= balance (- credits debits))</code>.</li>
                </ul></li>
            <li><p>Balancing a Transaction</p>
                <p>The balance of a transaction is calculated from the debits and credits on two or more accounts in the transaction. A transaction consists of a least one debit and one credit to two separate accounts.</p>
                <p>Let's say we are a business that wants to record a cash sale of physical merchandise. A sale will affect that following accounts:</p>
                <ol class="incremental">
                    <li>Inventory (asset)</li>
                    <li>Cash (asset)</li>
                    <li>Sales Revenue (income)</li>
                    <li>Cost of Goods Sold (COGS, expense)</li>
                </ol>
                <p>Typically, transactions are visualized as a table with a debit and credit column:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Account</th>
                            <th>Debit</th>
                            <th>Credit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Cash</td>
                            <td>100</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>Sales Revenue</td>
                            <td></td>
                            <td>100</td>
                        </tr>
                        <tr>
                            <td>COGS</td>
                            <td>60</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>Inventory</td>
                            <td></td>
                            <td>60</td>
                        </tr>
                        <tr>
                            <td>————-</td>
                            <td>—–</td>
                            <td>——</td>
                        </tr>
                        <tr>
                            <td>Totals</td>
                            <td>160</td>
                            <td>160</td>
                        </tr>
                    </tbody>
                </table>
                <p>So in the table above, cash is debited (increasing in value), sales revenue (an income account) is credited (increasing in value). You now have recorded an increase in your cash-on-hand and your sales.</p>
                <p>The Cash of Goods Sold account is debited (increasing in value), and your inventory is credited (decreasing in value). You have paid down the expense you had when purchasing an inventory good and the size or value of your inventory has decreased. By subtracting COGS from Sales Revenue, you can also know how much money you made from the transaction.</p>
                <p>And the debit and credit totals match on both sides.</p></li>
            <li><p>Ledgers</p>
                <p>Ledgers are ways of viewing the data your system records. For example, a general ledger will show raw data: what transactions occurred. A sales ledger will show sales. An account ledger will show the transactions for an account and its current balance. An accounts payable aging report will show how much money you owe, to whom, and how overdue you might be on a certain account. All of these different ledgers provide insight into your accounting: cash flow, sales/returns, etc.</p></li>
        </ol>
        <h3 id="requirements">Requirements</h3>
        <p>Given the above, we need to provide the following functionality in our library:</p>
        <ol class="incremental">
            <li>Account Creation</li>
            <li>Balanced Transaction Creation</li>
            <li>Account Balance Retrieval</li>
            <li>Chart of Accounts Balance Retrieval</li>
        </ol>
        <p>The library should also provide the ability to easily create ledgers from the data it provides.</p>
        <h3 id="testing-examples">Testing &amp; Examples</h3>
        <p>This library's functionality is going to be trickier than the <code class="verbatim">almighty-money</code> library's was, so we're going to need to create tests. For that, we'll be using <code class="verbatim">lisp-unit2</code>. We will do some basic unit tests, and we'll make some example ledgers to demonstrate the library's use in an accounting system.</p>
        <h3 id="dependencies">Dependencies</h3>
        <p>We will be using the <code class="verbatim">almighty-money</code> library we created along with some other dependencies.</p>
        <p>Since we are now adding dependencies to our project, I will introduce you to <code class="verbatim">vend</code>, a library that replaces the defacto-standard <code class="verbatim">quicklisp</code> library for dependency management. Let me explain why.</p>
        <h3 id="vendor-your-dependencies">Vendor Your Dependencies</h3>
        <p>The guiding principle of the Almighty Lisp developer is to, above all else, prioritize simplicity. Simplicity is the key to writing code that you and others can maintain without fear or frustration.</p>
        <p>When it comes to dependencies, simplicity looks like this:</p>
        <ol class="incremental">
            <li>Generally avoid adding dependencies to a project unless necessary. If you can write a simple thing yourself that gets the job done, you probably should.</li>
            <li>When adding dependencies to your project, adopt them as <strong>your code</strong>. You are now responsible for their bugs, features, efficiency, etc.</li>
            <li>When possible, remove dependencies. Usually this means slowly extracting functionality from a dependency and rewriting it customized for your needs.</li>
        </ol>
        <p>Some people feel that the trend to make dependencies <em>easier</em> to add to a project via tools like <code class="verbatim">npm</code> or <code class="verbatim">uv</code> are detrimental to codebase quality and are a security liability. If adding and maintaining dependencies with such tools is easy, you will be tempted to add and keep large amounts of third-party code in your codebase. Adding a dependency <em>is</em> and <em>should feel</em> like a serious, risky decision.</p>
        <p>While I can see the benefits of that mindset, the Almighty Lisp philosophy is one that is designed to maximize the effectiveness of the <em>individual programmer</em>. If you have a team of developers, you can expect to be able to work together to write the exact code that you need, both your library code and application code. Individual programmers need to prioritize writing application code over library code, which means individuals need to rely more heavily on dependencies.</p>
        <p>If your brain is so big you can crank out the whole web stack by yourself while producing high-quality code, you can ignore the above. For the rest of us, we need a simple way of introducing dependencies into our projects that provide us the means to easily transition dependencies into code fit exactly to our purpose, free from the potential of introduced security vulnerabilities.</p>
        <p><code class="verbatim">vend</code> is a library that does precisely that by making it simple to <em>vendor</em> our dependencies. <code class="verbatim">Vend</code> works by looking at our <code class="verbatim">defsystem</code> definitions, looks at what other systems our system <code class="verbatim">:depends-on</code>, and cloning the requisite systems from github into a directory in our project folder–defaulting to <code class="verbatim">vendored</code>.</p>
        <p>If for some reason you don't want to use <code class="verbatim">vend</code>, you can feel free to use <code class="verbatim">quicklisp</code> instead.</p>
        <ol class="incremental">
            <li><p>Installing <code class="verbatim">vend</code></p>
                <p>Installing <code class="verbatim">vend</code> is simple, but it does have one unusual requirement: it requires ECL, a different implementation of Common Lisp (we installed SBCL at the very beginning, before even installing Emacs). So first, we need to install ECL.</p>
                <p>If you're on Linux, you can try looking for a package for your distribution.</p>
                <p>On MacOS, ECL is available on Homebrew.</p>
                <p>Otherwise, you can follow the instructions below to compile ECL from the source. These come directly from <a href="https://ecl.common-lisp.dev/static/files/manual/current-manual/Building-ECL.html">the manual</a>.</p>
                <ol class="incremental">
                    <li><p>Download ECL</p>
                        <p>Download the latest release of ECL from <a href="https://ecl.common-lisp.dev/static/files/release/">their server</a>.</p></li>
                    <li><p>Extract the source code and enter its directory</p>
                        <pre><code>$ tar -xf ecl-xx.x.x.tgz
$ cd ecl-xx.x.x
                        </code></pre></li>
                    <li><p>Run the configuration file, build the program and install it</p>
                        <pre><code>$ ./configure --prefix=/usr/local
$ make                          # -jX if you have X cores
$ make install
                        </code></pre></li>
                    <li><p>Make sure the program is installed and ready to run</p>
                        <pre><code>$ /usr/local/bin/ecl

ECL (Embeddable Common-Lisp) 16.0.0
Copyright (C) 1984 Taiichi Yuasa and Masami Hagiya
Copyright (C) 1993 Giuseppe Attardi
Copyright (C) 2000 Juan J. Garcia-Ripoll
Copyright (C) 2015 Daniel Kochmanski
ECL is free software, and you are welcome to redistribute it
under certain conditions; see file &#39;Copyright&#39; for details.
Type :h for Help.
Top level in: #&lt;process TOP-LEVEL&gt;.
&gt;
                        </code></pre></li>
                    <li><p>Clone <code class="verbatim">vend</code> git repo</p>
                        <p>Now that you have ECL installed, you can install vend.</p>
                        <p>Clone <a href="https://github.com/fosskers/vend">the <code class="verbatim">vend</code> git repository</a> from Github.</p></li>
                    <li><p>Run <code class="verbatim">make</code></p>
                        <p>After cloning the repo, navigate into the vend directory and run the following commands:</p>
                        <pre><code>make
make install
                        </code></pre>
                        <p>After that, enter <code class="verbatim">vend</code> in the command line (you may need to restart the terminal) and you should see this:</p>
                        <pre><code>vend - Vendor your Common Lisp dependencies

Commands:
  check  [focus] - Check your dependencies for issues
  get            - Download all project dependencies into &#39;vendored/&#39;
  graph  [focus] - Visualise a graph of transitive project dependencies
  init   [name]  - Create a minimal project skeleton
  repl   [args]  - Start a Lisp session with only your vendored ASDF systems
  search [term]  - Search known systems
  test   [args]  - Run all detected test systems

Flags:
  --help    - Display this help message
  --version - Display the current version of vend
                        </code></pre></li>
                    <li><p>Emacs configuration</p>
                        <p>You need to configure Emacs to open the REPL via <code class="verbatim">vend</code>. To open your <code class="verbatim">config.el</code> file, type <code class="verbatim">C-h d c</code> or <code class="verbatim">SPC f P</code> (<code class="verbatim">doom/open-private-config</code>) and open <code class="verbatim">config.el</code> from the minibuffer. In your <code class="verbatim">config.el</code> file, add:</p>
                        <div class="sourceCode" id="cb385" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb385-1"><a href="#cb385-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setq</span> sly-default-lisp <span class="dt">&#39;sbcl</span></span>
                            <span id="cb385-2"><a href="#cb385-2" aria-hidden="true" tabindex="-1"></a>      sly-lisp-implementations &#39;((sbcl  (<span class="st">&quot;vend&quot;</span> <span class="st">&quot;repl&quot;</span> <span class="st">&quot;sbcl&quot;</span>)  :coding-system utf-8-unix)</span>
                            <span id="cb385-3"><a href="#cb385-3" aria-hidden="true" tabindex="-1"></a>                                 (ecl   (<span class="st">&quot;vend&quot;</span> <span class="st">&quot;repl&quot;</span> <span class="st">&quot;ecl&quot;</span>)   :coding-system utf-8-unix)</span>
                            <span id="cb385-4"><a href="#cb385-4" aria-hidden="true" tabindex="-1"></a>                                 (abcl  (<span class="st">&quot;vend&quot;</span> <span class="st">&quot;repl&quot;</span> <span class="st">&quot;abcl&quot;</span>)  :coding-system utf-8-unix)</span>
                            <span id="cb385-5"><a href="#cb385-5" aria-hidden="true" tabindex="-1"></a>                                 (clasp (<span class="st">&quot;vend&quot;</span> <span class="st">&quot;repl&quot;</span> <span class="st">&quot;clasp&quot;</span>) :coding-system utf-8-unix)))</span></code></pre></div>
                        <ol class="incremental">
                            <li><p>Can't find <code class="verbatim">vend</code>?</p>
                                <p>I had this error while testing on a fresh install of Ubuntu:</p>
                                <p><code class="verbatim">File local-variables error: (doom-hook-error lisp-mode-local-vars-hook sly-editing-mode (file-missing Searching for program No such file or directory vend))</code></p>
                                <p>That means that Emacs can't find the <code class="verbatim">vend</code> executable. To resolve the error, I installed the package <code class="verbatim">exec-path-from-shell</code>.</p>
                                <p>To install it, type <code class="verbatim">SPC f P</code> and open <code class="verbatim">config.el</code>. Add this to your <code class="verbatim">config.el</code> file:</p>
                                <pre class="elisp"><code>(use-package! exec-path-from-shell
  :when (or (memq window-system &#39;(mac ns x))
            (daemonp))
  :config
  (exec-path-from-shell-initialize))
                                </code></pre>
                                <p>And add this to your <code class="verbatim">packages.el</code> file (in the same folder as the <code class="verbatim">config.el</code>):</p>
                                <pre class="elisp"><code>(package! exec-path-from-shell)
                                </code></pre>
                                <p>Run <code class="verbatim">doom sync</code> in the terminal and restart doom with <code class="verbatim">SPC q r</code> (<code class="verbatim">doom/restart-and-restore</code>).</p>
                                <p>Strangely, after I did this <em>and then undid the changes</em>, <code class="verbatim">vend</code> continued to work. We all love software that just works, don't we folks?</p></li>
                        </ol></li>
                </ol></li>
        </ol>
        <h3 id="project-setup-1">Project Setup</h3>
        <ol class="incremental">
            <li><p>Project Files</p>
                <p>Our project is called <code class="verbatim">almighty-kaikei</code>, so <code class="verbatim">find-file</code> (<code class="verbatim">C-x C-f</code> or <code class="verbatim">SPC f f</code>) <code class="verbatim">almighty-kaikei/almighty-kaikei.asd</code> and save it. We're going to need tests later, so just make a <code class="verbatim">t</code> directory, too.</p></li>
            <li><p>Defining a System</p>
                <p>Now that we have <code class="verbatim">vend</code> installed, we can get the rest of our dependencies. First, we create a directory called <code class="verbatim">almighty-kaikei</code> and define our system in <code class="verbatim">almighty-kaikei.asd</code>.</p>
                <div class="sourceCode" id="cb388" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb388-1"><a href="#cb388-1" aria-hidden="true" tabindex="-1"></a>(defsystem <span class="st">&quot;almighty-kaikei&quot;</span></span>
                    <span id="cb388-2"><a href="#cb388-2" aria-hidden="true" tabindex="-1"></a>  :author <span class="st">&quot;Micah Killian&quot;</span></span>
                    <span id="cb388-3"><a href="#cb388-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">:version</span> <span class="st">&quot;0.0.1&quot;</span></span>
                    <span id="cb388-4"><a href="#cb388-4" aria-hidden="true" tabindex="-1"></a>  :description <span class="st">&quot;Almighty Double-Entry Accounting Program&quot;</span></span>
                    <span id="cb388-5"><a href="#cb388-5" aria-hidden="true" tabindex="-1"></a>  :depends-on (#:almighty-money #:local-time #:mito #:sxql #:dbi)</span>
                    <span id="cb388-6"><a href="#cb388-6" aria-hidden="true" tabindex="-1"></a>  :components ((:file <span class="st">&quot;src/main&quot;</span>)))</span></code></pre></div>
                <p>Make sure to save the file.</p></li>
            <li><p>Download Dependencies</p>
                <p>Now it's time to run <code class="verbatim">vend</code>. In the terminal, run this command:</p>
                <pre><code>% vend get
                </code></pre>
                <p>You will get an error saying that <code class="verbatim">almighty-money</code> isn't a known system. Not surprising–it's on our computer!</p>
                <p>To get around this, first we make the <code class="verbatim">vendored</code> directory ourselves and make another directory inside it called <code class="verbatim">almighty-money</code>.</p>
                <pre><code>% mkdir vendored
% cd vendored
% mkdir almighty-money
                </code></pre>
                <p>Now we can make a symbolic link from where we saved <code class="verbatim">almighty-money</code> and the directory we just made.</p>
                <pre><code>% ln -s ~/path/to/the/original/almighty-money almighty-money
                </code></pre>
                <p>If you did everything right, you can run <code class="verbatim">vend get</code> in the <code class="verbatim">almighty-kaikei</code> directory. It will find the <code class="verbatim">almighty-money.asd</code> file and won't attempt to search for or download it. Then it will download the rest of the dependencies as expected.</p></li>
            <li><p>Defining the <code class="verbatim">almighty-kaikei</code> package</p>
                <p>Now that we have our system setup, let's create the <code class="verbatim">main.lisp</code> file in the project root and define the package.</p>
                <div class="sourceCode" id="cb392" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:almighty-kaikei</span>
                    <span id="cb392-2"><a href="#cb392-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
                    <span id="cb392-3"><a href="#cb392-3" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:nicknames</span> #:almighty-kaikei/main #:ak)</span>
                    <span id="cb392-4"><a href="#cb392-4" aria-hidden="true" tabindex="-1"></a>  (:local-nicknames (#:lt #:local-time)</span>
                    <span id="cb392-5"><a href="#cb392-5" aria-hidden="true" tabindex="-1"></a>                    (#:m #:mito)</span>
                    <span id="cb392-6"><a href="#cb392-6" aria-hidden="true" tabindex="-1"></a>                    (#:s #:sxql)</span>
                    <span id="cb392-7"><a href="#cb392-7" aria-hidden="true" tabindex="-1"></a>                    (#:d #:dbi)</span>
                    <span id="cb392-8"><a href="#cb392-8" aria-hidden="true" tabindex="-1"></a>                    (#:am #:almighty-money)))</span></code></pre></div>
                <p>Now's a good time to learn a bit about our dependencies.</p></li>
        </ol>
        <h3 id="introducing-our-dependencies">Introducing Our Dependencies</h3>
        <ol class="incremental">
            <li><p><code class="verbatim">local-time</code></p>
                <p>This is the defacto standard library for working with time, similar to Python's <code class="verbatim">datetime</code> library.</p></li>
            <li><p><code class="verbatim">mito</code></p>
                <p>This is a SQL object-relational mapper. It's not such an opinionated ORM–we can rely on simple SQL queries for the most part when using it. It does the work of creating database tables and serializing between Lisp and SQL data.</p></li>
            <li><p><code class="verbatim">sxql</code></p>
                <p>This is a domain specific language for writing SQL in Lisp. I happen to really enjoy doing everything in Lisp (in a later project we will write HTML with the <code class="verbatim">hsx</code> library, another DSL). Putting everything I'm doing right in one spot, rather than spreading it across several files, just feels right to me.</p>
                <p>If you're not such an enthusiast of this style, you can check out the <code class="verbatim">cl-yesql</code> library. It is a library similar to Clojure's Yesql library. It allows you to <em>use</em> SQL from Lisp, rather than <em>write</em> it as with <code class="verbatim">sxql</code>.</p></li>
            <li><p><code class="verbatim">dbi</code></p>
                <p>This is a library for interfacing with databases. It provides functionality like SQL transactions, preparing and executing queries, etc. We need this to connect to our database and one query.</p></li>
        </ol>
        <h3 id="why-sql">Why SQL?</h3>
        <p>You might be wondering why we're using SQL instead of straight Lisp. The answer is that we want to be able to use this library as is in a production environment where we expect to be using a SQL database.</p>
        <h3 id="accounts">Accounts</h3>
        <p>The first thing we need to do is provide a way of designating and knowing whether an account is a left-hand-side account or a right-hand-side account.</p>
        <p>Recall that there are five basic categories of account: asset, expense, income, liability, and equity. Recall also that debits and credits influence the value of LHS and RHS differently and use a different formula for calculating their balance. So when we make accounts, we are going to assign it a certain category and we'll need to know which side it is in order to calculate its balance.</p>
        <div class="sourceCode" id="cb393" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb393-1"><a href="#cb393-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; * ░ ACCOUNT ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span></span>
            <span id="cb393-2"><a href="#cb393-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *left-hand-side* </span>&#39;((<span class="st">&quot;asset&quot;</span> <span class="op">-</span><span class="dv">1</span>) (<span class="st">&quot;expense&quot;</span> <span class="op">-</span><span class="dv">1</span>)))</span>
            <span id="cb393-3"><a href="#cb393-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *right-hand-side* </span>&#39;((<span class="st">&quot;income&quot;</span> <span class="dv">1</span>) (<span class="st">&quot;liability&quot;</span> <span class="dv">1</span>) (<span class="st">&quot;equity&quot;</span> <span class="dv">1</span>)))</span>
            <span id="cb393-4"><a href="#cb393-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *account-types* </span>(<span class="kw">append</span> *left-hand-side* *right-hand-side*))</span>
            <span id="cb393-5"><a href="#cb393-5" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb393-6"><a href="#cb393-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> valid-account-category-p </span>(account-category)</span>
            <span id="cb393-7"><a href="#cb393-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;A predicate that takes an account category string. Returns a list of the</span></span>
            <span id="cb393-8"><a href="#cb393-8" aria-hidden="true" tabindex="-1"></a><span class="st">category and its side, or nil.&quot;</span></span>
            <span id="cb393-9"><a href="#cb393-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">assoc</span> account-category *account-types* <span class="bu">:test</span> <span class="op">#&#39;</span>equal))</span></code></pre></div>
        <p>Just a reminder: the <code class="verbatim">:test #'equal</code> parameter in the call to <code class="verbatim">assoc</code> is necessary because strings are arrays of characters that are instantiated separately. Since the default for <code class="verbatim">:test</code> is <code class="verbatim">#'eql</code>, <code class="verbatim">member</code> usually tests if two things <em>are in identical places in memory</em>. <code class="verbatim">equal</code>, on the other hand, will compare the structure of its inputs.</p>
        <div class="sourceCode" id="cb394" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb394-1"><a href="#cb394-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eql</span> <span class="st">&quot;hello&quot;</span> <span class="st">&quot;hello&quot;</span>) <span class="co">;; two separately instatiated arrays</span></span>
            <span id="cb394-2"><a href="#cb394-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; NIL</span></span>
            <span id="cb394-3"><a href="#cb394-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((str <span class="st">&quot;hello&quot;</span>))</span>
            <span id="cb394-4"><a href="#cb394-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">eql</span> str str)) <span class="co">;; same variable, same place in memory</span></span>
            <span id="cb394-5"><a href="#cb394-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; T</span></span>
            <span id="cb394-6"><a href="#cb394-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">equal</span> <span class="st">&quot;hello&quot;</span> <span class="st">&quot;hello&quot;</span>)</span>
            <span id="cb394-7"><a href="#cb394-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; T</span></span></code></pre></div>
        <p>Next, we define the <code class="verbatim">account</code> table with Mito:</p>
        <div class="sourceCode" id="cb395" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb395-1"><a href="#cb395-1" aria-hidden="true" tabindex="-1"></a>(m:deftable account ()</span>
            <span id="cb395-2"><a href="#cb395-2" aria-hidden="true" tabindex="-1"></a>  ((name :col-type :text)</span>
            <span id="cb395-3"><a href="#cb395-3" aria-hidden="true" tabindex="-1"></a>   (code :col-type :text)</span>
            <span id="cb395-4"><a href="#cb395-4" aria-hidden="true" tabindex="-1"></a>   (category :col-type :text)</span>
            <span id="cb395-5"><a href="#cb395-5" aria-hidden="true" tabindex="-1"></a>   (currency :col-type :text))</span>
            <span id="cb395-6"><a href="#cb395-6" aria-hidden="true" tabindex="-1"></a>  (:table-name <span class="st">&quot;almighty_account&quot;</span>)</span>
            <span id="cb395-7"><a href="#cb395-7" aria-hidden="true" tabindex="-1"></a>  (:documentation <span class="st">&quot;A mito macro that defines a class and SQL table for double-entry accounting</span></span>
            <span id="cb395-8"><a href="#cb395-8" aria-hidden="true" tabindex="-1"></a><span class="st">accounts.&quot;</span>))</span>
            <span id="cb395-9"><a href="#cb395-9" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb395-10"><a href="#cb395-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> print-object </span>((this account) <span class="kw">stream</span>)</span>
            <span id="cb395-11"><a href="#cb395-11" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print-unreadable-object</span> (this <span class="kw">stream</span> <span class="bu">:type</span> <span class="kw">t</span> :identity <span class="kw">t</span>)</span>
            <span id="cb395-12"><a href="#cb395-12" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">with-slots</span> (name code) this</span>
            <span id="cb395-13"><a href="#cb395-13" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a ~a&quot;</span> name code))))</span>
            <span id="cb395-14"><a href="#cb395-14" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb395-15"><a href="#cb395-15" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> side </span>(account)</span>
            <span id="cb395-16"><a href="#cb395-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function for getting the multiplier used for determining whether a</span></span>
            <span id="cb395-17"><a href="#cb395-17" aria-hidden="true" tabindex="-1"></a><span class="st">debit/credit increases or decreases the value of an account.&quot;</span></span>
            <span id="cb395-18"><a href="#cb395-18" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">second</span> (<span class="kw">assoc</span> (account-category account) *account-types* <span class="bu">:test</span> <span class="op">#&#39;</span>equal)))</span></code></pre></div>
        <p>Mito's <code class="verbatim">deftable</code> macro expand into a <code class="verbatim">defclass</code> with a special <code class="verbatim">:meta-class</code>. The slots of the class will all have accessors prefixed with the name of the table. In this case, the accessor for the <code class="verbatim">name</code> slot is <code class="verbatim">account-name</code>. This is similar to how structures work.</p>
        <p>The <code class="verbatim">:col-type</code> slot option is for setting the SQL column type. In our case, we are going to use SQLite, which only really has text and integer types. If we were using PostgreSQL, we'd need to be more specific with our <code class="verbatim">:col-types</code>.</p>
        <p>By default Mito will set the SQL table name to the name of the Lisp class (<code class="verbatim">account</code> here), but we can manually set it with the <code class="verbatim">:table-name</code> class option. Here we are namespacing it with the <code class="verbatim">almighty_</code> prefix.</p>
        <p>We also define a <code class="verbatim">print-object</code> method for the <code class="verbatim">account</code> class to make it easier to understand when we print account objects to the REPL.</p>
        <p><code class="verbatim">side</code> will be important for when we enter and retrieve data from the database: it will determine whether the amount entered or returned is negative or positive.</p>
        <p>We can manually construct <code class="verbatim">account</code> objects with <code class="verbatim">make-instance</code>, but we'll make a custom constructor for convenience.</p>
        <div class="sourceCode" id="cb396" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb396-1"><a href="#cb396-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> make-account </span>(name code category &amp;optional (currency am:*default-currency*))</span>
            <span id="cb396-2"><a href="#cb396-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A constructor for ACCOUNT objects. CURRENCY defaults to</span></span>
            <span id="cb396-3"><a href="#cb396-3" aria-hidden="true" tabindex="-1"></a><span class="st">ALMIGHTY-MONEY:*DEFAULT-CURRENCY*.&quot;</span></span>
            <span id="cb396-4"><a href="#cb396-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (valid-account-category-p category)</span>
            <span id="cb396-5"><a href="#cb396-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">error</span> <span class="st">&quot;~a is not a valid account category.&quot;</span> category))</span>
            <span id="cb396-6"><a href="#cb396-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">make-instance</span> <span class="dt">&#39;account</span> <span class="bu">:name</span> name :code code :category category :currency currency))</span></code></pre></div>
        <p>That also allows us to validate the category.</p>
        <p>Because we need to store and retrieve accounts to and from SQL tables, we need some functions for doing that for accounts.</p>
        <div class="sourceCode" id="cb397" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> save-account </span>(account)</span>
            <span id="cb397-2"><a href="#cb397-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function for saving ACCOUNT rows to a database. Returns an error if the</span></span>
            <span id="cb397-3"><a href="#cb397-3" aria-hidden="true" tabindex="-1"></a><span class="st">account already exists.&quot;</span></span>
            <span id="cb397-4"><a href="#cb397-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((code (account-code account))</span>
            <span id="cb397-5"><a href="#cb397-5" aria-hidden="true" tabindex="-1"></a>         (account-exists (m:select-dao <span class="dt">&#39;account</span> (s:where (:= :code (account-code account))))))</span>
            <span id="cb397-6"><a href="#cb397-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">when</span> account-exists</span>
            <span id="cb397-7"><a href="#cb397-7" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="st">&quot;An account with code ~a already exists.&quot;</span> code))</span>
            <span id="cb397-8"><a href="#cb397-8" aria-hidden="true" tabindex="-1"></a>    (m:insert-dao account)))</span>
            <span id="cb397-9"><a href="#cb397-9" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb397-10"><a href="#cb397-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> get-or-create-account </span>(account)</span>
            <span id="cb397-11"><a href="#cb397-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function that takes an ACCOUNT object and searches your database for an</span></span>
            <span id="cb397-12"><a href="#cb397-12" aria-hidden="true" tabindex="-1"></a><span class="st">ACCOUNT with the same CODE. If one exists, it&#39;s returned. Eitherwise, it&#39;s</span></span>
            <span id="cb397-13"><a href="#cb397-13" aria-hidden="true" tabindex="-1"></a><span class="st">created and returned.&quot;</span></span>
            <span id="cb397-14"><a href="#cb397-14" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((account-exists (m:select-dao <span class="dt">&#39;account</span> (s:where (:= :code (account-code account))))))</span>
            <span id="cb397-15"><a href="#cb397-15" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> account-exists</span>
            <span id="cb397-16"><a href="#cb397-16" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">first</span> account-exists)</span>
            <span id="cb397-17"><a href="#cb397-17" aria-hidden="true" tabindex="-1"></a>        (m:insert-dao account))))</span>
            <span id="cb397-18"><a href="#cb397-18" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb397-19"><a href="#cb397-19" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> get-account </span>(account-code)</span>
            <span id="cb397-20"><a href="#cb397-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function that takes an ACCOUNT CODE and returns an ACCOUNT object. Returns an</span></span>
            <span id="cb397-21"><a href="#cb397-21" aria-hidden="true" tabindex="-1"></a><span class="st">error if an ACCOUNT with that CODE doesn&#39;t exist.&quot;</span></span>
            <span id="cb397-22"><a href="#cb397-22" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((account (<span class="kw">first</span> (m:select-dao <span class="dt">&#39;account</span></span>
            <span id="cb397-23"><a href="#cb397-23" aria-hidden="true" tabindex="-1"></a>                          (s:where (:= :code account-code))))))</span>
            <span id="cb397-24"><a href="#cb397-24" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">unless</span> account</span>
            <span id="cb397-25"><a href="#cb397-25" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="st">&quot;An account with code ~a doesn&#39;t exist.&quot;</span> account-code))</span>
            <span id="cb397-26"><a href="#cb397-26" aria-hidden="true" tabindex="-1"></a>    account))</span>
            <span id="cb397-27"><a href="#cb397-27" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb397-28"><a href="#cb397-28" aria-hidden="true" tabindex="-1"></a>(m:define-accessor account-transactions (this account)</span>
            <span id="cb397-29"><a href="#cb397-29" aria-hidden="true" tabindex="-1"></a>  (m:select-dao <span class="dt">&#39;transaction</span></span>
            <span id="cb397-30"><a href="#cb397-30" aria-hidden="true" tabindex="-1"></a>    (s:where (:= :account_id (object-id this)))))</span></code></pre></div>
        <p><code class="verbatim">save-account</code> is self-explanatory: We don't want duplicate accounts, so we prevent that with <code class="verbatim">save-account</code> by first doing a lookup for the <code class="verbatim">account-code</code> of the account we're trying to create.</p>
        <p><code class="verbatim">get-or-create-account</code> is useful for times where you want to ensure an account is saved in the database without causing an error if it already exists.</p>
        <p><code class="verbatim">get-account</code> makes it easy to get an account from a simple string containing an account code.</p>
        <p><code class="verbatim">define-accessor</code> is a mito macro useful for reducing database hits for things like one-to-many and many-to-many relationship queries. In this case, we have a one-to-many query: getting all the transactions for an account object we pass to it.</p>
        <p>For all of these, we used mito and sxql to query our database. Mito provides <code class="verbatim">select-dao</code>, a macro creating a list of Lisp objects containing the queried data. The first argument is a symbol–the name of a table defined with <code class="verbatim">mito:deftable</code>. It acts as the "SELECT * FROM [table-name]" part of a SQL query. You then provide the rest of the query using sxql.</p>
        <p>You'll notice that we refer to the <code class="verbatim">transaction</code> table in <code class="verbatim">account-transactions</code>. We'll define that next.</p>
        <h3 id="transactions">Transactions</h3>
        <p>When a transaction is made, such as a sale, a return, a payment, etc. we need to create different parts (what we'll call Legs)–debits and credits–that we need a way to know which parts go together. Transactions timestamps and ids are doing to be how we refer to groups of Legs.</p>
        <p>Transactions are simple to implement.</p>
        <div class="sourceCode" id="cb398" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb398-1"><a href="#cb398-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; * ░ TRANSACTION ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span></span>
            <span id="cb398-2"><a href="#cb398-2" aria-hidden="true" tabindex="-1"></a>(m:deftable transaction ()</span>
            <span id="cb398-3"><a href="#cb398-3" aria-hidden="true" tabindex="-1"></a>  ((date :col-type :timestamp</span>
            <span id="cb398-4"><a href="#cb398-4" aria-hidden="true" tabindex="-1"></a>         :inflate <span class="op">#&#39;</span>lt:universal-to-timestamp</span>
            <span id="cb398-5"><a href="#cb398-5" aria-hidden="true" tabindex="-1"></a>         :deflate <span class="op">#&#39;</span>lt:timestamp-to-universal))</span>
            <span id="cb398-6"><a href="#cb398-6" aria-hidden="true" tabindex="-1"></a>  (:table-name <span class="st">&quot;almighty_transaction&quot;</span>))</span>
            <span id="cb398-7"><a href="#cb398-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb398-8"><a href="#cb398-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> print-object </span>((this transaction) <span class="kw">stream</span>)</span>
            <span id="cb398-9"><a href="#cb398-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print-unreadable-object</span> (this <span class="kw">stream</span> <span class="bu">:type</span> <span class="kw">t</span> :identity <span class="kw">t</span>)</span>
            <span id="cb398-10"><a href="#cb398-10" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">with-slots</span> (date) this</span>
            <span id="cb398-11"><a href="#cb398-11" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a&quot;</span> date))))</span>
            <span id="cb398-12"><a href="#cb398-12" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb398-13"><a href="#cb398-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> make-transaction </span>(&amp;optional (date (lt:now)))</span>
            <span id="cb398-14"><a href="#cb398-14" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">make-instance</span> <span class="dt">&#39;transaction</span> :date date))</span></code></pre></div>
        <p>Mito provides the ability to set how a slot "inflates" and "deflates"–serializes into Lisp or SQL values. We are using <code class="verbatim">local-time</code> to convert between universal times and local-time timestamps. Universal times are a simple integer–the number of seconds after 2000-3-1. While it's not strictly necessary to serialize to universal times before saving to the database, it will make future queries easier.</p>
        <p><code class="verbatim">make-transaction</code> sets the default value of the <code class="verbatim">date</code> slot to <code class="verbatim">local-time:now</code>.</p>
        <h3 id="legs">Legs</h3>
        <p>The real fun begins with legs. Legs are like entries in the accounting books: This account was debited this amount at this time. A Transaction has to have at least two Legs–a debit and a credit–to be balanced. The whole purposes of a double-entry accounting system is to record at least two sides of a transaction to reduce errors in money tracking. If a transaction doesn't balance, that's a sign that there is an error in money tracking.</p>
        <p>So first, let's setup our leg table.</p>
        <div class="sourceCode" id="cb399" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb399-1"><a href="#cb399-1" aria-hidden="true" tabindex="-1"></a>(m:deftable leg ()</span>
            <span id="cb399-2"><a href="#cb399-2" aria-hidden="true" tabindex="-1"></a>  ((account :col-type account)</span>
            <span id="cb399-3"><a href="#cb399-3" aria-hidden="true" tabindex="-1"></a>   (side :col-type :integer)</span>
            <span id="cb399-4"><a href="#cb399-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Use LEG-ENTRY to access ENTRY-AMOUNT and ENTRY-CURRENCY as an</span></span>
            <span id="cb399-5"><a href="#cb399-5" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; ALMIGHTY-MONEY:MONEY object.</span></span>
            <span id="cb399-6"><a href="#cb399-6" aria-hidden="true" tabindex="-1"></a>   (entry-amount :col-type :integer)    <span class="co">; ALMIGHTY-MONEY:MONEY object AMOUNT.</span></span>
            <span id="cb399-7"><a href="#cb399-7" aria-hidden="true" tabindex="-1"></a>   (entry-currency :col-type :text) <span class="co">; ALMIGHTY-MONEY:MONEY object CURRENCY-CODE.</span></span>
            <span id="cb399-8"><a href="#cb399-8" aria-hidden="true" tabindex="-1"></a>   (transaction :col-type (<span class="kw">or</span> transaction :null)))</span>
            <span id="cb399-9"><a href="#cb399-9" aria-hidden="true" tabindex="-1"></a>  (:table-name <span class="st">&quot;almighty_leg&quot;</span>))</span>
            <span id="cb399-10"><a href="#cb399-10" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb399-11"><a href="#cb399-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> print-object </span>((this leg) <span class="kw">stream</span>)</span>
            <span id="cb399-12"><a href="#cb399-12" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">print-unreadable-object</span> (this <span class="kw">stream</span> <span class="bu">:type</span> <span class="kw">t</span> :identity <span class="kw">t</span>)</span>
            <span id="cb399-13"><a href="#cb399-13" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> ((account (<span class="kw">when</span> (<span class="kw">slot-boundp</span> this <span class="dt">&#39;account</span>) (<span class="kw">slot-value</span> this <span class="dt">&#39;account</span>)))</span>
            <span id="cb399-14"><a href="#cb399-14" aria-hidden="true" tabindex="-1"></a>          (transaction (<span class="kw">when</span> (<span class="kw">slot-boundp</span> this <span class="dt">&#39;transaction</span>) (<span class="kw">slot-value</span> this <span class="dt">&#39;transaction</span>)))) </span>
            <span id="cb399-15"><a href="#cb399-15" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a ~[DEBIT~;CREDIT~] ~a&quot;</span> account side (leg-entry this)))))</span></code></pre></div>
        <p>Mito allows us to assign <code class="verbatim">:col-type</code> to other tables, creating a relationship between different tables. The SQL table will actually have <code class="verbatim">account_id</code> and <code class="verbatim">transaction_id</code> columns corresponding to the ids of the other table rows.</p>
        <p><code class="verbatim">side</code> records whether a leg is a debit or a credit. Debits will be represented with 0, and credits with 1. This makes the format string in <code class="verbatim">print-object</code> easier: we use <code class="verbatim">tilde brackets</code> <code class="verbatim">~[...;...~]</code> to do conditional printing. If the value of <code class="verbatim">slot</code> is 0, then the first string (zero-indexed) will be printed. If it's 1, then the string after the <code class="verbatim">~;</code> will be printed. You can do this with an arbitrary number of integer values.</p>
        <div class="sourceCode" id="cb400" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb400-1"><a href="#cb400-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">format</span> <span class="kw">nil</span> <span class="st">&quot;~[HELLO~;GOODBYE~;KONNICHIWA~;SAYONARA~]&quot;</span> <span class="dv">0</span>)</span>
            <span id="cb400-2"><a href="#cb400-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;HELLO&quot;</span></span>
            <span id="cb400-3"><a href="#cb400-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">format</span> <span class="kw">nil</span> <span class="st">&quot;~[HELLO~;GOODBYE~;KONNICHIWA~;SAYONARA~]&quot;</span> <span class="dv">3</span>)</span>
            <span id="cb400-4"><a href="#cb400-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;SAYONARA&quot;</span></span></code></pre></div>
        <p><code class="verbatim">entry-amount</code> and <code class="verbatim">entry-currency</code> will record the amount of a certain currency of the leg. Ideally, we would be able to define some kind of custom <code class="verbatim">:col-type</code> for an <code class="verbatim">almighty-money:money</code> object and name it <code class="verbatim">entry</code>, but mito doesn't provide the ability to create custom column types on the Lisp side, so we will simulate it by creating an "accessor" for entries:</p>
        <div class="sourceCode" id="cb401" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb401-1"><a href="#cb401-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defgeneric</span><span class="fu"> leg-entry </span>(leg)</span>
            <span id="cb401-2"><a href="#cb401-2" aria-hidden="true" tabindex="-1"></a>  (:documentation <span class="st">&quot;A function for getting the ENTRY-AMOUNT and ENTRY-CURRENCY of a LEG object and returning a MONEY object.&quot;</span>)</span>
            <span id="cb401-3"><a href="#cb401-3" aria-hidden="true" tabindex="-1"></a>  (:method ((this leg))</span>
            <span id="cb401-4"><a href="#cb401-4" aria-hidden="true" tabindex="-1"></a>    (am:make-money (leg-entry-amount this) (leg-entry-currency this))))</span></code></pre></div>
        <p>Since all class slot accessors are generic functions, I am implementing <code class="verbatim">leg-entry</code> as a generic, too.</p>
        <p>Now we need a constructor.</p>
        <div class="sourceCode" id="cb402" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb402-1"><a href="#cb402-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> make-leg </span>(account side entry transaction)</span>
            <span id="cb402-2"><a href="#cb402-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A constructor for making LEG objects. ACCOUNT can either be an ACCOUNT object or</span></span>
            <span id="cb402-3"><a href="#cb402-3" aria-hidden="true" tabindex="-1"></a><span class="st">an ACCOUNT-CODE. ENTRY must receive an ALMIGHTY-MONEY:MONEY object.</span></span>
            <span id="cb402-4"><a href="#cb402-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb402-5"><a href="#cb402-5" aria-hidden="true" tabindex="-1"></a><span class="st">Usage example:</span></span>
            <span id="cb402-6"><a href="#cb402-6" aria-hidden="true" tabindex="-1"></a><span class="st">    (make-leg </span><span class="sc">\&quot;</span><span class="st">CODE000</span><span class="sc">\&quot;</span><span class="st"> (usd 5000))&quot;</span></span>
            <span id="cb402-7"><a href="#cb402-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((account (<span class="kw">etypecase</span> account</span>
            <span id="cb402-8"><a href="#cb402-8" aria-hidden="true" tabindex="-1"></a>                   (account account)</span>
            <span id="cb402-9"><a href="#cb402-9" aria-hidden="true" tabindex="-1"></a>                   (<span class="kw">string</span> (get-account account)))))</span>
            <span id="cb402-10"><a href="#cb402-10" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">unless</span> (am:moneyp entry)</span>
            <span id="cb402-11"><a href="#cb402-11" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="dt">&#39;type-error</span> :expected <span class="dt">&#39;am</span>:money :datum entry))</span>
            <span id="cb402-12"><a href="#cb402-12" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">make-instance</span> <span class="dt">&#39;leg</span> :account account</span>
            <span id="cb402-13"><a href="#cb402-13" aria-hidden="true" tabindex="-1"></a>                        :side side</span>
            <span id="cb402-14"><a href="#cb402-14" aria-hidden="true" tabindex="-1"></a>                        :entry-amount (am:amount entry)</span>
            <span id="cb402-15"><a href="#cb402-15" aria-hidden="true" tabindex="-1"></a>                        :entry-currency (am:currency-code entry)</span>
            <span id="cb402-16"><a href="#cb402-16" aria-hidden="true" tabindex="-1"></a>                        :transaction transaction)))</span></code></pre></div>
        <p>We use <code class="verbatim">etypecase</code> to convert from one a string <code class="verbatim">account-code</code> to an <code class="verbatim">account</code> object if necessary. We want <code class="verbatim">almighty-money:money</code> objects passed as the <code class="verbatim">entry</code>, so we signal a <code class="verbatim">type-error</code> condition if we don't get a <code class="verbatim">money</code> object in the <code class="verbatim">entry</code> position.</p>
        <p>Usually we don't want to use <code class="verbatim">make-leg</code> directly. Instead, we'll provide some helper functions for making debits and credits.</p>
        <div class="sourceCode" id="cb403" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *debit* </span><span class="op">-</span><span class="dv">1</span>)</span>
            <span id="cb403-2"><a href="#cb403-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *credit* </span><span class="dv">1</span>)</span>
            <span id="cb403-3"><a href="#cb403-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb403-4"><a href="#cb403-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> debit </span>(account amount)</span>
            <span id="cb403-5"><a href="#cb403-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function for constructing a LEG object with a side of *DEBIT*. The TRANSACTION</span></span>
            <span id="cb403-6"><a href="#cb403-6" aria-hidden="true" tabindex="-1"></a><span class="st">slot will be modified later before saving the row to the database.</span></span>
            <span id="cb403-7"><a href="#cb403-7" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb403-8"><a href="#cb403-8" aria-hidden="true" tabindex="-1"></a><span class="st">Usage examples:</span></span>
            <span id="cb403-9"><a href="#cb403-9" aria-hidden="true" tabindex="-1"></a><span class="st">    (debit </span><span class="sc">\&quot;</span><span class="st">CASH000</span><span class="sc">\&quot;</span><span class="st"> (usd 5000))</span></span>
            <span id="cb403-10"><a href="#cb403-10" aria-hidden="true" tabindex="-1"></a><span class="st">    (debit </span><span class="sc">\&quot;</span><span class="st">COGS000</span><span class="sc">\&quot;</span><span class="st"> 10000)</span></span>
            <span id="cb403-11"><a href="#cb403-11" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span></span>
            <span id="cb403-12"><a href="#cb403-12" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((account (<span class="kw">etypecase</span> account</span>
            <span id="cb403-13"><a href="#cb403-13" aria-hidden="true" tabindex="-1"></a>                   (account account)</span>
            <span id="cb403-14"><a href="#cb403-14" aria-hidden="true" tabindex="-1"></a>                   (<span class="kw">string</span> (get-account account))))</span>
            <span id="cb403-15"><a href="#cb403-15" aria-hidden="true" tabindex="-1"></a>        (amount (<span class="kw">etypecase</span> amount</span>
            <span id="cb403-16"><a href="#cb403-16" aria-hidden="true" tabindex="-1"></a>                  (<span class="kw">integer</span> (am:make-money amount))</span>
            <span id="cb403-17"><a href="#cb403-17" aria-hidden="true" tabindex="-1"></a>                  (am:money amount))))</span>
            <span id="cb403-18"><a href="#cb403-18" aria-hidden="true" tabindex="-1"></a>    (make-leg account *debit* (am:money* amount (side account) *debit*) <span class="kw">nil</span>)))</span>
            <span id="cb403-19"><a href="#cb403-19" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb403-20"><a href="#cb403-20" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> credit </span>(account amount)</span>
            <span id="cb403-21"><a href="#cb403-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function for constructing a LEG object with a side of *CREDIT*. The TRANSACTION</span></span>
            <span id="cb403-22"><a href="#cb403-22" aria-hidden="true" tabindex="-1"></a><span class="st">slot will be modified later before saving the row to the database.</span></span>
            <span id="cb403-23"><a href="#cb403-23" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb403-24"><a href="#cb403-24" aria-hidden="true" tabindex="-1"></a><span class="st">Usage example:</span></span>
            <span id="cb403-25"><a href="#cb403-25" aria-hidden="true" tabindex="-1"></a><span class="st">    (credit </span><span class="sc">\&quot;</span><span class="st">REV000</span><span class="sc">\&quot;</span><span class="st"> (usd 5000))</span></span>
            <span id="cb403-26"><a href="#cb403-26" aria-hidden="true" tabindex="-1"></a><span class="st">    (credit </span><span class="sc">\&quot;</span><span class="st">SLS000</span><span class="sc">\&quot;</span><span class="st"> 10000)</span></span>
            <span id="cb403-27"><a href="#cb403-27" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span></span>
            <span id="cb403-28"><a href="#cb403-28" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((account (<span class="kw">etypecase</span> account</span>
            <span id="cb403-29"><a href="#cb403-29" aria-hidden="true" tabindex="-1"></a>                   (account account)</span>
            <span id="cb403-30"><a href="#cb403-30" aria-hidden="true" tabindex="-1"></a>                   (<span class="kw">string</span> (get-account account))))</span>
            <span id="cb403-31"><a href="#cb403-31" aria-hidden="true" tabindex="-1"></a>        (amount (<span class="kw">etypecase</span> amount</span>
            <span id="cb403-32"><a href="#cb403-32" aria-hidden="true" tabindex="-1"></a>                  (<span class="kw">integer</span> (am:make-money amount))</span>
            <span id="cb403-33"><a href="#cb403-33" aria-hidden="true" tabindex="-1"></a>                  (am:money amount))))</span>
            <span id="cb403-34"><a href="#cb403-34" aria-hidden="true" tabindex="-1"></a>    (make-leg account *credit* (am:money* amount (side account) *credit*) <span class="kw">nil</span>)))</span></code></pre></div>
        <p>The <code class="verbatim">amount</code> can be either a <code class="verbatim">almighty-money:money</code> object, or a simple integer. If it's an integer, then we convert it to a <code class="verbatim">money</code> object using the <code class="verbatim">almighty-money:*default-currency*</code>. Unless you're dealing with multiple currencies, you can simply set the <code class="verbatim">*default-currency*</code> for your application and save yourself some typing.</p>
        <p>Remember that <code class="verbatim">almighty-money</code> only supports <code class="verbatim">USD</code> and <code class="verbatim">JPY</code> at the moment. If you want to use some other currency in <code class="verbatim">almighty-kaikei</code>, you need to add support to <code class="verbatim">almighty-money</code>.</p>
        <p>The important bit is the fact that we take the <code class="verbatim">amount</code> and multiply it by the side of the account <em>and</em> by <code class="verbatim">*debit*</code> or <code class="verbatim">*credit*</code>. An asset account that is credited should save a <em>negative</em> amount into the database–crediting a left-hand-side account should <em>decrease</em> its value. On the other hand, crediting a right-hand-side account should <em>increase</em> its value.</p>
        <p>It might be clarifying to look at the math this way:</p>
        <div class="sourceCode" id="cb404" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> ((lhs <span class="op">-</span><span class="dv">1</span>)</span>
            <span id="cb404-2"><a href="#cb404-2" aria-hidden="true" tabindex="-1"></a>      (rhs <span class="dv">1</span>)</span>
            <span id="cb404-3"><a href="#cb404-3" aria-hidden="true" tabindex="-1"></a>      (debit <span class="op">-</span><span class="dv">1</span>)</span>
            <span id="cb404-4"><a href="#cb404-4" aria-hidden="true" tabindex="-1"></a>      (credit <span class="dv">1</span>)</span>
            <span id="cb404-5"><a href="#cb404-5" aria-hidden="true" tabindex="-1"></a>      (amount <span class="dv">7</span>))</span>
            <span id="cb404-6"><a href="#cb404-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">list</span> (<span class="op">*</span> amount lhs debit)</span>
            <span id="cb404-7"><a href="#cb404-7" aria-hidden="true" tabindex="-1"></a>        (<span class="op">*</span> amount lhs credit)</span>
            <span id="cb404-8"><a href="#cb404-8" aria-hidden="true" tabindex="-1"></a>        (<span class="op">*</span> amount rhs debit)</span>
            <span id="cb404-9"><a href="#cb404-9" aria-hidden="true" tabindex="-1"></a>        (<span class="op">*</span> amount rhs credit)))</span>
            <span id="cb404-10"><a href="#cb404-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (7 -7 -7 7)</span></span></code></pre></div>
        <p>We're getting close to being able to make a transaction. Before we get there, we need to be able to tell debit legs from credit legs so we can see if the two sides of the transaction are balanced.</p>
        <div class="sourceCode" id="cb405" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb405-1"><a href="#cb405-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> debit-p </span>(leg)</span>
            <span id="cb405-2"><a href="#cb405-2" aria-hidden="true" tabindex="-1"></a>  (<span class="op">=</span> (leg-side leg) *debit*))</span>
            <span id="cb405-3"><a href="#cb405-3" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb405-4"><a href="#cb405-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> credit-p </span>(leg)</span>
            <span id="cb405-5"><a href="#cb405-5" aria-hidden="true" tabindex="-1"></a>  (<span class="op">=</span> (leg-side leg) *credit*))</span>
            <span id="cb405-6"><a href="#cb405-6" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb405-7"><a href="#cb405-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> sides-balanced-p </span>(legs)</span>
            <span id="cb405-8"><a href="#cb405-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((debits (sum-all-if <span class="op">#&#39;</span>debit-p legs))</span>
            <span id="cb405-9"><a href="#cb405-9" aria-hidden="true" tabindex="-1"></a>        (credits (sum-all-if <span class="op">#&#39;</span>credit-p legs)))</span>
            <span id="cb405-10"><a href="#cb405-10" aria-hidden="true" tabindex="-1"></a>    (<span class="op">=</span> (<span class="kw">abs</span> (am:amount debits)) (<span class="kw">abs</span> (am:amount credits)))))</span></code></pre></div>
        <p>Note that we are looking at the absolute value of the debit and credit amounts. As mentioned before, crediting a left-hand-side account will result in a <em>negative</em> value being passed to <code class="verbatim">make-leg</code>, the same is if you debited a right-hand-side account like an income account. The effect is that we always are going to have a positive and a negative value in our transactions. Both should have the same absolute value, though.</p>
        <p>Finally, we make the <code class="verbatim">transact!</code> function.</p>
        <div class="sourceCode" id="cb406" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb406-1"><a href="#cb406-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">define-condition</span><span class="fu"> unbalanced-transaction </span>(<span class="kw">error</span>)</span>
            <span id="cb406-2"><a href="#cb406-2" aria-hidden="true" tabindex="-1"></a>  ((debit-amount :initarg :debit-amount :reader debit-amount)</span>
            <span id="cb406-3"><a href="#cb406-3" aria-hidden="true" tabindex="-1"></a>   (credit-amount :initarg :credit-amount :reader credit-amount)</span>
            <span id="cb406-4"><a href="#cb406-4" aria-hidden="true" tabindex="-1"></a>   (message :initarg :message :reader message</span>
            <span id="cb406-5"><a href="#cb406-5" aria-hidden="true" tabindex="-1"></a>            :initform <span class="st">&quot;Left and right entries of the transaction do not balance.&quot;</span>))</span>
            <span id="cb406-6"><a href="#cb406-6" aria-hidden="true" tabindex="-1"></a>  (:report (<span class="kw">lambda</span> (<span class="kw">condition</span> <span class="kw">stream</span>)</span>
            <span id="cb406-7"><a href="#cb406-7" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">with-slots</span> (debit-amount credit-amount message) <span class="kw">condition</span></span>
            <span id="cb406-8"><a href="#cb406-8" aria-hidden="true" tabindex="-1"></a>               (<span class="kw">format</span> <span class="kw">stream</span> <span class="st">&quot;~a LEFT: ~a | RIGHT: ~a&quot;</span> message debit-amount credit-amount)))))</span>
            <span id="cb406-9"><a href="#cb406-9" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb406-10"><a href="#cb406-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> record-transaction </span>(transaction legs)</span>
            <span id="cb406-11"><a href="#cb406-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;A function for saving the data rows of a transaction to a SQL database: Legs for</span></span>
            <span id="cb406-12"><a href="#cb406-12" aria-hidden="true" tabindex="-1"></a><span class="st">the transaction, and the Transaction itself.&quot;</span></span>
            <span id="cb406-13"><a href="#cb406-13" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((transaction (m:insert-dao transaction)))</span>
            <span id="cb406-14"><a href="#cb406-14" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">loop</span> :for leg :in legs</span>
            <span id="cb406-15"><a href="#cb406-15" aria-hidden="true" tabindex="-1"></a>          :do (m:insert-dao leg))</span>
            <span id="cb406-16"><a href="#cb406-16" aria-hidden="true" tabindex="-1"></a>    transaction))</span>
            <span id="cb406-17"><a href="#cb406-17" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb406-18"><a href="#cb406-18" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> transact</span>! (&amp;<span class="kw">rest</span> legs)</span>
            <span id="cb406-19"><a href="#cb406-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function for making a double-entry accounting transaction having at least one</span></span>
            <span id="cb406-20"><a href="#cb406-20" aria-hidden="true" tabindex="-1"></a><span class="st">debit and one credit leg.</span></span>
            <span id="cb406-21"><a href="#cb406-21" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb406-22"><a href="#cb406-22" aria-hidden="true" tabindex="-1"></a><span class="st">If there is a LOCAL-TIME:TIMESTAMP in LEGS, the first one is used for the</span></span>
            <span id="cb406-23"><a href="#cb406-23" aria-hidden="true" tabindex="-1"></a><span class="st">transaction. If no LOCAL-TIME:TIMESTAMP is in LEGS, uses LOCAL-TIME:NOW for the</span></span>
            <span id="cb406-24"><a href="#cb406-24" aria-hidden="true" tabindex="-1"></a><span class="st">transaction.</span></span>
            <span id="cb406-25"><a href="#cb406-25" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb406-26"><a href="#cb406-26" aria-hidden="true" tabindex="-1"></a><span class="st">Returns an UNBALANCED-TRANSACTION error if debits /= credits.</span></span>
            <span id="cb406-27"><a href="#cb406-27" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb406-28"><a href="#cb406-28" aria-hidden="true" tabindex="-1"></a><span class="st">Usage Examples:</span></span>
            <span id="cb406-29"><a href="#cb406-29" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb406-30"><a href="#cb406-30" aria-hidden="true" tabindex="-1"></a><span class="st">    (transact! (debit </span><span class="sc">\&quot;</span><span class="st">CASH000</span><span class="sc">\&quot;</span><span class="st"> 5000)</span></span>
            <span id="cb406-31"><a href="#cb406-31" aria-hidden="true" tabindex="-1"></a><span class="st">               (credit </span><span class="sc">\&quot;</span><span class="st">REV000</span><span class="sc">\&quot;</span><span class="st"> 5000))</span></span>
            <span id="cb406-32"><a href="#cb406-32" aria-hidden="true" tabindex="-1"></a><span class="st">    (transact! (local-time:parse-timestring </span><span class="sc">\&quot;</span><span class="st">2025-12-25</span><span class="sc">\&quot;</span><span class="st">)</span></span>
            <span id="cb406-33"><a href="#cb406-33" aria-hidden="true" tabindex="-1"></a><span class="st">               (debit </span><span class="sc">\&quot;</span><span class="st">CASH000</span><span class="sc">\&quot;</span><span class="st"> 5000)</span></span>
            <span id="cb406-34"><a href="#cb406-34" aria-hidden="true" tabindex="-1"></a><span class="st">               (credit </span><span class="sc">\&quot;</span><span class="st">REV000</span><span class="sc">\&quot;</span><span class="st"> 5000))</span></span>
            <span id="cb406-35"><a href="#cb406-35" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span></span>
            <span id="cb406-36"><a href="#cb406-36" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((date (<span class="kw">or</span> (<span class="kw">find-if</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (x) (<span class="kw">typep</span> x <span class="dt">&#39;lt</span>:timestamp)) legs) (lt:now)))</span>
            <span id="cb406-37"><a href="#cb406-37" aria-hidden="true" tabindex="-1"></a>        (legs (<span class="kw">remove-if-not</span> <span class="op">#&#39;</span>(<span class="kw">lambda</span> (x) (<span class="kw">typep</span> x <span class="dt">&#39;leg</span>)) legs)))</span>
            <span id="cb406-38"><a href="#cb406-38" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">unless</span> (<span class="op">&gt;</span> (<span class="kw">length</span> legs) <span class="dv">1</span>)</span>
            <span id="cb406-39"><a href="#cb406-39" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="st">&quot;transactions must have at least two legs.&quot;</span>))</span>
            <span id="cb406-40"><a href="#cb406-40" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">unless</span> (<span class="kw">and</span> (<span class="kw">find-if</span> <span class="op">#&#39;</span>debit-p legs)</span>
            <span id="cb406-41"><a href="#cb406-41" aria-hidden="true" tabindex="-1"></a>                 (<span class="kw">find-if</span> <span class="op">#&#39;</span>credit-p legs))</span>
            <span id="cb406-42"><a href="#cb406-42" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="st">&quot;transactions must have at least one debit and one credit leg.&quot;</span>))</span>
            <span id="cb406-43"><a href="#cb406-43" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> ((transaction (make-transaction date))</span>
            <span id="cb406-44"><a href="#cb406-44" aria-hidden="true" tabindex="-1"></a>          (debits (sum-all-if <span class="op">#&#39;</span>debit-p legs))</span>
            <span id="cb406-45"><a href="#cb406-45" aria-hidden="true" tabindex="-1"></a>          (credits (sum-all-if <span class="op">#&#39;</span>credit-p legs)))</span>
            <span id="cb406-46"><a href="#cb406-46" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">unless</span> (sides-balanced-p legs)</span>
            <span id="cb406-47"><a href="#cb406-47" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">error</span> <span class="dt">&#39;unbalanced-transaction</span></span>
            <span id="cb406-48"><a href="#cb406-48" aria-hidden="true" tabindex="-1"></a>               :debit-amount (am:amount debits)</span>
            <span id="cb406-49"><a href="#cb406-49" aria-hidden="true" tabindex="-1"></a>               :credit-amount (am:amount credits)))</span>
            <span id="cb406-50"><a href="#cb406-50" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">loop</span> :for leg :in legs</span>
            <span id="cb406-51"><a href="#cb406-51" aria-hidden="true" tabindex="-1"></a>            :do (<span class="kw">setf</span> (leg-transaction leg) transaction))</span>
            <span id="cb406-52"><a href="#cb406-52" aria-hidden="true" tabindex="-1"></a>      (record-transaction transaction legs))))</span></code></pre></div>
        <p>If we look at <code class="verbatim">transact!</code> first, it can take an arbitrary number of legs. Since <code class="verbatim">legs</code> is a <code class="verbatim">&amp;rest</code> parameter, legs will be accessible in a list. First, we check to see if any of the arguments are a <code class="verbatim">local-time:timestamp</code>. If we find one, we will use that for the transaction.</p>
        <p>After that, we're going to ensure first that we have at least two legs. We also ensure that there is at least one debit and one credit in there. If the sides are all balanced, we add a <code class="verbatim">transaction</code> to the transaction slot of all the <code class="verbatim">legs</code> and save the transaction to the database.</p>
        <p>If the sides are unbalanced, we signal an <code class="verbatim">unbalanced-transaction</code> error. Creating and signaling a condition will make it easy to take specific actions for that kind of error (in a web application, we'd like to send the error to the user in the browser, for example).</p>
        <h3 id="playing-around">Playing around</h3>
        <p>Before we continue, how about we try playing with the code. In order to actually create any data, first we need to connect to our database and create tables. For right now, let's just keep things simple by establishing a long-lasting connection at toplevel.</p>
        <div class="sourceCode" id="cb407" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb407-1"><a href="#cb407-1" aria-hidden="true" tabindex="-1"></a>(mito:connect-toplevel :sqlite3 :database-name <span class="st">&quot;t/test.db&quot;</span>)</span></code></pre></div>
        <p>If you forgot to make a <code class="verbatim">t</code> directory for tests during project setup, you should do that before running the above code.</p>
        <p>Later, you can disconnect using <code class="verbatim">disconnect-toplevel</code></p>
        <div class="sourceCode" id="cb408" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb408-1"><a href="#cb408-1" aria-hidden="true" tabindex="-1"></a>(mito:disconnect-toplevel)</span></code></pre></div>
        <p>After establishing a connection, we need to create the tables. Mito provides a useful function for this purpose:</p>
        <div class="sourceCode" id="cb409" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb409-1"><a href="#cb409-1" aria-hidden="true" tabindex="-1"></a>(m:ensure-table-exists <span class="dt">&#39;account</span>)</span>
            <span id="cb409-2"><a href="#cb409-2" aria-hidden="true" tabindex="-1"></a>(m:ensure-table-exists <span class="dt">&#39;transaction</span>)</span>
            <span id="cb409-3"><a href="#cb409-3" aria-hidden="true" tabindex="-1"></a>(m:ensure-table-exists <span class="dt">&#39;leg</span>)</span></code></pre></div>
        <p><code class="verbatim">ensure-table-exists</code> will look to see if a table exists. If it doesn't, it creates it. Otherwise, it returns <code class="verbatim">nil</code>.</p>
        <p>Once you have your tables, you need some accounts to mess with.</p>
        <div class="sourceCode" id="cb410" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb410-1"><a href="#cb410-1" aria-hidden="true" tabindex="-1"></a>(save-account (make-account <span class="st">&quot;Cash&quot;</span> <span class="st">&quot;CSH000&quot;</span> <span class="st">&quot;asset&quot;</span>))</span>
            <span id="cb410-2"><a href="#cb410-2" aria-hidden="true" tabindex="-1"></a>(save-account (make-account <span class="st">&quot;Sales Revenue&quot;</span> <span class="st">&quot;REV000&quot;</span> <span class="st">&quot;income&quot;</span>))</span></code></pre></div>
        <p>We'll just make these for now.</p>
        <p>Let's make a sale: customer pays cash for something.</p>
        <div class="sourceCode" id="cb411" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb411-1"><a href="#cb411-1" aria-hidden="true" tabindex="-1"></a>(transact! (debit <span class="st">&quot;CSH000&quot;</span> (usd <span class="dv">5000</span>))</span>
            <span id="cb411-2"><a href="#cb411-2" aria-hidden="true" tabindex="-1"></a>           (credit <span class="st">&quot;REV000&quot;</span> (usd <span class="dv">5000</span>)))</span>
            <span id="cb411-3"><a href="#cb411-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;TRANSACTION 2025-11-26T04:41:56.367255Z {700805E313}&gt;</span></span></code></pre></div>
        <p>We can look at the contents of the database using Emacs' built-in <code class="verbatim">sqlite-mode</code> for looking at SQLite databases. Type <code class="verbatim">M-x sqlite-mode-open-file</code> and open <code class="verbatim">t/test.db</code>. You should see the names of the tables we made and the number of rows in each table.</p>
        <table>
            <thead>
                <tr>
                    <th>Table Name</th>
                    <th>Number of Rows</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>almighty<sub>account</sub></td>
                    <td>2</td>
                </tr>
                <tr>
                    <td>almighty<sub>leg</sub></td>
                    <td>2</td>
                </tr>
                <tr>
                    <td>almighty<sub>transaction</sub></td>
                    <td>1</td>
                </tr>
            </tbody>
        </table>
        <p>If you switch from Evil's <code class="verbatim">Normal-mode</code> to <code class="verbatim">Emacs-mode</code>, a mode that acts exactly like if you weren't using Evil at all, then you can even press <code class="verbatim">Enter</code> on a table name and see the rows and their data.</p>
        <h3 id="account-balance">Account Balance</h3>
        <p>So we've confirmed that we're saving data to the database, but now we need to know something about the accounts: What are their current balances? For that, we need write another function.</p>
        <div class="sourceCode" id="cb412" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb412-1"><a href="#cb412-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> account-legs </span>(account &amp;optional (as-of (universal-now)))</span>
            <span id="cb412-2"><a href="#cb412-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function for getting all the legs of an account as of a certain time,</span></span>
            <span id="cb412-3"><a href="#cb412-3" aria-hidden="true" tabindex="-1"></a><span class="st">defaulting to now.</span></span>
            <span id="cb412-4"><a href="#cb412-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb412-5"><a href="#cb412-5" aria-hidden="true" tabindex="-1"></a><span class="st">Usage Examples:</span></span>
            <span id="cb412-6"><a href="#cb412-6" aria-hidden="true" tabindex="-1"></a><span class="st">    (account-legs </span><span class="sc">\&quot;</span><span class="st">CSH000</span><span class="sc">\&quot;</span><span class="st">)</span></span>
            <span id="cb412-7"><a href="#cb412-7" aria-hidden="true" tabindex="-1"></a><span class="st">    (account-legs sales-account-object transaction-object)</span></span>
            <span id="cb412-8"><a href="#cb412-8" aria-hidden="true" tabindex="-1"></a><span class="st">    (account-legs cogs-account-object (local-time:parse-timestring </span><span class="sc">\&quot;</span><span class="st">2025-11-27</span><span class="sc">\&quot;</span><span class="st">))</span></span>
            <span id="cb412-9"><a href="#cb412-9" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span></span>
            <span id="cb412-10"><a href="#cb412-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((account (<span class="kw">etypecase</span> account</span>
            <span id="cb412-11"><a href="#cb412-11" aria-hidden="true" tabindex="-1"></a>                    (account account)</span>
            <span id="cb412-12"><a href="#cb412-12" aria-hidden="true" tabindex="-1"></a>                    (<span class="kw">string</span> (get-account account))))</span>
            <span id="cb412-13"><a href="#cb412-13" aria-hidden="true" tabindex="-1"></a>         (as-of (<span class="kw">etypecase</span> as-of</span>
            <span id="cb412-14"><a href="#cb412-14" aria-hidden="true" tabindex="-1"></a>                  (lt:timestamp (lt:timestamp-to-universal as-of))</span>
            <span id="cb412-15"><a href="#cb412-15" aria-hidden="true" tabindex="-1"></a>                  (transaction (lt:timestamp-to-universal (transaction-date as-of)))</span>
            <span id="cb412-16"><a href="#cb412-16" aria-hidden="true" tabindex="-1"></a>                  (<span class="kw">string</span> (lt:timestamp-to-universal (lt:parse-timestring as-of)))</span>
            <span id="cb412-17"><a href="#cb412-17" aria-hidden="true" tabindex="-1"></a>                  (<span class="kw">integer</span> as-of))))</span>
            <span id="cb412-18"><a href="#cb412-18" aria-hidden="true" tabindex="-1"></a>    (m:select-by-sql <span class="dt">&#39;leg</span></span>
            <span id="cb412-19"><a href="#cb412-19" aria-hidden="true" tabindex="-1"></a>                     (s:select :*</span>
            <span id="cb412-20"><a href="#cb412-20" aria-hidden="true" tabindex="-1"></a>                       (s:from (:as :almighty_leg :l))</span>
            <span id="cb412-21"><a href="#cb412-21" aria-hidden="true" tabindex="-1"></a>                       (s:inner-join (:as :almighty_transaction :t) :on (:= :l.transaction_id :t.id))</span>
            <span id="cb412-22"><a href="#cb412-22" aria-hidden="true" tabindex="-1"></a>                       (s:where (:and (:= :l.account_id (m:object-id account))</span>
            <span id="cb412-23"><a href="#cb412-23" aria-hidden="true" tabindex="-1"></a>                                      (:&lt;= :t.date as-of)))))))</span>
            <span id="cb412-24"><a href="#cb412-24" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb412-25"><a href="#cb412-25" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> account-balance </span>(account &amp;optional (as-of (universal-now)))</span>
            <span id="cb412-26"><a href="#cb412-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function for getting the balance of an account at a certain point in time,</span></span>
            <span id="cb412-27"><a href="#cb412-27" aria-hidden="true" tabindex="-1"></a><span class="st">defaulting to now.</span></span>
            <span id="cb412-28"><a href="#cb412-28" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb412-29"><a href="#cb412-29" aria-hidden="true" tabindex="-1"></a><span class="st">Usage Example:</span></span>
            <span id="cb412-30"><a href="#cb412-30" aria-hidden="true" tabindex="-1"></a><span class="st">    (account-balance </span><span class="sc">\&quot;</span><span class="st">CSH000</span><span class="sc">\&quot;</span><span class="st">)</span></span>
            <span id="cb412-31"><a href="#cb412-31" aria-hidden="true" tabindex="-1"></a><span class="st">    (account-balance sales-account-object)</span></span>
            <span id="cb412-32"><a href="#cb412-32" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span></span>
            <span id="cb412-33"><a href="#cb412-33" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((account (<span class="kw">if</span> (<span class="kw">stringp</span> account)</span>
            <span id="cb412-34"><a href="#cb412-34" aria-hidden="true" tabindex="-1"></a>                      (get-account account)</span>
            <span id="cb412-35"><a href="#cb412-35" aria-hidden="true" tabindex="-1"></a>                      account))</span>
            <span id="cb412-36"><a href="#cb412-36" aria-hidden="true" tabindex="-1"></a>         (legs (account-legs account as-of)))</span>
            <span id="cb412-37"><a href="#cb412-37" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> legs</span>
            <span id="cb412-38"><a href="#cb412-38" aria-hidden="true" tabindex="-1"></a>        (am:money* (<span class="kw">reduce</span> <span class="op">#&#39;</span>am:money+ (<span class="kw">mapcar</span> <span class="op">#&#39;</span>leg-entry legs)) (side account))</span>
            <span id="cb412-39"><a href="#cb412-39" aria-hidden="true" tabindex="-1"></a>        (am:make-money <span class="dv">0</span> (account-currency account)))))</span></code></pre></div>
        <p><code class="verbatim">account-legs</code> gets all the legs for an account, filtered by the date of the transaction. <code class="verbatim">account-balance</code> sums up the debit and credit legs of an account then subtracts debits from credits or credits from debits depending on the type of account.</p>
        <h3 id="long-term-problems">Long-term problems</h3>
        <ol class="incremental">
            <li><p>Many transactions</p>
                <p>Everything is chugging along quite nicely, but there's a problem. If you're familiar with database query optimization, you probably already wrote a nasty post about me on X when we made the <code class="verbatim">account-balance</code> function.</p>
                <p>"You absolute clown, you're getting <em>all</em> of the leg rows for a certain account, then passing them to Lisp to do the summation of their debits and credits? Delete this book."</p>
                <p>This is a reasonable position to have. With very few leg rows, this isn't really such a big deal. However, as the number of leg rows grows, the slower the operation will become. We can confirm that by making some mock data and then running <code class="verbatim">account-balance</code> on it.</p>
                <div class="sourceCode" id="cb413" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb413-1"><a href="#cb413-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Create lots of mock data, saving to disk. If you already had some test data</span></span>
                    <span id="cb413-2"><a href="#cb413-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; of your own, you can delete the .db file before running this.</span></span>
                    <span id="cb413-3"><a href="#cb413-3" aria-hidden="true" tabindex="-1"></a><span class="co">;; </span></span>
                    <span id="cb413-4"><a href="#cb413-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; This will take some time. Emacs will freeze while this process runs.</span></span>
                    <span id="cb413-5"><a href="#cb413-5" aria-hidden="true" tabindex="-1"></a>(with-coa</span>
                    <span id="cb413-6"><a href="#cb413-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((cash (ak:get-account <span class="st">&quot;CSH000&quot;</span>))</span>
                    <span id="cb413-7"><a href="#cb413-7" aria-hidden="true" tabindex="-1"></a>        (sale (ak:get-account <span class="st">&quot;SLS000&quot;</span>))</span>
                    <span id="cb413-8"><a href="#cb413-8" aria-hidden="true" tabindex="-1"></a>        (date (lt:now))</span>
                    <span id="cb413-9"><a href="#cb413-9" aria-hidden="true" tabindex="-1"></a>        (times <span class="dv">100000</span>)</span>
                    <span id="cb413-10"><a href="#cb413-10" aria-hidden="true" tabindex="-1"></a>        (amount <span class="dv">500</span>))</span>
                    <span id="cb413-11"><a href="#cb413-11" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">dotimes</span> (i times)</span>
                    <span id="cb413-12"><a href="#cb413-12" aria-hidden="true" tabindex="-1"></a>      (ak:transact! (ak:debit cash (am:usd amount))</span>
                    <span id="cb413-13"><a href="#cb413-13" aria-hidden="true" tabindex="-1"></a>                    (ak:credit sale (am:usd amount))</span>
                    <span id="cb413-14"><a href="#cb413-14" aria-hidden="true" tabindex="-1"></a>                    date))))</span>
                    <span id="cb413-15"><a href="#cb413-15" aria-hidden="true" tabindex="-1"></a><span class="co">;; Run ACCOUNT-BALANCE on mock data</span></span>
                    <span id="cb413-16"><a href="#cb413-16" aria-hidden="true" tabindex="-1"></a>(with-coa (ak:account-balance <span class="st">&quot;CSH000&quot;</span>))</span></code></pre></div>
                <p>If you run <code class="verbatim">account-balance</code> now, there will be a noticable lag between executing and receiving the return value.</p>
                <p>Let's do some basic profiling:</p>
                <div class="sourceCode" id="cb414" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb414-1"><a href="#cb414-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">time</span> (with-coa (ak:account-balance <span class="st">&quot;CSH000&quot;</span>)))</span></code></pre></div>
                <p><code class="verbatim">time</code> is a function for basic, dirty profiling. It will show how long it takes to complete a task along with some other information. If you run it in the REPL, you should get a result that looks something like this:</p>
                <pre class="example"><code>Evaluation took:
  2.944 seconds of real time
  2.950970 seconds of total run time (2.826497 user, 0.124473 system)
  [ Real times consist of 0.256 seconds GC time, and 2.688 seconds non-GC time. ]
  [ Run times consist of 0.254 seconds GC time, and 2.697 seconds non-GC time. ]
  100.24% CPU
  7 forms interpreted
  1,680,876,464 bytes consed
                </code></pre>
                <p>Well, what happens if we add a check for the account balance of the sales account?</p>
                <div class="sourceCode" id="cb416" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb416-1"><a href="#cb416-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">time</span> (with-coa</span>
                    <span id="cb416-2"><a href="#cb416-2" aria-hidden="true" tabindex="-1"></a>        (ak:account-balance-slow <span class="st">&quot;CSH000&quot;</span>)</span>
                    <span id="cb416-3"><a href="#cb416-3" aria-hidden="true" tabindex="-1"></a>        (ak:account-balance-slow <span class="st">&quot;SLS000&quot;</span>)))</span></code></pre></div>
                <p>The result:</p>
                <pre class="example"><code>Evaluation took:
  5.879 seconds of real time
  5.890071 seconds of total run time (5.630371 user, 0.259700 system)
  [ Real times consist of 0.511 seconds GC time, and 5.368 seconds non-GC time. ]
  [ Run times consist of 0.509 seconds GC time, and 5.382 seconds non-GC time. ]
  100.19% CPU
  7 forms interpreted
  3,361,540,272 bytes consed
                </code></pre>
                <p>As suspected, <code class="verbatim">account-balance</code> is going to be a problem in the long-term. We need to optimize.</p></li>
        </ol>
        <h3 id="optimization">Optimization</h3>
        <p>We could try getting back less data in our <code class="verbatim">account-legs</code> function just as an experiment.</p>
        <div class="sourceCode" id="cb418"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb418-1"><a href="#cb418-1" aria-hidden="true" tabindex="-1"></a>(defun account-legs (account &amp;optional (as-of (universal-now)))</span>
            <span id="cb418-2"><a href="#cb418-2" aria-hidden="true" tabindex="-1"></a>  &quot;A function for getting all the legs of an account as of a certain time,</span>
            <span id="cb418-3"><a href="#cb418-3" aria-hidden="true" tabindex="-1"></a>defaulting to now.</span>
            <span id="cb418-4"><a href="#cb418-4" aria-hidden="true" tabindex="-1"></a></span>
            <span id="cb418-5"><a href="#cb418-5" aria-hidden="true" tabindex="-1"></a>Usage Examples:</span>
            <span id="cb418-6"><a href="#cb418-6" aria-hidden="true" tabindex="-1"></a>    (account-legs \&quot;CSH000\&quot;)</span>
            <span id="cb418-7"><a href="#cb418-7" aria-hidden="true" tabindex="-1"></a>    (account-legs sales-account-object transaction-object)</span>
            <span id="cb418-8"><a href="#cb418-8" aria-hidden="true" tabindex="-1"></a>    (account-legs cogs-account-object (local-time:parse-timestring \&quot;2025-11-27\&quot;))</span>
            <span id="cb418-9"><a href="#cb418-9" aria-hidden="true" tabindex="-1"></a>&quot;</span>
            <span id="cb418-10"><a href="#cb418-10" aria-hidden="true" tabindex="-1"></a>  (let* ((account (etypecase account</span>
            <span id="cb418-11"><a href="#cb418-11" aria-hidden="true" tabindex="-1"></a>                    (account account)</span>
            <span id="cb418-12"><a href="#cb418-12" aria-hidden="true" tabindex="-1"></a>                    (string (get-account account))))</span>
            <span id="cb418-13"><a href="#cb418-13" aria-hidden="true" tabindex="-1"></a>         (as-of (etypecase as-of</span>
            <span id="cb418-14"><a href="#cb418-14" aria-hidden="true" tabindex="-1"></a>                  (lt:timestamp (lt:timestamp-to-universal as-of))</span>
            <span id="cb418-15"><a href="#cb418-15" aria-hidden="true" tabindex="-1"></a>                  (transaction (lt:timestamp-to-universal (transaction-date as-of)))</span>
            <span id="cb418-16"><a href="#cb418-16" aria-hidden="true" tabindex="-1"></a>                  (string (lt:timestamp-to-universal (lt:parse-timestring as-of)))</span>
            <span id="cb418-17"><a href="#cb418-17" aria-hidden="true" tabindex="-1"></a>                  (integer as-of))))</span>
            <span id="cb418-18"><a href="#cb418-18" aria-hidden="true" tabindex="-1"></a>    (m:select-by-sql &#39;leg</span>
            <span id="cb418-19"><a href="#cb418-19" aria-hidden="true" tabindex="-1"></a><span class="st">-                    (s:select :*</span></span>
            <span id="cb418-20"><a href="#cb418-20" aria-hidden="true" tabindex="-1"></a><span class="va">+                    (s:select (:entry_amount :entry_currency :side)</span></span>
            <span id="cb418-21"><a href="#cb418-21" aria-hidden="true" tabindex="-1"></a>                       (s:from (:as :almighty_leg :l))</span>
            <span id="cb418-22"><a href="#cb418-22" aria-hidden="true" tabindex="-1"></a>                       (s:inner-join (:as :almighty_transaction :t) :on (:= :l.transaction_id :t.id))</span>
            <span id="cb418-23"><a href="#cb418-23" aria-hidden="true" tabindex="-1"></a>                       (s:where (:and (:= :l.account_id (m:object-id account))</span>
            <span id="cb418-24"><a href="#cb418-24" aria-hidden="true" tabindex="-1"></a>                                      (:&lt;= :t.date as-of)))))))</span></code></pre></div>
        <p>If we run our little test again (running <code class="verbatim">account-balance</code> twice) we get:</p>
        <pre class="example"><code>Evaluation took:
  1.296 seconds of real time
  1.300803 seconds of total run time (1.235469 user, 0.065334 system)
  [ Real times consist of 0.112 seconds GC time, and 1.184 seconds non-GC time. ]
  [ Run times consist of 0.112 seconds GC time, and 1.189 seconds non-GC time. ]
  100.39% CPU
  7 forms interpreted
  782,634,128 bytes consed
        </code></pre>
        <p>This confirms that we are definitely being bogged down by all this object construction and deconstruction (notice the dramatic decrease in bytes consed), but focusing what data we get from the database isn't remotely enough to fix our problem.</p>
        <p>This is a common problem when using ORMs: if we try to do serious calculations by first serializing all of the data into our backend, we will inevitably see performance drops.</p>
        <p>What we really want is for our database to do all the work of marshaling the data and summing up the <code class="verbatim">amount</code> column of all of the <code class="verbatim">leg</code> rows, and just receive a single value–the balance! That way we aren't building up and breaking down a bunch of Lisp objects just to do a little bit of math.</p>
        <ol class="incremental">
            <li><p>Making a Query With <code class="verbatim">cl-dbi</code></p>
                <p>This is where <code class="verbatim">cl-dbi</code> will be necessary. It will allow us to execute a query manually.</p>
                <p><code class="verbatim">dbi</code> works by first preparing a query for a certain database connection.</p>
                <div class="sourceCode" id="cb420" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb420-1"><a href="#cb420-1" aria-hidden="true" tabindex="-1"></a>(dbi:prepare database-connection query)</span></code></pre></div>
                <p>The query is a simple string. You can <code class="verbatim">yield</code> one from a SQL statement prepared with <code class="verbatim">sxql</code>.</p>
                <div class="sourceCode" id="cb421" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a>(sxql:select :*</span>
                    <span id="cb421-2"><a href="#cb421-2" aria-hidden="true" tabindex="-1"></a>  (sxql:from :almighty_account)</span>
                    <span id="cb421-3"><a href="#cb421-3" aria-hidden="true" tabindex="-1"></a>  (sxql:where (:= :almighty_account.id <span class="dv">5</span>)))</span>
                    <span id="cb421-4"><a href="#cb421-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;SXQL-STATEMENT:</span></span>
                    <span id="cb421-5"><a href="#cb421-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; SELECT * FROM almighty_account</span></span>
                    <span id="cb421-6"><a href="#cb421-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; WHERE (almighty_account.id = 5)&gt;</span></span>
                    <span id="cb421-7"><a href="#cb421-7" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb421-8"><a href="#cb421-8" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb421-9"><a href="#cb421-9" aria-hidden="true" tabindex="-1"></a>(sxql:yield</span>
                    <span id="cb421-10"><a href="#cb421-10" aria-hidden="true" tabindex="-1"></a> (sxql:select :*</span>
                    <span id="cb421-11"><a href="#cb421-11" aria-hidden="true" tabindex="-1"></a>   (sxql:from :almighty_account)</span>
                    <span id="cb421-12"><a href="#cb421-12" aria-hidden="true" tabindex="-1"></a>   (sxql:where (:= :almighty_account.id <span class="dv">5</span>))))</span>
                    <span id="cb421-13"><a href="#cb421-13" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; &quot;SELECT * FROM almighty_account WHERE (almighty_account.id = ?)&quot;, (5)</span></span></code></pre></div>
                <p>Notice that we receive two values from <code class="verbatim">yield</code>. This is to make it easy to use <code class="verbatim">dbi</code> to prepare the statement–sanitizing user input to prevent SQL inject attacks.</p>
                <div class="sourceCode" id="cb422" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb422-1"><a href="#cb422-1" aria-hidden="true" tabindex="-1"></a>(with-chart-of-accounts</span>
                    <span id="cb422-2"><a href="#cb422-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">multiple-value-bind</span> (query binds)</span>
                    <span id="cb422-3"><a href="#cb422-3" aria-hidden="true" tabindex="-1"></a>      (sxql:yield</span>
                    <span id="cb422-4"><a href="#cb422-4" aria-hidden="true" tabindex="-1"></a>       (sxql:select :*</span>
                    <span id="cb422-5"><a href="#cb422-5" aria-hidden="true" tabindex="-1"></a>         (sxql:from :almighty_account)</span>
                    <span id="cb422-6"><a href="#cb422-6" aria-hidden="true" tabindex="-1"></a>         (sxql:where (:= :almighty_account.id <span class="dv">5</span>))))</span>
                    <span id="cb422-7"><a href="#cb422-7" aria-hidden="true" tabindex="-1"></a>    (dbi:prepare mito:*connection* query)))</span>
                    <span id="cb422-8"><a href="#cb422-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;DBD.SQLITE3:DBD-SQLITE3-QUERY {70078DE2C3}&gt;</span></span></code></pre></div>
                <p>We pass the prepared query and binds to <code class="verbatim">execute</code> to get a result.</p>
                <div class="sourceCode" id="cb423" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb423-1"><a href="#cb423-1" aria-hidden="true" tabindex="-1"></a>(with-chart-of-accounts</span>
                    <span id="cb423-2"><a href="#cb423-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">multiple-value-bind</span> (query binds)</span>
                    <span id="cb423-3"><a href="#cb423-3" aria-hidden="true" tabindex="-1"></a>      (sxql:yield</span>
                    <span id="cb423-4"><a href="#cb423-4" aria-hidden="true" tabindex="-1"></a>       (sxql:select :*</span>
                    <span id="cb423-5"><a href="#cb423-5" aria-hidden="true" tabindex="-1"></a>         (sxql:from :almighty_account)</span>
                    <span id="cb423-6"><a href="#cb423-6" aria-hidden="true" tabindex="-1"></a>         (sxql:where (:= :almighty_account.id <span class="dv">5</span>))))</span>
                    <span id="cb423-7"><a href="#cb423-7" aria-hidden="true" tabindex="-1"></a>    (dbi:execute (dbi:prepare mito:*connection* query)</span>
                    <span id="cb423-8"><a href="#cb423-8" aria-hidden="true" tabindex="-1"></a>                 binds)))</span>
                    <span id="cb423-9"><a href="#cb423-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; #&lt;DBD.SQLITE3:DBD-SQLITE3-QUERY {70081DDED3}&gt;</span></span></code></pre></div>
                <p>We have two options: we can take one row of the result at a time and do something with it, or we can receive the whole thing all at once and then do something with all of the data.</p>
                <div class="sourceCode" id="cb424" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb424-1"><a href="#cb424-1" aria-hidden="true" tabindex="-1"></a>(with-chart-of-accounts</span>
                    <span id="cb424-2"><a href="#cb424-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">multiple-value-bind</span> (query binds)</span>
                    <span id="cb424-3"><a href="#cb424-3" aria-hidden="true" tabindex="-1"></a>      (sxql:yield</span>
                    <span id="cb424-4"><a href="#cb424-4" aria-hidden="true" tabindex="-1"></a>       (sxql:select :*</span>
                    <span id="cb424-5"><a href="#cb424-5" aria-hidden="true" tabindex="-1"></a>         (sxql:from :almighty_account)</span>
                    <span id="cb424-6"><a href="#cb424-6" aria-hidden="true" tabindex="-1"></a>         (sxql:where (:= :almighty_account.id <span class="dv">5</span>))))</span>
                    <span id="cb424-7"><a href="#cb424-7" aria-hidden="true" tabindex="-1"></a>    (dbi:fetch (dbi:execute (dbi:prepare mito:*connection* query)</span>
                    <span id="cb424-8"><a href="#cb424-8" aria-hidden="true" tabindex="-1"></a>                            binds))))</span>
                    <span id="cb424-9"><a href="#cb424-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; (:|id| 5 :|name| &quot;General Expenses&quot; :|code| &quot;GEN000&quot; :|category| &quot;expense&quot;</span></span>
                    <span id="cb424-10"><a href="#cb424-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; :|currency| &quot;USD&quot; :|created_at| &quot;2025-11-30 03:59:02.662347Z&quot; :|updated_at|</span></span>
                    <span id="cb424-11"><a href="#cb424-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; &quot;2025-11-30 03:59:02.662347Z&quot;)</span></span>
                    <span id="cb424-12"><a href="#cb424-12" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb424-13"><a href="#cb424-13" aria-hidden="true" tabindex="-1"></a>(with-chart-of-accounts</span>
                    <span id="cb424-14"><a href="#cb424-14" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">multiple-value-bind</span> (query binds)</span>
                    <span id="cb424-15"><a href="#cb424-15" aria-hidden="true" tabindex="-1"></a>      (sxql:yield</span>
                    <span id="cb424-16"><a href="#cb424-16" aria-hidden="true" tabindex="-1"></a>       (sxql:select :*</span>
                    <span id="cb424-17"><a href="#cb424-17" aria-hidden="true" tabindex="-1"></a>         (sxql:from :almighty_account)</span>
                    <span id="cb424-18"><a href="#cb424-18" aria-hidden="true" tabindex="-1"></a>         (sxql:where (:= :almighty_account.id <span class="dv">5</span>))))</span>
                    <span id="cb424-19"><a href="#cb424-19" aria-hidden="true" tabindex="-1"></a>    (dbi:fetch-all (dbi:execute (dbi:prepare mito:*connection* query)</span>
                    <span id="cb424-20"><a href="#cb424-20" aria-hidden="true" tabindex="-1"></a>                                binds))))</span>
                    <span id="cb424-21"><a href="#cb424-21" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; ((:|id| 5 :|name| &quot;General Expenses&quot; :|code| &quot;GEN000&quot; :|category| &quot;expense&quot;</span></span>
                    <span id="cb424-22"><a href="#cb424-22" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  :|currency| &quot;USD&quot; :|created_at| &quot;2025-11-30 03:59:02.662347Z&quot; :|updated_at|</span></span>
                    <span id="cb424-23"><a href="#cb424-23" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  &quot;2025-11-30 03:59:02.662347Z&quot;))</span></span>
                    <span id="cb424-24"><a href="#cb424-24" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; notice the extra parentheses</span></span></code></pre></div>
                <p>And that's the basics of using <code class="verbatim">dbi</code>. <code class="verbatim">multiple-value-bind</code> is the go-to macro for working with forms that return multiple values like <code class="verbatim">sxql:yield</code>.</p></li>
            <li><p>Rename to <code class="verbatim">account-balance</code></p>
                <p>Now that you know basically how we're going to use <code class="verbatim">dbi</code> to get our data, we can get started on the task at hand.</p>
                <p>First, rename the <code class="verbatim">account-balance</code> function to <code class="verbatim">account-balance-slow</code>. We'll use it to test later.</p>
                <div class="sourceCode" id="cb425"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb425-1"><a href="#cb425-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ (defun account-balance-slow (account &amp;optional (as-of (universal-now)))</span></span>
                    <span id="cb425-2"><a href="#cb425-2" aria-hidden="true" tabindex="-1"></a><span class="va">+    ....)</span></span></code></pre></div>
                <p>Don't forget to export it with <code class="verbatim">sly-export-symbol-at-point</code> (<code class="verbatim">C-c x</code> with the cursor on function name).</p></li>
            <li><p><span class="todo TODO">TODO</span> Writing the query</p>
                <p>Now we need to get to the SQL query. What we want to do is get all of the legs for a certain account (as we do with <code class="verbatim">account-legs</code>) and then sum up the <code class="verbatim">entry_amount</code> columns of all those legs. In the end, we need an <code class="verbatim">amount</code> and a <code class="verbatim">currency</code> so we can properly make a <code class="verbatim">money</code> object later, so we're not going to <code class="verbatim">(select :*)</code>, we're going to return a sum.</p>
                <div class="sourceCode" id="cb426" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a>(with-coa</span>
                    <span id="cb426-2"><a href="#cb426-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((account (ak:get-account <span class="st">&quot;CSH000&quot;</span>)))</span>
                    <span id="cb426-3"><a href="#cb426-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">multiple-value-bind</span> (query binds)</span>
                    <span id="cb426-4"><a href="#cb426-4" aria-hidden="true" tabindex="-1"></a>        (s:yield</span>
                    <span id="cb426-5"><a href="#cb426-5" aria-hidden="true" tabindex="-1"></a>         (s:select ((:as (:sum :leg.entry_amount) :amount))</span>
                    <span id="cb426-6"><a href="#cb426-6" aria-hidden="true" tabindex="-1"></a>           (s:from (:as :almighty_account :account))</span>
                    <span id="cb426-7"><a href="#cb426-7" aria-hidden="true" tabindex="-1"></a>           (s:inner-join (:as :almighty_leg :leg) :on (:= :leg.account_id :account.id))</span>
                    <span id="cb426-8"><a href="#cb426-8" aria-hidden="true" tabindex="-1"></a>           (s:where (:= :account.id (m:object-id account)))))</span>
                    <span id="cb426-9"><a href="#cb426-9" aria-hidden="true" tabindex="-1"></a>      (d:fetch-all (d:execute (d:prepare m:*connection* query)</span>
                    <span id="cb426-10"><a href="#cb426-10" aria-hidden="true" tabindex="-1"></a>                              binds)))))</span>
                    <span id="cb426-11"><a href="#cb426-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; =&gt; ((:|amount| 100000000))</span></span></code></pre></div>
                <p>That looks good, but let's just be sure with a smaller test.</p>
                <div class="sourceCode" id="cb427" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb427-1"><a href="#cb427-1" aria-hidden="true" tabindex="-1"></a>(with-chart-of-accounts                 <span class="co">; Using in-memory database</span></span>
                    <span id="cb427-2"><a href="#cb427-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Use cash and revenue accounts.</span></span>
                    <span id="cb427-3"><a href="#cb427-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((cash (ak:get-account <span class="st">&quot;CSH000&quot;</span>))</span>
                    <span id="cb427-4"><a href="#cb427-4" aria-hidden="true" tabindex="-1"></a>        (revenue (ak:get-account <span class="st">&quot;RMR000&quot;</span>)))</span>
                    <span id="cb427-5"><a href="#cb427-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Make transactions.</span></span>
                    <span id="cb427-6"><a href="#cb427-6" aria-hidden="true" tabindex="-1"></a>    (ak:transact! (ak:debit cash <span class="dv">5000</span>)</span>
                    <span id="cb427-7"><a href="#cb427-7" aria-hidden="true" tabindex="-1"></a>                  (ak:credit revenue <span class="dv">5000</span>))</span>
                    <span id="cb427-8"><a href="#cb427-8" aria-hidden="true" tabindex="-1"></a>    (ak:transact! (ak:debit cash <span class="dv">5000</span>)</span>
                    <span id="cb427-9"><a href="#cb427-9" aria-hidden="true" tabindex="-1"></a>                  (ak:credit revenue <span class="dv">5000</span>))</span>
                    <span id="cb427-10"><a href="#cb427-10" aria-hidden="true" tabindex="-1"></a>    (ak:transact! (ak:debit cash <span class="dv">5000</span>)</span>
                    <span id="cb427-11"><a href="#cb427-11" aria-hidden="true" tabindex="-1"></a>                  (ak:credit revenue <span class="dv">5000</span>))</span>
                    <span id="cb427-12"><a href="#cb427-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Reverse the transactions.</span></span>
                    <span id="cb427-13"><a href="#cb427-13" aria-hidden="true" tabindex="-1"></a>    (ak:transact! (ak:credit cash <span class="dv">5000</span>)</span>
                    <span id="cb427-14"><a href="#cb427-14" aria-hidden="true" tabindex="-1"></a>                  (ak:debit revenue <span class="dv">5000</span>))</span>
                    <span id="cb427-15"><a href="#cb427-15" aria-hidden="true" tabindex="-1"></a>    (ak:transact! (ak:credit cash <span class="dv">5000</span>)</span>
                    <span id="cb427-16"><a href="#cb427-16" aria-hidden="true" tabindex="-1"></a>                  (ak:debit revenue <span class="dv">5000</span>))</span>
                    <span id="cb427-17"><a href="#cb427-17" aria-hidden="true" tabindex="-1"></a>    (ak:transact! (ak:credit cash <span class="dv">5000</span>)</span>
                    <span id="cb427-18"><a href="#cb427-18" aria-hidden="true" tabindex="-1"></a>                  (ak:debit revenue <span class="dv">5000</span>))</span>
                    <span id="cb427-19"><a href="#cb427-19" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">multiple-value-bind</span> (query binds)</span>
                    <span id="cb427-20"><a href="#cb427-20" aria-hidden="true" tabindex="-1"></a>        (s:yield</span>
                    <span id="cb427-21"><a href="#cb427-21" aria-hidden="true" tabindex="-1"></a>         (s:select ((:as (:sum :leg.entry_amount) :amount))</span>
                    <span id="cb427-22"><a href="#cb427-22" aria-hidden="true" tabindex="-1"></a>           (s:from (:as :almighty_account :account))</span>
                    <span id="cb427-23"><a href="#cb427-23" aria-hidden="true" tabindex="-1"></a>           (s:inner-join (:as :almighty_leg :leg) :on (:= :leg.account_id :account.id))</span>
                    <span id="cb427-24"><a href="#cb427-24" aria-hidden="true" tabindex="-1"></a>           <span class="co">;; Check cash balance.</span></span>
                    <span id="cb427-25"><a href="#cb427-25" aria-hidden="true" tabindex="-1"></a>           (s:where (:= :account.id (m:object-id cash)))))</span>
                    <span id="cb427-26"><a href="#cb427-26" aria-hidden="true" tabindex="-1"></a>      (d:fetch-all (d:execute (d:prepare m:*connection* query)</span>
                    <span id="cb427-27"><a href="#cb427-27" aria-hidden="true" tabindex="-1"></a>                              binds)))))</span>
                    <span id="cb427-28"><a href="#cb427-28" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">;  =&gt; ((:|amount| 0))</span></span></code></pre></div>
                <p>At this point, we just need to add a way to filter for the <code class="verbatim">as-of</code> transaction date, add the <code class="verbatim">entry_currency</code> to the return values, and turn this into a proper function.</p>
                <div class="sourceCode" id="cb428" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb428-1"><a href="#cb428-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> sql-account-balance </span>(account as-of)</span>
                    <span id="cb428-2"><a href="#cb428-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">multiple-value-bind</span> (query binds)</span>
                    <span id="cb428-3"><a href="#cb428-3" aria-hidden="true" tabindex="-1"></a>      (s:yield (s:select ((:as (:coalesce (:sum :leg.entry_amount) <span class="dv">0</span>) :amount)</span>
                    <span id="cb428-4"><a href="#cb428-4" aria-hidden="true" tabindex="-1"></a>                          (:as :leg.entry_currency :currency))</span>
                    <span id="cb428-5"><a href="#cb428-5" aria-hidden="true" tabindex="-1"></a>                 (s:from (:as :almighty_account :account))</span>
                    <span id="cb428-6"><a href="#cb428-6" aria-hidden="true" tabindex="-1"></a>                 (s:inner-join (:as :almighty_leg :leg) :on (:= :leg.account_id :account.id))</span>
                    <span id="cb428-7"><a href="#cb428-7" aria-hidden="true" tabindex="-1"></a>                 (s:inner-join (:as :almighty_transaction :tran) :on (:= :leg.transaction_id :tran.id))</span>
                    <span id="cb428-8"><a href="#cb428-8" aria-hidden="true" tabindex="-1"></a>                 (s:where (:and (:= :account.id (m:object-id account))</span>
                    <span id="cb428-9"><a href="#cb428-9" aria-hidden="true" tabindex="-1"></a>                                (:&lt;= :tran.date as-of)))</span>
                    <span id="cb428-10"><a href="#cb428-10" aria-hidden="true" tabindex="-1"></a>                 (s:group-by :leg.entry_currency)))</span>
                    <span id="cb428-11"><a href="#cb428-11" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> ((result (d:fetch (d:execute (d:prepare m:*connection* query)</span>
                    <span id="cb428-12"><a href="#cb428-12" aria-hidden="true" tabindex="-1"></a>                                      binds))))</span>
                    <span id="cb428-13"><a href="#cb428-13" aria-hidden="true" tabindex="-1"></a>      (am:make-money (<span class="kw">second</span> result) (<span class="kw">fourth</span> result)))))</span></code></pre></div>
                <p>Then let's make a new <code class="verbatim">account-balance</code> function:</p>
                <div class="sourceCode" id="cb429" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb429-1"><a href="#cb429-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> account-balance </span>(account &amp;optional (as-of (universal-now)))</span>
                    <span id="cb429-2"><a href="#cb429-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;A function for getting the balance of an account at a certain point in time,</span></span>
                    <span id="cb429-3"><a href="#cb429-3" aria-hidden="true" tabindex="-1"></a><span class="st">defaulting to now.</span></span>
                    <span id="cb429-4"><a href="#cb429-4" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb429-5"><a href="#cb429-5" aria-hidden="true" tabindex="-1"></a><span class="st">Usage Example:</span></span>
                    <span id="cb429-6"><a href="#cb429-6" aria-hidden="true" tabindex="-1"></a><span class="st">    (account-balance </span><span class="sc">\&quot;</span><span class="st">CSH000</span><span class="sc">\&quot;</span><span class="st">)</span></span>
                    <span id="cb429-7"><a href="#cb429-7" aria-hidden="true" tabindex="-1"></a><span class="st">    (account-balance sales-account-object)</span></span>
                    <span id="cb429-8"><a href="#cb429-8" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span></span>
                    <span id="cb429-9"><a href="#cb429-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((account (<span class="kw">if</span> (<span class="kw">stringp</span> account)</span>
                    <span id="cb429-10"><a href="#cb429-10" aria-hidden="true" tabindex="-1"></a>                     (get-account account)</span>
                    <span id="cb429-11"><a href="#cb429-11" aria-hidden="true" tabindex="-1"></a>                     account))</span>
                    <span id="cb429-12"><a href="#cb429-12" aria-hidden="true" tabindex="-1"></a>        (as-of (<span class="kw">etypecase</span> as-of</span>
                    <span id="cb429-13"><a href="#cb429-13" aria-hidden="true" tabindex="-1"></a>                 (lt:timestamp (lt:timestamp-to-universal as-of))</span>
                    <span id="cb429-14"><a href="#cb429-14" aria-hidden="true" tabindex="-1"></a>                 (transaction (lt:timestamp-to-universal (transaction-date as-of)))</span>
                    <span id="cb429-15"><a href="#cb429-15" aria-hidden="true" tabindex="-1"></a>                 (<span class="kw">string</span> (lt:timestamp-to-universal (lt:parse-timestring as-of)))</span>
                    <span id="cb429-16"><a href="#cb429-16" aria-hidden="true" tabindex="-1"></a>                 (<span class="kw">integer</span> as-of))))</span>
                    <span id="cb429-17"><a href="#cb429-17" aria-hidden="true" tabindex="-1"></a>    (sql-account-balance account as-of)))</span></code></pre></div>
                <p>Now we can test it out against the slower version.</p>
                <div class="sourceCode" id="cb430" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb430-1"><a href="#cb430-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">time</span> (with-coa (ak:account-balance-slow <span class="st">&quot;CSH000&quot;</span>)))</span></code></pre></div>
                <p>Results in:</p>
                <pre class="example"><code>Evaluation took:
  0.675 seconds of real time
  0.677828 seconds of total run time (0.638939 user, 0.038889 system)
  [ Real times consist of 0.060 seconds GC time, and 0.615 seconds non-GC time. ]
  [ Run times consist of 0.060 seconds GC time, and 0.618 seconds non-GC time. ]
  100.44% CPU
  7 forms interpreted
  391,349,920 bytes consed
                </code></pre>
                <p>Now for the optimized version:</p>
                <div class="sourceCode" id="cb432" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb432-1"><a href="#cb432-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">time</span> (with-coa (ak:account-balance <span class="st">&quot;CSH000&quot;</span>)))</span></code></pre></div>
                <p>Results in:</p>
                <pre class="example"><code>Evaluation took:
  0.051 seconds of real time
  0.044906 seconds of total run time (0.033658 user, 0.011248 system)
  88.24% CPU
  7 forms interpreted
  262,080 bytes consed
                </code></pre>
                <p>Much better.</p></li>
        </ol>
        <h3 id="example-usage">Example Usage</h3>
        <p>Now that we have the basic functionality of our library finished, it's time to kick the tires a bit and see what it can do. First, we'll make it a REPL-based application, but later we'll upgrade it into a CLI script in the chapter on <code class="verbatim">DEPLOYING</code>.</p>
        <ol class="incremental">
            <li><p>Setup</p>
                <p>In the project root directory, make a new directory named <code class="verbatim">example</code>.</p>
                <p>We need a system for this example, so let's set that up.</p>
                <div class="sourceCode" id="cb434" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb434-1"><a href="#cb434-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; almighty-kaikei/almighty-kaikei-examples.asd</span></span>
                    <span id="cb434-2"><a href="#cb434-2" aria-hidden="true" tabindex="-1"></a>(defsystem <span class="st">&quot;almighty-kaikei-examples&quot;</span></span>
                    <span id="cb434-3"><a href="#cb434-3" aria-hidden="true" tabindex="-1"></a>  :author <span class="st">&quot;Micah Killian&quot;</span></span>
                    <span id="cb434-4"><a href="#cb434-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">:version</span> <span class="st">&quot;0.0.1&quot;</span></span>
                    <span id="cb434-5"><a href="#cb434-5" aria-hidden="true" tabindex="-1"></a>  :description <span class="st">&quot;Examples of how to use the Almighty-Kaikei library.&quot;</span></span>
                    <span id="cb434-6"><a href="#cb434-6" aria-hidden="true" tabindex="-1"></a>  :depends-on (#:almighty-money #:almighty-kaikei #:local-time #:mito #:sxql #:dbi)</span>
                    <span id="cb434-7"><a href="#cb434-7" aria-hidden="true" tabindex="-1"></a>  :components ((:module <span class="st">&quot;examples&quot;</span></span>
                    <span id="cb434-8"><a href="#cb434-8" aria-hidden="true" tabindex="-1"></a>                :serial <span class="kw">t</span></span>
                    <span id="cb434-9"><a href="#cb434-9" aria-hidden="true" tabindex="-1"></a>                :components ((:file <span class="st">&quot;db&quot;</span>)</span>
                    <span id="cb434-10"><a href="#cb434-10" aria-hidden="true" tabindex="-1"></a>                             (:file <span class="st">&quot;views&quot;</span>)))))</span></code></pre></div>
                <p>Before we work on our queries, it'll help to know the motivation for getting the data by looking at our views.</p></li>
            <li><p>Views</p>
                <p>First, let's get our package set up in <code class="verbatim">examples/views.lisp</code>.</p>
                <div class="sourceCode" id="cb435" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb435-1"><a href="#cb435-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:examples/views</span>
                    <span id="cb435-2"><a href="#cb435-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
                    <span id="cb435-3"><a href="#cb435-3" aria-hidden="true" tabindex="-1"></a>  (:local-nicknames (#:db #:examples/db)</span>
                    <span id="cb435-4"><a href="#cb435-4" aria-hidden="true" tabindex="-1"></a>                    (#:lt #:local-time)</span>
                    <span id="cb435-5"><a href="#cb435-5" aria-hidden="true" tabindex="-1"></a>                    (#:ak #:almighty-kaikei)</span>
                    <span id="cb435-6"><a href="#cb435-6" aria-hidden="true" tabindex="-1"></a>                    (#:am #:almighty-money)))</span>
                    <span id="cb435-7"><a href="#cb435-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:examples/views)</span></code></pre></div>
                <p>In here, we're going to create some simple reports. The first one is a general ledger. The most basic kind of accounting report is the general ledger. It simply contains all of the transactions made, detailing the two sides and accounts affected.</p>
                <div class="sourceCode" id="cb436" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb436-1"><a href="#cb436-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; * ░ VIEWS ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span></span>
                    <span id="cb436-2"><a href="#cb436-2" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb436-3"><a href="#cb436-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> format-general-ledger </span>(from to)</span>
                    <span id="cb436-4"><a href="#cb436-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((transaction-count (db:transaction-count-for-period from to))</span>
                    <span id="cb436-5"><a href="#cb436-5" aria-hidden="true" tabindex="-1"></a>        (legs (db:legs-for-period from to)))</span>
                    <span id="cb436-6"><a href="#cb436-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Showing ~a transactions.~%&quot;</span> transaction-count)</span>
                    <span id="cb436-7"><a href="#cb436-7" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a~30t~a~60t~a~%&quot;</span> <span class="st">&quot;Transaction #&quot;</span> <span class="st">&quot;Debits&quot;</span> <span class="st">&quot;Credits&quot;</span>)</span>
                    <span id="cb436-8"><a href="#cb436-8" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">loop</span> :for leg :in legs</span>
                    <span id="cb436-9"><a href="#cb436-9" aria-hidden="true" tabindex="-1"></a>          :for i <span class="op">=</span> <span class="dv">0</span></span>
                    <span id="cb436-10"><a href="#cb436-10" aria-hidden="true" tabindex="-1"></a>          :if (<span class="kw">and</span> (ak:debit-p leg) (<span class="op">=</span> <span class="dv">0</span> i))</span>
                    <span id="cb436-11"><a href="#cb436-11" aria-hidden="true" tabindex="-1"></a>            :do (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a~30t~30a~%&quot;</span> (ak:leg-transaction-id leg) (<span class="kw">list</span> (am:format-money <span class="kw">nil</span> (ak:leg-entry leg)) (ak:account-name (ak:leg-account leg))))</span>
                    <span id="cb436-12"><a href="#cb436-12" aria-hidden="true" tabindex="-1"></a>          :else</span>
                    <span id="cb436-13"><a href="#cb436-13" aria-hidden="true" tabindex="-1"></a>            :do (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a~60t~30a~%&quot;</span> (ak:leg-transaction-id leg) (<span class="kw">list</span> (am:format-money <span class="kw">nil</span> (ak:leg-entry leg)) (ak:account-name (ak:leg-account leg))))</span>
                    <span id="cb436-14"><a href="#cb436-14" aria-hidden="true" tabindex="-1"></a>          :finally (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%&quot;</span>))))</span></code></pre></div>
                <p>This function will</p></li>
            <li><p>Queries</p>
                <p>Let's make <code class="verbatim">examples/db.lisp</code> and define the package:</p>
                <div class="sourceCode" id="cb437" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb437-1"><a href="#cb437-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:examples/db</span>
                    <span id="cb437-2"><a href="#cb437-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
                    <span id="cb437-3"><a href="#cb437-3" aria-hidden="true" tabindex="-1"></a>  (:local-nicknames (#:lt #:local-time)</span>
                    <span id="cb437-4"><a href="#cb437-4" aria-hidden="true" tabindex="-1"></a>                    (#:m #:mito)</span>
                    <span id="cb437-5"><a href="#cb437-5" aria-hidden="true" tabindex="-1"></a>                    (#:s #:sxql)</span>
                    <span id="cb437-6"><a href="#cb437-6" aria-hidden="true" tabindex="-1"></a>                    (#:ak #:almighty-kaikei)</span>
                    <span id="cb437-7"><a href="#cb437-7" aria-hidden="true" tabindex="-1"></a>                    (#:am #:almighty-money)))</span>
                    <span id="cb437-8"><a href="#cb437-8" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb437-9"><a href="#cb437-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:examples/db)</span></code></pre></div>
                <p>This package will be in charge of helping us work with the database: establishing a connection, select queries, and other "business logic" queries.</p>
                <div class="sourceCode" id="cb438" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb438-1"><a href="#cb438-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; * ░ UTILS ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span></span>
                    <span id="cb438-2"><a href="#cb438-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> with-universals </span>(bindings &amp;body body)</span>
                    <span id="cb438-3"><a href="#cb438-3" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">let</span> ,(<span class="kw">loop</span> :for (var val) :in bindings</span>
                    <span id="cb438-4"><a href="#cb438-4" aria-hidden="true" tabindex="-1"></a>               :collect (<span class="kw">list</span> var</span>
                    <span id="cb438-5"><a href="#cb438-5" aria-hidden="true" tabindex="-1"></a>                              `(lt:timestamp-to-universal</span>
                    <span id="cb438-6"><a href="#cb438-6" aria-hidden="true" tabindex="-1"></a>                                (<span class="kw">if</span> (<span class="kw">stringp</span> ,val)</span>
                    <span id="cb438-7"><a href="#cb438-7" aria-hidden="true" tabindex="-1"></a>                                    (lt:parse-timestring ,val)</span>
                    <span id="cb438-8"><a href="#cb438-8" aria-hidden="true" tabindex="-1"></a>                                    ,val))))</span>
                    <span id="cb438-9"><a href="#cb438-9" aria-hidden="true" tabindex="-1"></a>     ,@body))</span>
                    <span id="cb438-10"><a href="#cb438-10" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb438-11"><a href="#cb438-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> with-db-connection </span>(&amp;optional (db-name <span class="st">&quot;sqlite.db&quot;</span>) &amp;body body)</span>
                    <span id="cb438-12"><a href="#cb438-12" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">let</span> ((mito:*connection* (dbi:connect-cached :sqlite3 :database-name ,db-name)))</span>
                    <span id="cb438-13"><a href="#cb438-13" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">unwind-protect</span> (<span class="kw">progn</span> ,@body)</span>
                    <span id="cb438-14"><a href="#cb438-14" aria-hidden="true" tabindex="-1"></a>       (dbi:disconnect mito:*connection*))))</span>
                    <span id="cb438-15"><a href="#cb438-15" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb438-16"><a href="#cb438-16" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> db-path </span>()</span>
                    <span id="cb438-17"><a href="#cb438-17" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((db-path (asdf:system-relative-pathname :almighty-kaikei-examples #p<span class="st">&quot;data/sqlite.db&quot;</span>)))</span>
                    <span id="cb438-18"><a href="#cb438-18" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">ensure-directories-exist</span> db-path)</span>
                    <span id="cb438-19"><a href="#cb438-19" aria-hidden="true" tabindex="-1"></a>    db-path))</span>
                    <span id="cb438-20"><a href="#cb438-20" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb438-21"><a href="#cb438-21" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> initialize-application-database </span>()</span>
                    <span id="cb438-22"><a href="#cb438-22" aria-hidden="true" tabindex="-1"></a>  (with-db-connection (db-path)</span>
                    <span id="cb438-23"><a href="#cb438-23" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> (</span>
                    <span id="cb438-24"><a href="#cb438-24" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Asset Accounts</span></span>
                    <span id="cb438-25"><a href="#cb438-25" aria-hidden="true" tabindex="-1"></a>          (cash-account                 (ak:make-account <span class="st">&quot;Cash&quot;</span>                <span class="st">&quot;CSH000&quot;</span> <span class="st">&quot;asset&quot;</span>))</span>
                    <span id="cb438-26"><a href="#cb438-26" aria-hidden="true" tabindex="-1"></a>          (inventory-account            (ak:make-account <span class="st">&quot;Inventory&quot;</span>           <span class="st">&quot;INV000&quot;</span> <span class="st">&quot;asset&quot;</span>))</span>
                    <span id="cb438-27"><a href="#cb438-27" aria-hidden="true" tabindex="-1"></a>          (accounts-receivable-account  (ak:make-account <span class="st">&quot;Accounts Receivable&quot;</span> <span class="st">&quot;REC000&quot;</span> <span class="st">&quot;asset&quot;</span>))</span>
                    <span id="cb438-28"><a href="#cb438-28" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Expense Accounts</span></span>
                    <span id="cb438-29"><a href="#cb438-29" aria-hidden="true" tabindex="-1"></a>          (cost-of-goods-sold-account   (ak:make-account <span class="st">&quot;Cost of Goods Sold&quot;</span>  <span class="st">&quot;CGS000&quot;</span> <span class="st">&quot;expense&quot;</span>))</span>
                    <span id="cb438-30"><a href="#cb438-30" aria-hidden="true" tabindex="-1"></a>          (general-expenses-account     (ak:make-account <span class="st">&quot;General Expenses&quot;</span>    <span class="st">&quot;GEN000&quot;</span> <span class="st">&quot;expense&quot;</span>))</span>
                    <span id="cb438-31"><a href="#cb438-31" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Income Account</span></span>
                    <span id="cb438-32"><a href="#cb438-32" aria-hidden="true" tabindex="-1"></a>          (sales-revenue-account        (ak:make-account <span class="st">&quot;Sales Revenue&quot;</span>       <span class="st">&quot;SLS000&quot;</span> <span class="st">&quot;income&quot;</span>))</span>
                    <span id="cb438-33"><a href="#cb438-33" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Liability Account</span></span>
                    <span id="cb438-34"><a href="#cb438-34" aria-hidden="true" tabindex="-1"></a>          (tax-account                  (ak:make-account <span class="st">&quot;Tax Payable&quot;</span>         <span class="st">&quot;TAX000&quot;</span> <span class="st">&quot;liability&quot;</span>))</span>
                    <span id="cb438-35"><a href="#cb438-35" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Equity Accounts</span></span>
                    <span id="cb438-36"><a href="#cb438-36" aria-hidden="true" tabindex="-1"></a>          (room-revenue-account         (ak:make-account <span class="st">&quot;Room Revenue&quot;</span>        <span class="st">&quot;RMR000&quot;</span> <span class="st">&quot;equity&quot;</span>)))</span>
                    <span id="cb438-37"><a href="#cb438-37" aria-hidden="true" tabindex="-1"></a>      (m:ensure-table-exists <span class="dt">&#39;ak</span>:account)</span>
                    <span id="cb438-38"><a href="#cb438-38" aria-hidden="true" tabindex="-1"></a>      (m:ensure-table-exists <span class="dt">&#39;ak</span>:transaction)</span>
                    <span id="cb438-39"><a href="#cb438-39" aria-hidden="true" tabindex="-1"></a>      (m:ensure-table-exists <span class="dt">&#39;ak</span>:leg)</span>
                    <span id="cb438-40"><a href="#cb438-40" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb438-41"><a href="#cb438-41" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Asset</span></span>
                    <span id="cb438-42"><a href="#cb438-42" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account cash-account)</span>
                    <span id="cb438-43"><a href="#cb438-43" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account inventory-account)</span>
                    <span id="cb438-44"><a href="#cb438-44" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account accounts-receivable-account)</span>
                    <span id="cb438-45"><a href="#cb438-45" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Expense</span></span>
                    <span id="cb438-46"><a href="#cb438-46" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account cost-of-goods-sold-account)</span>
                    <span id="cb438-47"><a href="#cb438-47" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account general-expenses-account)</span>
                    <span id="cb438-48"><a href="#cb438-48" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Income</span></span>
                    <span id="cb438-49"><a href="#cb438-49" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account sales-revenue-account)</span>
                    <span id="cb438-50"><a href="#cb438-50" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Liablity</span></span>
                    <span id="cb438-51"><a href="#cb438-51" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account tax-account)</span>
                    <span id="cb438-52"><a href="#cb438-52" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Equity</span></span>
                    <span id="cb438-53"><a href="#cb438-53" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account room-revenue-account))))</span></code></pre></div>
                <p>To begin with, we have <code class="verbatim">with-universals</code>. This converts <code class="verbatim">local-time:timestamp</code> objects into Common Lisp <code class="verbatim">universal times</code>. According to the HyperSpec (<a href="https://cl-community-spec.github.io/pages/Universal-Time.html">https://cl-community-spec.github.io/pages/Universal-Time.html</a>),</p>
                <blockquote>
                    <p>Universal time is an absolute time represented as a single non-negative integer—the number of seconds since midnight, January 1, 1900 GMT (ignoring leap seconds).</p>
                </blockquote>
                <p>Earlier, we wrote the <code class="verbatim">transaction</code> <code class="verbatim">deftable</code> in order to automatically serialize timestamps to universal times as well as the reverse. For our queries, if we ever want to filter rows by timestamps, we might be tempted to use <code class="verbatim">local-time:timestamp</code> objects directly, but they don't work. We could try converting timestamps into a format that SQLite understands that still looks like a timestamp, but for our purposes, a simple integer will do.</p>
                <p><code class="verbatim">with-db-connection</code> is a simple macro for running some code with a database connection. <code class="verbatim">mito:*connection*</code> needs to be set to a <code class="verbatim">dbi</code> connection, which we set to sqlite3. <code class="verbatim">unwind-protect</code> is a macro that will always run the form of its second argument even if the first argument form has some error. It's useful for any necessary cleanup after a form does some work, perhaps saving some data to a file, but then fails in the middle. In our case, we use it to close the connection.</p>
                <p><code class="verbatim">db-path</code> ensures that we have a place to put our database file (if the <code class="verbatim">data</code> folder isn't already created, for example).</p>
                <p><code class="verbatim">initialize-application-database</code> is for ensuring the <code class="verbatim">almighty-kaikei</code> tables are available and our Chart of Accounts is created. When we first start our application, we need to run this function.</p></li>
            <li><p>General ledger</p>
                <p>The most basic kind of accounting report is the General Ledger. It simply contains all of the transactions made, detailing the two sides and accounts affected.</p>
                <div class="sourceCode" id="cb439" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb439-1"><a href="#cb439-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> sales </span>(from to)</span>
                    <span id="cb439-2"><a href="#cb439-2" aria-hidden="true" tabindex="-1"></a>  (with-universals ((from from)</span>
                    <span id="cb439-3"><a href="#cb439-3" aria-hidden="true" tabindex="-1"></a>                    (to to))</span>
                    <span id="cb439-4"><a href="#cb439-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let*</span> ((transaction-count (<span class="kw">second</span> (<span class="kw">first</span> (m:retrieve-by-sql</span>
                    <span id="cb439-5"><a href="#cb439-5" aria-hidden="true" tabindex="-1"></a>                                              (s:select ((<span class="bu">:count</span> :*))</span>
                    <span id="cb439-6"><a href="#cb439-6" aria-hidden="true" tabindex="-1"></a>                                                (s:from :almighty_transaction)</span>
                    <span id="cb439-7"><a href="#cb439-7" aria-hidden="true" tabindex="-1"></a>                                                (s:inner-join :almighty_leg :on (:= :almighty_leg.transaction_id :almighty_transaction.id))</span>
                    <span id="cb439-8"><a href="#cb439-8" aria-hidden="true" tabindex="-1"></a>                                                (s:where (:and</span>
                    <span id="cb439-9"><a href="#cb439-9" aria-hidden="true" tabindex="-1"></a>                                                          (:= :almighty_leg.account_id (m:object-id (ak:get-account <span class="st">&quot;RMR000&quot;</span>)))</span>
                    <span id="cb439-10"><a href="#cb439-10" aria-hidden="true" tabindex="-1"></a>                                                          (:&gt;= :almighty_transaction.date from)</span>
                    <span id="cb439-11"><a href="#cb439-11" aria-hidden="true" tabindex="-1"></a>                                                          (:&lt;= :almighty_transaction.date to))))))))</span>
                    <span id="cb439-12"><a href="#cb439-12" aria-hidden="true" tabindex="-1"></a>           (sales-account (ak:get-account <span class="st">&quot;RMR000&quot;</span>))</span>
                    <span id="cb439-13"><a href="#cb439-13" aria-hidden="true" tabindex="-1"></a>           (legs (m:select-dao <span class="dt">&#39;ak</span>:leg</span>
                    <span id="cb439-14"><a href="#cb439-14" aria-hidden="true" tabindex="-1"></a>                   (m:joins <span class="dt">&#39;ak</span>:transaction)</span>
                    <span id="cb439-15"><a href="#cb439-15" aria-hidden="true" tabindex="-1"></a>                   (s:where (:and</span>
                    <span id="cb439-16"><a href="#cb439-16" aria-hidden="true" tabindex="-1"></a>                             (:= :almighty_leg.account-id (m:object-id sales-account))</span>
                    <span id="cb439-17"><a href="#cb439-17" aria-hidden="true" tabindex="-1"></a>                             (:&gt;= :almighty_transaction.date from)</span>
                    <span id="cb439-18"><a href="#cb439-18" aria-hidden="true" tabindex="-1"></a>                             (:&lt;= :almighty_transaction.date to)))</span>
                    <span id="cb439-19"><a href="#cb439-19" aria-hidden="true" tabindex="-1"></a>                   (s:order-by :almighty_transaction.id))))</span>
                    <span id="cb439-20"><a href="#cb439-20" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~&amp;Showing ~a transactions.~%&quot;</span> transaction-count)</span>
                    <span id="cb439-21"><a href="#cb439-21" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb439-22"><a href="#cb439-22" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a~15t~a~45t~a~%&quot;</span> <span class="st">&quot;Transaction #&quot;</span> <span class="st">&quot;Debits&quot;</span> <span class="st">&quot;Credits&quot;</span>)</span>
                    <span id="cb439-23"><a href="#cb439-23" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">loop</span> :for leg :in legs</span>
                    <span id="cb439-24"><a href="#cb439-24" aria-hidden="true" tabindex="-1"></a>            :for i <span class="op">=</span> <span class="dv">0</span></span>
                    <span id="cb439-25"><a href="#cb439-25" aria-hidden="true" tabindex="-1"></a>            :if (<span class="kw">and</span> (ak:debit-p leg) (<span class="op">=</span> <span class="dv">0</span> i))</span>
                    <span id="cb439-26"><a href="#cb439-26" aria-hidden="true" tabindex="-1"></a>              :do (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a~15t~a~%&quot;</span> (ak:leg-transaction-id leg) (<span class="kw">list</span> (am:format-money <span class="kw">nil</span> (ak:leg-entry leg)) (ak:account-name (ak:leg-account leg))))</span>
                    <span id="cb439-27"><a href="#cb439-27" aria-hidden="true" tabindex="-1"></a>            :else</span>
                    <span id="cb439-28"><a href="#cb439-28" aria-hidden="true" tabindex="-1"></a>              :do (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~a~45t~a~%&quot;</span> (ak:leg-transaction-id leg) (<span class="kw">list</span> (am:format-money <span class="kw">nil</span> (ak:leg-entry leg)) (ak:account-name (ak:leg-account leg))))</span>
                    <span id="cb439-29"><a href="#cb439-29" aria-hidden="true" tabindex="-1"></a>            :finally (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;~%&quot;</span>)))))</span></code></pre></div>
                <p><code class="verbatim">general-ledger</code> uses a <code class="verbatim">with-universals</code> macro for taking two <code class="verbatim">local-time</code> "timestrings" and converting them to <em>universal times</em>. When making queries like this, universal times are easier to use than trying to work with local-time timestamps–that's why we set up transaction dates to inflate/deflate (serialize/deserialize) between timestamps and universal times earlier.</p>
                <p>Here's <code class="verbatim">with-universals</code>:</p>
                <div class="sourceCode" id="cb440" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb440-1"><a href="#cb440-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> with-universals </span>(bindings &amp;body body)</span>
                    <span id="cb440-2"><a href="#cb440-2" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">let</span> ,(<span class="kw">loop</span> :for (var val) :in bindings</span>
                    <span id="cb440-3"><a href="#cb440-3" aria-hidden="true" tabindex="-1"></a>               :collect (<span class="kw">list</span> var</span>
                    <span id="cb440-4"><a href="#cb440-4" aria-hidden="true" tabindex="-1"></a>                             `(lt:timestamp-to-universal</span>
                    <span id="cb440-5"><a href="#cb440-5" aria-hidden="true" tabindex="-1"></a>                               (<span class="kw">if</span> (<span class="kw">stringp</span> ,val)</span>
                    <span id="cb440-6"><a href="#cb440-6" aria-hidden="true" tabindex="-1"></a>                                   (lt:parse-timestring ,val)</span>
                    <span id="cb440-7"><a href="#cb440-7" aria-hidden="true" tabindex="-1"></a>                                   ,val))))</span>
                    <span id="cb440-8"><a href="#cb440-8" aria-hidden="true" tabindex="-1"></a>     ,@body))</span></code></pre></div>
                <p>It takes <code class="verbatim">bindings</code>, a list of lists (as in a <code class="verbatim">let</code> form) with a variable and the value to bind it to. It takes a string and converts it to a universal time. A simple but useful for reports like <code class="verbatim">general-ledger</code> that want to show data for a certain time range.</p>
                <p>The <code class="verbatim">transaction-count</code> variable is bound to the result of a simple SQL query that gets the number of transactions for a time range.</p>
                <p><code class="verbatim">legs</code> is similar, with one small difference: it uses <code class="verbatim">mito:joins</code>–the equivalent of typing in <code class="verbatim">inner-join :table_name :on ...</code>. Since we're using <code class="verbatim">select-dao</code>, we can use the <code class="verbatim">joins</code> macro to save a little bit of typing.</p>
                <p>After that, we just go through the list of leg objects and <code class="verbatim">format</code> them. The <code class="verbatim">TILDE t</code> format directive here is useful for making tabular output. <code class="verbatim">~nt</code> is <em>padded</em> to the <code class="verbatim">nth</code> space. <code class="verbatim">~15t</code> means "If you aren't at column 15 yet, move there before continuing to format."</p>
                <p>Output of <code class="verbatim">general-ledger</code> should look like this:</p>
                <pre class="example"><code>Showing 300 transactions.
Transaction #                 Debits                        Credits
1                             ($50.00 Cash)
1                                                           ($50.00 Room Revenue)
2                             ($50.00 Cash)
2                                                           ($50.00 Room Revenue)
3                             ($50.00 Cash)
3                                                           ($50.00 Room Revenue)
4                             ($50.00 Cash)
4                                                           ($50.00 Room Revenue)
                </code></pre>
                <p>We're implementing these reports using <code class="verbatim">format</code>, but we could just as easily use HTML to format them for the web. For simplicity we're keeping the query definition and the "front end" together in one function.</p></li>
            <li><p>Trial balance</p>
                <p>A trial balance shows the net total balance of all accounts.</p></li>
        </ol>
        <h3 id="tests">Tests</h3>
        <p>At this point, we need to start thinking about testing a little more seriously. We want to be able to test not only our ability to get account balances, but to do so at specific times. We need to be able to set up an environment for our tests that won't affect the other tests. What we want is essentially a lexical database environment.</p>
        <p>So now we need to get systematic with testing, and for that we'll use <code class="verbatim">lisp-unit2</code></p>
        <ol class="incremental">
            <li><p>Getting Started with <code class="verbatim">lisp-unit2</code></p>
                <p>To get started, open a buffer in <code class="verbatim">t/main.lisp</code> and add this:</p>
                <div class="sourceCode" id="cb442" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb442-1"><a href="#cb442-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:almighty-kaikei/test/main</span>
                    <span id="cb442-2"><a href="#cb442-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
                    <span id="cb442-3"><a href="#cb442-3" aria-hidden="true" tabindex="-1"></a>  (:local-nicknames (#:lu #:lisp-unit2)</span>
                    <span id="cb442-4"><a href="#cb442-4" aria-hidden="true" tabindex="-1"></a>                    (#:lt #:local-time)</span>
                    <span id="cb442-5"><a href="#cb442-5" aria-hidden="true" tabindex="-1"></a>                    (#:ak #:almighty-kaikei)</span>
                    <span id="cb442-6"><a href="#cb442-6" aria-hidden="true" tabindex="-1"></a>                    (#:am #:almighty-money)))</span>
                    <span id="cb442-7"><a href="#cb442-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:almighty-kaikei/test/main)</span></code></pre></div></li>
            <li><p>Making a test</p>
                <p>Now let's make a simple test to learn how to use <code class="verbatim">lisp-unit2</code>.</p>
                <div class="sourceCode" id="cb443" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb443-1"><a href="#cb443-1" aria-hidden="true" tabindex="-1"></a>(lu:define-test testing-testing-123 ()</span>
                    <span id="cb443-2"><a href="#cb443-2" aria-hidden="true" tabindex="-1"></a>  (lu:assert-eql <span class="dv">123</span> <span class="dv">123</span>))</span></code></pre></div>
                <p>This test will pass if (eql 123 123) or fail otherwise. To run the test, we can use <code class="verbatim">lu:run-tests</code>.</p>
                <div class="sourceCode" id="cb444" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb444-1"><a href="#cb444-1" aria-hidden="true" tabindex="-1"></a>(lu:run-tests)</span></code></pre></div>
                <p>It should return something like this:</p>
                <pre class="example"><code>#&lt;LU:TEST-RESULTS-DB Tests:(1) Passed:(1) Failed:(0) Errors:(0) Warnings:(0) {700C0D01D3}&gt;
                </code></pre></li>
            <li><p>Tags</p>
                <p>You can group sets of tests using "tags". You can specify one or more tags.</p>
                <div class="sourceCode" id="cb446" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb446-1"><a href="#cb446-1" aria-hidden="true" tabindex="-1"></a>(lu:define-test test-my-test (:tags &#39;(math)))</span>
                    <span id="cb446-2"><a href="#cb446-2" aria-hidden="true" tabindex="-1"></a>(lu:define-test test-my-test2 (:tags &#39;(accounting reporting)))</span></code></pre></div>
                <p>To run tests with a certain tag or tags:</p>
                <div class="sourceCode" id="cb447" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb447-1"><a href="#cb447-1" aria-hidden="true" tabindex="-1"></a>(lu:run-tests :tags &#39;(accounting))</span></code></pre></div></li>
            <li><p>Contexts</p>
                <p>In addition to tags, you can specify contexts. Contexts are lexical environments for tests. You can specify them on a per-test basis or for all tests in the call to <code class="verbatim">lu:run-tests</code>.</p>
                <div class="sourceCode" id="cb448" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb448-1"><a href="#cb448-1" aria-hidden="true" tabindex="-1"></a>(lu:define-test test-my-context-text (:contexts (<span class="kw">list</span> <span class="op">#&#39;</span>with-my-context <span class="op">#&#39;</span>with-another-context)))</span>
                    <span id="cb448-2"><a href="#cb448-2" aria-hidden="true" tabindex="-1"></a>(lu:run-tests :run-contexts (<span class="kw">list</span> <span class="op">#&#39;</span>lu:with-failure-debugging-context))</span></code></pre></div>
                <p><code class="verbatim">lu:with-failure-debugging-context</code> is a built-in context that will open the debugger if an assertion fails, giving you an opportunity to look at the data.</p>
                <p>Contexts are functions that return a <code class="verbatim">funcall</code> to a body function.</p>
                <div class="sourceCode" id="cb449" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb449-1"><a href="#cb449-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> with-my-context </span>(body-fn)</span>
                    <span id="cb449-2"><a href="#cb449-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((...))</span>
                    <span id="cb449-3"><a href="#cb449-3" aria-hidden="true" tabindex="-1"></a>    (do-thing)</span>
                    <span id="cb449-4"><a href="#cb449-4" aria-hidden="true" tabindex="-1"></a>    (do-another-thing)</span>
                    <span id="cb449-5"><a href="#cb449-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">funcall</span> body-fn)))</span></code></pre></div>
                <p>Every test that uses <code class="verbatim">with-my-custom-context</code> will include this lexical environment.</p></li>
            <li><p>Making testing contexts</p>
                <p>In order to run our tests, we need to be able to do several things for every test:</p>
                <ol class="incremental">
                    <li>Connect and disconnect to a database.</li>
                    <li>Create and destroy our database tables.</li>
                    <li>Create a standard set of accounts (called a Chart of Accounts).</li>
                </ol>
                <p>First, let's create the function and macro for connecting to the database:</p>
                <div class="sourceCode" id="cb450" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb450-1"><a href="#cb450-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> with-db-connection </span>(&amp;optional (db-name <span class="st">&quot;sqlite.db&quot;</span>) &amp;body body)</span>
                    <span id="cb450-2"><a href="#cb450-2" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">let</span> ((mito:*connection* (dbi:connect-cached :sqlite3 :database-name ,db-name)))</span>
                    <span id="cb450-3"><a href="#cb450-3" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">unwind-protect</span> (<span class="kw">progn</span> ,@body)</span>
                    <span id="cb450-4"><a href="#cb450-4" aria-hidden="true" tabindex="-1"></a>       (dbi:disconnect mito:*connection*))))</span>
                    <span id="cb450-5"><a href="#cb450-5" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb450-6"><a href="#cb450-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> test-db-path </span>()</span>
                    <span id="cb450-7"><a href="#cb450-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((db-path (asdf:system-relative-pathname :almighty-kaikei #p<span class="st">&quot;t/test.db&quot;</span>)))</span>
                    <span id="cb450-8"><a href="#cb450-8" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">ensure-directories-exist</span> db-path)</span>
                    <span id="cb450-9"><a href="#cb450-9" aria-hidden="true" tabindex="-1"></a>    db-path))</span></code></pre></div>
                <p>Next, we need to make a "chart of accounts" lexical database environment–"fixtures". To reiterate, there are five different categories of accounts, and a chart of accounts may have several of each category. In our context, we will make the SQL tables and then add the accounts to the database.</p>
                <div class="sourceCode" id="cb451" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb451-1"><a href="#cb451-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> with-chart-of-accounts-context </span>(body-fn)</span>
                    <span id="cb451-2"><a href="#cb451-2" aria-hidden="true" tabindex="-1"></a>  (with-db-connection #p<span class="st">&quot;:memory:&quot;</span></span>
                    <span id="cb451-3"><a href="#cb451-3" aria-hidden="true" tabindex="-1"></a>    (m:ensure-table-exists <span class="dt">&#39;ak</span>:account)</span>
                    <span id="cb451-4"><a href="#cb451-4" aria-hidden="true" tabindex="-1"></a>    (m:ensure-table-exists <span class="dt">&#39;ak</span>:transaction)</span>
                    <span id="cb451-5"><a href="#cb451-5" aria-hidden="true" tabindex="-1"></a>    (m:ensure-table-exists <span class="dt">&#39;ak</span>:leg)</span>
                    <span id="cb451-6"><a href="#cb451-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> (</span>
                    <span id="cb451-7"><a href="#cb451-7" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Asset Accounts</span></span>
                    <span id="cb451-8"><a href="#cb451-8" aria-hidden="true" tabindex="-1"></a>          (cash-account                 (ak:make-account <span class="st">&quot;Cash&quot;</span>                <span class="st">&quot;CSH000&quot;</span> <span class="st">&quot;asset&quot;</span>))</span>
                    <span id="cb451-9"><a href="#cb451-9" aria-hidden="true" tabindex="-1"></a>          (inventory-account            (ak:make-account <span class="st">&quot;Inventory&quot;</span>           <span class="st">&quot;INV000&quot;</span> <span class="st">&quot;asset&quot;</span>))</span>
                    <span id="cb451-10"><a href="#cb451-10" aria-hidden="true" tabindex="-1"></a>          (accounts-receivable-account  (ak:make-account <span class="st">&quot;Accounts Receivable&quot;</span> <span class="st">&quot;REC000&quot;</span> <span class="st">&quot;asset&quot;</span>))</span>
                    <span id="cb451-11"><a href="#cb451-11" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Expense Accounts</span></span>
                    <span id="cb451-12"><a href="#cb451-12" aria-hidden="true" tabindex="-1"></a>          (cost-of-goods-sold-account   (ak:make-account <span class="st">&quot;Cost of Goods Sold&quot;</span>  <span class="st">&quot;CGS000&quot;</span> <span class="st">&quot;expense&quot;</span>))</span>
                    <span id="cb451-13"><a href="#cb451-13" aria-hidden="true" tabindex="-1"></a>          (general-expenses-account     (ak:make-account <span class="st">&quot;General Expenses&quot;</span>    <span class="st">&quot;GEN000&quot;</span> <span class="st">&quot;expense&quot;</span>))</span>
                    <span id="cb451-14"><a href="#cb451-14" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Income Account</span></span>
                    <span id="cb451-15"><a href="#cb451-15" aria-hidden="true" tabindex="-1"></a>          (sales-revenue-account        (ak:make-account <span class="st">&quot;Sales Revenue&quot;</span>       <span class="st">&quot;SLS000&quot;</span> <span class="st">&quot;equity&quot;</span>))</span>
                    <span id="cb451-16"><a href="#cb451-16" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Liability Account</span></span>
                    <span id="cb451-17"><a href="#cb451-17" aria-hidden="true" tabindex="-1"></a>          (liability-account            (ak:make-account <span class="st">&quot;Liabilities&quot;</span>         <span class="st">&quot;LIA000&quot;</span> <span class="st">&quot;liability&quot;</span>))</span>
                    <span id="cb451-18"><a href="#cb451-18" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Equity Accounts</span></span>
                    <span id="cb451-19"><a href="#cb451-19" aria-hidden="true" tabindex="-1"></a>          (room-revenue-account         (ak:make-account <span class="st">&quot;Room Revenue&quot;</span>        <span class="st">&quot;RMR000&quot;</span> <span class="st">&quot;equity&quot;</span>)))</span>
                    <span id="cb451-20"><a href="#cb451-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Asset</span></span>
                    <span id="cb451-21"><a href="#cb451-21" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account cash-account)</span>
                    <span id="cb451-22"><a href="#cb451-22" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account inventory-account)</span>
                    <span id="cb451-23"><a href="#cb451-23" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account accounts-receivable-account)</span>
                    <span id="cb451-24"><a href="#cb451-24" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Expense</span></span>
                    <span id="cb451-25"><a href="#cb451-25" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account cost-of-goods-sold-account)</span>
                    <span id="cb451-26"><a href="#cb451-26" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account general-expenses-account)</span>
                    <span id="cb451-27"><a href="#cb451-27" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Income</span></span>
                    <span id="cb451-28"><a href="#cb451-28" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account sales-revenue-account)</span>
                    <span id="cb451-29"><a href="#cb451-29" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Liablity</span></span>
                    <span id="cb451-30"><a href="#cb451-30" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account liability-account)</span>
                    <span id="cb451-31"><a href="#cb451-31" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Equity</span></span>
                    <span id="cb451-32"><a href="#cb451-32" aria-hidden="true" tabindex="-1"></a>      (ak:get-or-save-account room-revenue-account)</span>
                    <span id="cb451-33"><a href="#cb451-33" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">funcall</span> body-fn))))</span></code></pre></div>
                <p>This is the context that we'll use for our <code class="verbatim">lisp-unit2</code> tests. It uses SQLite's in-memory database, making it temporary for the duration of each connection.</p>
                <p>We also want a way to mess around outside of the tests, so let's make a macro that lets us do that:</p>
                <div class="sourceCode" id="cb452" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb452-1"><a href="#cb452-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> with-coa </span>(&amp;body body)</span>
                    <span id="cb452-2"><a href="#cb452-2" aria-hidden="true" tabindex="-1"></a>  `(with-db-connection (test-db-path)</span>
                    <span id="cb452-3"><a href="#cb452-3" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">let</span> (</span>
                    <span id="cb452-4"><a href="#cb452-4" aria-hidden="true" tabindex="-1"></a>           <span class="co">;; Asset Accounts</span></span>
                    <span id="cb452-5"><a href="#cb452-5" aria-hidden="true" tabindex="-1"></a>           (cash-account                 (ak:make-account <span class="st">&quot;Cash&quot;</span>                <span class="st">&quot;CSH000&quot;</span> <span class="st">&quot;asset&quot;</span>))</span>
                    <span id="cb452-6"><a href="#cb452-6" aria-hidden="true" tabindex="-1"></a>           (inventory-account            (ak:make-account <span class="st">&quot;Inventory&quot;</span>           <span class="st">&quot;INV000&quot;</span> <span class="st">&quot;asset&quot;</span>))</span>
                    <span id="cb452-7"><a href="#cb452-7" aria-hidden="true" tabindex="-1"></a>           (accounts-receivable-account  (ak:make-account <span class="st">&quot;Accounts Receivable&quot;</span> <span class="st">&quot;REC000&quot;</span> <span class="st">&quot;asset&quot;</span>))</span>
                    <span id="cb452-8"><a href="#cb452-8" aria-hidden="true" tabindex="-1"></a>           <span class="co">;; Expense Accounts</span></span>
                    <span id="cb452-9"><a href="#cb452-9" aria-hidden="true" tabindex="-1"></a>           (cost-of-goods-sold-account   (ak:make-account <span class="st">&quot;Cost of Goods Sold&quot;</span>  <span class="st">&quot;CGS000&quot;</span> <span class="st">&quot;expense&quot;</span>))</span>
                    <span id="cb452-10"><a href="#cb452-10" aria-hidden="true" tabindex="-1"></a>           (general-expenses-account     (ak:make-account <span class="st">&quot;General Expenses&quot;</span>    <span class="st">&quot;GEN000&quot;</span> <span class="st">&quot;expense&quot;</span>))</span>
                    <span id="cb452-11"><a href="#cb452-11" aria-hidden="true" tabindex="-1"></a>           <span class="co">;; Income Account</span></span>
                    <span id="cb452-12"><a href="#cb452-12" aria-hidden="true" tabindex="-1"></a>           (sales-revenue-account        (ak:make-account <span class="st">&quot;Sales Revenue&quot;</span>       <span class="st">&quot;SLS000&quot;</span> <span class="st">&quot;income&quot;</span>))</span>
                    <span id="cb452-13"><a href="#cb452-13" aria-hidden="true" tabindex="-1"></a>           <span class="co">;; Liability Account</span></span>
                    <span id="cb452-14"><a href="#cb452-14" aria-hidden="true" tabindex="-1"></a>           (liability-account            (ak:make-account <span class="st">&quot;Liabilities&quot;</span>         <span class="st">&quot;LIA000&quot;</span> <span class="st">&quot;liability&quot;</span>))</span>
                    <span id="cb452-15"><a href="#cb452-15" aria-hidden="true" tabindex="-1"></a>           <span class="co">;; Equity Accounts</span></span>
                    <span id="cb452-16"><a href="#cb452-16" aria-hidden="true" tabindex="-1"></a>           (room-revenue-account         (ak:make-account <span class="st">&quot;Room Revenue&quot;</span>        <span class="st">&quot;RMR000&quot;</span> <span class="st">&quot;equity&quot;</span>)))</span>
                    <span id="cb452-17"><a href="#cb452-17" aria-hidden="true" tabindex="-1"></a>       (m:ensure-table-exists <span class="dt">&#39;ak</span>:account)</span>
                    <span id="cb452-18"><a href="#cb452-18" aria-hidden="true" tabindex="-1"></a>       (m:ensure-table-exists <span class="dt">&#39;ak</span>:transaction)</span>
                    <span id="cb452-19"><a href="#cb452-19" aria-hidden="true" tabindex="-1"></a>       (m:ensure-table-exists <span class="dt">&#39;ak</span>:leg)</span>
                    <span id="cb452-20"><a href="#cb452-20" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb452-21"><a href="#cb452-21" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Asset</span></span>
                    <span id="cb452-22"><a href="#cb452-22" aria-hidden="true" tabindex="-1"></a>       (ak:get-or-save-account cash-account)</span>
                    <span id="cb452-23"><a href="#cb452-23" aria-hidden="true" tabindex="-1"></a>       (ak:get-or-save-account inventory-account)</span>
                    <span id="cb452-24"><a href="#cb452-24" aria-hidden="true" tabindex="-1"></a>       (ak:get-or-save-account accounts-receivable-account)</span>
                    <span id="cb452-25"><a href="#cb452-25" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Expense</span></span>
                    <span id="cb452-26"><a href="#cb452-26" aria-hidden="true" tabindex="-1"></a>       (ak:get-or-save-account cost-of-goods-sold-account)</span>
                    <span id="cb452-27"><a href="#cb452-27" aria-hidden="true" tabindex="-1"></a>       (ak:get-or-save-account general-expenses-account)</span>
                    <span id="cb452-28"><a href="#cb452-28" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Income</span></span>
                    <span id="cb452-29"><a href="#cb452-29" aria-hidden="true" tabindex="-1"></a>       (ak:get-or-save-account sales-revenue-account)</span>
                    <span id="cb452-30"><a href="#cb452-30" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Liablity</span></span>
                    <span id="cb452-31"><a href="#cb452-31" aria-hidden="true" tabindex="-1"></a>       (ak:get-or-save-account liability-account)</span>
                    <span id="cb452-32"><a href="#cb452-32" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Equity</span></span>
                    <span id="cb452-33"><a href="#cb452-33" aria-hidden="true" tabindex="-1"></a>       (ak:get-or-save-account room-revenue-account)</span>
                    <span id="cb452-34"><a href="#cb452-34" aria-hidden="true" tabindex="-1"></a>       ,@body)))</span></code></pre></div>
                <p>Using <code class="verbatim">with-coa</code> will cause a .db file to be created that we can inspect and run queries on.</p></li>
            <li><p>Making tests</p>
                <p>So now it's time to make some tests. We'll start with some warm-up tests just to see if we can do basic stuff.</p>
                <div class="sourceCode" id="cb453" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb453-1"><a href="#cb453-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; * ░ Accounting ░░░░░░░░░░░░░░░░░░░░</span></span>
                    <span id="cb453-2"><a href="#cb453-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; For our accounting scenarios, we will imagine the accounting for a hotel.</span></span>
                    <span id="cb453-3"><a href="#cb453-3" aria-hidden="true" tabindex="-1"></a><span class="co">;; The hotel sells stays, has a restaurant, and rooms have snack fridges.</span></span>
                    <span id="cb453-4"><a href="#cb453-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; They take cash and credit.</span></span>
                    <span id="cb453-5"><a href="#cb453-5" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb453-6"><a href="#cb453-6" aria-hidden="true" tabindex="-1"></a>(lu:define-test tests-get-account (:tags &#39;(accounting) :contexts (<span class="kw">list</span> <span class="op">#&#39;</span>with-chart-of-accounts-context))</span>
                    <span id="cb453-7"><a href="#cb453-7" aria-hidden="true" tabindex="-1"></a>  (lu:assert-true (ak:get-account <span class="st">&quot;CSH000&quot;</span>)))</span>
                    <span id="cb453-8"><a href="#cb453-8" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb453-9"><a href="#cb453-9" aria-hidden="true" tabindex="-1"></a>(lu:define-test test-account-code (:tags &#39;(accounting) :contexts (<span class="kw">list</span> <span class="op">#&#39;</span>with-chart-of-accounts-context))</span>
                    <span id="cb453-10"><a href="#cb453-10" aria-hidden="true" tabindex="-1"></a>  (lu:assert-equal <span class="st">&quot;CSH000&quot;</span> (ak:account-code (ak:get-account <span class="st">&quot;CSH000&quot;</span>))))</span>
                    <span id="cb453-11"><a href="#cb453-11" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb453-12"><a href="#cb453-12" aria-hidden="true" tabindex="-1"></a>(lu:define-test test-make-account (:tags &#39;(accounting) :contexts (<span class="kw">list</span> <span class="op">#&#39;</span>with-chart-of-accounts-context))</span>
                    <span id="cb453-13"><a href="#cb453-13" aria-hidden="true" tabindex="-1"></a>  (lu:assert-true (<span class="kw">typep</span> (ak:make-account <span class="st">&quot;Expenses&quot;</span> <span class="st">&quot;EXP&quot;</span> <span class="st">&quot;expense&quot;</span>) <span class="dt">&#39;ak</span>:account)))</span>
                    <span id="cb453-14"><a href="#cb453-14" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb453-15"><a href="#cb453-15" aria-hidden="true" tabindex="-1"></a>(lu:define-test test-get-or-create-account (:tags &#39;(accounting) :contexts (<span class="kw">list</span> <span class="op">#&#39;</span>with-chart-of-accounts-context))</span>
                    <span id="cb453-16"><a href="#cb453-16" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((new-account (ak:get-or-save-account (ak:make-account <span class="st">&quot;More Assets&quot;</span> <span class="st">&quot;ASS001&quot;</span> <span class="st">&quot;asset&quot;</span>))))</span>
                    <span id="cb453-17"><a href="#cb453-17" aria-hidden="true" tabindex="-1"></a>    (lu:assert-no-error <span class="dt">&#39;error</span> (ak:account-code (ak:get-account <span class="st">&quot;ASS001&quot;</span>)))))</span></code></pre></div>
                <p>These tests check to see if everything related to getting or making accounts is working. We can run these with <code class="verbatim">(lu:run-tests)</code>. If everything passes, great. If you have a failing test, run <code class="verbatim">(lu:run-tests :run-contexts (list #'lu:with-failure-debugging-context))</code>.</p>
                <p>Assuming you have everything settled with the above tests, let's start getting into the meat of things. Remember that the purpose of these tests is to confirm both that the system is working and that we understand how the accounting works.</p>
                <div class="sourceCode" id="cb454" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb454-1"><a href="#cb454-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; * ░ Transactions ░░░░░░░░░░░░░░░░░░░░</span></span>
                    <span id="cb454-2"><a href="#cb454-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; ** ░ Card Sale of Service ░░░░░░░░░░░░░░░░░░░░</span></span>
                    <span id="cb454-3"><a href="#cb454-3" aria-hidden="true" tabindex="-1"></a><span class="co">;; This scenario involves tracking:</span></span>
                    <span id="cb454-4"><a href="#cb454-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; 1. A card payment going to our Receivable account.</span></span>
                    <span id="cb454-5"><a href="#cb454-5" aria-hidden="true" tabindex="-1"></a><span class="co">;; 2. Card payment provider expense.</span></span>
                    <span id="cb454-6"><a href="#cb454-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; 3. The revenue after paying that expense.</span></span>
                    <span id="cb454-7"><a href="#cb454-7" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb454-8"><a href="#cb454-8" aria-hidden="true" tabindex="-1"></a>(lu:define-test test-transact!<span class="op">-</span>card-sale-of-service (:tags &#39;(accounting transactions)</span>
                    <span id="cb454-9"><a href="#cb454-9" aria-hidden="true" tabindex="-1"></a>                                                     :contexts (<span class="kw">list</span> <span class="op">#&#39;</span>with-chart-of-accounts-context))</span>
                    <span id="cb454-10"><a href="#cb454-10" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb454-11"><a href="#cb454-11" aria-hidden="true" tabindex="-1"></a>  (ak:transact! (ak:debit <span class="st">&quot;REC000&quot;</span> <span class="dv">4500</span>)</span>
                    <span id="cb454-12"><a href="#cb454-12" aria-hidden="true" tabindex="-1"></a>                (ak:debit <span class="st">&quot;GEN000&quot;</span> <span class="dv">500</span>)</span>
                    <span id="cb454-13"><a href="#cb454-13" aria-hidden="true" tabindex="-1"></a>                (ak:credit <span class="st">&quot;RMR000&quot;</span> <span class="dv">5000</span>))</span>
                    <span id="cb454-14"><a href="#cb454-14" aria-hidden="true" tabindex="-1"></a>  (lu:assert-equality <span class="op">#&#39;</span>am:money= (ak:account-balance (ak:get-account <span class="st">&quot;REC000&quot;</span>)) (am:usd <span class="dv">4500</span>))</span>
                    <span id="cb454-15"><a href="#cb454-15" aria-hidden="true" tabindex="-1"></a>  (lu:assert-equality <span class="op">#&#39;</span>am:money= (ak:account-balance (ak:get-account <span class="st">&quot;GEN000&quot;</span>)) (am:usd <span class="dv">500</span>))</span>
                    <span id="cb454-16"><a href="#cb454-16" aria-hidden="true" tabindex="-1"></a>  (lu:assert-equality <span class="op">#&#39;</span>am:money= (ak:account-balance (ak:get-account <span class="st">&quot;RMR000&quot;</span>)) (am:usd <span class="dv">5000</span>)))</span>
                    <span id="cb454-17"><a href="#cb454-17" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb454-18"><a href="#cb454-18" aria-hidden="true" tabindex="-1"></a>(lu:define-test test-transact!<span class="op">-</span>unbalanced-sides (:tags &#39;(accounting transactions)</span>
                    <span id="cb454-19"><a href="#cb454-19" aria-hidden="true" tabindex="-1"></a>                                                 :contexts (<span class="kw">list</span> <span class="op">#&#39;</span>with-chart-of-accounts-context))</span>
                    <span id="cb454-20"><a href="#cb454-20" aria-hidden="true" tabindex="-1"></a>  (lu:assert-error <span class="dt">&#39;ak</span>:unbalanced-transaction (ak:transact! (ak:debit <span class="st">&quot;CSH000&quot;</span> <span class="dv">5000</span>)</span>
                    <span id="cb454-21"><a href="#cb454-21" aria-hidden="true" tabindex="-1"></a>                                                            (ak:credit <span class="st">&quot;RMR000&quot;</span> <span class="dv">4000</span>))))</span>
                    <span id="cb454-22"><a href="#cb454-22" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb454-23"><a href="#cb454-23" aria-hidden="true" tabindex="-1"></a>(lu:define-test test-transact!<span class="op">-</span>not-enough-legs (:tags &#39;(accounting transactions)</span>
                    <span id="cb454-24"><a href="#cb454-24" aria-hidden="true" tabindex="-1"></a>                                                :contexts (<span class="kw">list</span> <span class="op">#&#39;</span>with-chart-of-accounts-context))</span>
                    <span id="cb454-25"><a href="#cb454-25" aria-hidden="true" tabindex="-1"></a>  (lu:assert-error <span class="dt">&#39;simple-error</span> (ak:transact! (ak:debit <span class="st">&quot;CSH000&quot;</span> <span class="dv">5000</span>))))</span></code></pre></div>
                <p>Recall that we're considering the example of a hotel's finances. In the <code class="verbatim">card-cale-of-service</code> scenario, we receive a credit card payment for a room. We credit our Room Revenue income account 5000 cents ($50)–increasing its value. The card payment service charges us 500 cents ($5) that is debited to our general expenses account–adding to its value. Finally we credit our Receivable account the remainder of the money, 4500 cents ($45), which is what we expect to actually have after paying our expenses.</p>
                <p>Since the test begins with no transactions in the database, all three accounts should have account balances equal the amounts they've been increased by.</p>
                <p>The second test just checks that our <code class="verbatim">unbalanced-transaction</code> condition works properly. The third checks to make sure we receive an error if there aren't at least two legs in the transaction.</p>
                <p>We'll make a couple more tests just to confirm that our understanding of the principles of double-entry accounting are solid.</p>
                <div class="sourceCode" id="cb455" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb455-1"><a href="#cb455-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; ** ░ Cash Sale of Goods ░░░░░░░░░░░░░░░░░░░░</span></span>
                    <span id="cb455-2"><a href="#cb455-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; This scenario involves tracking:</span></span>
                    <span id="cb455-3"><a href="#cb455-3" aria-hidden="true" tabindex="-1"></a><span class="co">;; 1. The cash paid.</span></span>
                    <span id="cb455-4"><a href="#cb455-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; 2. The revenue earned.</span></span>
                    <span id="cb455-5"><a href="#cb455-5" aria-hidden="true" tabindex="-1"></a><span class="co">;; 3. The cost of the good sold.</span></span>
                    <span id="cb455-6"><a href="#cb455-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; 4. The reduction in inventory of the good.</span></span>
                    <span id="cb455-7"><a href="#cb455-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; 5. The total profit (revenue - cogs)</span></span>
                    <span id="cb455-8"><a href="#cb455-8" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb455-9"><a href="#cb455-9" aria-hidden="true" tabindex="-1"></a>(lu:define-test test-cash-sale-of-goods (:tags &#39;(accounting transactions)</span>
                    <span id="cb455-10"><a href="#cb455-10" aria-hidden="true" tabindex="-1"></a>                                         :contexts (<span class="kw">list</span> <span class="op">#&#39;</span>with-chart-of-accounts-context))</span>
                    <span id="cb455-11"><a href="#cb455-11" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((cash-account <span class="st">&quot;CSH000&quot;</span>)</span>
                    <span id="cb455-12"><a href="#cb455-12" aria-hidden="true" tabindex="-1"></a>        (sales-account <span class="st">&quot;SLS000&quot;</span>)</span>
                    <span id="cb455-13"><a href="#cb455-13" aria-hidden="true" tabindex="-1"></a>        (cogs-account <span class="st">&quot;CGS000&quot;</span>)</span>
                    <span id="cb455-14"><a href="#cb455-14" aria-hidden="true" tabindex="-1"></a>        (inventory-account <span class="st">&quot;INV000&quot;</span>))</span>
                    <span id="cb455-15"><a href="#cb455-15" aria-hidden="true" tabindex="-1"></a>    (ak:transact! (ak:debit cash-account <span class="dv">5000</span>) (ak:credit sales-account <span class="dv">5000</span>)</span>
                    <span id="cb455-16"><a href="#cb455-16" aria-hidden="true" tabindex="-1"></a>                  (ak:debit inventory-account <span class="dv">3000</span>) (ak:credit cogs-account <span class="dv">3000</span>))</span>
                    <span id="cb455-17"><a href="#cb455-17" aria-hidden="true" tabindex="-1"></a>    (lu:assert-equality <span class="op">#&#39;</span>am:money= (ak:account-balance cash-account) (am:usd <span class="dv">5000</span>))</span>
                    <span id="cb455-18"><a href="#cb455-18" aria-hidden="true" tabindex="-1"></a>    (lu:assert-equality <span class="op">#&#39;</span>am:money= (ak:account-balance sales-account) (am:usd <span class="dv">5000</span>))</span>
                    <span id="cb455-19"><a href="#cb455-19" aria-hidden="true" tabindex="-1"></a>    (lu:assert-equality <span class="op">#&#39;</span>am:money= (ak:account-balance cogs-account) (am:usd <span class="op">-</span><span class="dv">3000</span>)) <span class="co">; Crediting expense account decreases its value.</span></span>
                    <span id="cb455-20"><a href="#cb455-20" aria-hidden="true" tabindex="-1"></a>    (lu:assert-equality <span class="op">#&#39;</span>am:money= (ak:account-balance inventory-account) (am:usd <span class="dv">3000</span>))</span>
                    <span id="cb455-21"><a href="#cb455-21" aria-hidden="true" tabindex="-1"></a>    (lu:assert-equality <span class="op">#&#39;</span>am:money=</span>
                    <span id="cb455-22"><a href="#cb455-22" aria-hidden="true" tabindex="-1"></a>                        (am:money+ (ak:account-balance sales-account) (ak:account-balance cogs-account))</span>
                    <span id="cb455-23"><a href="#cb455-23" aria-hidden="true" tabindex="-1"></a>                        (am:usd <span class="dv">2000</span>))))</span>
                    <span id="cb455-24"><a href="#cb455-24" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb455-25"><a href="#cb455-25" aria-hidden="true" tabindex="-1"></a><span class="co">;; ** ░ Credit Card Sale of Hotel Stay ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span></span>
                    <span id="cb455-26"><a href="#cb455-26" aria-hidden="true" tabindex="-1"></a><span class="co">;; This scenario involves tracking:                         </span></span>
                    <span id="cb455-27"><a href="#cb455-27" aria-hidden="true" tabindex="-1"></a><span class="co">;; 1. Accounts Receivable (Asset) for credit card payment.  </span></span>
                    <span id="cb455-28"><a href="#cb455-28" aria-hidden="true" tabindex="-1"></a><span class="co">;; 2. The room revenue (Equity) earned.                     </span></span>
                    <span id="cb455-29"><a href="#cb455-29" aria-hidden="true" tabindex="-1"></a><span class="co">;; 3. Credit card processing fees (Expense)                 </span></span>
                    <span id="cb455-30"><a href="#cb455-30" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb455-31"><a href="#cb455-31" aria-hidden="true" tabindex="-1"></a>(lu:define-test test-debit-card-sale-of-hotel-stay (:tags &#39;(accounting transactions)</span>
                    <span id="cb455-32"><a href="#cb455-32" aria-hidden="true" tabindex="-1"></a>                                                    :contexts (<span class="kw">list</span> <span class="op">#&#39;</span>with-chart-of-accounts-context))</span>
                    <span id="cb455-33"><a href="#cb455-33" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((receivable-asset-account <span class="st">&quot;REC000&quot;</span>)</span>
                    <span id="cb455-34"><a href="#cb455-34" aria-hidden="true" tabindex="-1"></a>        (general-expense-account <span class="st">&quot;GEN000&quot;</span>)</span>
                    <span id="cb455-35"><a href="#cb455-35" aria-hidden="true" tabindex="-1"></a>        (room-revenue-account <span class="st">&quot;RMR000&quot;</span>)</span>
                    <span id="cb455-36"><a href="#cb455-36" aria-hidden="true" tabindex="-1"></a>        (cash-asset-account <span class="st">&quot;CSH000&quot;</span>))</span>
                    <span id="cb455-37"><a href="#cb455-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Sale is made--debit Receivable Account for card payment, debit general expenses for card fees.</span></span>
                    <span id="cb455-38"><a href="#cb455-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Credit Room Revenue for sale.</span></span>
                    <span id="cb455-39"><a href="#cb455-39" aria-hidden="true" tabindex="-1"></a>    (ak:transact! (ak:credit room-revenue-account (am:usd <span class="dv">5000</span>))</span>
                    <span id="cb455-40"><a href="#cb455-40" aria-hidden="true" tabindex="-1"></a>                  (ak:debit general-expense-account (am:usd <span class="dv">500</span>))</span>
                    <span id="cb455-41"><a href="#cb455-41" aria-hidden="true" tabindex="-1"></a>                  (ak:debit receivable-asset-account (am:usd <span class="dv">4500</span>)))</span>
                    <span id="cb455-42"><a href="#cb455-42" aria-hidden="true" tabindex="-1"></a>    (lu:assert-equality <span class="op">#&#39;</span>am:money=</span>
                    <span id="cb455-43"><a href="#cb455-43" aria-hidden="true" tabindex="-1"></a>                        (ak:account-balance receivable-asset-account)</span>
                    <span id="cb455-44"><a href="#cb455-44" aria-hidden="true" tabindex="-1"></a>                        (am:usd <span class="dv">4500</span>))</span>
                    <span id="cb455-45"><a href="#cb455-45" aria-hidden="true" tabindex="-1"></a>    (lu:assert-equality <span class="op">#&#39;</span>am:money=</span>
                    <span id="cb455-46"><a href="#cb455-46" aria-hidden="true" tabindex="-1"></a>                        (ak:account-balance general-expense-account)</span>
                    <span id="cb455-47"><a href="#cb455-47" aria-hidden="true" tabindex="-1"></a>                        (am:usd <span class="dv">500</span>))</span>
                    <span id="cb455-48"><a href="#cb455-48" aria-hidden="true" tabindex="-1"></a>    (lu:assert-equality <span class="op">#&#39;</span>am:money=</span>
                    <span id="cb455-49"><a href="#cb455-49" aria-hidden="true" tabindex="-1"></a>                        (ak:account-balance room-revenue-account)</span>
                    <span id="cb455-50"><a href="#cb455-50" aria-hidden="true" tabindex="-1"></a>                        (am:usd <span class="dv">5000</span>))</span>
                    <span id="cb455-51"><a href="#cb455-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Bank fulfills payment; clear receivable and add to cash</span></span>
                    <span id="cb455-52"><a href="#cb455-52" aria-hidden="true" tabindex="-1"></a>    (ak:transact! (ak:debit cash-asset-account (am:usd <span class="dv">4500</span>))</span>
                    <span id="cb455-53"><a href="#cb455-53" aria-hidden="true" tabindex="-1"></a>                  (ak:credit receivable-asset-account (am:usd <span class="dv">4500</span>)))</span>
                    <span id="cb455-54"><a href="#cb455-54" aria-hidden="true" tabindex="-1"></a>    (lu:assert-equality <span class="op">#&#39;</span>am:money=</span>
                    <span id="cb455-55"><a href="#cb455-55" aria-hidden="true" tabindex="-1"></a>                        (ak:account-balance receivable-asset-account)</span>
                    <span id="cb455-56"><a href="#cb455-56" aria-hidden="true" tabindex="-1"></a>                        (am:usd <span class="dv">0</span>))</span>
                    <span id="cb455-57"><a href="#cb455-57" aria-hidden="true" tabindex="-1"></a>    (lu:assert-equality <span class="op">#&#39;</span>am:money=</span>
                    <span id="cb455-58"><a href="#cb455-58" aria-hidden="true" tabindex="-1"></a>                        (ak:account-balance cash-asset-account)</span>
                    <span id="cb455-59"><a href="#cb455-59" aria-hidden="true" tabindex="-1"></a>                        (am:usd <span class="dv">4500</span>))))</span></code></pre></div>
                <p>Call <code class="verbatim">(lu:run-tests)</code> again. Everything pass? Good. Let's test one more important feature: the <code class="verbatim">as-of</code> parameter of <code class="verbatim">account-balance</code>.</p>
                <div class="sourceCode" id="cb456" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb456-1"><a href="#cb456-1" aria-hidden="true" tabindex="-1"></a>(lu:define-test test-account-legs-as-of</span>
                    <span id="cb456-2"><a href="#cb456-2" aria-hidden="true" tabindex="-1"></a>    (:tags &#39;(query) :contexts (<span class="kw">list</span> <span class="op">#&#39;</span>with-chart-of-accounts-context))</span>
                    <span id="cb456-3"><a href="#cb456-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((cash (ak:get-account <span class="st">&quot;CSH000&quot;</span>))</span>
                    <span id="cb456-4"><a href="#cb456-4" aria-hidden="true" tabindex="-1"></a>        (sale (ak:get-account <span class="st">&quot;SLS000&quot;</span>))</span>
                    <span id="cb456-5"><a href="#cb456-5" aria-hidden="true" tabindex="-1"></a>        (date (lt:now)))</span>
                    <span id="cb456-6"><a href="#cb456-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> ((<span class="dv">1</span>st (ak:transact! (ak:debit cash (am:usd <span class="dv">500</span>))</span>
                    <span id="cb456-7"><a href="#cb456-7" aria-hidden="true" tabindex="-1"></a>                             (ak:credit sale (am:usd <span class="dv">500</span>))</span>
                    <span id="cb456-8"><a href="#cb456-8" aria-hidden="true" tabindex="-1"></a>                             date))</span>
                    <span id="cb456-9"><a href="#cb456-9" aria-hidden="true" tabindex="-1"></a>          (<span class="dv">2</span>nd (ak:transact! (ak:debit cash (am:usd <span class="dv">500</span>))</span>
                    <span id="cb456-10"><a href="#cb456-10" aria-hidden="true" tabindex="-1"></a>                             (ak:credit sale (am:usd <span class="dv">500</span>))</span>
                    <span id="cb456-11"><a href="#cb456-11" aria-hidden="true" tabindex="-1"></a>                             (lt:timestamp+ date <span class="dv">10</span> :sec))))</span>
                    <span id="cb456-12"><a href="#cb456-12" aria-hidden="true" tabindex="-1"></a>      (lu:assert-number-equal <span class="dv">1</span> (<span class="kw">length</span> (ak:account-legs cash (lt:timestamp+ (ak:transaction-date <span class="dv">2</span>nd) <span class="op">-</span><span class="dv">1</span> :sec)))))))</span></code></pre></div>
                <p>Here we make two transactions, one ten seconds after the other. We set the <code class="verbatim">as-of</code> parameter to one second <em>before</em> the second transaction. We expect for the cash account that we should only have one leg–the one for the first transaction. Call <code class="verbatim">(lu:run-tests)</code> and check if this passes. It does? Good.</p></li>
        </ol>
        <h1 id="7c445704-498d-45c5-ab3c-4e11cc16eda8">DEPLOYING</h1>
        <h2 id="182e344f-5bd4-408d-b444-b0ae7b371856">EXECUTABLE CLI APP</h2>
        <p>Common Lisp can make executables. There are several ways to make executables. Which method you use will depend on the nature of your project.</p>
        <h3 id="tic-tac-toe">Tic-tac-toe</h3>
        <p>Our tic-tac-toe game is the simplest example. We will use SBCL's <code class="verbatim">sb-ext:save-lisp-and-die</code> function.</p>
        <div class="sourceCode" id="cb457" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb457-1"><a href="#cb457-1" aria-hidden="true" tabindex="-1"></a>(sb-ext:save-lisp-and-die #P<span class="st">&quot;path/to/the/binary&quot;</span>                    </span>
            <span id="cb457-2"><a href="#cb457-2" aria-hidden="true" tabindex="-1"></a>                          :top-level <span class="st">&quot;ttt:play-game-with-computer&quot;</span> </span>
            <span id="cb457-3"><a href="#cb457-3" aria-hidden="true" tabindex="-1"></a>                          :executable <span class="kw">t</span>)                          </span></code></pre></div>
        <p>The first argument is the path to the binary you want to create.</p>
        <p>The second argument is the package-qualified name of the "main" function you want to call when running the executable.</p>
        <p>The third argument tells SBCL to return an executable, not a Lisp image.</p>
        <p>In order to call <code class="verbatim">sb-ext:save-lisp-and-die</code>, you of course need to have some code compiled and loaded; however, you can't run it in a Sly REPL. Instead, you need to run it in the command line. That would look like this:</p>
        <pre><code>sbcl --load tic-tac-toe.lisp --eval &quot;(sb-ext:save-lisp-and-die #p\&quot;ttt\&quot; :toplevel #&#39;ttt:play-game-with-computer :executable t)&quot;
        </code></pre>
        <p>First, load the lisp file, then evaluate the call to <code class="verbatim">sb-ext:save-lisp-and-die</code>.</p>
        <p>You can make the process more accessible to users by creating a Makefile to run the above:</p>
        <div class="sourceCode" id="cb459"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb459-1"><a href="#cb459-1" aria-hidden="true" tabindex="-1"></a><span class="dv">build:</span></span>
            <span id="cb459-2"><a href="#cb459-2" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>sbcl --load tic-tac-toe.lisp \</span>
            <span id="cb459-3"><a href="#cb459-3" aria-hidden="true" tabindex="-1"></a>         <span class="ch">-</span><span class="fu">-eval </span><span class="st">&quot;(sb-ext:save-lisp-and-die #p\&quot;</span><span class="fu">ttt\</span><span class="st">&quot; :toplevel #&#39;ttt:play-game-with-computer :executable t)&quot;</span></span></code></pre></div>
        <p>But, if you try to run this, you'll have a problem: the package <code class="verbatim">ttt</code> doesn't exist because we hadn't learned about packages before making the tic-tac-toe game. So let's go add a package definition to the tic-tac-toe.lisp file.</p>
        <div class="sourceCode" id="cb460" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb460-1"><a href="#cb460-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:ttt</span>
            <span id="cb460-2"><a href="#cb460-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> :cl)</span>
            <span id="cb460-3"><a href="#cb460-3" aria-hidden="true" tabindex="-1"></a>  (:export #:play-game-with-computer))</span>
            <span id="cb460-4"><a href="#cb460-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:ttt)</span></code></pre></div>
        <p>With that, you can run <code class="verbatim">make build</code>. Once the executable is created, you can type <code class="verbatim">./ttt</code> in your command line and enjoy a spirited game of tic-tac-toe against the computer.</p>
        <h3 id="almighty-kaikei-1">almighty-kaikei</h3>
        <p>For very simple programs, the above is good enough. However, if your project has an <code class="verbatim">.asd</code> file, then you have the option of making an executable from a whole system.</p>
        <p>The simple version of this process looks like this:</p>
        <ul class="incremental">
            <li>Configure the system to build an executable.</li>
            <li>Load the system with <code class="verbatim">asdf:load-system</code>.</li>
            <li>Run <code class="verbatim">asdf:make</code> on the loaded system.</li>
        </ul>
        <p>This process uses ASDF, rather than calling <code class="verbatim">sb-ext:save-lisp-and-die</code> directly.</p>
        <ol class="incremental">
            <li><p>Configure System</p>
                <p>First, we need to configure the system. In our case, we want to load the <code class="verbatim">almighty-kaikei-examples</code> system, since it actually <em>uses</em> the library.</p>
                <div class="sourceCode" id="cb461" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb461-1"><a href="#cb461-1" aria-hidden="true" tabindex="-1"></a>(defsystem <span class="st">&quot;almighty-kaikei-examples&quot;</span></span>
                    <span id="cb461-2"><a href="#cb461-2" aria-hidden="true" tabindex="-1"></a>  :author <span class="st">&quot;Micah Killian&quot;</span></span>
                    <span id="cb461-3"><a href="#cb461-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">:version</span> <span class="st">&quot;0.0.1&quot;</span></span>
                    <span id="cb461-4"><a href="#cb461-4" aria-hidden="true" tabindex="-1"></a>  :description <span class="st">&quot;Almighty Double-Booking Accounting Program&quot;</span></span>
                    <span id="cb461-5"><a href="#cb461-5" aria-hidden="true" tabindex="-1"></a>  :depends-on (#:almighty-money #:almighty-kaikei #:local-time #:mito #:sxql #:dbi #:dbd-sqlite3)</span>
                    <span id="cb461-6"><a href="#cb461-6" aria-hidden="true" tabindex="-1"></a>  :components ((:file <span class="st">&quot;reports&quot;</span>))</span>
                    <span id="cb461-7"><a href="#cb461-7" aria-hidden="true" tabindex="-1"></a>  :build-operation <span class="st">&quot;program-op&quot;</span></span>
                    <span id="cb461-8"><a href="#cb461-8" aria-hidden="true" tabindex="-1"></a>  :build-pathname <span class="st">&quot;kaikei&quot;</span></span>
                    <span id="cb461-9"><a href="#cb461-9" aria-hidden="true" tabindex="-1"></a>  :entry-point <span class="st">&quot;almighty-kaikei-reports:main&quot;</span>)</span></code></pre></div>
                <ol class="incremental">
                    <li><p>Add driver</p>
                        <p>The first change is in the <code class="verbatim">:depends-on</code> list: <code class="verbatim">cl-dbi</code> will compile and load a driver for your database if you don't already have one loaded. From <a href="https://github.com/fukamachi/cl-dbi?tab=readme-ov-file#installation">the cl-dbi readme</a>:</p>
                        <blockquote>
                            <p>cl-dbi will load another system on the fly depending on your database's driver:</p>
                            <p>:dbd-sqlite3 :dbd-mysql :dbd-postgres</p>
                            <p>You must reference the required one in your system definition if you plan to build an executable (and if you plan to run it on a machine where Quicklisp is not installed).</p>
                        </blockquote>
                        <p>It will cause a nasty error in your executable if you don't add either the <code class="verbatim">:dbd-sqlite3</code>, <code class="verbatim">:dbd-mysql</code>, or <code class="verbatim">:dbd-postgres</code> systems to your system <code class="verbatim">:depends-on</code>. And don't forget to <code class="verbatim">vend get</code> when you add this system!</p></li>
                    <li><p>Add build configuration</p>
                        <p>Next, we add <code class="verbatim">:build-operation</code> with the argument <code class="verbatim">program-op</code>. ASDF has a number of <a href="https://asdf.common-lisp.dev/asdf.html#Predefined-operations-of-ASDF-1">predefined operations (<span>https://asdf.common-lisp.dev/asdf.html#Predefined-operations-of-ASDF-1</span>)</a> for compiling and loading systems. The default op is <code class="verbatim">load-op</code>. If you don't set it to <code class="verbatim">program-op</code>, you will simply load the system and get dropped into a REPL. <code class="verbatim">program-op</code> tells ASDF to make an executable out of the system.</p>
                        <p><code class="verbatim">:build-pathname</code> is the name of the executable file we want to create.</p>
                        <p><code class="verbatim">:entry-point</code> is the package-qualified name of the function we want to call when running the executable. More on this in just a second. For now, our system is all set up with a few changes.</p></li>
                </ol></li>
            <li><p>Load &amp; Make System</p>
                <p>Now we just need to load and make the system. We're going to do things a little differently this time, though. What we'll do is make a <code class="verbatim">build.lisp</code> file and simply load that file. This will give us more flexibility for orchestrating the next steps. First, the Makefile:</p>
                <div class="sourceCode" id="cb462"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb462-1"><a href="#cb462-1" aria-hidden="true" tabindex="-1"></a><span class="dv">kaikei:</span><span class="dt"> build.lisp almighty-kaikei-examples.asd main.lisp reports.lisp</span></span>
                    <span id="cb462-2"><a href="#cb462-2" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>sbcl --load build.lisp </span>
                    <span id="cb462-3"><a href="#cb462-3" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
                <p>The filenames after <code class="verbatim">kaikei:</code> tell make to run the code that follows if any of the files listed are updated.</p>
                <p>Now for the <code class="verbatim">build.lisp</code> file:</p>
                <div class="sourceCode" id="cb463" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb463-1"><a href="#cb463-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> :asdf)</span>
                    <span id="cb463-2"><a href="#cb463-2" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb463-3"><a href="#cb463-3" aria-hidden="true" tabindex="-1"></a><span class="co">;; Force ASDF to only look here for systems.</span></span>
                    <span id="cb463-4"><a href="#cb463-4" aria-hidden="true" tabindex="-1"></a>(asdf:initialize-source-registry `(:source-registry (:tree ,(uiop:getcwd)) :ignore-inherited-configuration))</span>
                    <span id="cb463-5"><a href="#cb463-5" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb463-6"><a href="#cb463-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">progn</span></span>
                    <span id="cb463-7"><a href="#cb463-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;--- LOADING SYSTEM ---~%&quot;</span>)</span>
                    <span id="cb463-8"><a href="#cb463-8" aria-hidden="true" tabindex="-1"></a>  (asdf:load-system :almighty-kaikei-examples)</span>
                    <span id="cb463-9"><a href="#cb463-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;--- SYSTEM LOADED ---~%&quot;</span>))</span>
                    <span id="cb463-10"><a href="#cb463-10" aria-hidden="true" tabindex="-1"></a></span>
                    <span id="cb463-11"><a href="#cb463-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">progn</span></span>
                    <span id="cb463-12"><a href="#cb463-12" aria-hidden="true" tabindex="-1"></a>  (asdf:make <span class="st">&quot;almighty-kaikei-examples&quot;</span>)</span>
                    <span id="cb463-13"><a href="#cb463-13" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">format</span> <span class="kw">t</span> <span class="st">&quot;--- DONE ---~%&quot;</span>)</span>
                    <span id="cb463-14"><a href="#cb463-14" aria-hidden="true" tabindex="-1"></a>  (quit))</span></code></pre></div>
                <p>We <code class="verbatim">require</code> ASDF in order to use it here. <code class="verbatim">require</code> loads a package if it isn't already loaded. Usually ASDF is built into modern implementations of Common Lisp, but this ensures that ASDF is loaded in cases where your implementation doesn't load it (or have it built in).</p>
                <p>The call to <code class="verbatim">asdf:initialize-source-registry</code> is to ensure that when ASDF loads the system that it resolves dependences using only the systems within our project directory.</p>
                <p><code class="verbatim">asdf:load-system</code> is the same operation performed with the REPL shortcut <code class="verbatim">, load-system</code>.</p>
                <p><code class="verbatim">asdf:make</code> runs the <code class="verbatim">:build-operation</code> we configured earlier.</p>
                <p>We run <code class="verbatim">quit</code> because if for some reason you are running <code class="verbatim">make</code> and there are no changes, then no executable will be made and you'll be thrown into the REPL. <code class="verbatim">quit</code> is there to conveniently kick us out immediately.</p></li>
            <li><p>Add <code class="verbatim">almighty-kaikei-examples:main</code> function</p>
                <p>The <code class="verbatim">:entry-point</code> in the system is set to a function called <code class="verbatim">main</code>, but we haven't written that function yet. For now, we're going to make this very simple:</p>
                <div class="sourceCode" id="cb464" data-org-language="lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb464-1"><a href="#cb464-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; add</span></span>
                    <span id="cb464-2"><a href="#cb464-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> main </span>()</span>
                    <span id="cb464-3"><a href="#cb464-3" aria-hidden="true" tabindex="-1"></a>  (with-coa (general-ledger <span class="st">&quot;2025-12-1&quot;</span> <span class="st">&quot;2025-12-5&quot;</span>)))</span></code></pre></div></li>
            <li><p>Run <code class="verbatim">make</code></p>
                <p>Now, all you need to do is run <code class="verbatim">make</code> to create the binary.</p></li>
        </ol>
        <h2 id="f3e5fffd-c0a9-43fd-9369-c3c5a747b999">DEPLOYING FUKA STACK WEB APP</h2>
        <p>We are going to deploy a simple hello world web app to a Ubuntu 24.04 LTS box. We'll make it using the Fuka Stack: <code class="verbatim">clack</code>, <code class="verbatim">lack</code>, <code class="verbatim">woo</code>, and <code class="verbatim">myway</code>. We'll use <code class="verbatim">vend</code> for our dependencies. After we setup a small hello world example of using the Fuka Stack, we'll setup the server, upload the code, build an executable, and then run that executable as a service via <code class="verbatim">systemd</code>.</p>
        <p>If you use Ubuntu 24.04 LTS on an x86-64 processor–the same OS and hardware as the server–you <em>might</em> even be able to skip the step of uploading the code to the server, building the executable on your machine and then uploading the executable to the server.</p>
        <p>The purpose is not to get into the weeds of how to make a web framework. When we get to the part about the code, we'll focus on the parts relevant to deploying, not to setting up the framework.</p>
        <h3 id="5c561c53-71de-45c4-a8b7-42c22623776e">Requirements</h3>
        <ul class="incremental">
            <li>An SSH Key.</li>
            <li>A server with Ubuntu 24.04 LTS.</li>
            <li><code class="verbatim">vend</code> installed on your computer.</li>
        </ul>
        <h3 id="3bd04917-1b8d-405d-bd45-7c6e4d939415">The Server</h3>
        <ol class="incremental">
            <li><p>Add non-root user</p>
                <p>First, SSH into your server. Once you're in, run this command, replacing <code class="verbatim">yourusername</code> with one of your choosing.</p>
                <pre><code>adduser yourusername
                </code></pre>
                <p>Then, give that username sudo permissions.</p>
                <pre><code>usermod -aG sudo yourusername
                </code></pre>
                <p>Then you need to set up SSH for the new username. Exit the SSH session. On your local machine, run this command in the terminal:</p>
                <pre><code>ssh-copy-id yourusername@your-server-ip
                </code></pre></li>
            <li><p>Install Roswell dependencies, libev4, Caddy</p>
                <p>In the terminal, run this command:</p>
                <pre><code>sudo apt install git build-essential automake autoconf libcurl4-openssl-dev zlib1g-dev libev4 -y
                </code></pre></li>
            <li><p>Install Roswell</p>
                <p>We use Roswell so that we can get the latest version of SBCL or use some other implementation later. While Common Lisp isn't getting update, implementations update their compilers, adding optimizations, etc.</p>
                <p>In the terminal, run these commands:</p>
                <pre><code>git clone -b release https://github.com/roswell/roswell.git
cd roswell
sh bootstrap
./configure
make
sudo make install
cd ..
rm -rf roswell
                </code></pre></li>
            <li><p>Install Caddy</p>
                <p>Caddy is a reverse proxy that will let use run our Woo server on port 5000 but be accessible in the browser from <a href="https://the-ip-address-or-domain-name">https://the-ip-address-or-domain-name</a> rather than <a href="https://the-ip-address-or-domain-name:5000">https://the-ip-address-or-domain-name:5000</a>. I like it because it takes care of SSL certificates automatically, so when you use it, <a href="https://">https://</a> just works.</p>
                <p>Run the following commands:</p>
                <pre><code>sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https
curl -1sLf &#39;https://dl.cloudsmith.io/public/caddy/stable/gpg.key&#39; | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf &#39;https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt&#39; | sudo tee /etc/apt/sources.list.d/caddy-stable.list
sudo apt update
sudo apt install caddy
                </code></pre>
                <p>Open up <code class="verbatim">/etc/caddy/Caddyfile</code> with your favorite editor (such as <code class="verbatim">nano</code>). There <em>should</em> already be some default stuff there. Create a block like this:</p>
                <pre><code>your-server-ip-address-or-domain-name {
    reverse_proxy localhost:5000
}
                </code></pre>
                <p>You need to enable and start the service after your changes.</p>
                <pre><code>sudo systemctl enable caddy
sudo systemctl start caddy
                </code></pre></li>
            <li><p>(Optional) Change Hostname</p>
                <p>The server terminal should show something like <code class="verbatim">yourusername@localhost</code>. You can change <code class="verbatim">localhost</code> to something of your choosing.</p>
                <p>Run this command:</p>
                <pre><code>sudo hostnamectl set-hostname almightylisp
                </code></pre>
                <p>Then use our favorite editor to <code class="verbatim">sudo</code> open <code class="verbatim">/etc/hosts</code>. Add <code class="verbatim">127.0.0.1  yourpreferredhostname</code>, save, and close. Then run <code class="verbatim">exec $SHELL</code> or just restart the SSH session.</p>
                <p>With that, you are ready to move on to the code.</p></li>
        </ol>
        <h3 id="a36cfa21-3a7f-4841-9910-5b653ca3f86a">The Code</h3>
        <ol class="incremental">
            <li><p>Project Setup</p>
                <p>First, on your local machine, make a new project root directory called <code class="verbatim">fuka-stack</code>. Inside it, you can also make another directory called <code class="verbatim">src</code>.</p></li>
            <li><p>Build Script, Service, Makefile</p>
                <ol class="incremental">
                    <li><p>Build Script</p>
                        <p>The script for building the executable is going to look similar to our previous <code class="verbatim">build.lisp</code> file. However, this one is a <code class="verbatim">.ros</code> file, used by Roswell to build the executable.</p>
                        <p>Open a buffer in <code class="verbatim">fuka-stack/fuka-stack-app.ros</code>, add the following code, and then save:</p>
                        <div class="sourceCode" id="cb474" data-org-language="lisp" data-tangle="../code/deploying/fuka-stack/fuka-stack-app.ros"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb474-1"><a href="#cb474-1" aria-hidden="true" tabindex="-1"></a>#!/bin/sh</span>
                            <span id="cb474-2"><a href="#cb474-2" aria-hidden="true" tabindex="-1"></a><span class="co">#|-*- mode:lisp -*-|#</span></span>
                            <span id="cb474-3"><a href="#cb474-3" aria-hidden="true" tabindex="-1"></a><span class="co">#|</span></span>
                            <span id="cb474-4"><a href="#cb474-4" aria-hidden="true" tabindex="-1"></a><span class="co">exec ros -Q -- $0 &quot;$@&quot;</span></span>
                            <span id="cb474-5"><a href="#cb474-5" aria-hidden="true" tabindex="-1"></a><span class="co">|#</span></span>
                            <span id="cb474-6"><a href="#cb474-6" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb474-7"><a href="#cb474-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Roswell script header (above) makes this executable</span></span>
                            <span id="cb474-8"><a href="#cb474-8" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb474-9"><a href="#cb474-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:fuka-stack-script</span>
                            <span id="cb474-10"><a href="#cb474-10" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
                            <span id="cb474-11"><a href="#cb474-11" aria-hidden="true" tabindex="-1"></a>  (:export #:main))</span>
                            <span id="cb474-12"><a href="#cb474-12" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:fuka-stack-script)</span>
                            <span id="cb474-13"><a href="#cb474-13" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb474-14"><a href="#cb474-14" aria-hidden="true" tabindex="-1"></a><span class="co">;; Load your system</span></span>
                            <span id="cb474-15"><a href="#cb474-15" aria-hidden="true" tabindex="-1"></a>(asdf:initialize-source-registry</span>
                            <span id="cb474-16"><a href="#cb474-16" aria-hidden="true" tabindex="-1"></a> `(:source-registry</span>
                            <span id="cb474-17"><a href="#cb474-17" aria-hidden="true" tabindex="-1"></a>   (:tree ,(uiop:getcwd))</span>
                            <span id="cb474-18"><a href="#cb474-18" aria-hidden="true" tabindex="-1"></a>   :ignore-inherited-configuration))</span>
                            <span id="cb474-19"><a href="#cb474-19" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb474-20"><a href="#cb474-20" aria-hidden="true" tabindex="-1"></a>(asdf:load-system <span class="st">&quot;fuka-stack&quot;</span>)</span>
                            <span id="cb474-21"><a href="#cb474-21" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb474-22"><a href="#cb474-22" aria-hidden="true" tabindex="-1"></a><span class="co">;; Environment variable utilities.</span></span>
                            <span id="cb474-23"><a href="#cb474-23" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> get-env-int </span>(env default)</span>
                            <span id="cb474-24"><a href="#cb474-24" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((env (uiop:getenv env)))</span>
                            <span id="cb474-25"><a href="#cb474-25" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> env</span>
                            <span id="cb474-26"><a href="#cb474-26" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">parse-integer</span> env <span class="bu">:junk-allowed</span> <span class="kw">t</span>)</span>
                            <span id="cb474-27"><a href="#cb474-27" aria-hidden="true" tabindex="-1"></a>        default)))</span>
                            <span id="cb474-28"><a href="#cb474-28" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb474-29"><a href="#cb474-29" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> get-env </span>(env default)</span>
                            <span id="cb474-30"><a href="#cb474-30" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">or</span> (uiop:getenv env) default))</span>
                            <span id="cb474-31"><a href="#cb474-31" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb474-32"><a href="#cb474-32" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> envp </span>(env)</span>
                            <span id="cb474-33"><a href="#cb474-33" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (<span class="kw">string-equal</span> (uiop:getenvp env) <span class="st">&quot;true&quot;</span>)</span>
                            <span id="cb474-34"><a href="#cb474-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">t</span></span>
                            <span id="cb474-35"><a href="#cb474-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">nil</span>))</span>
                            <span id="cb474-36"><a href="#cb474-36" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb474-37"><a href="#cb474-37" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> main </span>()</span>
                            <span id="cb474-38"><a href="#cb474-38" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((host (get-env <span class="st">&quot;HOST&quot;</span> <span class="st">&quot;127.0.0.1&quot;</span>))</span>
                            <span id="cb474-39"><a href="#cb474-39" aria-hidden="true" tabindex="-1"></a>        (port (get-env-int <span class="st">&quot;PORT&quot;</span> <span class="dv">5000</span>))</span>
                            <span id="cb474-40"><a href="#cb474-40" aria-hidden="true" tabindex="-1"></a>        (debugp (envp <span class="st">&quot;DEBUGP&quot;</span>))) </span>
                            <span id="cb474-41"><a href="#cb474-41" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">handler-case</span></span>
                            <span id="cb474-42"><a href="#cb474-42" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">progn</span></span>
                            <span id="cb474-43"><a href="#cb474-43" aria-hidden="true" tabindex="-1"></a>          (clack:clackup (lack:builder fuka-stack:*component*) :server :woo :address host :port port :debug debugp)</span>
                            <span id="cb474-44"><a href="#cb474-44" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">sleep</span> <span class="kw">most-positive-fixnum</span>))</span>
                            <span id="cb474-45"><a href="#cb474-45" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> (c)</span>
                            <span id="cb474-46"><a href="#cb474-46" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">format</span> <span class="va">*error-output*</span> <span class="st">&quot;Aborting. ~a ~&amp;&quot;</span> c)</span>
                            <span id="cb474-47"><a href="#cb474-47" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">force-output</span> <span class="va">*error-output*</span>)</span>
                            <span id="cb474-48"><a href="#cb474-48" aria-hidden="true" tabindex="-1"></a>        (uiop:quit <span class="dv">1</span>)))))</span></code></pre></div>
                        <p>The <code class="verbatim">.ros</code> file needs to have its own <code class="verbatim">main</code> function. For the purposes of deploying a web app, all you need to understand is this <code class="verbatim">main</code> function. That function uses <code class="verbatim">uiop:getenv</code> via <code class="verbatim">get-env</code> and <code class="verbatim">get-env-int</code> helpers to–you guessed it–get the environment variables <code class="verbatim">HOST</code> and <code class="verbatim">PORT</code>, defaulting to <code class="verbatim">127.0.01</code> and <code class="verbatim">5000</code>. If the <code class="verbatim">DEBUGP</code> environment variable is set to <code class="verbatim">true</code>, then the <code class="verbatim">clack:clackup</code> <code class="verbatim">:debug</code> setting will be set to <code class="verbatim">t</code>, otherwise <code class="verbatim">nil</code>. Later we'll change the variables on the production environment, but this allows you to try this code out on your computer.</p>
                        <p><code class="verbatim">sleep</code> is a function we haven't seen before. Usually, after loading the system and calling <code class="verbatim">clack:clackup</code> to start the server, it will remain on (usually you save it to a parameter so you can turn it off with <code class="verbatim">clack:stop</code>).</p>
                        <p>When you run the executable built with this code, if you don't include the call to <code class="verbatim">(sleep most-positive-fixnum)</code>, systemd will assume your executable is done working and stop the service, turning off your server.</p></li>
                    <li><p>Service &amp; Env files</p>
                        <p>We will need to run our executable as a service. If we don't, the server will block our terminal session, and if there is an error, it will simply crash the server. Systemd can be configured to restart any crashed services, and the service won't block our terminal session, either.</p>
                        <p>Open a buffer in <code class="verbatim">fuka-stack/fuka-stack-app.service</code>, add the following code, and then save.</p>
                        <div class="sourceCode" id="cb475" data-tangle="../code/deploying/fuka-stack/fuka-stack-app.service"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb475-1"><a href="#cb475-1" aria-hidden="true" tabindex="-1"></a>[Unit]</span>
                            <span id="cb475-2"><a href="#cb475-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Description</span><span class="ch">=</span><span class="st">Fuka Base App</span></span>
                            <span id="cb475-3"><a href="#cb475-3" aria-hidden="true" tabindex="-1"></a><span class="dt">After</span><span class="ch">=</span><span class="st">network.target</span></span>
                            <span id="cb475-4"><a href="#cb475-4" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb475-5"><a href="#cb475-5" aria-hidden="true" tabindex="-1"></a>[Service]</span>
                            <span id="cb475-6"><a href="#cb475-6" aria-hidden="true" tabindex="-1"></a><span class="dt">Type</span><span class="ch">=</span><span class="st">simple</span></span>
                            <span id="cb475-7"><a href="#cb475-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace with the username you create when setting up the server</span></span>
                            <span id="cb475-8"><a href="#cb475-8" aria-hidden="true" tabindex="-1"></a><span class="dt">User</span><span class="ch">=</span><span class="st">micah </span></span>
                            <span id="cb475-9"><a href="#cb475-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ...same here</span></span>
                            <span id="cb475-10"><a href="#cb475-10" aria-hidden="true" tabindex="-1"></a><span class="dt">WorkingDirectory</span><span class="ch">=</span><span class="st">/home/micah/.local/bin/</span></span>
                            <span id="cb475-11"><a href="#cb475-11" aria-hidden="true" tabindex="-1"></a><span class="dt">EnvironmentFile</span><span class="ch">=</span><span class="st">/etc/systemd/system/fuka-stack-app.env</span></span>
                            <span id="cb475-12"><a href="#cb475-12" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb475-13"><a href="#cb475-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ...and here</span></span>
                            <span id="cb475-14"><a href="#cb475-14" aria-hidden="true" tabindex="-1"></a><span class="dt">ExecStart</span><span class="ch">=</span><span class="st">/home/micah/.local/bin/fuka-stack</span></span>
                            <span id="cb475-15"><a href="#cb475-15" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb475-16"><a href="#cb475-16" aria-hidden="true" tabindex="-1"></a><span class="dt">TimeoutStartSec</span><span class="ch">=</span><span class="st">120</span></span>
                            <span id="cb475-17"><a href="#cb475-17" aria-hidden="true" tabindex="-1"></a><span class="dt">TimeoutStopSec</span><span class="ch">=</span><span class="st">10</span></span>
                            <span id="cb475-18"><a href="#cb475-18" aria-hidden="true" tabindex="-1"></a><span class="dt">KillMode</span><span class="ch">=</span><span class="st">process</span></span>
                            <span id="cb475-19"><a href="#cb475-19" aria-hidden="true" tabindex="-1"></a><span class="dt">KillSignal</span><span class="ch">=</span><span class="st">SIGTERM</span></span>
                            <span id="cb475-20"><a href="#cb475-20" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb475-21"><a href="#cb475-21" aria-hidden="true" tabindex="-1"></a><span class="dt">Restart</span><span class="ch">=</span><span class="st">on-failure</span></span>
                            <span id="cb475-22"><a href="#cb475-22" aria-hidden="true" tabindex="-1"></a><span class="dt">RestartSec</span><span class="ch">=</span><span class="st">5</span></span>
                            <span id="cb475-23"><a href="#cb475-23" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb475-24"><a href="#cb475-24" aria-hidden="true" tabindex="-1"></a>[Install]</span>
                            <span id="cb475-25"><a href="#cb475-25" aria-hidden="true" tabindex="-1"></a><span class="dt">WantedBy</span><span class="ch">=</span><span class="st">multi-user.target</span></span></code></pre></div>
                        <p>We also need environment variables set up, which we can do in a separate file (notice <code class="verbatim">EnvironmentFile</code> above).</p>
                        <p>Open a buffer in <code class="verbatim">fuka-stack/fuka-stack-app.env</code>, add the following code, and then save.</p>
                        <div class="sourceCode" id="cb476" data-tangle="../code/deploying/fuka-stack/fuka-stack-app.env"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb476-1"><a href="#cb476-1" aria-hidden="true" tabindex="-1"></a><span class="dt">HOST</span><span class="ch">=</span><span class="st">0.0.0.0</span></span>
                            <span id="cb476-2"><a href="#cb476-2" aria-hidden="true" tabindex="-1"></a><span class="dt">PORT</span><span class="ch">=</span><span class="st">5000</span></span>
                            <span id="cb476-3"><a href="#cb476-3" aria-hidden="true" tabindex="-1"></a><span class="dt">DEBUGP</span><span class="ch">=</span><span class="st">false</span></span></code></pre></div></li>
                    <li><p>Makefile</p>
                        <p>The makefile includes both <code class="verbatim">make</code> and <code class="verbatim">make install</code> commands. Open a buffer in <code class="verbatim">fuka-stack/makefile</code> and save this code inside:</p>
                        <div class="sourceCode" id="cb477" data-tangle="../code/deploying/fuka-stack/makefile"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb477-1"><a href="#cb477-1" aria-hidden="true" tabindex="-1"></a><span class="dv">fuka-stack:</span><span class="dt"> build.lisp *.asd *.lisp src/*.lisp</span></span>
                            <span id="cb477-2"><a href="#cb477-2" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>ros build fuka-stack-app.ros</span>
                            <span id="cb477-3"><a href="#cb477-3" aria-hidden="true" tabindex="-1"></a><span class="dv">install:</span></span>
                            <span id="cb477-4"><a href="#cb477-4" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>mv fuka-stack-app ~/.local/bin/fuka-stack-app</span>
                            <span id="cb477-5"><a href="#cb477-5" aria-hidden="true" tabindex="-1"></a>    sudo cp fuka-stack-app.service /etc/systemd/system/fuka-stack-app.service</span>
                            <span id="cb477-6"><a href="#cb477-6" aria-hidden="true" tabindex="-1"></a>    sudo cp fuka-stack-app.env /etc/systemd/system/fuka-stack-app.env</span>
                            <span id="cb477-7"><a href="#cb477-7" aria-hidden="true" tabindex="-1"></a>    sudo systemctl daemon-reload</span>
                            <span id="cb477-8"><a href="#cb477-8" aria-hidden="true" tabindex="-1"></a>    sudo systemctl enable fuka-stack-app.service</span>
                            <span id="cb477-9"><a href="#cb477-9" aria-hidden="true" tabindex="-1"></a><span class="dv">run:</span></span>
                            <span id="cb477-10"><a href="#cb477-10" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>sudo systemctl start fuka-stack-app.service</span></code></pre></div>
                        <p><code class="verbatim">make</code> will run Roswell's version of SBCL to build the executable. If you want to use/test this script locally you need to install Roswell.</p>
                        <p><code class="verbatim">make install</code> will move the <code class="verbatim">fuka-stack-app</code> executable, setup the systemd service and environment variables, and then start the service.</p></li>
                </ol></li>
            <li><p>Hello World Code</p>
                <p>Now that we have our server set up, and we have all we need to build an executable and start it as a service, we can make our hello-world web app.</p>
                <ol class="incremental">
                    <li><p>System</p>
                        <p>In the project root directory, make a file called <code class="verbatim">fuka-stack.asd</code> and place the below code into it.</p>
                        <div class="sourceCode" id="cb478" data-org-language="lisp" data-tangle="../code/deploying/fuka-stack/fuka-stack.asd"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb478-1"><a href="#cb478-1" aria-hidden="true" tabindex="-1"></a>(defsystem <span class="st">&quot;fuka-stack&quot;</span></span>
                            <span id="cb478-2"><a href="#cb478-2" aria-hidden="true" tabindex="-1"></a>  :author <span class="st">&quot;Micah Killian &lt;micah@killianarts.online&gt;&quot;</span></span>
                            <span id="cb478-3"><a href="#cb478-3" aria-hidden="true" tabindex="-1"></a>  :maintainer <span class="st">&quot;Micah Killian &lt;micah@killianarts.online&gt;&quot;</span></span>
                            <span id="cb478-4"><a href="#cb478-4" aria-hidden="true" tabindex="-1"></a>  :description <span class="st">&quot;Fuka Stack hello world deploy example&quot;</span></span>
                            <span id="cb478-5"><a href="#cb478-5" aria-hidden="true" tabindex="-1"></a>  :license <span class="st">&quot;MIT&quot;</span></span>
                            <span id="cb478-6"><a href="#cb478-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">:version</span> <span class="st">&quot;0.1&quot;</span></span>
                            <span id="cb478-7"><a href="#cb478-7" aria-hidden="true" tabindex="-1"></a>  :depends-on (:clack</span>
                            <span id="cb478-8"><a href="#cb478-8" aria-hidden="true" tabindex="-1"></a>               :woo </span>
                            <span id="cb478-9"><a href="#cb478-9" aria-hidden="true" tabindex="-1"></a>               :myway</span>
                            <span id="cb478-10"><a href="#cb478-10" aria-hidden="true" tabindex="-1"></a>               :lack</span>
                            <span id="cb478-11"><a href="#cb478-11" aria-hidden="true" tabindex="-1"></a>               :lack-component</span>
                            <span id="cb478-12"><a href="#cb478-12" aria-hidden="true" tabindex="-1"></a>               :lack-request</span>
                            <span id="cb478-13"><a href="#cb478-13" aria-hidden="true" tabindex="-1"></a>               :lack-response)</span>
                            <span id="cb478-14"><a href="#cb478-14" aria-hidden="true" tabindex="-1"></a>  :components ((:module <span class="st">&quot;src&quot;</span></span>
                            <span id="cb478-15"><a href="#cb478-15" aria-hidden="true" tabindex="-1"></a>                :components</span>
                            <span id="cb478-16"><a href="#cb478-16" aria-hidden="true" tabindex="-1"></a>                ((:file <span class="st">&quot;main&quot;</span>)))))</span></code></pre></div>
                        <p>Notice that we don't have any of the build options like we had for the previous executable CLI app. That's because we'll be using Roswell to build the executable.</p>
                        <p>Save this file and then be sure to run <code class="verbatim">vend get</code> to download the dependencies into your project.</p></li>
                    <li><p>Main</p>
                        <p>Finally, we have the main body of the app. I won't be explaining the mechanics of the stack–that is the subject of a future book.</p>
                        <p>Open a buffer in <code class="verbatim">fuka-stack/src/main.lisp</code>, add this code, and save it.</p>
                        <div class="sourceCode" id="cb479" data-org-language="lisp" data-tangle="../code/deploying/fuka-stack/src/main.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb479-1"><a href="#cb479-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:fuka-stack</span>
                            <span id="cb479-2"><a href="#cb479-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
                            <span id="cb479-3"><a href="#cb479-3" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:nicknames</span> #:fuka-stack/main))</span>
                            <span id="cb479-4"><a href="#cb479-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:fuka-stack/main)</span>
                            <span id="cb479-5"><a href="#cb479-5" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb479-6"><a href="#cb479-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Lack setup</span></span>
                            <span id="cb479-7"><a href="#cb479-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> fuka-component </span>(lack/component::lack-component)</span>
                            <span id="cb479-8"><a href="#cb479-8" aria-hidden="true" tabindex="-1"></a>  ((routes :initarg :routes :accessor component-routes :initform (myway:make-mapper))))</span>
                            <span id="cb479-9"><a href="#cb479-9" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb479-10"><a href="#cb479-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *component*</span></span>
                            <span id="cb479-11"><a href="#cb479-11" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">make-instance</span> <span class="dt">&#39;fuka-component</span>))</span>
                            <span id="cb479-12"><a href="#cb479-12" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb479-13"><a href="#cb479-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *request* </span><span class="kw">nil</span>)</span>
                            <span id="cb479-14"><a href="#cb479-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *response* </span><span class="kw">nil</span>)</span>
                            <span id="cb479-15"><a href="#cb479-15" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb479-16"><a href="#cb479-16" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> lack/component</span>:call ((component fuka-component) env)</span>
                            <span id="cb479-17"><a href="#cb479-17" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((*request* (lack/request:make-request env)))</span>
                            <span id="cb479-18"><a href="#cb479-18" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">multiple-value-bind</span> (response foundp)</span>
                            <span id="cb479-19"><a href="#cb479-19" aria-hidden="true" tabindex="-1"></a>        (myway:dispatch (<span class="kw">slot-value</span> component <span class="dt">&#39;routes</span>)</span>
                            <span id="cb479-20"><a href="#cb479-20" aria-hidden="true" tabindex="-1"></a>                        (lack/request:request-path-info *request*)</span>
                            <span id="cb479-21"><a href="#cb479-21" aria-hidden="true" tabindex="-1"></a>                        :method (lack/request:request-method *request*))</span>
                            <span id="cb479-22"><a href="#cb479-22" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">if</span> foundp</span>
                            <span id="cb479-23"><a href="#cb479-23" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">if</span> (<span class="kw">functionp</span> response)</span>
                            <span id="cb479-24"><a href="#cb479-24" aria-hidden="true" tabindex="-1"></a>              response</span>
                            <span id="cb479-25"><a href="#cb479-25" aria-hidden="true" tabindex="-1"></a>              (<span class="kw">destructuring-bind</span> (status headers body) response</span>
                            <span id="cb479-26"><a href="#cb479-26" aria-hidden="true" tabindex="-1"></a>                (lack/response:finalize-response (lack/response:make-response status headers body))))</span>
                            <span id="cb479-27"><a href="#cb479-27" aria-hidden="true" tabindex="-1"></a>          (lack/response:finalize-response (lack/response:make-response <span class="dv">404</span> &#39;(:content-type <span class="st">&quot;text/html&quot;</span>) &#39;(<span class="st">&quot;Not found&quot;</span>)))))))</span>
                            <span id="cb479-28"><a href="#cb479-28" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb479-29"><a href="#cb479-29" aria-hidden="true" tabindex="-1"></a><span class="co">;; Clack response utility</span></span>
                            <span id="cb479-30"><a href="#cb479-30" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> http-response </span>(body &amp;key (code <span class="dv">200</span>) (headers <span class="kw">nil</span>))</span>
                            <span id="cb479-31"><a href="#cb479-31" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((headers (<span class="kw">append</span> `(:content-type <span class="st">&quot;text/html; charset=utf-8&quot;</span></span>
                            <span id="cb479-32"><a href="#cb479-32" aria-hidden="true" tabindex="-1"></a>                           :content-length ,(<span class="kw">length</span> body))</span>
                            <span id="cb479-33"><a href="#cb479-33" aria-hidden="true" tabindex="-1"></a>                         headers)))</span>
                            <span id="cb479-34"><a href="#cb479-34" aria-hidden="true" tabindex="-1"></a>    `(,code ,headers (,body))))</span>
                            <span id="cb479-35"><a href="#cb479-35" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb479-36"><a href="#cb479-36" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb479-37"><a href="#cb479-37" aria-hidden="true" tabindex="-1"></a><span class="co">;; Myway routing utilities</span></span>
                            <span id="cb479-38"><a href="#cb479-38" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> make-endpoint </span>(fn)</span>
                            <span id="cb479-39"><a href="#cb479-39" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">lambda</span> (params)</span>
                            <span id="cb479-40"><a href="#cb479-40" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">funcall</span> (<span class="kw">symbol-function</span> fn) params)))</span>
                            <span id="cb479-41"><a href="#cb479-41" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb479-42"><a href="#cb479-42" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> route </span>(<span class="kw">method</span> routing-rule endpoint &amp;optional (mapper (component-routes *component*)))</span>
                            <span id="cb479-43"><a href="#cb479-43" aria-hidden="true" tabindex="-1"></a>  (myway:connect mapper</span>
                            <span id="cb479-44"><a href="#cb479-44" aria-hidden="true" tabindex="-1"></a>                 routing-rule</span>
                            <span id="cb479-45"><a href="#cb479-45" aria-hidden="true" tabindex="-1"></a>                 (make-endpoint endpoint)</span>
                            <span id="cb479-46"><a href="#cb479-46" aria-hidden="true" tabindex="-1"></a>                 :method <span class="kw">method</span>))</span>
                            <span id="cb479-47"><a href="#cb479-47" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb479-48"><a href="#cb479-48" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb479-49"><a href="#cb479-49" aria-hidden="true" tabindex="-1"></a><span class="co">;; Index controller and route</span></span>
                            <span id="cb479-50"><a href="#cb479-50" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> index </span>(params)</span>
                            <span id="cb479-51"><a href="#cb479-51" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">declare</span> (<span class="kw">ignore</span> params))</span>
                            <span id="cb479-52"><a href="#cb479-52" aria-hidden="true" tabindex="-1"></a>  (http-response (<span class="kw">format</span> <span class="kw">nil</span></span>
                            <span id="cb479-53"><a href="#cb479-53" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Hello, world! This is the path: ~a. This is the HTTP request method: ~a.&quot;</span></span>
                            <span id="cb479-54"><a href="#cb479-54" aria-hidden="true" tabindex="-1"></a>                         (lack/request:request-path-info *request*)</span>
                            <span id="cb479-55"><a href="#cb479-55" aria-hidden="true" tabindex="-1"></a>                         (lack/request:request-method *request*))))</span>
                            <span id="cb479-56"><a href="#cb479-56" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb479-57"><a href="#cb479-57" aria-hidden="true" tabindex="-1"></a>(route :GET <span class="st">&quot;/&quot;</span> <span class="dt">&#39;index</span>)</span></code></pre></div></li>
                </ol></li>
        </ol>
        <h3 id="f7028007-a91d-4b80-aef3-fe9524b6be84">The Deploy</h3>
        <p>You are one the precipice of a new beginning, my friend. Your Common Lisp web development life arch begins with the next two steps.</p>
        <ol class="incremental">
            <li><p>Uploading Code</p>
                <p>It's time to upload your code to the server. If you are comfortable using git, you could use it now. For the sake of simplicity, we'll just upload with the <code class="verbatim">rsync</code> command.</p>
                <p>From your local machine, run this command:</p>
                <pre><code>rsync -avz --progress ~/path/to/your/local/version/of/fuka-stack yourusername@domain-name-or-ip-address-to-your-server:/home/yourusername/fuka-stack
                </code></pre></li>
            <li><p>Run <code class="verbatim">make</code> Commands</p>
                <p>Now all you need to do is ssh back into your server, navigate to the fuka-stack directory, and run the <code class="verbatim">make</code>, <code class="verbatim">make install</code>, and <code class="verbatim">make run</code> commands in order. If all goes well (and we know things always go well with deploys), you should now be able to access your hello-world example in your browser with <a href="https://your-domain-name-or-server-ip-address">https://your-domain-name-or-server-ip-address</a>.</p>
                <p>Congratulations, you have successfully deployed a Common Lisp web app!</p></li>
        </ol>
        <h3 id="summary">Summary</h3>
        <p>There are a number of things we could have done differently. We could have skipped Roswell and just used whatever version of SBCL was available on the Ubuntu 24.04 LTS package repository. We could have compiled the latest one from source. We could have built the executable in about three other ways. We could have used nginx instead of Caddy. We could have used <code class="verbatim">hunchentoot</code> instead of <code class="verbatim">clack</code> and friends. We could have used Docker to set up the entire environment on the server and simply run the code from that environment.</p>
        <p>The principles to keep in mind when deploying a Common Lisp web app are these:</p>
        <ol class="incremental">
            <li>You need to have some entry point–the call to start the server.</li>
            <li>You need to run that call <em>someway</em> as a service to enable automatic restarts.</li>
            <li>You will need to call <code class="verbatim">sleep</code> in the entry point to keep the server thread open in the background.</li>
            <li>You want to turn off the debugger in prod.</li>
        </ol>
        <h2 id="fbe5717c-2302-46ad-9f21-9b178aa8d6d5">HOLD DEPLOYING AN ELECTRON APP</h2>
        <h3 id="5af8862d-4b1c-4003-9fcf-ac1dc9cb93e0">The Code</h3>
        <ol class="incremental">
            <li><p>Project Setup</p>
                <p>First, on your local machine, make a new project root directory called <code class="verbatim">fuka-stack</code>. Inside it, you can also make another directory called <code class="verbatim">src</code>.</p></li>
            <li><p>Build Script, Service, Makefile</p>
                <ol class="incremental">
                    <li><p>Build Script</p>
                        <p>The script for building the executable is going to look similar to our previous <code class="verbatim">build.lisp</code> file. However, this one is a <code class="verbatim">.ros</code> file, used by Roswell to build the executable.</p>
                        <p>Open a buffer in <code class="verbatim">fuka-stack/fuka-stack-app.ros</code>, add the following code, and then save:</p>
                        <div class="sourceCode" id="cb481" data-org-language="lisp" data-tangle="../code/deploying/ceramic-app/ceramic-app.ros"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb481-1"><a href="#cb481-1" aria-hidden="true" tabindex="-1"></a>#!/bin/sh</span>
                            <span id="cb481-2"><a href="#cb481-2" aria-hidden="true" tabindex="-1"></a><span class="co">#|-*- mode:lisp -*-|#</span></span>
                            <span id="cb481-3"><a href="#cb481-3" aria-hidden="true" tabindex="-1"></a><span class="co">#|</span></span>
                            <span id="cb481-4"><a href="#cb481-4" aria-hidden="true" tabindex="-1"></a><span class="co">exec ros -Q -- $0 &quot;$@&quot;</span></span>
                            <span id="cb481-5"><a href="#cb481-5" aria-hidden="true" tabindex="-1"></a><span class="co">|#</span></span>
                            <span id="cb481-6"><a href="#cb481-6" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb481-7"><a href="#cb481-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Roswell script header (above) makes this executable</span></span>
                            <span id="cb481-8"><a href="#cb481-8" aria-hidden="true" tabindex="-1"></a>(ql:quickload <span class="st">&quot;ceramic&quot;</span>)</span>
                            <span id="cb481-9"><a href="#cb481-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:ceramic-app-script</span>
                            <span id="cb481-10"><a href="#cb481-10" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
                            <span id="cb481-11"><a href="#cb481-11" aria-hidden="true" tabindex="-1"></a>  (:export #:main))</span>
                            <span id="cb481-12"><a href="#cb481-12" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:ceramic-app-script)</span>
                            <span id="cb481-13"><a href="#cb481-13" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb481-14"><a href="#cb481-14" aria-hidden="true" tabindex="-1"></a><span class="co">;; Load your system</span></span>
                            <span id="cb481-15"><a href="#cb481-15" aria-hidden="true" tabindex="-1"></a>(asdf:initialize-source-registry</span>
                            <span id="cb481-16"><a href="#cb481-16" aria-hidden="true" tabindex="-1"></a> `(:source-registry</span>
                            <span id="cb481-17"><a href="#cb481-17" aria-hidden="true" tabindex="-1"></a>   (:tree ,(uiop:getcwd))</span>
                            <span id="cb481-18"><a href="#cb481-18" aria-hidden="true" tabindex="-1"></a>   :ignore-inherited-configuration))</span>
                            <span id="cb481-19"><a href="#cb481-19" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb481-20"><a href="#cb481-20" aria-hidden="true" tabindex="-1"></a>(asdf:load-system <span class="st">&quot;ceramic-app&quot;</span>)</span>
                            <span id="cb481-21"><a href="#cb481-21" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb481-22"><a href="#cb481-22" aria-hidden="true" tabindex="-1"></a><span class="co">;; Environment variable utilities.</span></span>
                            <span id="cb481-23"><a href="#cb481-23" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> get-env-int </span>(env default)</span>
                            <span id="cb481-24"><a href="#cb481-24" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((env (uiop:getenv env)))</span>
                            <span id="cb481-25"><a href="#cb481-25" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> env</span>
                            <span id="cb481-26"><a href="#cb481-26" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">parse-integer</span> env <span class="bu">:junk-allowed</span> <span class="kw">t</span>)</span>
                            <span id="cb481-27"><a href="#cb481-27" aria-hidden="true" tabindex="-1"></a>        default)))</span>
                            <span id="cb481-28"><a href="#cb481-28" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb481-29"><a href="#cb481-29" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> get-env </span>(env default)</span>
                            <span id="cb481-30"><a href="#cb481-30" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">or</span> (uiop:getenv env) default))</span>
                            <span id="cb481-31"><a href="#cb481-31" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb481-32"><a href="#cb481-32" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> envp </span>(env)</span>
                            <span id="cb481-33"><a href="#cb481-33" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (<span class="kw">string-equal</span> (uiop:getenvp env) <span class="st">&quot;true&quot;</span>)</span>
                            <span id="cb481-34"><a href="#cb481-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">t</span></span>
                            <span id="cb481-35"><a href="#cb481-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">nil</span>))</span>
                            <span id="cb481-36"><a href="#cb481-36" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb481-37"><a href="#cb481-37" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> main </span>()</span>
                            <span id="cb481-38"><a href="#cb481-38" aria-hidden="true" tabindex="-1"></a>  (ceramic:setup)</span>
                            <span id="cb481-39"><a href="#cb481-39" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((connection (clack:clackup (lack:builder ceramic-app:*component*) :server :woo :address <span class="st">&quot;127.0.0.1&quot;</span> :port <span class="dv">5000</span> :debug <span class="kw">nil</span>))</span>
                            <span id="cb481-40"><a href="#cb481-40" aria-hidden="true" tabindex="-1"></a>        (window (ceramic:make-window :url <span class="st">&quot;http://127.0.0.1:5000&quot;</span>)))</span>
                            <span id="cb481-41"><a href="#cb481-41" aria-hidden="true" tabindex="-1"></a>    (ceramic:show-window window)))</span></code></pre></div>
                        <p>The <code class="verbatim">.ros</code> file needs to have its own <code class="verbatim">main</code> function. For the purposes of deploying a web app, all you need to understand is this <code class="verbatim">main</code> function. That function uses <code class="verbatim">uiop:getenv</code> via <code class="verbatim">get-env</code> and <code class="verbatim">get-env-int</code> helpers to–you guessed it–get the environment variables <code class="verbatim">HOST</code> and <code class="verbatim">PORT</code>, defaulting to <code class="verbatim">127.0.01</code> and <code class="verbatim">5000</code>. If the <code class="verbatim">DEBUGP</code> environment variable is set to <code class="verbatim">true</code>, then the <code class="verbatim">clack:clackup</code> <code class="verbatim">:debug</code> setting will be set to <code class="verbatim">t</code>, otherwise <code class="verbatim">nil</code>. Later we'll change the variables on the production environment, but this allows you to try this code out on your computer.</p>
                        <p><code class="verbatim">sleep</code> is a function we haven't seen before. Usually, after loading the system and calling <code class="verbatim">clack:clackup</code> to start the server, it will remain on (usually you save it to a parameter so you can turn it off with <code class="verbatim">clack:stop</code>).</p>
                        <p>When you run the executable built with this code, if you don't include the call to <code class="verbatim">(sleep most-positive-fixnum)</code>, systemd will assume your executable is done working and stop the service, turning off your server.</p></li>
                    <li><p>Service &amp; Env files</p>
                        <p>We will need to run our executable as a service. If we don't, the server will block our terminal session, and if there is an error, it will simply crash the server. Systemd can be configured to restart any crashed services, and the service won't block our terminal session, either.</p>
                        <p>Open a buffer in <code class="verbatim">fuka-stack/fuka-stack-app.service</code>, add the following code, and then save.</p>
                        <div class="sourceCode" id="cb482" data-tangle="../code/deploying/ceramic-app/cer"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb482-1"><a href="#cb482-1" aria-hidden="true" tabindex="-1"></a>[Unit]</span>
                            <span id="cb482-2"><a href="#cb482-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Description</span><span class="ch">=</span><span class="st">Fuka Base App</span></span>
                            <span id="cb482-3"><a href="#cb482-3" aria-hidden="true" tabindex="-1"></a><span class="dt">After</span><span class="ch">=</span><span class="st">network.target</span></span>
                            <span id="cb482-4"><a href="#cb482-4" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb482-5"><a href="#cb482-5" aria-hidden="true" tabindex="-1"></a>[Service]</span>
                            <span id="cb482-6"><a href="#cb482-6" aria-hidden="true" tabindex="-1"></a><span class="dt">Type</span><span class="ch">=</span><span class="st">simple</span></span>
                            <span id="cb482-7"><a href="#cb482-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace with the username you create when setting up the server</span></span>
                            <span id="cb482-8"><a href="#cb482-8" aria-hidden="true" tabindex="-1"></a><span class="dt">User</span><span class="ch">=</span><span class="st">micah </span></span>
                            <span id="cb482-9"><a href="#cb482-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ...same here</span></span>
                            <span id="cb482-10"><a href="#cb482-10" aria-hidden="true" tabindex="-1"></a><span class="dt">WorkingDirectory</span><span class="ch">=</span><span class="st">/home/micah/.local/bin/</span></span>
                            <span id="cb482-11"><a href="#cb482-11" aria-hidden="true" tabindex="-1"></a><span class="dt">EnvironmentFile</span><span class="ch">=</span><span class="st">/etc/systemd/system/fuka-stack-app.env</span></span>
                            <span id="cb482-12"><a href="#cb482-12" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb482-13"><a href="#cb482-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ...and here</span></span>
                            <span id="cb482-14"><a href="#cb482-14" aria-hidden="true" tabindex="-1"></a><span class="dt">ExecStart</span><span class="ch">=</span><span class="st">/home/micah/.local/bin/fuka-stack</span></span>
                            <span id="cb482-15"><a href="#cb482-15" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb482-16"><a href="#cb482-16" aria-hidden="true" tabindex="-1"></a><span class="dt">TimeoutStartSec</span><span class="ch">=</span><span class="st">120</span></span>
                            <span id="cb482-17"><a href="#cb482-17" aria-hidden="true" tabindex="-1"></a><span class="dt">TimeoutStopSec</span><span class="ch">=</span><span class="st">10</span></span>
                            <span id="cb482-18"><a href="#cb482-18" aria-hidden="true" tabindex="-1"></a><span class="dt">KillMode</span><span class="ch">=</span><span class="st">process</span></span>
                            <span id="cb482-19"><a href="#cb482-19" aria-hidden="true" tabindex="-1"></a><span class="dt">KillSignal</span><span class="ch">=</span><span class="st">SIGTERM</span></span>
                            <span id="cb482-20"><a href="#cb482-20" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb482-21"><a href="#cb482-21" aria-hidden="true" tabindex="-1"></a><span class="dt">Restart</span><span class="ch">=</span><span class="st">on-failure</span></span>
                            <span id="cb482-22"><a href="#cb482-22" aria-hidden="true" tabindex="-1"></a><span class="dt">RestartSec</span><span class="ch">=</span><span class="st">5</span></span>
                            <span id="cb482-23"><a href="#cb482-23" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb482-24"><a href="#cb482-24" aria-hidden="true" tabindex="-1"></a>[Install]</span>
                            <span id="cb482-25"><a href="#cb482-25" aria-hidden="true" tabindex="-1"></a><span class="dt">WantedBy</span><span class="ch">=</span><span class="st">multi-user.target</span></span></code></pre></div>
                        <p>We also need environment variables set up, which we can do in a separate file (notice <code class="verbatim">EnvironmentFile</code> above).</p>
                        <p>Open a buffer in <code class="verbatim">fuka-stack/fuka-stack-app.env</code>, add the following code, and then save.</p>
                        <div class="sourceCode" id="cb483" data-tangle="../code/deploying/fuka-stack/fuka-stack-app.env"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb483-1"><a href="#cb483-1" aria-hidden="true" tabindex="-1"></a><span class="dt">HOST</span><span class="ch">=</span><span class="st">0.0.0.0</span></span>
                            <span id="cb483-2"><a href="#cb483-2" aria-hidden="true" tabindex="-1"></a><span class="dt">PORT</span><span class="ch">=</span><span class="st">5000</span></span>
                            <span id="cb483-3"><a href="#cb483-3" aria-hidden="true" tabindex="-1"></a><span class="dt">DEBUGP</span><span class="ch">=</span><span class="st">false</span></span></code></pre></div></li>
                    <li><p>Makefile</p>
                        <p>The makefile includes both <code class="verbatim">make</code> and <code class="verbatim">make install</code> commands. Open a buffer in <code class="verbatim">fuka-stack/makefile</code> and save this code inside:</p>
                        <div class="sourceCode" id="cb484" data-tangle="../code/deploying/fuka-stack/makefile"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb484-1"><a href="#cb484-1" aria-hidden="true" tabindex="-1"></a><span class="dv">fuka-stack:</span><span class="dt"> build.lisp *.asd *.lisp src/*.lisp</span></span>
                            <span id="cb484-2"><a href="#cb484-2" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>ros build fuka-stack-app.ros</span>
                            <span id="cb484-3"><a href="#cb484-3" aria-hidden="true" tabindex="-1"></a><span class="dv">install:</span></span>
                            <span id="cb484-4"><a href="#cb484-4" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>mv fuka-stack-app ~/.local/bin/fuka-stack-app</span>
                            <span id="cb484-5"><a href="#cb484-5" aria-hidden="true" tabindex="-1"></a>    sudo cp fuka-stack-app.service /etc/systemd/system/fuka-stack-app.service</span>
                            <span id="cb484-6"><a href="#cb484-6" aria-hidden="true" tabindex="-1"></a>    sudo cp fuka-stack-app.env /etc/systemd/system/fuka-stack-app.env</span>
                            <span id="cb484-7"><a href="#cb484-7" aria-hidden="true" tabindex="-1"></a>    sudo systemctl daemon-reload</span>
                            <span id="cb484-8"><a href="#cb484-8" aria-hidden="true" tabindex="-1"></a>    sudo systemctl enable fuka-stack-app.service</span>
                            <span id="cb484-9"><a href="#cb484-9" aria-hidden="true" tabindex="-1"></a><span class="dv">run:</span></span>
                            <span id="cb484-10"><a href="#cb484-10" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>sudo systemctl start fuka-stack-app.service</span></code></pre></div>
                        <p><code class="verbatim">make</code> will run Roswell's version of SBCL to build the executable. If you want to use/test this script locally you need to install Roswell.</p>
                        <p><code class="verbatim">make install</code> will move the <code class="verbatim">fuka-stack-app</code> executable, setup the systemd service and environment variables, and then start the service.</p></li>
                </ol></li>
            <li><p>Hello World Code</p>
                <p>Now that we have our server set up, and we have all we need to build an executable and start it as a service, we can make our hello-world web app.</p>
                <ol class="incremental">
                    <li><p>System</p>
                        <p>In the project root directory, make a file called <code class="verbatim">fuka-stack.asd</code> and place the below code into it.</p>
                        <div class="sourceCode" id="cb485" data-org-language="lisp" data-tangle="../code/deploying/ceramic-app/ceramic-app.asd"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb485-1"><a href="#cb485-1" aria-hidden="true" tabindex="-1"></a>(defsystem <span class="st">&quot;ceramic-app&quot;</span></span>
                            <span id="cb485-2"><a href="#cb485-2" aria-hidden="true" tabindex="-1"></a>  :author <span class="st">&quot;Micah Killian &lt;micah@killianarts.online&gt;&quot;</span></span>
                            <span id="cb485-3"><a href="#cb485-3" aria-hidden="true" tabindex="-1"></a>  :maintainer <span class="st">&quot;Micah Killian &lt;micah@killianarts.online&gt;&quot;</span></span>
                            <span id="cb485-4"><a href="#cb485-4" aria-hidden="true" tabindex="-1"></a>  :description <span class="st">&quot;Ceramic Electron Example App&quot;</span></span>
                            <span id="cb485-5"><a href="#cb485-5" aria-hidden="true" tabindex="-1"></a>  :license <span class="st">&quot;MIT&quot;</span></span>
                            <span id="cb485-6"><a href="#cb485-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">:version</span> <span class="st">&quot;0.1&quot;</span></span>
                            <span id="cb485-7"><a href="#cb485-7" aria-hidden="true" tabindex="-1"></a>  :depends-on (:clack</span>
                            <span id="cb485-8"><a href="#cb485-8" aria-hidden="true" tabindex="-1"></a>               :woo </span>
                            <span id="cb485-9"><a href="#cb485-9" aria-hidden="true" tabindex="-1"></a>               :myway</span>
                            <span id="cb485-10"><a href="#cb485-10" aria-hidden="true" tabindex="-1"></a>               :lack</span>
                            <span id="cb485-11"><a href="#cb485-11" aria-hidden="true" tabindex="-1"></a>               :lack-component</span>
                            <span id="cb485-12"><a href="#cb485-12" aria-hidden="true" tabindex="-1"></a>               :lack-request</span>
                            <span id="cb485-13"><a href="#cb485-13" aria-hidden="true" tabindex="-1"></a>               :lack-response)</span>
                            <span id="cb485-14"><a href="#cb485-14" aria-hidden="true" tabindex="-1"></a>  :components ((:module <span class="st">&quot;src&quot;</span></span>
                            <span id="cb485-15"><a href="#cb485-15" aria-hidden="true" tabindex="-1"></a>                :components</span>
                            <span id="cb485-16"><a href="#cb485-16" aria-hidden="true" tabindex="-1"></a>                ((:file <span class="st">&quot;main&quot;</span>)))))</span></code></pre></div>
                        <p>Notice that we don't have any of the build options like we had for the previous executable CLI app. That's because we'll be using Roswell to build the executable.</p>
                        <p>Save this file and then be sure to run <code class="verbatim">vend get</code> to download the dependencies into your project.</p></li>
                    <li><p>Main</p>
                        <p>Finally, we have the main body of the app. I won't be explaining the mechanics of the stack–that is the subject of a future book.</p>
                        <p>Open a buffer in <code class="verbatim">fuka-stack/src/main.lisp</code>, add this code, and save it.</p>
                        <div class="sourceCode" id="cb486" data-org-language="lisp" data-tangle="../code/deploying/ceramic-app/src/main.lisp"><pre class="sourceCode lisp"><code class="sourceCode lisp"><span id="cb486-1"><a href="#cb486-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defpackage</span><span class="fu"> </span>#:ceramic-app</span>
                            <span id="cb486-2"><a href="#cb486-2" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:use</span> #:cl)</span>
                            <span id="cb486-3"><a href="#cb486-3" aria-hidden="true" tabindex="-1"></a>  (<span class="bu">:nicknames</span> #:ceramic-app/main))</span>
                            <span id="cb486-4"><a href="#cb486-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">in-package</span> #:ceramic-app/main)</span>
                            <span id="cb486-5"><a href="#cb486-5" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb486-6"><a href="#cb486-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Lack setup</span></span>
                            <span id="cb486-7"><a href="#cb486-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> fuka-component </span>(lack/component::lack-component)</span>
                            <span id="cb486-8"><a href="#cb486-8" aria-hidden="true" tabindex="-1"></a>  ((routes :initarg :routes :accessor component-routes :initform (myway:make-mapper))))</span>
                            <span id="cb486-9"><a href="#cb486-9" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb486-10"><a href="#cb486-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *component*</span></span>
                            <span id="cb486-11"><a href="#cb486-11" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">make-instance</span> <span class="dt">&#39;fuka-component</span>))</span>
                            <span id="cb486-12"><a href="#cb486-12" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb486-13"><a href="#cb486-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *request* </span><span class="kw">nil</span>)</span>
                            <span id="cb486-14"><a href="#cb486-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defparameter</span><span class="fu"> *response* </span><span class="kw">nil</span>)</span>
                            <span id="cb486-15"><a href="#cb486-15" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb486-16"><a href="#cb486-16" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> lack/component</span>:call ((component fuka-component) env)</span>
                            <span id="cb486-17"><a href="#cb486-17" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((*request* (lack/request:make-request env)))</span>
                            <span id="cb486-18"><a href="#cb486-18" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">multiple-value-bind</span> (response foundp)</span>
                            <span id="cb486-19"><a href="#cb486-19" aria-hidden="true" tabindex="-1"></a>        (myway:dispatch (<span class="kw">slot-value</span> component <span class="dt">&#39;routes</span>)</span>
                            <span id="cb486-20"><a href="#cb486-20" aria-hidden="true" tabindex="-1"></a>                        (lack/request:request-path-info *request*)</span>
                            <span id="cb486-21"><a href="#cb486-21" aria-hidden="true" tabindex="-1"></a>                        :method (lack/request:request-method *request*))</span>
                            <span id="cb486-22"><a href="#cb486-22" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">if</span> foundp</span>
                            <span id="cb486-23"><a href="#cb486-23" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">if</span> (<span class="kw">functionp</span> response)</span>
                            <span id="cb486-24"><a href="#cb486-24" aria-hidden="true" tabindex="-1"></a>              response</span>
                            <span id="cb486-25"><a href="#cb486-25" aria-hidden="true" tabindex="-1"></a>              (<span class="kw">destructuring-bind</span> (status headers body) response</span>
                            <span id="cb486-26"><a href="#cb486-26" aria-hidden="true" tabindex="-1"></a>                (lack/response:finalize-response (lack/response:make-response status headers body))))</span>
                            <span id="cb486-27"><a href="#cb486-27" aria-hidden="true" tabindex="-1"></a>          (lack/response:finalize-response (lack/response:make-response <span class="dv">404</span> &#39;(:content-type <span class="st">&quot;text/html&quot;</span>) &#39;(<span class="st">&quot;Not found&quot;</span>)))))))</span>
                            <span id="cb486-28"><a href="#cb486-28" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb486-29"><a href="#cb486-29" aria-hidden="true" tabindex="-1"></a><span class="co">;; Clack response utility</span></span>
                            <span id="cb486-30"><a href="#cb486-30" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> http-response </span>(body &amp;key (code <span class="dv">200</span>) (headers <span class="kw">nil</span>))</span>
                            <span id="cb486-31"><a href="#cb486-31" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((headers (<span class="kw">append</span> `(:content-type <span class="st">&quot;text/html; charset=utf-8&quot;</span></span>
                            <span id="cb486-32"><a href="#cb486-32" aria-hidden="true" tabindex="-1"></a>                           :content-length ,(<span class="kw">length</span> body))</span>
                            <span id="cb486-33"><a href="#cb486-33" aria-hidden="true" tabindex="-1"></a>                         headers)))</span>
                            <span id="cb486-34"><a href="#cb486-34" aria-hidden="true" tabindex="-1"></a>    `(,code ,headers (,body))))</span>
                            <span id="cb486-35"><a href="#cb486-35" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb486-36"><a href="#cb486-36" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb486-37"><a href="#cb486-37" aria-hidden="true" tabindex="-1"></a><span class="co">;; Myway routing utilities</span></span>
                            <span id="cb486-38"><a href="#cb486-38" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> make-endpoint </span>(fn)</span>
                            <span id="cb486-39"><a href="#cb486-39" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">lambda</span> (params)</span>
                            <span id="cb486-40"><a href="#cb486-40" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">funcall</span> (<span class="kw">symbol-function</span> fn) params)))</span>
                            <span id="cb486-41"><a href="#cb486-41" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb486-42"><a href="#cb486-42" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> route </span>(<span class="kw">method</span> routing-rule endpoint &amp;optional (mapper (component-routes *component*)))</span>
                            <span id="cb486-43"><a href="#cb486-43" aria-hidden="true" tabindex="-1"></a>  (myway:connect mapper</span>
                            <span id="cb486-44"><a href="#cb486-44" aria-hidden="true" tabindex="-1"></a>                 routing-rule</span>
                            <span id="cb486-45"><a href="#cb486-45" aria-hidden="true" tabindex="-1"></a>                 (make-endpoint endpoint)</span>
                            <span id="cb486-46"><a href="#cb486-46" aria-hidden="true" tabindex="-1"></a>                 :method <span class="kw">method</span>))</span>
                            <span id="cb486-47"><a href="#cb486-47" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb486-48"><a href="#cb486-48" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb486-49"><a href="#cb486-49" aria-hidden="true" tabindex="-1"></a><span class="co">;; Index controller and route</span></span>
                            <span id="cb486-50"><a href="#cb486-50" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> index </span>(params)</span>
                            <span id="cb486-51"><a href="#cb486-51" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">declare</span> (<span class="kw">ignore</span> params))</span>
                            <span id="cb486-52"><a href="#cb486-52" aria-hidden="true" tabindex="-1"></a>  (http-response (<span class="kw">format</span> <span class="kw">nil</span></span>
                            <span id="cb486-53"><a href="#cb486-53" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Hello, world! This is the path: ~a. This is the HTTP request method: ~a.&quot;</span></span>
                            <span id="cb486-54"><a href="#cb486-54" aria-hidden="true" tabindex="-1"></a>                         (lack/request:request-path-info *request*)</span>
                            <span id="cb486-55"><a href="#cb486-55" aria-hidden="true" tabindex="-1"></a>                         (lack/request:request-method *request*))))</span>
                            <span id="cb486-56"><a href="#cb486-56" aria-hidden="true" tabindex="-1"></a></span>
                            <span id="cb486-57"><a href="#cb486-57" aria-hidden="true" tabindex="-1"></a>(route :GET <span class="st">&quot;/&quot;</span> <span class="dt">&#39;index</span>)</span></code></pre></div></li>
                </ol></li>
        </ol>
        <h1 id="acd0e3c4-efd8-40f0-b22e-fef7e58c3913">RESOURCES</h1>
    </body>
</html>
